<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"/><meta name="theme-color" content="#222"/><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/><meta name="renderer" content="webkit"/><link rel="icon" type="image/ico" sizes="32x32" href="/blog/assets/favicon.ico"/><link rel="apple-touch-icon" sizes="180x180" href="/blog/assets/apple-touch-icon.png"/><meta name="msvalidate.01" content="C974411E5F5A79173F7830327E92F59E"/><meta name="google-site-verification" content="UJapM2d84iH6w1FVXFWeXhz_PoqtMDTU3mmNjGfRe1E"/><link rel="alternate" href="/blog/rss.xml" title="望春风" type="application/rss+xml"><link rel="alternate" href="/blog/atom.xml" title="望春风" type="application/atom+xml"><link rel="alternate" type="application/json" title="望春风" href="https://salvely.github.io/blog/feed.json"/><link rel="preconnect" href="https://lf9-cdn-tos.bytecdntp.com"/><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"/><link rel="dns-prefetch" href="https://unpkg.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/blog/css/app.css?v=0.3.6"><script src="https://cdn.staticfile.org/vue/3.2.45/vue.global.prod.js"></script><link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css"/><link rel="canonical" href="https://salvely.github.io/blog/2024/01/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/CIT5950/"><title>HW3: LRU SimpleVM 实现记录</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">HW3: LRU SimpleVM 实现记录</h1><div class="meta"><span class="item" title="创建时间：2024-01-04 13:27:01"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2024-01-04T13:27:01+08:00">2024-01-04</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>30k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>27 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/blog/" rel="start">Salvely</a></li></ul><ul class="right" id="rightNav"><li class="item theme" @click="changeThemeByBtn"><i class="ic" :class="{'i-sun': !themeStatus,'i-moon': themeStatus}"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" data-background-image="https://i.imgtg.com/2023/03/09/Y0iNK.jpg"></li><li class="item" data-background-image="https://i.imgtg.com/2023/03/09/YSj7p.jpg"></li><li class="item" data-background-image="https://i.imgtg.com/2023/03/09/YS6XY.jpg"></li><li class="item" data-background-image="https://i.imgtg.com/2023/03/09/Y0kTl.jpg"></li><li class="item" data-background-image="https://i.imgtg.com/2023/03/09/Y0zdB.jpg"></li><li class="item" data-background-image="https://i.imgtg.com/2023/03/09/YQSYM.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemListElement itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/blog/">首页</a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" itemprop="item" rel="index" title="分类于计算机科学"><span itemprop="name">计算机科学<meta itemprop="position" content="0"/></span></a></span><i class="ic i-angle-right"></i><span itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/" itemprop="item" rel="index" title="分类于系统"><span itemprop="name">系统<meta itemprop="position" content="1"/></span></a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/" itemprop="item" rel="index" title="分类于系统入门"><span itemprop="name">系统入门<meta itemprop="position" content="2"/></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://salvely.github.io/blog/2024/01/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/CIT5950/"/><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/blog/assets/avatar.jpg"/><meta itemprop="name" content="Salvely"/><meta itemprop="description" content="自己买花自己戴，爱恨多自在。只为人生不重来，何不放开怀, 计算机&amp;数理&amp;文学爱好者，喜欢健身、下厨、听音乐和看电影"/></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="望春风"/></span><div class="body md" itemprop="articleBody"><h1 id="overview"><a class="markdownIt-Anchor" href="#overview">#</a> Overview</h1>
<p>本作业要求实现:</p>
<ul>
<li>Page 对象：
<ul>
<li>若 Page 不在 memory 中，那么它的数据被存储在磁盘上的 <code>swap file</code>  部分。在 <code>swap file</code>  中，每一页都有对应的顺序存储的数据。</li>
<li>可以使用 C++  <code>fstream</code>  类进行 I/O 读写。尤其是 <code>read()</code>  和 <code>write()</code>  方法。</li>
</ul>
</li>
<li>PageTable 对象
<ul>
<li>包含多个 page 以及 <code>swap file</code></li>
<li>这里主要要求实现 LRU 算法</li>
</ul>
</li>
</ul>
<h1 id="相关文件"><a class="markdownIt-Anchor" href="#相关文件">#</a> 相关文件</h1>
<h2 id="page"><a class="markdownIt-Anchor" href="#page">#</a> Page</h2>
<ul>
<li><code>Page.h</code></li>
<li><code>Page.cc</code></li>
<li><code>PageTemplates.cc</code></li>
</ul>
<h2 id="pagetable"><a class="markdownIt-Anchor" href="#pagetable">#</a> PageTable</h2>
<ul>
<li><code>PageTable.h</code></li>
<li><code>PageTable.cc</code></li>
</ul>
<h2 id="testing"><a class="markdownIt-Anchor" href="#testing">#</a> Testing</h2>
<ul>
<li><code>test_page.cc</code></li>
<li><code>test_pagetable.cc</code></li>
</ul>
<h1 id="实现提示"><a class="markdownIt-Anchor" href="#实现提示">#</a> 实现提示</h1>
<ul>
<li>map, unordered_map, list, vector 结构都很有用</li>
<li><code>fstream</code>  中的 <code>read()</code>  和 <code>write()</code>  很有用</li>
<li>需要将 <code>uint8_t</code>  切换到 <code>char</code>  类型来使用 <code>fstream</code></li>
<li>利用初始化列表来初始化引用类型</li>
</ul>
<h1 id="page-2"><a class="markdownIt-Anchor" href="#page-2">#</a> Page</h1>
<h2 id="page-源码分析"><a class="markdownIt-Anchor" href="#page-源码分析">#</a> Page 源码分析</h2>
<p><code>simplevm namespace</code>  中存在一个类 <code>Page</code> ，此外还有一个 <code>uint32_t</code>  类型 ( <code>pno_t</code>  类型) 的变量，用来表示页号。 <code>Page</code>  页的解释如下:</p>
<ul>
<li>页对象存在 -&gt; 页被导入到 physical memory-&gt; 创建一个 <code>page</code> ，并且从 <code>swap_file</code>  中读 <code>page</code>  数据。页的数据从 <code>virtual_pno * Page::PAGE_SIZE</code>  开始</li>
<li>页对象不存在 -&gt; 数据存储在 <code>swap_file</code>  中</li>
<li>用户可以
<ul>
<li>获取数据</li>
<li>存储数据</li>
<li>将数据刷新到 <code>swap file</code>  中（多余的无法放入 physical memory 的虚拟内存所存储的地方）</li>
</ul>
</li>
</ul>
<p><code>Page</code>  类中包含如下 <code>public</code>  方法:</p>
<ul>
<li><code>Page(fstream&amp; swap_file, pno_t virtual_pno);</code>
<ul>
<li>构造函数，传入该 <code>page</code>  对应的 <code>swap_file</code>  和页号</li>
<li>我们从 <code>swap_file</code>  读入页数据，刷新时将页数据写入 <code>swap_file</code></li>
<li>页号规定了我们在 <code>swap_file</code>  的哪里写入数据</li>
</ul>
</li>
<li><code>Page(const Page&amp; other);</code>
<ul>
<li>利用一个页来复制构造另一个页，两个页具有相同的页号和 <code>swap_file</code>  地址，但是数据是复制了的（不是引用）</li>
</ul>
</li>
<li><code>~Page()</code>
<ul>
<li>清理声明的变量</li>
<li>如果当前数据为 dirty 状态，那么将其刷新到对应的 <code>swap_file</code></li>
</ul>
</li>
<li><code>Page&amp; operator=(const Page&amp; rhs)</code>
<ul>
<li>赋值函数，同复制构造函数，两个 <code>Page</code>  具有相同的 <code>swap_file</code>  和页号，但是 <code>data</code>  是被复制了的</li>
</ul>
</li>
<li><code>template &lt;typename T&gt; T access(uint32_t virtual_address);</code>
<ul>
<li>获取该页面的值（需要考虑错误情况）</li>
</ul>
</li>
<li><code>T store(uint32_t virtual address, const T&amp; to_write)</code>
<ul>
<li>存储值到该页面中去</li>
</ul>
</li>
<li><code>bool operator&lt;(const Page&amp; rhs);</code>
<ul>
<li>比较两个页面顺序</li>
</ul>
</li>
<li><code>pno_t pno();</code>
<ul>
<li>获取该页面的页号</li>
</ul>
</li>
<li><code>bool dirty();</code>
<ul>
<li>该 page 是否为 dirty 状态 (如果有人在 flush 之后，向该 page 写过值就是 dirty)</li>
</ul>
</li>
<li><code>void flush();</code>
<ul>
<li>如果该 page 是 dirty 状态，就把内容刷新到 <code>swap_file</code></li>
</ul>
</li>
<li>变量： <code>static constexpr size_t PAGE_SIZE = 4096U;</code>
<ul>
<li>该 page 的大小</li>
</ul>
</li>
</ul>
<p>Page 中还包括如下 <code>private</code>  变量:</p>
<ul>
<li><code>fstream&amp; swap_file_;</code>
<ul>
<li>注意这里是个引用，一个 page 没有对 <code>swap_file</code>  的所有权，只能 access 到它，所以这里 <code>swap_file</code>  是个引用</li>
</ul>
</li>
<li><code>pno_t virtual_pno_;</code>
<ul>
<li>该 page 的页号</li>
</ul>
</li>
<li><code>uint8_t *bytes_;</code>
<ul>
<li>该 page 的字节内容</li>
</ul>
</li>
<li><code>bool dirty_;</code>
<ul>
<li>该 page 是否在 flush 后被写入</li>
</ul>
</li>
</ul>
<h2 id="page-设计"><a class="markdownIt-Anchor" href="#page-设计">#</a> Page 设计</h2>
<h2 id="pagetemplatescc实现"><a class="markdownIt-Anchor" href="#pagetemplatescc实现">#</a>  <code>PageTemplates.cc</code>  实现</h2>
<p><code>PageTemplates.cc</code>  在 <code>simplevm namespace</code>  中。源码如下:</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">namespace</span> simplevm <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token comment">// TODO: implement all template member functions for Page</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">// This function allows users to read various data types</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">// from the page. Trying to read a non-primitive type or use</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">// a virtual address that doesn't map to this page results</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// in undefined behaviour. You can also assume that</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// anything being read fits in on the page we are reading</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// is not partially on another page.</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// If you are familiar with endianness, it shouldn't be</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// considered for this function.</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">// Arguments:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">//   - virtual_address: a virtual address that maps somewhere</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">//     into the page, where we will read data of type T</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// Returns:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">//   - the data of type T that was read from the page</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span></pre></td></tr><tr><td data-num="20"></td><td><pre>  T <span class="token class-name">Page</span><span class="token double-colon punctuation">::</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> virtual_address<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>virtual_address <span class="token operator">/</span> PAGE_SIZE <span class="token operator">!=</span> virtual_pno_<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    virtual_address <span class="token operator">=</span> virtual_address <span class="token operator">%</span> PAGE_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    T<span class="token operator">*</span> address <span class="token operator">=</span> <span class="token punctuation">(</span>T<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bytes_ <span class="token operator">+</span> virtual_address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">*</span>address<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token comment">// This function allows users to write various data types</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token comment">// to the page. Trying to write a non-primitive type or use</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token comment">// a virtual address that doesn't map to this page results</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token comment">// in undefined behaviour. You can also assume that</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token comment">// anything being written fits on the current page</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token comment">// is not partially on another page.</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token comment">// If you are familiar with endianness, it shouldn't be</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">// considered for this function.</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token comment">// Arguments:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token comment">//   - virtual_address: a virtual address that maps somewhere</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token comment">//     into the page, where we will read data of type T</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token comment">//   - to_write: the data of type T to write to the page</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token comment">// Returns: nothing</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token keyword">void</span> <span class="token class-name">Page</span><span class="token double-colon punctuation">::</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> virtual_address<span class="token punctuation">,</span> <span class="token keyword">const</span> T<span class="token operator">&amp;</span> to_write<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>virtual_address <span class="token operator">/</span> PAGE_SIZE <span class="token operator">!=</span> virtual_pno_<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    virtual_address <span class="token operator">=</span> virtual_address <span class="token operator">%</span> PAGE_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    T<span class="token operator">*</span> address <span class="token operator">=</span> <span class="token punctuation">(</span>T<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>bytes_ <span class="token operator">+</span> virtual_address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token operator">*</span>address <span class="token operator">=</span> to_write<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    dirty_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="pageh定义"><a class="markdownIt-Anchor" href="#pageh定义">#</a>  <code>Page.h</code>  定义</h2>
<p><code>Page.h</code>  在 <code>simplevm namespace</code>  中。源码如下:</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">PAGE_H_</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PAGE_H_</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdint></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>fstream<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">namespace</span> simplevm <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// defines the type pno_t, which is the type</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// that represents a page number</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">uint32_t</span> pno_t<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">///////////////////////////////////////////////////////////////////////////////</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// A Page is a class that represents a page of memory</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">// in our simple virtual memory model.</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// If a page object exists, then we say that the page is loaded</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">// into physical memory. When the page object doesn't exist, then its</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">// data is stored in the swap_file. When we load in a page to</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">// "physical memory", we are creating the page and we read the page's data</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">// from the swap file. A page's data in the swap file starts at</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">// virtual_pno * Page::PAGE_SIZE</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">//</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">// This Class manages a page's worth of data</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">// Users can access or store data, sa well as flush the data in the</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">// page to the specified swap file. A swap file is where exceess virtual</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">// memory is stored when it can't fit in physical memory.</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">///////////////////////////////////////////////////////////////////////////////</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Page</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token comment">// Constructs a new Page object associated</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token comment">// with a swap_file and a virtual page number.</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token comment">// The swap file is where we will load in the page</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token comment">// contents and flush the page contents. The virtual</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">// page number decides where in that file we read</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token comment">// and write this page.</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token comment">// Passing in an invalid page number is undefined behaviour</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token comment">// Note that a Page does not have ownership</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token comment">// of the swap_file_, just access to it.</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token comment">// Arguments:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token comment">//  - swap_file the swap_file associated with the page</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token comment">//  - the virtual page number of our new page</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token function">Page</span><span class="token punctuation">(</span>fstream<span class="token operator">&amp;</span> swap_file<span class="token punctuation">,</span> pno_t virtual_pno<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token comment">// Constructs a new Page object that is a copy of</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token comment">// another page object. Both pages will have</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token comment">// the same page number and swap_file, but should</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token comment">// have independent copies of the page data.</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token comment">// Misc: this means that there could be issues with</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token comment">// having the original and copy page having differnt</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token comment">// data. This cctor should only really be used</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token comment">// in the context of managing pages with something</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token comment">// like STL, where the original page used for the cctor</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token comment">// will be discarded. In real C++, we would want to</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token comment">// use move semantics here.</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token comment">// Arguements:</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token comment">//   - other: the page we are copying</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token function">Page</span><span class="token punctuation">(</span><span class="token keyword">const</span> Page<span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token comment">// Destructor for the page object</span></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token comment">// Cleans up any dynamically allocated data or</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token comment">// otherwise allocated resources AND should flush</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token comment">// its contents if the page is dirty at time of</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token comment">// destruction.</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token operator">~</span><span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token comment">// Set the current Page object so that is a copy of</span></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token comment">// another page object. Both pages will have</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token comment">// the same page number and swap_file, but should</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token comment">// have independent copies of the page data.</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token comment">// Misc: this means that there could be issues with</span></pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token comment">// having the original and copy page having differnt</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token comment">// data. This op= should only really be used</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token comment">// in the context of managing pages with something</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token comment">// like STL, where the original page used for the cctor</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token comment">// will be discarded. In real C++, we would want to</span></pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token comment">// use move semantics here.</span></pre></td></tr><tr><td data-num="83"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token comment">// You can assume each page has the same swap_file.</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token comment">// Arguements:</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token comment">//   - rhs: the page we are copying</span></pre></td></tr><tr><td data-num="88"></td><td><pre>  Page<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Page<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>  <span class="token comment">// This function is not required, but you may add it</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token comment">// if it is needed for some of the STL containers</span></pre></td></tr><tr><td data-num="92"></td><td><pre>  <span class="token comment">// you use in PageTable</span></pre></td></tr><tr><td data-num="93"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="94"></td><td><pre>  <span class="token comment">// Determines if this page should go before another page if they</span></pre></td></tr><tr><td data-num="95"></td><td><pre>  <span class="token comment">// were in sorted order.</span></pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="97"></td><td><pre>  <span class="token comment">// Arguments:</span></pre></td></tr><tr><td data-num="98"></td><td><pre>  <span class="token comment">//   - rhs: the Page we are comparing this to</span></pre></td></tr><tr><td data-num="99"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token comment">// Returns: true iff this page would show up before the other</span></pre></td></tr><tr><td data-num="101"></td><td><pre>  <span class="token comment">// page in sorted order. False otherwise.</span></pre></td></tr><tr><td data-num="102"></td><td><pre>  <span class="token keyword">bool</span> <span class="token keyword">operator</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">const</span> Page<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre>  <span class="token comment">// This function allows users to read various data types</span></pre></td></tr><tr><td data-num="105"></td><td><pre>  <span class="token comment">// from the page. Trying to read a non-primitive type or use</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  <span class="token comment">// a virtual address that doesn't map to this page results</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  <span class="token comment">// in undefined behaviour. You can also assume that</span></pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token comment">// anything being read fits in on the page we are reading</span></pre></td></tr><tr><td data-num="109"></td><td><pre>  <span class="token comment">// is not partially on another page.</span></pre></td></tr><tr><td data-num="110"></td><td><pre>  <span class="token comment">// If you are familiar with endianness, it shouldn't be</span></pre></td></tr><tr><td data-num="111"></td><td><pre>  <span class="token comment">// considered for this function.</span></pre></td></tr><tr><td data-num="112"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="113"></td><td><pre>  <span class="token comment">// Arguments:</span></pre></td></tr><tr><td data-num="114"></td><td><pre>  <span class="token comment">//   - virtual_address: a virtual address that maps somewhere</span></pre></td></tr><tr><td data-num="115"></td><td><pre>  <span class="token comment">//     into the page, where we will read data of type T</span></pre></td></tr><tr><td data-num="116"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="117"></td><td><pre>  <span class="token comment">// Returns:</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token comment">//   - the data of type T that was read from the page</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span></pre></td></tr><tr><td data-num="120"></td><td><pre>  T <span class="token function">access</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> virtual_address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre></pre></td></tr><tr><td data-num="122"></td><td><pre>  <span class="token comment">// This function allows users to write various data types</span></pre></td></tr><tr><td data-num="123"></td><td><pre>  <span class="token comment">// to the page. Trying to write a non-primitive type or use</span></pre></td></tr><tr><td data-num="124"></td><td><pre>  <span class="token comment">// a virtual address that doesn't map to this page results</span></pre></td></tr><tr><td data-num="125"></td><td><pre>  <span class="token comment">// in undefined behaviour. You can also assume that</span></pre></td></tr><tr><td data-num="126"></td><td><pre>  <span class="token comment">// anything being written fits on the current page</span></pre></td></tr><tr><td data-num="127"></td><td><pre>  <span class="token comment">// is not partially on another page.</span></pre></td></tr><tr><td data-num="128"></td><td><pre>  <span class="token comment">// If you are familiar with endianness, it shouldn't be</span></pre></td></tr><tr><td data-num="129"></td><td><pre>  <span class="token comment">// considered for this function.</span></pre></td></tr><tr><td data-num="130"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="131"></td><td><pre>  <span class="token comment">// Arguments:</span></pre></td></tr><tr><td data-num="132"></td><td><pre>  <span class="token comment">//   - virtual_address: a virtual address that maps somewhere</span></pre></td></tr><tr><td data-num="133"></td><td><pre>  <span class="token comment">//     into the page, where we will read data of type T</span></pre></td></tr><tr><td data-num="134"></td><td><pre>  <span class="token comment">//   - to_write: the data of type T to write to the page</span></pre></td></tr><tr><td data-num="135"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="136"></td><td><pre>  <span class="token comment">// Returns: nothing</span></pre></td></tr><tr><td data-num="137"></td><td><pre>  <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">></span></pre></td></tr><tr><td data-num="138"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">store</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> virtual_address<span class="token punctuation">,</span> <span class="token keyword">const</span> T<span class="token operator">&amp;</span> to_write<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre></pre></td></tr><tr><td data-num="140"></td><td><pre>  <span class="token comment">// Returns the virtual page number of this page</span></pre></td></tr><tr><td data-num="141"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="142"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="143"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="144"></td><td><pre>  <span class="token comment">// Returns: this page's virtual page number</span></pre></td></tr><tr><td data-num="145"></td><td><pre>  pno_t <span class="token function">pno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre></pre></td></tr><tr><td data-num="147"></td><td><pre>  <span class="token comment">// Returns whether or not a page is dirty</span></pre></td></tr><tr><td data-num="148"></td><td><pre>  <span class="token comment">// A page is "dirty" if someone has written to the data managed</span></pre></td></tr><tr><td data-num="149"></td><td><pre>  <span class="token comment">// by the page since the last time the page was flush()'d.</span></pre></td></tr><tr><td data-num="150"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="151"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="152"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="153"></td><td><pre>  <span class="token comment">// Returns: Whether this page is dirty or not</span></pre></td></tr><tr><td data-num="154"></td><td><pre>  <span class="token keyword">bool</span> <span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre></pre></td></tr><tr><td data-num="156"></td><td><pre>  <span class="token comment">// Flushes the page to the swap file if it is dirty.</span></pre></td></tr><tr><td data-num="157"></td><td><pre>  <span class="token comment">// Flushing a page to the swap file involves writing</span></pre></td></tr><tr><td data-num="158"></td><td><pre>  <span class="token comment">// the page at the the spot correspoding to its page number</span></pre></td></tr><tr><td data-num="159"></td><td><pre>  <span class="token comment">// in the swap_file. For a description of what it means</span></pre></td></tr><tr><td data-num="160"></td><td><pre>  <span class="token comment">// for a page to be dirty, see the dirty() member function.</span></pre></td></tr><tr><td data-num="161"></td><td><pre>  <span class="token comment">// The page should not be written if it is not dirty.</span></pre></td></tr><tr><td data-num="162"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="163"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="164"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="165"></td><td><pre>  <span class="token comment">// Returns: Nothing</span></pre></td></tr><tr><td data-num="166"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre></pre></td></tr><tr><td data-num="168"></td><td><pre>  <span class="token comment">// The amount of memory a page represents</span></pre></td></tr><tr><td data-num="169"></td><td><pre>  <span class="token keyword">static</span> <span class="token keyword">constexpr</span> size_t PAGE_SIZE <span class="token operator">=</span> <span class="token number">4096U</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre></pre></td></tr><tr><td data-num="171"></td><td><pre> <span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="172"></td><td><pre>  <span class="token comment">// The file we will be reading/writing to</span></pre></td></tr><tr><td data-num="173"></td><td><pre>  <span class="token comment">// Note how this is a reference</span></pre></td></tr><tr><td data-num="174"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="175"></td><td><pre>  <span class="token comment">// also note that a Page does not have ownership</span></pre></td></tr><tr><td data-num="176"></td><td><pre>  <span class="token comment">// of the swap_file_, just access to it.</span></pre></td></tr><tr><td data-num="177"></td><td><pre>  fstream<span class="token operator">&amp;</span> swap_file_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="178"></td><td><pre></pre></td></tr><tr><td data-num="179"></td><td><pre>  <span class="token comment">// the virtual page number</span></pre></td></tr><tr><td data-num="180"></td><td><pre>  pno_t virtual_pno_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="181"></td><td><pre></pre></td></tr><tr><td data-num="182"></td><td><pre>  <span class="token comment">// The bytes of the page. One byte is 8 bits</span></pre></td></tr><tr><td data-num="183"></td><td><pre>  <span class="token comment">// so we use 8-bit unsigned integers.</span></pre></td></tr><tr><td data-num="184"></td><td><pre>  <span class="token comment">// You can also assume that a 'char' is one byte big</span></pre></td></tr><tr><td data-num="185"></td><td><pre>  <span class="token keyword">uint8_t</span> <span class="token operator">*</span>bytes_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="186"></td><td><pre></pre></td></tr><tr><td data-num="187"></td><td><pre>  <span class="token comment">// Whether the page is dirty or not</span></pre></td></tr><tr><td data-num="188"></td><td><pre>  <span class="token keyword">bool</span> dirty_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="189"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="190"></td><td><pre></pre></td></tr><tr><td data-num="191"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="192"></td><td><pre></pre></td></tr><tr><td data-num="193"></td><td><pre><span class="token comment">// since we have template code</span></pre></td></tr><tr><td data-num="194"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./PageTemplates.cc"</span></span></pre></td></tr><tr><td data-num="195"></td><td><pre></pre></td></tr><tr><td data-num="196"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// PAGE_H_</span></span></pre></td></tr></table></figure><h2 id="pagecc实现"><a class="markdownIt-Anchor" href="#pagecc实现">#</a>  <code>Page.cc</code>  实现</h2>
<p><code>Page.cc</code>  在 <code>simplevm namespace</code>  中。源码如下:</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./Page.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">namespace</span> simplevm <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// TODO: implement all non template member functions for Page</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// Constructs a new Page object associated</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// with a swap_file and a virtual page number.</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">// The swap file is where we will load in the page</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// contents and flush the page contents. The virtual</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">// page number decides where in that file we read</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">// and write this page.</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">// Passing in an invalid page number is undefined behaviour</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">// Note that a Page does not have ownership</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// of the swap_file_, just access to it.</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">// Arguments:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">//  - swap_file the swap_file associated with the page</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token comment">//  - the virtual page number of our new page</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token class-name">Page</span><span class="token double-colon punctuation">::</span><span class="token function">Page</span><span class="token punctuation">(</span>fstream<span class="token operator">&amp;</span> swap_file<span class="token punctuation">,</span> pno_t virtual_pno<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">swap_file_</span><span class="token punctuation">(</span>swap_file<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">this</span><span class="token operator">-></span>virtual_pno_ <span class="token operator">=</span> virtual_pno<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">this</span><span class="token operator">-></span>bytes_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">uint8_t</span><span class="token punctuation">[</span>PAGE_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// seek the correct position</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    swap_file_<span class="token punctuation">.</span><span class="token function">seekg</span><span class="token punctuation">(</span>virtual_pno_ <span class="token operator">*</span> PAGE_SIZE<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>beg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// read from the swap file</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    swap_file_<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>bytes_<span class="token punctuation">,</span>PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>swap_file_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Swap file read failed!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">this</span><span class="token operator">-></span>dirty_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">// Constructs a new Page object that is a copy of</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token comment">// another page object. Both pages will have</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token comment">// the same page number and swap_file, but should</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token comment">// have independent copies of the page data.</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment">// Misc: this means that there could be issues with</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token comment">// having the original and copy page having differnt</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token comment">// data. This cctor should only really be used</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token comment">// in the context of managing pages with something</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token comment">// like STL, where the original page used for the cctor</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token comment">// will be discarded. In real C++, we would want to</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token comment">// use move semantics here.</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token comment">// Arguements:</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token comment">//   - other: the page we are copying</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token class-name">Page</span><span class="token double-colon punctuation">::</span><span class="token function">Page</span><span class="token punctuation">(</span><span class="token keyword">const</span> Page<span class="token operator">&amp;</span> other<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">swap_file_</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>swap_file_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">this</span><span class="token operator">-></span>virtual_pno_ <span class="token operator">=</span> other<span class="token punctuation">.</span>virtual_pno_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">this</span><span class="token operator">-></span>bytes_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">uint8_t</span><span class="token punctuation">[</span>PAGE_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-></span>bytes_<span class="token punctuation">,</span>other<span class="token punctuation">.</span>bytes_<span class="token punctuation">,</span>PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">this</span><span class="token operator">-></span>dirty_ <span class="token operator">=</span> other<span class="token punctuation">.</span>dirty_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token comment">// Destructor for the page object</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token comment">// Cleans up any dynamically allocated data or</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token comment">// otherwise allocated resources AND should flush</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token comment">// its contents if the page is dirty at time of</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token comment">// destruction.</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token class-name">Page</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>dirty_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    dirty_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">delete</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token comment">// Set the current Page object so that is a copy of</span></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token comment">// another page object. Both pages will have</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token comment">// the same page number and swap_file, but should</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token comment">// have independent copies of the page data.</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token comment">// Misc: this means that there could be issues with</span></pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token comment">// having the original and copy page having differnt</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token comment">// data. This op= should only really be used</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token comment">// in the context of managing pages with something</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token comment">// like STL, where the original page used for the cctor</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token comment">// will be discarded. In real C++, we would want to</span></pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token comment">// use move semantics here.</span></pre></td></tr><tr><td data-num="83"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token comment">// You can assume each page has the same swap_file.</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token comment">// Arguements:</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token comment">//   - rhs: the page we are copying</span></pre></td></tr><tr><td data-num="88"></td><td><pre>  Page<span class="token operator">&amp;</span> Page<span class="token double-colon punctuation">::</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Page<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">!=</span><span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token keyword">this</span><span class="token operator">-></span><span class="token operator">~</span><span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token function">Page</span><span class="token punctuation">(</span>rhs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="94"></td><td><pre></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="97"></td><td><pre></pre></td></tr><tr><td data-num="98"></td><td><pre>  <span class="token comment">// This function is not required, but you may add it</span></pre></td></tr><tr><td data-num="99"></td><td><pre>  <span class="token comment">// if it is needed for some of the STL containers</span></pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token comment">// you use in PageTable</span></pre></td></tr><tr><td data-num="101"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="102"></td><td><pre>  <span class="token comment">// Determines if this page should go before another page if they</span></pre></td></tr><tr><td data-num="103"></td><td><pre>  <span class="token comment">// were in sorted order.</span></pre></td></tr><tr><td data-num="104"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="105"></td><td><pre>  <span class="token comment">// Arguments:</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  <span class="token comment">//   - rhs: the Page we are comparing this to</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token comment">// Returns: true iff this page would show up before the other</span></pre></td></tr><tr><td data-num="109"></td><td><pre>  <span class="token comment">// page in sorted order. False otherwise.</span></pre></td></tr><tr><td data-num="110"></td><td><pre>  <span class="token keyword">bool</span> Page<span class="token double-colon punctuation">::</span><span class="token keyword">operator</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">const</span> Page<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token operator">-></span>virtual_pno_ <span class="token operator">&lt;</span> rhs<span class="token punctuation">.</span>virtual_pno_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>  <span class="token comment">// Returns the virtual page number of this page</span></pre></td></tr><tr><td data-num="115"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="116"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="117"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token comment">// Returns: this page's virtual page number</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  pno_t <span class="token class-name">Page</span><span class="token double-colon punctuation">::</span><span class="token function">pno</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token operator">-></span>virtual_pno_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="122"></td><td><pre></pre></td></tr><tr><td data-num="123"></td><td><pre>  <span class="token comment">// Returns whether or not a page is dirty</span></pre></td></tr><tr><td data-num="124"></td><td><pre>  <span class="token comment">// A page is "dirty" if someone has written to the data managed</span></pre></td></tr><tr><td data-num="125"></td><td><pre>  <span class="token comment">// by the page since the last time the page was flush()'d.</span></pre></td></tr><tr><td data-num="126"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="127"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="128"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="129"></td><td><pre>  <span class="token comment">// Returns: Whether this page is dirty or not</span></pre></td></tr><tr><td data-num="130"></td><td><pre>  <span class="token keyword">bool</span> <span class="token class-name">Page</span><span class="token double-colon punctuation">::</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token operator">-></span>dirty_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="133"></td><td><pre></pre></td></tr><tr><td data-num="134"></td><td><pre>  <span class="token comment">// Flushes the page to the swap file if it is dirty.</span></pre></td></tr><tr><td data-num="135"></td><td><pre>  <span class="token comment">// Flushing a page to the swap file involves writing</span></pre></td></tr><tr><td data-num="136"></td><td><pre>  <span class="token comment">// the page at the the spot correspoding to its page number</span></pre></td></tr><tr><td data-num="137"></td><td><pre>  <span class="token comment">// in the swap_file. For a description of what it means</span></pre></td></tr><tr><td data-num="138"></td><td><pre>  <span class="token comment">// for a page to be dirty, see the dirty() member function.</span></pre></td></tr><tr><td data-num="139"></td><td><pre>  <span class="token comment">// The page should not be written if it is not dirty.</span></pre></td></tr><tr><td data-num="140"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="141"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="142"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="143"></td><td><pre>  <span class="token comment">// Returns: Nothing</span></pre></td></tr><tr><td data-num="144"></td><td><pre>  <span class="token keyword">void</span> <span class="token class-name">Page</span><span class="token double-colon punctuation">::</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>        <span class="token comment">// seek the correct position</span></pre></td></tr><tr><td data-num="147"></td><td><pre>        swap_file_<span class="token punctuation">.</span><span class="token function">seekg</span><span class="token punctuation">(</span>virtual_pno_ <span class="token operator">*</span> PAGE_SIZE<span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>beg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>        <span class="token comment">// write to the swap file</span></pre></td></tr><tr><td data-num="149"></td><td><pre>        swap_file_<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>bytes_<span class="token punctuation">,</span>PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>swap_file_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>            std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Swap file write failed!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>        dirty_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="157"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="pagetable-2"><a class="markdownIt-Anchor" href="#pagetable-2">#</a> PageTable</h1>
<h2 id="pagetable-源码分析"><a class="markdownIt-Anchor" href="#pagetable-源码分析">#</a> PageTable 源码分析</h2>
<p>PageTable 的作用如下：</p>
<ul>
<li>管理一个进程的地址空间</li>
<li>包括 <code>swap_file</code></li>
<li>从 physical memory 中读取页</li>
<li>选择页淘汰，进行页替换</li>
</ul>
<p><code>PageTable.cc</code>  中有如下一些方法：</p>
<ul>
<li><code>PageTable(std::string swap_file_name, size_t page_capacity);</code>
<ul>
<li>初始化页表，制定 <code>swap_file</code>  名称和页容量</li>
<li>存储的页不可超过页容量</li>
</ul>
</li>
<li><code>~PageTable();</code>
<ul>
<li>清理所有变量</li>
<li>flush dirty pages</li>
</ul>
</li>
<li><code>Page&amp; get_page(uint32_t virtual_address);</code>
<ul>
<li>返回一个虚拟地址对应的 page</li>
<li>将该页导入 physical memory</li>
<li>返回它</li>
<li>有几种可能情况
<ul>
<li>该页在 Physical memory 中，返回对应的页的引用，并且将该页标记为最新（挪到 vector 最前）</li>
<li>该页不在 physical memory 中，并且 physical memory 还没满。那么将其导入 physical memory，并且标记为最新（挪到 vector 最前），返回该页引用</li>
<li>该页不在 Physical memory 中，并且 physical memory 已经满了，那么先执行淘汰算法，淘汰最老的页，将其写入 <code>swap_file</code> 。然后将该页从 <code>swap_file</code>  中导入进来，放在 vector 最前</li>
</ul>
</li>
<li>注意：
<ul>
<li>virtual address != 页号，可能有多个 virtual address 对应同一个页号 (一页有 4096 个字节嘛)</li>
<li>页的最新和最老完全取决于 <code>get_page</code>  函数的调用情况</li>
</ul>
</li>
</ul>
</li>
<li><code>size_t capacity();</code>
<ul>
<li>返回页容量</li>
</ul>
</li>
<li><code>size_t loaded_pages();</code>
<ul>
<li>返回导入 physical memory 的页数目</li>
</ul>
</li>
<li><code>bool page_available(pno_t virtual_pno);</code>
<ul>
<li>返回对应页是否存在 physical memory 中</li>
</ul>
</li>
<li><code>void flush_all_pages();</code>
<ul>
<li>将所有页都刷新到 <code>swap_file</code>  中</li>
</ul>
</li>
<li><code>void flush_page(pno_t virtual_pno);</code>
<ul>
<li>将对应的页刷新到 <code>swap_file</code>  中</li>
</ul>
</li>
<li><code>void discard_page(pno_t virtual_pno);</code>
<ul>
<li>从页表中丢弃对应的页。如果该页不存在，则返回。否则，若该页为 dirty，则将该页数据写入 <code>swap_file</code> ，然后丢弃它</li>
</ul>
</li>
<li><code>void evict_page();</code>
<ul>
<li>若没有 page 在页表中，则什么也不做。否则丢弃最老的一页（丢弃前记得将其写入 <code>swap_file</code> ）</li>
</ul>
</li>
</ul>
<p><code>PageTable.cc</code>  有两个 <code>private</code>  变量：</p>
<ul>
<li><code>fstream swap_file_</code> : 交换文件</li>
<li><code>size_t capacity</code> : 页容量</li>
<li><code>size_t page_num</code> : 当前已经导入 physical memory 的页数目</li>
<li><code>std::vector&lt;Page*&gt; page_list</code> : 记录所有在 physical memory 中的页</li>
<li><code>std::unordered_map&lt;pno_t,Page*&gt; mp</code> :</li>
</ul>
<h2 id="pagetableh设计"><a class="markdownIt-Anchor" href="#pagetableh设计">#</a>  <code>PageTable.h</code>  设计</h2>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">PAGE_TABLE_H_</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PAGE_TABLE_H_</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdint></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// #include &lt;vector></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unordered_map></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;list></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./Page.h"</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>fstream<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">namespace</span> simplevm <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">///////////////////////////////////////////////////////////////////////////////</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">// A PageTable manages a processes memeory for our simplified</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// virtual memory model. This involves managing a swap_file</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">// which is where pages of data are stored when they aren't loaded</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">// into physical memory. For our software model, we will say a page</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">// is in "physical memory" if it is loaded into our memory space</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">// (e.g. it is on the heap). Pages that aren't loaded in will have</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">// their contents stored in the swap_file and will not have an</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">// associated Page object (see Page.h). Our page table can only have</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">// so many pages stored in memory at one time, which is specified</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">// on PageTable Creation. We implement an LRU page replacement</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">// policy to decide which pages to evict if we need to load a new page</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">// and we already have reached our capacity on the numberof pages we can</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">// hold.</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">//</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">// Users can get a page from the cache, flush pages to the swap_file,</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">// request any page is evicted, and specifically ask for a page to be evicted.</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">///////////////////////////////////////////////////////////////////////////////</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">PageTable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre> <span class="token keyword">public</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">// Constructs a new page table with the specified</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token comment">// swap file and the specified page capacity, which is</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token comment">// the number of pages that can be held in memory</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token comment">// at one time. There cannot be more than page_capacity</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token comment">// number of pages loaded in at a time.</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token comment">// Arguments:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token comment">//   - swap_file_name: the name of the swap_file</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token comment">//   - page_capacity: the maximum number of pages that can be held</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token comment">//     in memory at one time.</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token function">PageTable</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string swap_file_name<span class="token punctuation">,</span> size_t page_capacity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token comment">// Destructs the page table, freeing any allocated resources</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token comment">// and flushing any pages currently loaded into memory that</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token comment">// are dirty</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token operator">~</span><span class="token function">PageTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token comment">// Given a virtual address, gets the associated</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token comment">// page for that virtual address. This page will</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token comment">// be "loaded" into physical memory by the time it</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token comment">// is returned.</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token comment">// There are three possiblities when a page is requested:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token comment">// 1. The page is currently in the "loaded" and in the cache.</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token comment">//    In this case, a reference to the page is returned and</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token comment">//    and the page is marked as most recently used in the cache</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token comment">// 2. The page is not currently "loaded", and the PageTable</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token comment">//    has not reached its page capacity:</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token comment">//    In this case, the page is loaded from the swap file and added</span></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token comment">//    to the cache as the most recently used page.</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token comment">// 3. The page is not currently "loaded", and the PageTable</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token comment">//    is at page capacity:</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token comment">//    The least recently used page in the cache is evicted from the</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token comment">//    cache. Afterwards the requested page is loaded from the swap file</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token comment">//    and added to the cache as the most recently used page.</span></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token comment">// NOTE: What decides how recntly used a page was used is entirely</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token comment">// decided by how recntly it was returned by a call to get_page.</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token comment">// Arguments:</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token comment">//   - virtual_address: A virtual address that is associated</span></pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token comment">//     with a requested page. The virutal address is represented</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token comment">//     as a unsigned 32 bit integer. NOTE: a virtual address</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token comment">//     is NOT the same as a page number. Multiple virtual addresses</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token comment">//     could be associated with the same page number.</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token comment">// Returns:</span></pre></td></tr><tr><td data-num="83"></td><td><pre>  <span class="token comment">//   - the requested page, which is loaded into the cache and</span></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token comment">//     marked as the most recently used page</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  Page<span class="token operator">&amp;</span> <span class="token function">get_page</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> virtual_address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token comment">// Returns the page capacity of the page table</span></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="89"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="90"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token comment">// Returns: the page capacity of the page table</span></pre></td></tr><tr><td data-num="92"></td><td><pre>  size_t <span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre>  <span class="token comment">// Returns the number of pages currently loaded into "physical memory"</span></pre></td></tr><tr><td data-num="95"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="97"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="98"></td><td><pre>  <span class="token comment">// Returns: the number of pages currently loaded into "physical memory"</span></pre></td></tr><tr><td data-num="99"></td><td><pre>  size_t <span class="token function">loaded_pages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre></pre></td></tr><tr><td data-num="101"></td><td><pre>  <span class="token comment">// Checks to see if the specified page is loaded into memory</span></pre></td></tr><tr><td data-num="102"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="103"></td><td><pre>  <span class="token comment">// Arguments: The virtual page number of the page to check for</span></pre></td></tr><tr><td data-num="104"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="105"></td><td><pre>  <span class="token comment">// Returns: True iff the page is loaded into memory, false otherwise</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  <span class="token keyword">bool</span> <span class="token function">page_available</span><span class="token punctuation">(</span>pno_t virtual_pno<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre></pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token comment">// Makes sure that all currently loaded pages are flushed</span></pre></td></tr><tr><td data-num="109"></td><td><pre>  <span class="token comment">// meaning tha the page contents are updated on the swap file.</span></pre></td></tr><tr><td data-num="110"></td><td><pre>  <span class="token comment">// This should not affect how recently used each page is and all pages</span></pre></td></tr><tr><td data-num="111"></td><td><pre>  <span class="token comment">// will remain loaded into memory after this operation is performed.</span></pre></td></tr><tr><td data-num="112"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="113"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="114"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="115"></td><td><pre>  <span class="token comment">// Returns: Nothing</span></pre></td></tr><tr><td data-num="116"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">flush_all_pages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token comment">// Flushes the specified page to the swap file.</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  <span class="token comment">// This should not affect how recently used each page is and all pages</span></pre></td></tr><tr><td data-num="120"></td><td><pre>  <span class="token comment">// will remain loaded into memory after this operation is performed.</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="122"></td><td><pre>  <span class="token comment">// Arguments: the virtual page number of the page to flush</span></pre></td></tr><tr><td data-num="123"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="124"></td><td><pre>  <span class="token comment">// Returns: Nothing</span></pre></td></tr><tr><td data-num="125"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">flush_page</span><span class="token punctuation">(</span>pno_t virtual_pno<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre></pre></td></tr><tr><td data-num="127"></td><td><pre>  <span class="token comment">// Discards the specified page from the PageTable.</span></pre></td></tr><tr><td data-num="128"></td><td><pre>  <span class="token comment">// If the page is dirty, then it is flushed before it is discarded.</span></pre></td></tr><tr><td data-num="129"></td><td><pre>  <span class="token comment">// If the page is not in the table, then nothing happens.</span></pre></td></tr><tr><td data-num="130"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="131"></td><td><pre>  <span class="token comment">// Arguments: the virtual page number of the page to discard.</span></pre></td></tr><tr><td data-num="132"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="133"></td><td><pre>  <span class="token comment">// Returns: Nothing</span></pre></td></tr><tr><td data-num="134"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">discard_page</span><span class="token punctuation">(</span>pno_t virtual_pno<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre></pre></td></tr><tr><td data-num="136"></td><td><pre>  <span class="token comment">// Evicts a page from the PageTable. The page evicted</span></pre></td></tr><tr><td data-num="137"></td><td><pre>  <span class="token comment">// should be the least recntly used page in the cache.</span></pre></td></tr><tr><td data-num="138"></td><td><pre>  <span class="token comment">// If the evicted page is dirty, then it is flushed before it is evicted.</span></pre></td></tr><tr><td data-num="139"></td><td><pre>  <span class="token comment">// If there are no pages in the cache, then do nothing.</span></pre></td></tr><tr><td data-num="140"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="141"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="142"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="143"></td><td><pre>  <span class="token comment">// Returns: Nothing</span></pre></td></tr><tr><td data-num="144"></td><td><pre>  <span class="token keyword">void</span> <span class="token function">evict_page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre></pre></td></tr><tr><td data-num="146"></td><td><pre> <span class="token keyword">private</span><span class="token operator">:</span></pre></td></tr><tr><td data-num="147"></td><td><pre>  <span class="token comment">// The swap file where pages are stored</span></pre></td></tr><tr><td data-num="148"></td><td><pre>  fstream swap_file_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre></pre></td></tr><tr><td data-num="150"></td><td><pre>  <span class="token comment">// The number of pages that can be stored</span></pre></td></tr><tr><td data-num="151"></td><td><pre>  <span class="token comment">// in the PageTable at one time.</span></pre></td></tr><tr><td data-num="152"></td><td><pre>  size_t capacity_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="153"></td><td><pre></pre></td></tr><tr><td data-num="154"></td><td><pre>  <span class="token comment">// TODO: add fields</span></pre></td></tr><tr><td data-num="155"></td><td><pre>  size_t page_num<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre></pre></td></tr><tr><td data-num="157"></td><td><pre>  <span class="token comment">// a vector to store pages in physical memory</span></pre></td></tr><tr><td data-num="158"></td><td><pre>  std<span class="token double-colon punctuation">::</span>list<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>pno_t<span class="token punctuation">,</span>Page<span class="token operator">*</span><span class="token operator">>></span> page_list<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="159"></td><td><pre></pre></td></tr><tr><td data-num="160"></td><td><pre>  <span class="token comment">// use an unordered_map to quickly determined the corresponding page</span></pre></td></tr><tr><td data-num="161"></td><td><pre>  std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>pno_t<span class="token punctuation">,</span>Page<span class="token operator">*</span><span class="token operator">></span> mp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="163"></td><td><pre></pre></td></tr><tr><td data-num="164"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="165"></td><td><pre></pre></td></tr><tr><td data-num="166"></td><td><pre></pre></td></tr><tr><td data-num="167"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// PAGE_TABLE_H_</span></span></pre></td></tr></table></figure><h2 id="pagetablecc实现"><a class="markdownIt-Anchor" href="#pagetablecc实现">#</a>  <code>PageTable.cc</code>  实现</h2>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./PageTable.h"</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"./Page.h"</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">namespace</span> simplevm <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">// TODO: implment PageTable member functions</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">// Constructs a new page table with the specified</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// swap file and the specified page capacity, which is</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// the number of pages that can be held in memory</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">// at one time. There cannot be more than page_capacity</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">// number of pages loaded in at a time.</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token comment">// Arguments:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">//   - swap_file_name: the name of the swap_file</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token comment">//   - page_capacity: the maximum number of pages that can be held</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token comment">//     in memory at one time.</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token class-name">PageTable</span><span class="token double-colon punctuation">::</span><span class="token function">PageTable</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string swap_file_name<span class="token punctuation">,</span> size_t page_capacity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    swap_file_<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>swap_file_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">this</span><span class="token operator">-></span>capacity_ <span class="token operator">=</span> page_capacity<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">this</span><span class="token operator">-></span>page_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">// Destructs the page table, freeing any allocated resources</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment">// and flushing any pages currently loaded into memory that</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token comment">// are dirty</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token class-name">PageTable</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">PageTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">while</span><span class="token punctuation">(</span>page_num <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        Page<span class="token operator">*</span> deleted_page <span class="token operator">=</span> page_list<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>second<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        page_list<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        deleted_page<span class="token operator">-></span><span class="token operator">~</span><span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        page_num <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    mp<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    page_list<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token comment">// Given a virtual address, gets the associated</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token comment">// page for that virtual address. This page will</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token comment">// be "loaded" into physical memory by the time it</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token comment">// is returned.</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token comment">// There are three possiblities when a page is requested:</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token comment">// 1. The page is currently in the "loaded" and in the cache.</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token comment">//    In this case, a reference to the page is returned and</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token comment">//    and the page is marked as most recently used in the cache</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token comment">// 2. The page is not currently "loaded", and the PageTable</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token comment">//    has not reached its page capacity:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token comment">//    In this case, the page is loaded from the swap file and added</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token comment">//    to the cache as the most recently used page.</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token comment">// 3. The page is not currently "loaded", and the PageTable</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token comment">//    is at page capacity:</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token comment">//    The least recently used page in the cache is evicted from the</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token comment">//    cache. Afterwards the requested page is loaded from the swap file</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token comment">//    and added to the cache as the most recently used page.</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token comment">// NOTE: What decides how recntly used a page was used is entirely</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token comment">// decided by how recntly it was returned by a call to get_page.</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token comment">// Arguments:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token comment">//   - virtual_address: A virtual address that is associated</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token comment">//     with a requested page. The virutal address is represented</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token comment">//     as a unsigned 32 bit integer. NOTE: a virtual address</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token comment">//     is NOT the same as a page number. Multiple virtual addresses</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token comment">//     could be associated with the same page number.</span></pre></td></tr><tr><td data-num="64"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token comment">// Returns:</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token comment">//   - the requested page, which is loaded into the cache and</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token comment">//     marked as the most recently used page</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  Page<span class="token operator">&amp;</span> <span class="token class-name">PageTable</span><span class="token double-colon punctuation">::</span><span class="token function">get_page</span><span class="token punctuation">(</span><span class="token keyword">uint32_t</span> virtual_address<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token comment">// obtain the virtual_pno according to the virtual address</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    pno_t pno <span class="token operator">=</span> virtual_address <span class="token operator">/</span> Page<span class="token double-colon punctuation">::</span>PAGE_SIZE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">page_available</span><span class="token punctuation">(</span>pno<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        Page<span class="token operator">*</span> p <span class="token operator">=</span> mp<span class="token punctuation">[</span>pno<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        page_list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>pno<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        page_list<span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>pno<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">*</span>p<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        Page<span class="token operator">*</span> pg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Page</span><span class="token punctuation">(</span>swap_file_<span class="token punctuation">,</span>pno<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>page_num <span class="token operator">&lt;</span> capacity_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>            page_list<span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>pno<span class="token punctuation">,</span>pg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token function">flush_page</span><span class="token punctuation">(</span>pno<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>            page_num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>            <span class="token comment">// LRU Algorithms</span></pre></td></tr><tr><td data-num="87"></td><td><pre>            <span class="token comment">// evict the oldest page, and flush it</span></pre></td></tr><tr><td data-num="88"></td><td><pre>            <span class="token function">evict_page</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token comment">// add the new page to the front of the list</span></pre></td></tr><tr><td data-num="90"></td><td><pre>            page_list<span class="token punctuation">.</span><span class="token function">push_front</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>pno<span class="token punctuation">,</span>pg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>            page_num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        mp<span class="token punctuation">[</span>pno<span class="token punctuation">]</span> <span class="token operator">=</span> pg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>mp<span class="token punctuation">[</span>pno<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="97"></td><td><pre></pre></td></tr><tr><td data-num="98"></td><td><pre>  <span class="token comment">// Returns the page capacity of the page table</span></pre></td></tr><tr><td data-num="99"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="101"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="102"></td><td><pre>  <span class="token comment">// Returns: the page capacity of the page table</span></pre></td></tr><tr><td data-num="103"></td><td><pre>  size_t <span class="token class-name">PageTable</span><span class="token double-colon punctuation">::</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token keyword">return</span> capacity_<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre>  <span class="token comment">// Returns the number of pages currently loaded into "physical memory"</span></pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="109"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="110"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="111"></td><td><pre>  <span class="token comment">// Returns: the number of pages currently loaded into "physical memory"</span></pre></td></tr><tr><td data-num="112"></td><td><pre>  size_t <span class="token class-name">PageTable</span><span class="token double-colon punctuation">::</span><span class="token function">loaded_pages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token keyword">return</span> page_num<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre>  <span class="token comment">// Checks to see if the specified page is loaded into memory</span></pre></td></tr><tr><td data-num="117"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token comment">// Arguments: The virtual page number of the page to check for</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="120"></td><td><pre>  <span class="token comment">// Returns: True iff the page is loaded into memory, false otherwise</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token keyword">bool</span> <span class="token class-name">PageTable</span><span class="token double-colon punctuation">::</span><span class="token function">page_available</span><span class="token punctuation">(</span>pno_t virtual_pno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    <span class="token keyword">return</span> mp<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>virtual_pno<span class="token punctuation">)</span> <span class="token operator">!=</span> mp<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="124"></td><td><pre></pre></td></tr><tr><td data-num="125"></td><td><pre>  <span class="token comment">// Makes sure that all currently loaded pages are flushed</span></pre></td></tr><tr><td data-num="126"></td><td><pre>  <span class="token comment">// meaning tha the page contents are updated on the swap file.</span></pre></td></tr><tr><td data-num="127"></td><td><pre>  <span class="token comment">// This should not affect how recently used each page is and all pages</span></pre></td></tr><tr><td data-num="128"></td><td><pre>  <span class="token comment">// will remain loaded into memory after this operation is performed.</span></pre></td></tr><tr><td data-num="129"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="130"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="131"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="132"></td><td><pre>  <span class="token comment">// Returns: Nothing</span></pre></td></tr><tr><td data-num="133"></td><td><pre>  <span class="token keyword">void</span> <span class="token class-name">PageTable</span><span class="token double-colon punctuation">::</span><span class="token function">flush_all_pages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> p<span class="token operator">:</span>page_list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>        p<span class="token punctuation">.</span>second<span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="138"></td><td><pre></pre></td></tr><tr><td data-num="139"></td><td><pre>  <span class="token comment">// Flushes the specified page to the swap file.</span></pre></td></tr><tr><td data-num="140"></td><td><pre>  <span class="token comment">// This should not affect how recently used each page is and all pages</span></pre></td></tr><tr><td data-num="141"></td><td><pre>  <span class="token comment">// will remain loaded into memory after this operation is performed.</span></pre></td></tr><tr><td data-num="142"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="143"></td><td><pre>  <span class="token comment">// Arguments: the virtual page number of the page to flush</span></pre></td></tr><tr><td data-num="144"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="145"></td><td><pre>  <span class="token comment">// Returns: Nothing</span></pre></td></tr><tr><td data-num="146"></td><td><pre>  <span class="token keyword">void</span> <span class="token class-name">PageTable</span><span class="token double-colon punctuation">::</span><span class="token function">flush_page</span><span class="token punctuation">(</span>pno_t virtual_pno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">page_available</span><span class="token punctuation">(</span>virtual_pno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>        Page<span class="token operator">*</span> p <span class="token operator">=</span> mp<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>virtual_pno<span class="token punctuation">)</span><span class="token operator">-></span>second<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>        p<span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="152"></td><td><pre></pre></td></tr><tr><td data-num="153"></td><td><pre>  <span class="token comment">// Discards the specified page from the PageTable.</span></pre></td></tr><tr><td data-num="154"></td><td><pre>  <span class="token comment">// If the page is dirty, then it is flushed before it is discarded.</span></pre></td></tr><tr><td data-num="155"></td><td><pre>  <span class="token comment">// If the page is not in the table, then nothing happens.</span></pre></td></tr><tr><td data-num="156"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="157"></td><td><pre>  <span class="token comment">// Arguments: the virtual page number of the page to discard.</span></pre></td></tr><tr><td data-num="158"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="159"></td><td><pre>  <span class="token comment">// Returns: Nothing</span></pre></td></tr><tr><td data-num="160"></td><td><pre>  <span class="token keyword">void</span> <span class="token class-name">PageTable</span><span class="token double-colon punctuation">::</span><span class="token function">discard_page</span><span class="token punctuation">(</span>pno_t virtual_pno<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">page_available</span><span class="token punctuation">(</span>virtual_pno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>        Page<span class="token operator">*</span> p <span class="token operator">=</span> mp<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>virtual_pno<span class="token punctuation">)</span><span class="token operator">-></span>second<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>        p<span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>        page_list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">make_pair</span><span class="token punctuation">(</span>virtual_pno<span class="token punctuation">,</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>        mp<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>virtual_pno<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>        page_num <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="169"></td><td><pre></pre></td></tr><tr><td data-num="170"></td><td><pre>  <span class="token comment">// Evicts a page from the PageTable. The page evicted</span></pre></td></tr><tr><td data-num="171"></td><td><pre>  <span class="token comment">// should be the least recntly used page in the cache.</span></pre></td></tr><tr><td data-num="172"></td><td><pre>  <span class="token comment">// If the evicted page is dirty, then it is flushed before it is evicted.</span></pre></td></tr><tr><td data-num="173"></td><td><pre>  <span class="token comment">// If there are no pages in the cache, then do nothing.</span></pre></td></tr><tr><td data-num="174"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="175"></td><td><pre>  <span class="token comment">// Arguments: None</span></pre></td></tr><tr><td data-num="176"></td><td><pre>  <span class="token comment">//</span></pre></td></tr><tr><td data-num="177"></td><td><pre>  <span class="token comment">// Returns: Nothing</span></pre></td></tr><tr><td data-num="178"></td><td><pre>  <span class="token keyword">void</span> <span class="token class-name">PageTable</span><span class="token double-colon punctuation">::</span><span class="token function">evict_page</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="179"></td><td><pre>    pno_t current_pno <span class="token operator">=</span> page_list<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="180"></td><td><pre>    Page<span class="token operator">*</span> p <span class="token operator">=</span> page_list<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>second<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="181"></td><td><pre>    <span class="token comment">// find the value in unordered_map</span></pre></td></tr><tr><td data-num="182"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> mp<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> mp<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="183"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>it<span class="token operator">-></span>first <span class="token operator">==</span> current_pno <span class="token operator">&amp;&amp;</span> it<span class="token operator">-></span>second <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>            mp<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>            <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="186"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="187"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>    page_list<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="189"></td><td><pre>    p<span class="token operator">-></span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="190"></td><td><pre>    page_num <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="192"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="2024/01/04/计算机科学/系统/系统入门/CIT5950/">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2024-01-06 07:54:57" itemprop="dateModified" datetime="2024-01-06T07:54:57+08:00">2024-01-06</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i>赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/blog/assets/wechatpay.png" alt="Salvely 微信支付"/><p>微信支付</p></div><div><img data-src="/blog/assets/alipay.png" alt="Salvely 支付宝"/><p>支付宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Salvely<i class="ic i-at"><em>@</em></i>望春风</li><li class="link"><strong>本文链接：</strong><a href="https://salvely.github.io/blog/2024/01/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/CIT5950/" title="HW3: LRU SimpleVM 实现记录">https://salvely.github.io/blog/2024/01/04/计算机科学/系统/系统入门/CIT5950/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/blog/2023/10/31/Projects/Snake/analysis/" rel="prev" itemprop="url" data-background-image="https:&#x2F;&#x2F;i.imgtg.com&#x2F;2023&#x2F;03&#x2F;09&#x2F;YSj7p.jpg" title="动手写贪吃蛇游戏"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>Snake</span><h3>动手写贪吃蛇游戏</h3></a></div><div class="item right"></div></div><div class="wrap" id="wcomments"></div><script type="module" data-pjax="data-pjax">import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';

setTimeout(function () {
    init({
        el: '#wcomments',
        serverURL: 'https://salvely.zeabur.app',
        lang: 'zh-CN',
        locale: {"nick":"昵称","nickError":"昵称不能少于3个字符","mail":"邮箱","mailError":"请填写正确的邮件地址","link":"网址","optional":"可选","placeholder":"欢迎评论","sofa":"来发评论吧~","submit":"提交","like":"喜欢","cancelLike":"取消喜欢","reply":"回复","cancelReply":"取消回复","comment":"评论","refresh":"刷新","more":"加载更多...","preview":"预览","emoji":"表情","uploadImage":"上传图片","seconds":"秒前","minutes":"分钟前","hours":"小时前","days":"天前","now":"刚刚","uploading":"正在上传","login":"登录","logout":"退出","admin":"博主","sticky":"置顶","word":"字","wordHint":"评论字数应在 $0 到 $1 字之间！\\n当前字数：$2","anonymous":"匿名","level0":"潜水","level1":"冒泡","level2":"吐槽","level3":"活跃","level4":"话痨","level5":"传说","gif":"表情包","gifSearchPlaceholder":"搜索表情包","profile":"个人资料","approved":"通过","waiting":"待审核","spam":"垃圾","unsticky":"取消置顶","oldest":"按倒序","latest":"按正序","hottest":"按热度","reactionTitle":"你认为这篇文章怎么样？"},
        emoji: ["https://unpkg.com/@waline/emojis@1.0.1/weibo","https://unpkg.com/@waline/emojis@1.0.1/alus","https://unpkg.com/@waline/emojis@1.0.1/bilibili","https://unpkg.com/@waline/emojis@1.0.1/qq","https://unpkg.com/@waline/emojis@1.0.1/tieba","https://unpkg.com/@waline/emojis@1.0.1/tw-emoji"],
        meta: ["nick","mail","link"],
        requiredMeta: ["nick","mail"],
        wordLimit: 5000,
        pageSize: 10,
        pageview: true,
        path: window.location.pathname,
        dark: 'html[data-theme="dark"]'
    });
}, 1000)</script></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#overview"><span class="toc-number">1.</span> <span class="toc-text"> Overview</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6"><span class="toc-number">2.</span> <span class="toc-text"> 相关文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#page"><span class="toc-number">2.1.</span> <span class="toc-text"> Page</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pagetable"><span class="toc-number">2.2.</span> <span class="toc-text"> PageTable</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#testing"><span class="toc-number">2.3.</span> <span class="toc-text"> Testing</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%8F%90%E7%A4%BA"><span class="toc-number">3.</span> <span class="toc-text"> 实现提示</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#page-2"><span class="toc-number">4.</span> <span class="toc-text"> Page</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#page-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">4.1.</span> <span class="toc-text"> Page 源码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#page-%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.2.</span> <span class="toc-text"> Page 设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pagetemplatescc%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.3.</span> <span class="toc-text">  PageTemplates.cc  实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pageh%E5%AE%9A%E4%B9%89"><span class="toc-number">4.4.</span> <span class="toc-text">  Page.h  定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pagecc%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.5.</span> <span class="toc-text">  Page.cc  实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pagetable-2"><span class="toc-number">5.</span> <span class="toc-text"> PageTable</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#pagetable-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">5.1.</span> <span class="toc-text"> PageTable 源码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pagetableh%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.2.</span> <span class="toc-text">  PageTable.h  设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pagetablecc%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.3.</span> <span class="toc-text">  PageTable.cc  实现</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li  class="active"><a href="/blog/2024/01/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/CIT5950/" rel="bookmark" title="HW3: LRU SimpleVM 实现记录">HW3: LRU SimpleVM 实现记录</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Salvely" data-src="/blog/assets/avatar.jpg"/><p class="name" itemprop="name">Salvely</p><div class="description" itemprop="description">计算机&数理&文学爱好者，喜欢健身、下厨、听音乐和看电影</div></div><nav class="state"><div class="item posts"><a href="/blog/archives/"><span class="count">9</span><span class="name">文章</span></a></div><div class="item categories"><a href="/blog/categories/"><span class="count">11</span><span class="name">分类</span></a></div><div class="item tags"><a href="/blog/tags/"><span class="count">12</span><span class="name">标签</span></a></div></nav><div class="social"><a href="https://github.com/Salvely" class="item github" rel="noopener" title="https:&#x2F;&#x2F;github.com&#x2F;Salvely" target="_blank"><i class="ic i-github"></i></a><a href="/blog/iamgwen9@gmail.com" class="item email" title="iamgwen9@gmail.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/blog/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-user"></i>关于</a><ul class="submenu"><li class="item"><a href="/blog/about/" rel="section"><i class="ic i-user"></i>关于本站</a></li><li class="item"><a href="/blog/admiration/" rel="section"><i class="ic i-coffee"></i>赞赏博主</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/blog/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/blog/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/blog/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/blog/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-home"></i>学习</a><ul class="submenu"><li class="item"><a href="/blog/roadmap/" rel="section"><i class="ic i-check"></i>学习路径</a></li><li class="item"><a href="/blog/course/" rel="section"><i class="ic i-check"></i>CourseDone</a></li><li class="item"><a href="https://github.com/Salvely/Weekly-report" rel="noopener" target="_blank"><i class="ic i-pen"></i>学习周报</a></li></ul></li><li class="item"><a href="/blog/hobby" rel="section"><i class="ic i-coffee"></i>爱好</a></li><li class="item"><a href="/blog/go/" rel="section"><i class="ic i-link"></i>开往</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/blog/2023/10/31/Projects/Snake/analysis/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" title="分类于编程语言">编程语言</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C/" title="分类于C++">C++</a></div><span><a href="/blog/2023/10/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C++/CS106L/">Stanford CS106L:Standard C++ Programming</a></span></li><li class="item"><div class="breadcrumb"><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" title="分类于开发工具">开发工具</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Debian/" title="分类于Debian">Debian</a></div><span><a href="/blog/2023/10/14/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Debian/Debain%E5%8C%85%E7%AE%A1%E7%90%86/">Debian包管理初探</a></span></li><li class="item"><div class="breadcrumb"><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/" title="分类于系统">系统</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/" title="分类于系统入门">系统入门</a></div><span><a href="/blog/2024/01/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%B3%BB%E7%BB%9F/%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8/CIT5950/">HW3: LRU SimpleVM 实现记录</a></span></li><li class="item"><div class="breadcrumb"><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" title="分类于编程语言">编程语言</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C/" title="分类于C++">C++</a></div><span><a href="/blog/2023/10/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C++/C++%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/">C++参考资料</a></span></li><li class="item"><div class="breadcrumb"><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" title="分类于编程语言">编程语言</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C/" title="分类于C++">C++</a></div><span><a href="/blog/2023/10/27/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/C++/C++%E7%BC%96%E8%AF%91%E4%B8%8E%E5%B7%A5%E7%A8%8B%E6%9E%84%E5%BB%BA/">C++编译与工程构建</a></span></li><li class="item"><div class="breadcrumb"><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" title="分类于开发工具">开发工具</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Arch/" title="分类于Arch">Arch</a></div><span><a href="/blog/2023/10/15/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Arch/%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/">Arch Linux系统配置教程</a></span></li><li class="item"><div class="breadcrumb"><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" title="分类于开发工具">开发工具</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Arch/" title="分类于Arch">Arch</a></div><span><a href="/blog/2023/10/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Arch/%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/">Arch Linux安装实录&知识讲解&踩坑分析（超详细！）</a></span></li><li class="item"><div class="breadcrumb"><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" title="分类于计算机科学">计算机科学</a><i class="ic i-angle-right"></i><a href="/blog/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%9D%82%E8%B0%88/" title="分类于杂谈">杂谈</a></div><span><a href="/blog/2023/10/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/%E6%9D%82%E8%B0%88/C++%E7%9A%84%E8%AF%9E%E7%94%9F%E4%B8%8E%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/">C++的诞生与一些思考</a></span></li><li class="item"><div class="breadcrumb"><a href="/blog/categories/Projects/" title="分类于Projects">Projects</a><i class="ic i-angle-right"></i><a href="/blog/categories/Projects/Snake/" title="分类于Snake">Snake</a></div><span><a href="/blog/2023/10/31/Projects/Snake/analysis/">动手写贪吃蛇游戏</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"><li class="item" v-for="com in coms"><a v-bind:href="root + com.href" data-pjax-state="data-pjax-state"><span class="breadcrumb">{{com.nick}} @ {{com.time}}</span><span>{{com.text}}<br/></span></a></li></ul></div></div><div class="status"><div class="copyright">&copy; 2023 -<span itemprop="copyrightYear">2024</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Salvely @ Salvely</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">75k 字</span><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">1:08</span></div><div class="powered-by">基于 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & Theme.<a href="https://github.com/theme-shoka-x/hexo-theme-shokaX/" rel="noopener" target="_blank">ShokaX</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL = {
        path: `2024/01/04/计算机科学/系统/系统入门/CIT5950/`,
        favicon: {
        show: `（●´3｀●）やれやれだぜ`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,
    chart: false,
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=default,fetch"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/pace/1.0.2/pace.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/algoliasearch/4.12.1/algoliasearch-lite.umd.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/instantsearch.js/4.39.0/instantsearch.production.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/quicklink/2.2.0/quicklink.umd.min.js"></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/??jquery/3.5.1/jquery.min.js,fancybox/3.5.7/jquery.fancybox.min.js,justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js" async></script><script src="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-6-M/KaTeX/0.15.2/contrib/copy-tex.min.js" async></script><script src="/blog/js/app.js?v=0.3.6"></script>
    <script type="module" data-pjax>
        let items = []
        import { RecentComments } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs'
        RecentComments({
          serverURL: 'https://salvely.zeabur.app',
          count: 10,
        }).then(({ comments }) => {
          comments.forEach(function (item) {
              let cText = (item.orig.length > 50) ? item.orig.substring(0,50)+'...' : item.orig
              item.url = item.url !== '/' ?  '/' + item.url : item.url;
              const siteLink = item.url + "#" + item.objectId
              items.push({
                  href: siteLink,
                  nick: item.nick,
                  time: item.insertedAt.split('T').shift(),
                  text: cText
              })
          })
          Vue.createApp({
            data() {
                return {
                    coms: items,
                    root: '/blog'
                }
            }
          }).mount('#new-comment')
        }).catch(function (err) {
          console.error(err)
        })
    </script>
    </body></html>